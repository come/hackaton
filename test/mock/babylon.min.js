var BABYLON;!function(e){var t=function(){function e(e,t,i){"undefined"==typeof e&&(e=0),"undefined"==typeof t&&(t=0),"undefined"==typeof i&&(i=0),this.r=e,this.g=t,this.b=i}return e.prototype.toString=function(){return"{R: "+this.r+" G:"+this.g+" B:"+this.b+"}"},e.prototype.toArray=function(e,t){void 0===t&&(t=0),e[t]=this.r,e[t+1]=this.g,e[t+2]=this.b},e.prototype.asArray=function(){var e=[];return this.toArray(e,0),e},e.prototype.multiply=function(t){return new e(this.r*t.r,this.g*t.g,this.b*t.b)},e.prototype.multiplyToRef=function(e,t){t.r=this.r*e.r,t.g=this.g*e.g,t.b=this.b*e.b},e.prototype.equals=function(e){return e&&this.r===e.r&&this.g===e.g&&this.b===e.b},e.prototype.scale=function(t){return new e(this.r*t,this.g*t,this.b*t)},e.prototype.scaleToRef=function(e,t){t.r=this.r*e,t.g=this.g*e,t.b=this.b*e},e.prototype.add=function(t){return new e(this.r+t.r,this.g+t.g,this.b+t.b)},e.prototype.addToRef=function(e,t){t.r=this.r+e.r,t.g=this.g+e.g,t.b=this.b+e.b},e.prototype.subtract=function(t){return new e(this.r-t.r,this.g-t.g,this.b-t.b)},e.prototype.subtractToRef=function(e,t){t.r=this.r-e.r,t.g=this.g-e.g,t.b=this.b-e.b},e.prototype.clone=function(){return new e(this.r,this.g,this.b)},e.prototype.copyFrom=function(e){this.r=e.r,this.g=e.g,this.b=e.b},e.prototype.copyFromFloats=function(e,t,i){this.r=e,this.g=t,this.b=i},e.FromArray=function(t){return new e(t[0],t[1],t[2])},e.FromInts=function(t,i,r){return new e(t/255,i/255,r/255)},e.Lerp=function(t,i,r){var n=t.r+(i.r-t.r)*r,o=t.g+(i.g-t.g)*r,s=t.b+(i.b-t.b)*r;return new e(n,o,s)},e.Red=function(){return new e(1,0,0)},e.Green=function(){return new e(0,1,0)},e.Blue=function(){return new e(0,0,1)},e.Black=function(){return new e(0,0,0)},e.White=function(){return new e(1,1,1)},e.Purple=function(){return new e(.5,0,.5)},e.Magenta=function(){return new e(1,0,1)},e.Yellow=function(){return new e(1,1,0)},e.Gray=function(){return new e(.5,.5,.5)},e}();e.Color3=t;var i=function(){function t(e,t,i,r){this.r=e,this.g=t,this.b=i,this.a=r}return t.prototype.addInPlace=function(e){this.r+=e.r,this.g+=e.g,this.b+=e.b,this.a+=e.a},t.prototype.asArray=function(){var e=[];return this.toArray(e,0),e},t.prototype.toArray=function(e,t){void 0===t&&(t=0),e[t]=this.r,e[t+1]=this.g,e[t+2]=this.b,e[t+3]=this.a},t.prototype.add=function(e){return new t(this.r+e.r,this.g+e.g,this.b+e.b,this.a+e.a)},t.prototype.subtract=function(e){return new t(this.r-e.r,this.g-e.g,this.b-e.b,this.a-e.a)},t.prototype.subtractToRef=function(e,t){t.r=this.r-e.r,t.g=this.g-e.g,t.b=this.b-e.b,t.a=this.a-e.a},t.prototype.scale=function(e){return new t(this.r*e,this.g*e,this.b*e,this.a*e)},t.prototype.scaleToRef=function(e,t){t.r=this.r*e,t.g=this.g*e,t.b=this.b*e,t.a=this.a*e},t.prototype.toString=function(){return"{R: "+this.r+" G:"+this.g+" B:"+this.b+" A:"+this.a+"}"},t.prototype.clone=function(){return new t(this.r,this.g,this.b,this.a)},t.Lerp=function(i,r,n){var o=new t(0,0,0,0);return e.Color4.LerpToRef(i,r,n,o),o},t.LerpToRef=function(e,t,i,r){r.r=e.r+(t.r-e.r)*i,r.g=e.g+(t.g-e.g)*i,r.b=e.b+(t.b-e.b)*i,r.a=e.a+(t.a-e.a)*i},t.FromArray=function(e,i){return i||(i=0),new t(e[i],e[i+1],e[i+2],e[i+3])},t.FromInts=function(e,i,r,n){return new t(e/255,i/255,r/255,n/255)},t}();e.Color4=i;var r=function(){function e(e,t){this.x=e,this.y=t}return e.prototype.toString=function(){return"{X: "+this.x+" Y:"+this.y+"}"},e.prototype.toArray=function(e,t){void 0===t&&(t=0),e[t]=this.x,e[t+1]=this.y},e.prototype.asArray=function(){var e=[];return this.toArray(e,0),e},e.prototype.copyFrom=function(e){this.x=e.x,this.y=e.y},e.prototype.add=function(t){return new e(this.x+t.x,this.y+t.y)},e.prototype.subtract=function(t){return new e(this.x-t.x,this.y-t.y)},e.prototype.negate=function(){return new e(-this.x,-this.y)},e.prototype.scaleInPlace=function(e){this.x*=e,this.y*=e},e.prototype.scale=function(t){return new e(this.x*t,this.y*t)},e.prototype.equals=function(e){return e&&this.x===e.x&&this.y===e.y},e.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y)},e.prototype.lengthSquared=function(){return this.x*this.x+this.y*this.y},e.prototype.normalize=function(){var e=this.length();if(0!==e){var t=1/e;this.x*=t,this.y*=t}},e.prototype.clone=function(){return new e(this.x,this.y)},e.Zero=function(){return new e(0,0)},e.CatmullRom=function(t,i,r,n,o){var s=o*o,a=o*s,h=.5*(2*i.x+(-t.x+r.x)*o+(2*t.x-5*i.x+4*r.x-n.x)*s+(-t.x+3*i.x-3*r.x+n.x)*a),c=.5*(2*i.y+(-t.y+r.y)*o+(2*t.y-5*i.y+4*r.y-n.y)*s+(-t.y+3*i.y-3*r.y+n.y)*a);return new e(h,c)},e.Clamp=function(t,i,r){var n=t.x;n=n>r.x?r.x:n,n=n<i.x?i.x:n;var o=t.y;return o=o>r.y?r.y:o,o=o<i.y?i.y:o,new e(n,o)},e.Hermite=function(t,i,r,n,o){var s=o*o,a=o*s,h=2*a-3*s+1,c=-2*a+3*s,u=a-2*s+o,l=a-s,f=t.x*h+r.x*c+i.x*u+n.x*l,d=t.y*h+r.y*c+i.y*u+n.y*l;return new e(f,d)},e.Lerp=function(t,i,r){var n=t.x+(i.x-t.x)*r,o=t.y+(i.y-t.y)*r;return new e(n,o)},e.Dot=function(e,t){return e.x*t.x+e.y*t.y},e.Normalize=function(e){var t=e.clone();return t.normalize(),t},e.Minimize=function(t,i){var r=t.x<i.x?t.x:i.x,n=t.y<i.y?t.y:i.y;return new e(r,n)},e.Maximize=function(t,i){var r=t.x>i.x?t.x:i.x,n=t.y>i.y?t.y:i.y;return new e(r,n)},e.Transform=function(t,i){var r=t.x*i.m[0]+t.y*i.m[4],n=t.x*i.m[1]+t.y*i.m[5];return new e(r,n)},e.Distance=function(t,i){return Math.sqrt(e.DistanceSquared(t,i))},e.DistanceSquared=function(e,t){var i=e.x-t.x,r=e.y-t.y;return i*i+r*r},e}();e.Vector2=r;var n=function(){function t(e,t,i){this.x=e,this.y=t,this.z=i}return t.prototype.toString=function(){return"{X: "+this.x+" Y:"+this.y+" Z:"+this.z+"}"},t.prototype.asArray=function(){var e=[];return this.toArray(e,0),e},t.prototype.toArray=function(e,t){void 0===t&&(t=0),e[t]=this.x,e[t+1]=this.y,e[t+2]=this.z},t.prototype.addInPlace=function(e){this.x+=e.x,this.y+=e.y,this.z+=e.z},t.prototype.add=function(e){return new t(this.x+e.x,this.y+e.y,this.z+e.z)},t.prototype.addToRef=function(e,t){t.x=this.x+e.x,t.y=this.y+e.y,t.z=this.z+e.z},t.prototype.subtractInPlace=function(e){this.x-=e.x,this.y-=e.y,this.z-=e.z},t.prototype.subtract=function(e){return new t(this.x-e.x,this.y-e.y,this.z-e.z)},t.prototype.subtractToRef=function(e,t){t.x=this.x-e.x,t.y=this.y-e.y,t.z=this.z-e.z},t.prototype.subtractFromFloats=function(e,i,r){return new t(this.x-e,this.y-i,this.z-r)},t.prototype.subtractFromFloatsToRef=function(e,t,i,r){r.x=this.x-e,r.y=this.y-t,r.z=this.z-i},t.prototype.negate=function(){return new t(-this.x,-this.y,-this.z)},t.prototype.scaleInPlace=function(e){this.x*=e,this.y*=e,this.z*=e},t.prototype.scale=function(e){return new t(this.x*e,this.y*e,this.z*e)},t.prototype.scaleToRef=function(e,t){t.x=this.x*e,t.y=this.y*e,t.z=this.z*e},t.prototype.equals=function(e){return e&&this.x===e.x&&this.y===e.y&&this.z===e.z},t.prototype.equalsToFloats=function(e,t,i){return this.x===e&&this.y===t&&this.z===i},t.prototype.multiplyInPlace=function(e){this.x*=e.x,this.y*=e.y,this.z*=e.z},t.prototype.multiply=function(e){return new t(this.x*e.x,this.y*e.y,this.z*e.z)},t.prototype.multiplyToRef=function(e,t){t.x=this.x*e.x,t.y=this.y*e.y,t.z=this.z*e.z},t.prototype.multiplyByFloats=function(e,i,r){return new t(this.x*e,this.y*i,this.z*r)},t.prototype.divide=function(e){return new t(this.x/e.x,this.y/e.y,this.z/e.z)},t.prototype.divideToRef=function(e,t){t.x=this.x/e.x,t.y=this.y/e.y,t.z=this.z/e.z},t.prototype.MinimizeInPlace=function(e){e.x<this.x&&(this.x=e.x),e.y<this.y&&(this.y=e.y),e.z<this.z&&(this.z=e.z)},t.prototype.MaximizeInPlace=function(e){e.x>this.x&&(this.x=e.x),e.y>this.y&&(this.y=e.y),e.z>this.z&&(this.z=e.z)},t.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},t.prototype.lengthSquared=function(){return this.x*this.x+this.y*this.y+this.z*this.z},t.prototype.normalize=function(){var e=this.length();if(0!==e){var t=1/e;this.x*=t,this.y*=t,this.z*=t}},t.prototype.clone=function(){return new t(this.x,this.y,this.z)},t.prototype.copyFrom=function(e){this.x=e.x,this.y=e.y,this.z=e.z},t.prototype.copyFromFloats=function(e,t,i){this.x=e,this.y=t,this.z=i},t.FromArray=function(e,i){return i||(i=0),new t(e[i],e[i+1],e[i+2])},t.FromArrayToRef=function(e,t,i){i.x=e[t],i.y=e[t+1],i.z=e[t+2]},t.FromFloatArrayToRef=function(e,t,i){i.x=e[t],i.y=e[t+1],i.z=e[t+2]},t.FromFloatsToRef=function(e,t,i,r){r.x=e,r.y=t,r.z=i},t.Zero=function(){return new t(0,0,0)},t.Up=function(){return new t(0,1,0)},t.TransformCoordinates=function(e,i){var r=t.Zero();return t.TransformCoordinatesToRef(e,i,r),r},t.TransformCoordinatesToRef=function(e,t,i){var r=e.x*t.m[0]+e.y*t.m[4]+e.z*t.m[8]+t.m[12],n=e.x*t.m[1]+e.y*t.m[5]+e.z*t.m[9]+t.m[13],o=e.x*t.m[2]+e.y*t.m[6]+e.z*t.m[10]+t.m[14],s=e.x*t.m[3]+e.y*t.m[7]+e.z*t.m[11]+t.m[15];i.x=r/s,i.y=n/s,i.z=o/s},t.TransformCoordinatesFromFloatsToRef=function(e,t,i,r,n){var o=e*r.m[0]+t*r.m[4]+i*r.m[8]+r.m[12],s=e*r.m[1]+t*r.m[5]+i*r.m[9]+r.m[13],a=e*r.m[2]+t*r.m[6]+i*r.m[10]+r.m[14],h=e*r.m[3]+t*r.m[7]+i*r.m[11]+r.m[15];n.x=o/h,n.y=s/h,n.z=a/h},t.TransformNormal=function(e,i){var r=t.Zero();return t.TransformNormalToRef(e,i,r),r},t.TransformNormalToRef=function(e,t,i){i.x=e.x*t.m[0]+e.y*t.m[4]+e.z*t.m[8],i.y=e.x*t.m[1]+e.y*t.m[5]+e.z*t.m[9],i.z=e.x*t.m[2]+e.y*t.m[6]+e.z*t.m[10]},t.TransformNormalFromFloatsToRef=function(e,t,i,r,n){n.x=e*r.m[0]+t*r.m[4]+i*r.m[8],n.y=e*r.m[1]+t*r.m[5]+i*r.m[9],n.z=e*r.m[2]+t*r.m[6]+i*r.m[10]},t.CatmullRom=function(e,i,r,n,o){var s=o*o,a=o*s,h=.5*(2*i.x+(-e.x+r.x)*o+(2*e.x-5*i.x+4*r.x-n.x)*s+(-e.x+3*i.x-3*r.x+n.x)*a),c=.5*(2*i.y+(-e.y+r.y)*o+(2*e.y-5*i.y+4*r.y-n.y)*s+(-e.y+3*i.y-3*r.y+n.y)*a),u=.5*(2*i.z+(-e.z+r.z)*o+(2*e.z-5*i.z+4*r.z-n.z)*s+(-e.z+3*i.z-3*r.z+n.z)*a);return new t(h,c,u)},t.Clamp=function(e,i,r){var n=e.x;n=n>r.x?r.x:n,n=n<i.x?i.x:n;var o=e.y;o=o>r.y?r.y:o,o=o<i.y?i.y:o;var s=e.z;return s=s>r.z?r.z:s,s=s<i.z?i.z:s,new t(n,o,s)},t.Hermite=function(e,i,r,n,o){var s=o*o,a=o*s,h=2*a-3*s+1,c=-2*a+3*s,u=a-2*s+o,l=a-s,f=e.x*h+r.x*c+i.x*u+n.x*l,d=e.y*h+r.y*c+i.y*u+n.y*l,p=e.z*h+r.z*c+i.z*u+n.z*l;return new t(f,d,p)},t.Lerp=function(e,i,r){var n=e.x+(i.x-e.x)*r,o=e.y+(i.y-e.y)*r,s=e.z+(i.z-e.z)*r;return new t(n,o,s)},t.Dot=function(e,t){return e.x*t.x+e.y*t.y+e.z*t.z},t.Cross=function(e,i){var r=t.Zero();return t.CrossToRef(e,i,r),r},t.CrossToRef=function(e,t,i){i.x=e.y*t.z-e.z*t.y,i.y=e.z*t.x-e.x*t.z,i.z=e.x*t.y-e.y*t.x},t.Normalize=function(e){var i=t.Zero();return t.NormalizeToRef(e,i),i},t.NormalizeToRef=function(e,t){t.copyFrom(e),t.normalize()},t.Project=function(i,r,n,o){var s=o.width,a=o.height,h=o.x,c=o.y,u=e.Matrix.FromValues(s/2,0,0,0,0,-a/2,0,0,0,0,1,0,h+s/2,a/2+c,0,1),l=r.multiply(n).multiply(u);return t.TransformCoordinates(i,l)},t.Unproject=function(t,i,r,n,o,s){var a=n.multiply(o).multiply(s);a.invert(),t.x=t.x/i*2-1,t.y=-(t.y/r*2-1);var h=e.Vector3.TransformCoordinates(t,a),c=t.x*a.m[3]+t.y*a.m[7]+t.z*a.m[11]+a.m[15];return e.Tools.WithinEpsilon(c,1)&&(h=h.scale(1/c)),h},t.Minimize=function(e,t){var i=e.clone();return i.MinimizeInPlace(t),i},t.Maximize=function(e,t){var i=e.clone();return i.MaximizeInPlace(t),i},t.Distance=function(e,i){return Math.sqrt(t.DistanceSquared(e,i))},t.DistanceSquared=function(e,t){var i=e.x-t.x,r=e.y-t.y,n=e.z-t.z;return i*i+r*r+n*n},t.Center=function(e,t){var i=e.add(t);return i.scaleInPlace(.5),i},t}();e.Vector3=n;var o=function(){function e(e,t,i,r){"undefined"==typeof e&&(e=0),"undefined"==typeof t&&(t=0),"undefined"==typeof i&&(i=0),"undefined"==typeof r&&(r=0),this.x=e,this.y=t,this.z=i,this.w=r}return e.prototype.toString=function(){return"{X: "+this.x+" Y:"+this.y+" Z:"+this.z+" W:"+this.w+"}"},e.prototype.asArray=function(){return[this.x,this.y,this.z,this.w]},e.prototype.equals=function(e){return e&&this.x===e.x&&this.y===e.y&&this.z===e.z&&this.w===e.w},e.prototype.clone=function(){return new e(this.x,this.y,this.z,this.w)},e.prototype.copyFrom=function(e){this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w},e.prototype.add=function(t){return new e(this.x+t.x,this.y+t.y,this.z+t.z,this.w+t.w)},e.prototype.subtract=function(t){return new e(this.x-t.x,this.y-t.y,this.z-t.z,this.w-t.w)},e.prototype.scale=function(t){return new e(this.x*t,this.y*t,this.z*t,this.w*t)},e.prototype.multiply=function(t){var i=new e(0,0,0,1);return this.multiplyToRef(t,i),i},e.prototype.multiplyToRef=function(e,t){t.x=this.x*e.w+this.y*e.z-this.z*e.y+this.w*e.x,t.y=-this.x*e.z+this.y*e.w+this.z*e.x+this.w*e.y,t.z=this.x*e.y-this.y*e.x+this.z*e.w+this.w*e.z,t.w=-this.x*e.x-this.y*e.y-this.z*e.z+this.w*e.w},e.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},e.prototype.normalize=function(){var e=1/this.length();this.x*=e,this.y*=e,this.z*=e,this.w*=e},e.prototype.toEulerAngles=function(){var e=this.x,t=this.y,i=this.z,r=this.w,o=e*e,s=t*t,a=i*i,h=Math.atan2(2*(t*r-e*i),1-2*(s+a)),c=Math.asin(2*(e*t+i*r)),u=Math.atan2(2*(e*r-t*i),1-2*(o+a)),l=e*t+i*r;return l>.499?(h=2*Math.atan2(e,r),u=0):-.499>l&&(h=-2*Math.atan2(e,r),u=0),new n(c,h,u)},e.prototype.toRotationMatrix=function(e){var t=this.x*this.x,i=this.y*this.y,r=this.z*this.z,n=this.x*this.y,o=this.z*this.w,s=this.z*this.x,a=this.y*this.w,h=this.y*this.z,c=this.x*this.w;e.m[0]=1-2*(i+r),e.m[1]=2*(n+o),e.m[2]=2*(s-a),e.m[3]=0,e.m[4]=2*(n-o),e.m[5]=1-2*(r+t),e.m[6]=2*(h+c),e.m[7]=0,e.m[8]=2*(s+a),e.m[9]=2*(h-c),e.m[10]=1-2*(i+t),e.m[11]=0,e.m[12]=0,e.m[13]=0,e.m[14]=0,e.m[15]=1},e.RotationAxis=function(t,i){var r=new e,n=Math.sin(i/2);return r.w=Math.cos(i/2),r.x=t.x*n,r.y=t.y*n,r.z=t.z*n,r},e.FromArray=function(t,i){return i||(i=0),new e(t[i],t[i+1],t[i+2],t[i+3])},e.RotationYawPitchRoll=function(t,i,r){var n=new e;return e.RotationYawPitchRollToRef(t,i,r,n),n},e.RotationYawPitchRollToRef=function(e,t,i,r){var n=.5*i,o=.5*t,s=.5*e,a=Math.sin(n),h=Math.cos(n),c=Math.sin(o),u=Math.cos(o),l=Math.sin(s),f=Math.cos(s);r.x=f*c*h+l*u*a,r.y=l*u*h-f*c*a,r.z=f*u*a-l*c*h,r.w=f*u*h+l*c*a},e.Slerp=function(t,i,r){var n,o,s=r,a=t.x*i.x+t.y*i.y+t.z*i.z+t.w*i.w,h=!1;if(0>a&&(h=!0,a=-a),a>.999999)o=1-s,n=h?-s:s;else{var c=Math.acos(a),u=1/Math.sin(c);o=Math.sin((1-s)*c)*u,n=h?-Math.sin(s*c)*u:Math.sin(s*c)*u}return new e(o*t.x+n*i.x,o*t.y+n*i.y,o*t.z+n*i.z,o*t.w+n*i.w)},e}();e.Quaternion=o;var s=function(){function e(){this.m=new Float32Array(16)}return e.prototype.isIdentity=function(){return 1!=this.m[0]||1!=this.m[5]||1!=this.m[10]||1!=this.m[15]?!1:0!=this.m[1]||0!=this.m[2]||0!=this.m[3]||0!=this.m[4]||0!=this.m[6]||0!=this.m[7]||0!=this.m[8]||0!=this.m[9]||0!=this.m[11]||0!=this.m[12]||0!=this.m[13]||0!=this.m[14]?!1:!0},e.prototype.determinant=function(){var e=this.m[10]*this.m[15]-this.m[11]*this.m[14],t=this.m[9]*this.m[15]-this.m[11]*this.m[13],i=this.m[9]*this.m[14]-this.m[10]*this.m[13],r=this.m[8]*this.m[15]-this.m[11]*this.m[12],n=this.m[8]*this.m[14]-this.m[10]*this.m[12],o=this.m[8]*this.m[13]-this.m[9]*this.m[12];return this.m[0]*(this.m[5]*e-this.m[6]*t+this.m[7]*i)-this.m[1]*(this.m[4]*e-this.m[6]*r+this.m[7]*n)+this.m[2]*(this.m[4]*t-this.m[5]*r+this.m[7]*o)-this.m[3]*(this.m[4]*i-this.m[5]*n+this.m[6]*o)},e.prototype.toArray=function(){return this.m},e.prototype.asArray=function(){return this.toArray()},e.prototype.invert=function(){this.invertToRef(this)},e.prototype.invertToRef=function(e){var t=this.m[0],i=this.m[1],r=this.m[2],n=this.m[3],o=this.m[4],s=this.m[5],a=this.m[6],h=this.m[7],c=this.m[8],u=this.m[9],l=this.m[10],f=this.m[11],d=this.m[12],p=this.m[13],m=this.m[14],_=this.m[15],g=l*_-f*m,v=u*_-f*p,y=u*m-l*p,x=c*_-f*d,A=c*m-l*d,B=c*p-u*d,T=s*g-a*v+h*y,b=-(o*g-a*x+h*A),M=o*v-s*x+h*B,L=-(o*y-s*A+a*B),E=1/(t*T+i*b+r*M+n*L),O=a*_-h*m,P=s*_-h*p,S=s*m-a*p,w=o*_-h*d,C=o*m-a*d,I=o*p-s*d,D=a*f-h*l,R=s*f-h*u,N=s*l-a*u,V=o*f-h*c,F=o*l-a*c,k=o*u-s*c;e.m[0]=T*E,e.m[4]=b*E,e.m[8]=M*E,e.m[12]=L*E,e.m[1]=-(i*g-r*v+n*y)*E,e.m[5]=(t*g-r*x+n*A)*E,e.m[9]=-(t*v-i*x+n*B)*E,e.m[13]=(t*y-i*A+r*B)*E,e.m[2]=(i*O-r*P+n*S)*E,e.m[6]=-(t*O-r*w+n*C)*E,e.m[10]=(t*P-i*w+n*I)*E,e.m[14]=-(t*S-i*C+r*I)*E,e.m[3]=-(i*D-r*R+n*N)*E,e.m[7]=(t*D-r*V+n*F)*E,e.m[11]=-(t*R-i*V+n*k)*E,e.m[15]=(t*N-i*F+r*k)*E},e.prototype.setTranslation=function(e){this.m[12]=e.x,this.m[13]=e.y,this.m[14]=e.z},e.prototype.multiply=function(t){var i=new e;return this.multiplyToRef(t,i),i},e.prototype.copyFrom=function(e){for(var t=0;16>t;t++)this.m[t]=e.m[t]},e.prototype.copyToArray=function(e,t){"undefined"==typeof t&&(t=0);for(var i=0;16>i;i++)e[t+i]=this.m[i]},e.prototype.multiplyToRef=function(e,t){this.multiplyToArray(e,t.m,0)},e.prototype.multiplyToArray=function(e,t,i){var r=this.m[0],n=this.m[1],o=this.m[2],s=this.m[3],a=this.m[4],h=this.m[5],c=this.m[6],u=this.m[7],l=this.m[8],f=this.m[9],d=this.m[10],p=this.m[11],m=this.m[12],_=this.m[13],g=this.m[14],v=this.m[15],y=e.m[0],x=e.m[1],A=e.m[2],B=e.m[3],T=e.m[4],b=e.m[5],M=e.m[6],L=e.m[7],E=e.m[8],O=e.m[9],P=e.m[10],S=e.m[11],w=e.m[12],C=e.m[13],I=e.m[14],D=e.m[15];t[i]=r*y+n*T+o*E+s*w,t[i+1]=r*x+n*b+o*O+s*C,t[i+2]=r*A+n*M+o*P+s*I,t[i+3]=r*B+n*L+o*S+s*D,t[i+4]=a*y+h*T+c*E+u*w,t[i+5]=a*x+h*b+c*O+u*C,t[i+6]=a*A+h*M+c*P+u*I,t[i+7]=a*B+h*L+c*S+u*D,t[i+8]=l*y+f*T+d*E+p*w,t[i+9]=l*x+f*b+d*O+p*C,t[i+10]=l*A+f*M+d*P+p*I,t[i+11]=l*B+f*L+d*S+p*D,t[i+12]=m*y+_*T+g*E+v*w,t[i+13]=m*x+_*b+g*O+v*C,t[i+14]=m*A+_*M+g*P+v*I,t[i+15]=m*B+_*L+g*S+v*D},e.prototype.equals=function(e){return e&&this.m[0]===e.m[0]&&this.m[1]===e.m[1]&&this.m[2]===e.m[2]&&this.m[3]===e.m[3]&&this.m[4]===e.m[4]&&this.m[5]===e.m[5]&&this.m[6]===e.m[6]&&this.m[7]===e.m[7]&&this.m[8]===e.m[8]&&this.m[9]===e.m[9]&&this.m[10]===e.m[10]&&this.m[11]===e.m[11]&&this.m[12]===e.m[12]&&this.m[13]===e.m[13]&&this.m[14]===e.m[14]&&this.m[15]===e.m[15]},e.prototype.clone=function(){return e.FromValues(this.m[0],this.m[1],this.m[2],this.m[3],this.m[4],this.m[5],this.m[6],this.m[7],this.m[8],this.m[9],this.m[10],this.m[11],this.m[12],this.m[13],this.m[14],this.m[15])},e.FromArray=function(t,i){var r=new e;return i||(i=0),e.FromArrayToRef(t,i,r),r},e.FromArrayToRef=function(e,t,i){for(var r=0;16>r;r++)i.m[r]=e[r+t]},e.FromValuesToRef=function(e,t,i,r,n,o,s,a,h,c,u,l,f,d,p,m,_){_.m[0]=e,_.m[1]=t,_.m[2]=i,_.m[3]=r,_.m[4]=n,_.m[5]=o,_.m[6]=s,_.m[7]=a,_.m[8]=h,_.m[9]=c,_.m[10]=u,_.m[11]=l,_.m[12]=f,_.m[13]=d,_.m[14]=p,_.m[15]=m},e.FromValues=function(t,i,r,n,o,s,a,h,c,u,l,f,d,p,m,_){var g=new e;return g.m[0]=t,g.m[1]=i,g.m[2]=r,g.m[3]=n,g.m[4]=o,g.m[5]=s,g.m[6]=a,g.m[7]=h,g.m[8]=c,g.m[9]=u,g.m[10]=l,g.m[11]=f,g.m[12]=d,g.m[13]=p,g.m[14]=m,g.m[15]=_,g},e.Identity=function(){return e.FromValues(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1)},e.IdentityToRef=function(t){e.FromValuesToRef(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1,t)},e.Zero=function(){return e.FromValues(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)},e.RotationX=function(t){var i=new e;return e.RotationXToRef(t,i),i},e.RotationXToRef=function(e,t){var i=Math.sin(e),r=Math.cos(e);t.m[0]=1,t.m[15]=1,t.m[5]=r,t.m[10]=r,t.m[9]=-i,t.m[6]=i,t.m[1]=0,t.m[2]=0,t.m[3]=0,t.m[4]=0,t.m[7]=0,t.m[8]=0,t.m[11]=0,t.m[12]=0,t.m[13]=0,t.m[14]=0},e.RotationY=function(t){var i=new e;return e.RotationYToRef(t,i),i},e.RotationYToRef=function(e,t){var i=Math.sin(e),r=Math.cos(e);t.m[5]=1,t.m[15]=1,t.m[0]=r,t.m[2]=-i,t.m[8]=i,t.m[10]=r,t.m[1]=0,t.m[3]=0,t.m[4]=0,t.m[6]=0,t.m[7]=0,t.m[9]=0,t.m[11]=0,t.m[12]=0,t.m[13]=0,t.m[14]=0},e.RotationZ=function(t){var i=new e;return e.RotationZToRef(t,i),i},e.RotationZToRef=function(e,t){var i=Math.sin(e),r=Math.cos(e);t.m[10]=1,t.m[15]=1,t.m[0]=r,t.m[1]=i,t.m[4]=-i,t.m[5]=r,t.m[2]=0,t.m[3]=0,t.m[6]=0,t.m[7]=0,t.m[8]=0,t.m[9]=0,t.m[11]=0,t.m[12]=0,t.m[13]=0,t.m[14]=0},e.RotationAxis=function(t,i){var r=Math.sin(-i),n=Math.cos(-i),o=1-n;t.normalize();var s=e.Zero();return s.m[0]=t.x*t.x*o+n,s.m[1]=t.x*t.y*o-t.z*r,s.m[2]=t.x*t.z*o+t.y*r,s.m[3]=0,s.m[4]=t.y*t.x*o+t.z*r,s.m[5]=t.y*t.y*o+n,s.m[6]=t.y*t.z*o-t.x*r,s.m[7]=0,s.m[8]=t.z*t.x*o-t.y*r,s.m[9]=t.z*t.y*o+t.x*r,s.m[10]=t.z*t.z*o+n,s.m[11]=0,s.m[15]=1,s},e.RotationYawPitchRoll=function(t,i,r){var n=new e;return e.RotationYawPitchRollToRef(t,i,r,n),n},e.RotationYawPitchRollToRef=function(e,t,i,r){o.RotationYawPitchRollToRef(e,t,i,this._tempQuaternion),this._tempQuaternion.toRotationMatrix(r)},e.Scaling=function(t,i,r){var n=e.Zero();return e.ScalingToRef(t,i,r,n),n},e.ScalingToRef=function(e,t,i,r){r.m[0]=e,r.m[1]=0,r.m[2]=0,r.m[3]=0,r.m[4]=0,r.m[5]=t,r.m[6]=0,r.m[7]=0,r.m[8]=0,r.m[9]=0,r.m[10]=i,r.m[11]=0,r.m[12]=0,r.m[13]=0,r.m[14]=0,r.m[15]=1},e.Translation=function(t,i,r){var n=e.Identity();return e.TranslationToRef(t,i,r,n),n},e.TranslationToRef=function(t,i,r,n){e.FromValuesToRef(1,0,0,0,0,1,0,0,0,0,1,0,t,i,r,1,n)},e.LookAtLH=function(t,i,r){var n=e.Zero();return e.LookAtLHToRef(t,i,r,n),n},e.LookAtLHToRef=function(t,i,r,o){i.subtractToRef(t,this._zAxis),this._zAxis.normalize(),n.CrossToRef(r,this._zAxis,this._xAxis),this._xAxis.normalize(),n.CrossToRef(this._zAxis,this._xAxis,this._yAxis),this._yAxis.normalize();var s=-n.Dot(this._xAxis,t),a=-n.Dot(this._yAxis,t),h=-n.Dot(this._zAxis,t);return e.FromValuesToRef(this._xAxis.x,this._yAxis.x,this._zAxis.x,0,this._xAxis.y,this._yAxis.y,this._zAxis.y,0,this._xAxis.z,this._yAxis.z,this._zAxis.z,0,s,a,h,1,o)},e.OrthoLH=function(t,i,r,n){var o=2/t,s=2/i,a=1/(n-r),h=r/(r-n);return e.FromValues(o,0,0,0,0,s,0,0,0,0,a,0,0,0,h,1)},e.OrthoOffCenterLH=function(t,i,r,n,o,s){var a=e.Zero();return e.OrthoOffCenterLHToRef(t,i,r,n,o,s,a),a},e.OrthoOffCenterLHToRef=function(e,t,i,r,n,o,s){s.m[0]=2/(t-e),s.m[1]=s.m[2]=s.m[3]=0,s.m[5]=2/(r-i),s.m[4]=s.m[6]=s.m[7]=0,s.m[10]=-1/(n-o),s.m[8]=s.m[9]=s.m[11]=0,s.m[12]=(e+t)/(e-t),s.m[13]=(r+i)/(i-r),s.m[14]=n/(n-o),s.m[15]=1},e.PerspectiveLH=function(t,i,r,n){var o=e.Zero();return o.m[0]=2*r/t,o.m[1]=o.m[2]=o.m[3]=0,o.m[5]=2*r/i,o.m[4]=o.m[6]=o.m[7]=0,o.m[10]=-n/(r-n),o.m[8]=o.m[9]=0,o.m[11]=1,o.m[12]=o.m[13]=o.m[15]=0,o.m[14]=r*n/(r-n),o},e.PerspectiveFovLH=function(t,i,r,n){var o=e.Zero();return e.PerspectiveFovLHToRef(t,i,r,n,o),o},e.PerspectiveFovLHToRef=function(e,t,i,r,n){var o=1/Math.tan(.5*e);n.m[0]=o/t,n.m[1]=n.m[2]=n.m[3]=0,n.m[5]=o,n.m[4]=n.m[6]=n.m[7]=0,n.m[8]=n.m[9]=0,n.m[10]=-r/(i-r),n.m[11]=1,n.m[12]=n.m[13]=n.m[15]=0,n.m[14]=i*r/(i-r)},e.GetFinalMatrix=function(t,i,r,n,o,s){var a=t.width,h=t.height,c=t.x,u=t.y,l=e.FromValues(a/2,0,0,0,0,-h/2,0,0,0,0,s-o,0,c+a/2,h/2+u,o,1);return i.multiply(r).multiply(n).multiply(l)},e.Transpose=function(t){var i=new e;return i.m[0]=t.m[0],i.m[1]=t.m[4],i.m[2]=t.m[8],i.m[3]=t.m[12],i.m[4]=t.m[1],i.m[5]=t.m[5],i.m[6]=t.m[9],i.m[7]=t.m[13],i.m[8]=t.m[2],i.m[9]=t.m[6],i.m[10]=t.m[10],i.m[11]=t.m[14],i.m[12]=t.m[3],i.m[13]=t.m[7],i.m[14]=t.m[11],i.m[15]=t.m[15],i},e.Reflection=function(t){var i=new e;return e.ReflectionToRef(t,i),i},e.ReflectionToRef=function(e,t){e.normalize();var i=e.normal.x,r=e.normal.y,n=e.normal.z,o=-2*i,s=-2*r,a=-2*n;t.m[0]=o*i+1,t.m[1]=s*i,t.m[2]=a*i,t.m[3]=0,t.m[4]=o*r,t.m[5]=s*r+1,t.m[6]=a*r,t.m[7]=0,t.m[8]=o*n,t.m[9]=s*n,t.m[10]=a*n+1,t.m[11]=0,t.m[12]=o*e.d,t.m[13]=s*e.d,t.m[14]=a*e.d,t.m[15]=1},e._tempQuaternion=new o,e._xAxis=n.Zero(),e._yAxis=n.Zero(),e._zAxis=n.Zero(),e}();e.Matrix=s;var a=function(){function t(e,t,i,r){this.normal=new n(e,t,i),this.d=r}return t.prototype.asArray=function(){return[this.normal.x,this.normal.y,this.normal.z,this.d]},t.prototype.clone=function(){return new t(this.normal.x,this.normal.y,this.normal.z,this.d)},t.prototype.normalize=function(){var e=Math.sqrt(this.normal.x*this.normal.x+this.normal.y*this.normal.y+this.normal.z*this.normal.z),t=0;0!=e&&(t=1/e),this.normal.x*=t,this.normal.y*=t,this.normal.z*=t,this.d*=t},t.prototype.transform=function(t){var i=e.Matrix.Transpose(t),r=this.normal.x,n=this.normal.y,o=this.normal.z,s=this.d,a=r*i.m[0]+n*i.m[1]+o*i.m[2]+s*i.m[3],h=r*i.m[4]+n*i.m[5]+o*i.m[6]+s*i.m[7],c=r*i.m[8]+n*i.m[9]+o*i.m[10]+s*i.m[11],u=r*i.m[12]+n*i.m[13]+o*i.m[14]+s*i.m[15];return new e.Plane(a,h,c,u)},t.prototype.dotCoordinate=function(e){return this.normal.x*e.x+this.normal.y*e.y+this.normal.z*e.z+this.d},t.prototype.copyFromPoints=function(e,t,i){var r,n=t.x-e.x,o=t.y-e.y,s=t.z-e.z,a=i.x-e.x,h=i.y-e.y,c=i.z-e.z,u=o*c-s*h,l=s*a-n*c,f=n*h-o*a,d=Math.sqrt(u*u+l*l+f*f);r=0!=d?1/d:0,this.normal.x=u*r,this.normal.y=l*r,this.normal.z=f*r,this.d=-(this.normal.x*e.x+this.normal.y*e.y+this.normal.z*e.z)},t.prototype.isFrontFacingTo=function(e,t){var i=n.Dot(this.normal,e);return t>=i},t.prototype.signedDistanceTo=function(e){return n.Dot(e,this.normal)+this.d},t.FromArray=function(t){return new e.Plane(t[0],t[1],t[2],t[3])},t.FromPoints=function(t,i,r){var n=new e.Plane(0,0,0,0);return n.copyFromPoints(t,i,r),n},t.FromPositionAndNormal=function(t,i){var r=new e.Plane(0,0,0,0);return i.normalize(),r.normal=i,r.d=-(i.x*t.x+i.y*t.y+i.z*t.z),r},t.SignedDistanceToPlaneFromPositionAndNormal=function(e,t,i){var r=-(t.x*e.x+t.y*e.y+t.z*e.z);return n.Dot(i,t)+r},t}();e.Plane=a;var h=function(){function e(e,t,i,r){this.x=e,this.y=t,this.width=i,this.height=r}return e.prototype.toGlobal=function(t){var i=t.getRenderWidth(),r=t.getRenderHeight();return new e(this.x*i,this.y*r,this.width*i,this.height*r)},e}();e.Viewport=h;var c=function(){function e(){}return e.GetPlanes=function(t){for(var i=[],r=0;6>r;r++)i.push(new a(0,0,0,0));return e.GetPlanesToRef(t,i),i},e.GetPlanesToRef=function(e,t){t[0].normal.x=e.m[3]+e.m[2],t[0].normal.y=e.m[7]+e.m[6],t[0].normal.z=e.m[10]+e.m[10],t[0].d=e.m[15]+e.m[14],t[0].normalize(),t[1].normal.x=e.m[3]-e.m[2],t[1].normal.y=e.m[7]-e.m[6],t[1].normal.z=e.m[11]-e.m[10],t[1].d=e.m[15]-e.m[14],t[1].normalize(),t[2].normal.x=e.m[3]+e.m[0],t[2].normal.y=e.m[7]+e.m[4],t[2].normal.z=e.m[11]+e.m[8],t[2].d=e.m[15]+e.m[12],t[2].normalize(),t[3].normal.x=e.m[3]-e.m[0],t[3].normal.y=e.m[7]-e.m[4],t[3].normal.z=e.m[11]-e.m[8],t[3].d=e.m[15]-e.m[12],t[3].normalize(),t[4].normal.x=e.m[3]-e.m[1],t[4].normal.y=e.m[7]-e.m[5],t[4].normal.z=e.m[11]-e.m[9],t[4].d=e.m[15]-e.m[13],t[4].normalize(),t[5].normal.x=e.m[3]+e.m[1],t[5].normal.y=e.m[7]+e.m[5],t[5].normal.z=e.m[11]+e.m[9],t[5].d=e.m[15]+e.m[13],t[5].normalize()},e}();e.Frustum=c;var u=function(){function t(e,t){this.origin=e,this.direction=t}return t.prototype.intersectsBoxMinMax=function(e,t){var i=0,r=Number.MAX_VALUE;if(Math.abs(this.direction.x)<1e-7){if(this.origin.x<e.x||this.origin.x>t.x)return!1}else{var n=1/this.direction.x,o=(e.x-this.origin.x)*n,s=(t.x-this.origin.x)*n;if(o>s){var a=o;o=s,s=a}if(i=Math.max(o,i),r=Math.min(s,r),i>r)return!1}if(Math.abs(this.direction.y)<1e-7){if(this.origin.y<e.y||this.origin.y>t.y)return!1}else if(n=1/this.direction.y,o=(e.y-this.origin.y)*n,s=(t.y-this.origin.y)*n,o>s&&(a=o,o=s,s=a),i=Math.max(o,i),r=Math.min(s,r),i>r)return!1;if(Math.abs(this.direction.z)<1e-7){if(this.origin.z<e.z||this.origin.z>t.z)return!1}else if(n=1/this.direction.z,o=(e.z-this.origin.z)*n,s=(t.z-this.origin.z)*n,o>s&&(a=o,o=s,s=a),i=Math.max(o,i),r=Math.min(s,r),i>r)return!1;return!0},t.prototype.intersectsBox=function(e){return this.intersectsBoxMinMax(e.minimum,e.maximum)},t.prototype.intersectsSphere=function(e){var t=e.center.x-this.origin.x,i=e.center.y-this.origin.y,r=e.center.z-this.origin.z,n=t*t+i*i+r*r,o=e.radius*e.radius;if(o>=n)return!0;var s=t*this.direction.x+i*this.direction.y+r*this.direction.z;if(0>s)return!1;var a=n-s*s;return o>=a},t.prototype.intersectsTriangle=function(t,i,r){this._edge1||(this._edge1=e.Vector3.Zero(),this._edge2=e.Vector3.Zero(),this._pvec=e.Vector3.Zero(),this._tvec=e.Vector3.Zero(),this._qvec=e.Vector3.Zero()),i.subtractToRef(t,this._edge1),r.subtractToRef(t,this._edge2),e.Vector3.CrossToRef(this.direction,this._edge2,this._pvec);var o=n.Dot(this._edge1,this._pvec);if(0===o)return null;var s=1/o;this.origin.subtractToRef(t,this._tvec);var a=n.Dot(this._tvec,this._pvec)*s;if(0>a||a>1)return null;n.CrossToRef(this._tvec,this._edge1,this._qvec);var h=n.Dot(this.direction,this._qvec)*s;return 0>h||a+h>1?null:new e.IntersectionInfo(a,h,n.Dot(this._edge2,this._qvec)*s)},t.CreateNew=function(i,r,n,o,s,a,h){var c=e.Vector3.Unproject(new e.Vector3(i,r,0),n,o,s,a,h),u=e.Vector3.Unproject(new e.Vector3(i,r,1),n,o,s,a,h),l=u.subtract(c);return l.normalize(),new t(c,l)},t.Transform=function(i,r){var n=e.Vector3.TransformCoordinates(i.origin,r),o=e.Vector3.TransformNormal(i.direction,r);return new t(n,o)},t}();e.Ray=u,function(e){e[e.LOCAL=0]="LOCAL",e[e.WORLD=1]="WORLD"}(e.Space||(e.Space={}));var l=(e.Space,function(){function t(){}return t.X=new e.Vector3(1,0,0),t.Y=new e.Vector3(0,1,0),t.Z=new e.Vector3(0,0,1),t}());e.Axis=l}(BABYLON||(BABYLON={}));var BABYLON=BABYLON||{};!function(){function e(e){var t=document.createElement("a");t.href=e;var i=e.substring(e.lastIndexOf("/")+1,e.length),r=e.substring(0,e.indexOf(i,0));return r}{var t=window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB;window.IDBTransaction||window.webkitIDBTransaction||window.msIDBTransaction,window.IDBKeyRange||window.webkitIDBKeyRange||window.msIDBKeyRange}BABYLON.Database=function(e){this.currentSceneUrl=BABYLON.Database.ReturnFullUrlLocation(e),this.db=null,this.enableSceneOffline=!1,this.enableTexturesOffline=!1,this.manifestVersionFound=0,this.mustUpdateRessources=!1,this.hasReachedQuota=!1,this.checkManifestFile()},BABYLON.Database.isUASupportingBlobStorage=!0,BABYLON.Database.ReturnFullUrlLocation=function(t){return-1===t.indexOf("http:/")?e(window.location.href)+t:t},BABYLON.Database.prototype.checkManifestFile=function(){function e(){BABYLON.Tools.Log("Valid manifest file not found. Scene & textures will be loaded directly from the web server."),t.enableSceneOffline=!1,t.enableTexturesOffline=!1}var t=this,i=this.currentSceneUrl+".manifest",r=new XMLHttpRequest;r.open("GET",i,!1),r.addEventListener("load",function(){if(200===r.status)try{var i=JSON.parse(r.response);t.enableSceneOffline=i.enableSceneOffline,t.enableTexturesOffline=i.enableTexturesOffline,i.version&&!isNaN(parseInt(i.version))&&(t.manifestVersionFound=i.version)}catch(n){e()}else e()},!1),r.addEventListener("error",function(){e()},!1);try{r.send()}catch(n){BABYLON.Tools.Error("Error on XHR send request.")}},BABYLON.Database.prototype.openAsync=function(e,i){function r(){n.isSupported=!1,i&&i()}var n=this;if(t&&(this.enableSceneOffline||this.enableTexturesOffline))if(this.db)e&&e();else{this.hasReachedQuota=!1,this.isSupported=!0;var o=t.open("babylonjs",1);o.onerror=function(){r()},o.onblocked=function(){BABYLON.Tools.Error("IDB request blocked. Please reload the page."),r()},o.onsuccess=function(){n.db=o.result,e()},o.onupgradeneeded=function(e){n.db=e.target.result;try{{n.db.createObjectStore("scenes",{keyPath:"sceneUrl"}),n.db.createObjectStore("versions",{keyPath:"sceneUrl"}),n.db.createObjectStore("textures",{keyPath:"textureUrl"})}}catch(t){BABYLON.Tools.Error("Error while creating object stores. Exception: "+t.message),r()}}}else this.isSupported=!1,i&&i()},BABYLON.Database.prototype.loadImageFromDB=function(e,t){var i=this,r=BABYLON.Database.ReturnFullUrlLocation(e),n=function(){i.hasReachedQuota||null===i.db?t.src=e:i._saveImageIntoDBAsync(r,t)};this.mustUpdateRessources?n():this._loadImageFromDBAsync(r,t,n)},BABYLON.Database.prototype._loadImageFromDBAsync=function(e,t,i){if(this.isSupported&&null!==this.db){var r,n=this.db.transaction(["textures"]);n.onabort=function(){t.src=e},n.oncomplete=function(){var e;if(r){var n=window.URL||window.webkitURL;e=n.createObjectURL(r.data,{oneTimeOnly:!0}),t.src=e}else i()};var o=n.objectStore("textures").get(e);o.onsuccess=function(e){r=e.target.result},o.onerror=function(){BABYLON.Tools.Error("Error loading texture "+e+" from DB."),t.src=e}}else BABYLON.Tools.Error("Error: IndexedDB not supported by your browser or BabylonJS Database is not open."),t.src=e},BABYLON.Database.prototype._saveImageIntoDBAsync=function(e,t){if(this.isSupported){var i=function(){var e;if(r){var i=window.URL||window.webkitURL;try{e=i.createObjectURL(r,{oneTimeOnly:!0})}catch(n){e=i.createObjectURL(r)}}t.src=e};if(BABYLON.Database.isUASupportingBlobStorage){var r,n=this,o=new XMLHttpRequest;o.open("GET",e,!0),o.responseType="blob",o.addEventListener("load",function(){if(200===o.status){r=o.response;var s=n.db.transaction(["textures"],"readwrite");
s.onabort=function(e){try{"QuotaExceededError"===e.srcElement.error.name&&(n.hasReachedQuota=!0)}catch(t){}i()},s.oncomplete=function(){i()};var a={};a.textureUrl=e,a.data=r;try{var h=s.objectStore("textures").put(a);h.onsuccess=function(){},h.onerror=function(){i()}}catch(c){25===c.code&&(BABYLON.Database.isUASupportingBlobStorage=!1),t.src=e}}else t.src=e},!1),o.addEventListener("error",function(){BABYLON.Tools.Error("Error in XHR request in BABYLON.Database."),t.src=e},!1),o.send()}else t.src=e}else BABYLON.Tools.Error("Error: IndexedDB not supported by your browser or BabylonJS Database is not open."),t.src=e},BABYLON.Database.prototype._checkVersionFromDB=function(e,t){var i=this,r=function(){i._saveVersionIntoDBAsync(e,t)};this._loadVersionFromDBAsync(e,t,r)},BABYLON.Database.prototype._loadVersionFromDBAsync=function(e,t,i){if(this.isSupported){var r,n=this;try{var o=this.db.transaction(["versions"]);o.oncomplete=function(){r?n.manifestVersionFound>r.data?(n.mustUpdateRessources=!0,i()):t(r.data):(n.mustUpdateRessources=!0,i())},o.onabort=function(){t(-1)};var s=o.objectStore("versions").get(e);s.onsuccess=function(e){r=e.target.result},s.onerror=function(){BABYLON.Tools.Error("Error loading version for scene "+e+" from DB."),t(-1)}}catch(a){BABYLON.Tools.Error("Error while accessing 'versions' object store (READ OP). Exception: "+a.message),t(-1)}}else BABYLON.Tools.Error("Error: IndexedDB not supported by your browser or BabylonJS Database is not open."),t(-1)},BABYLON.Database.prototype._saveVersionIntoDBAsync=function(e,t){if(this.isSupported&&!this.hasReachedQuota){var i=this;try{var r=this.db.transaction(["versions"],"readwrite");r.onabort=function(e){try{"QuotaExceededError"===e.srcElement.error.name&&(i.hasReachedQuota=!0)}catch(r){}t(-1)},r.oncomplete=function(){t(i.manifestVersionFound)};var n={};n.sceneUrl=e,n.data=this.manifestVersionFound;var o=r.objectStore("versions").put(n);o.onsuccess=function(){},o.onerror=function(){BABYLON.Tools.Error("Error in DB add version request in BABYLON.Database.")}}catch(s){BABYLON.Tools.Error("Error while accessing 'versions' object store (WRITE OP). Exception: "+s.message),t(-1)}}else t(-1)},BABYLON.Database.prototype.loadSceneFromDB=function(e,t,i,r){var n=this,o=BABYLON.Database.ReturnFullUrlLocation(e),s=function(){n._saveSceneIntoDBAsync(o,t,i)};this._checkVersionFromDB(o,function(e){-1!==e?n.mustUpdateRessources?n._saveSceneIntoDBAsync(o,t,i):n._loadSceneFromDBAsync(o,t,s):r()})},BABYLON.Database.prototype._loadSceneFromDBAsync=function(e,t,i){if(this.isSupported){var r,n=this.db.transaction(["scenes"]);n.oncomplete=function(){r?t(r.data):i()},n.onabort=function(){i()};var o=n.objectStore("scenes").get(e);o.onsuccess=function(e){r=e.target.result},o.onerror=function(){BABYLON.Tools.Error("Error loading scene "+e+" from DB."),i()}}else BABYLON.Tools.Error("Error: IndexedDB not supported by your browser or BabylonJS Database is not open."),t()},BABYLON.Database.prototype._saveSceneIntoDBAsync=function(e,t,i){if(this.isSupported){var r,n=new XMLHttpRequest,o=this;n.open("GET",e,!0),n.onprogress=i,n.addEventListener("load",function(){if(200===n.status)if(r=n.responseText,o.hasReachedQuota)t(r);else{var i=o.db.transaction(["scenes"],"readwrite");i.onabort=function(e){try{"QuotaExceededError"===e.srcElement.error.name&&(o.hasReachedQuota=!0)}catch(i){}t(r)},i.oncomplete=function(){t(r)};var s={};s.sceneUrl=e,s.data=r,s.version=o.manifestVersionFound;try{var a=i.objectStore("scenes").put(s);a.onsuccess=function(){},a.onerror=function(){BABYLON.Tools.Error("Error in DB add scene request in BABYLON.Database.")}}catch(h){t(r)}}else t()},!1),n.addEventListener("error",function(){BABYLON.Tools.Error("error on XHR request."),t()},!1),n.send()}else BABYLON.Tools.Error("Error: IndexedDB not supported by your browser or BabylonJS Database is not open."),t()}}();var BABYLON;!function(e){!function(t){var i=function(){function t(){}return t.GetTGAHeader=function(e){var t=0,i={id_length:e[t++],colormap_type:e[t++],image_type:e[t++],colormap_index:e[t++]|e[t++]<<8,colormap_length:e[t++]|e[t++]<<8,colormap_size:e[t++],origin:[e[t++]|e[t++]<<8,e[t++]|e[t++]<<8],width:e[t++]|e[t++]<<8,height:e[t++]|e[t++]<<8,pixel_size:e[t++],flags:e[t++]};return i},t.UploadContent=function(i,r){if(r.length<19)return void e.Tools.Error("Unable to load TGA file - Not enough data to contain header");var n=18,o=t.GetTGAHeader(r);if(o.id_length+n>r.length)return void e.Tools.Error("Unable to load TGA file - Not enough data");n+=o.id_length;var s=!1,a=!1,h=!1,c=!1;switch(o.image_type){case t._TYPE_RLE_INDEXED:s=!0;case t._TYPE_INDEXED:a=!0;break;case t._TYPE_RLE_RGB:s=!0;case t._TYPE_RGB:h=!0;break;case t._TYPE_RLE_GREY:s=!0;case t._TYPE_GREY:c=!0}var u,l,f=(15&o.flags,o.pixel_size>>3),d=o.width*o.height*f;if(a&&(l=r.subarray(n,n+=o.colormap_length*(o.colormap_size>>3))),s){u=new Uint8Array(d);for(var p,m,_,g=0,v=new Uint8Array(f);d>n;)if(p=r[n++],m=(127&p)+1,128&p){for(_=0;f>_;++_)v[_]=r[n++];for(_=0;m>_;++_)u.set(v,g+_*f);g+=f*m}else{for(m*=f,_=0;m>_;++_)u[g+_]=r[n++];g+=m}}else u=r.subarray(n,n+=a?o.width*o.height:d);var y,x,A,B,T,b;switch((o.flags&t._ORIGIN_MASK)>>t._ORIGIN_SHIFT){default:case t._ORIGIN_UL:y=0,A=1,b=o.width,x=0,B=1,T=o.height;break;case t._ORIGIN_BL:y=0,A=1,b=o.width,x=o.height-1,B=-1,T=-1;break;case t._ORIGIN_UR:y=o.width-1,A=-1,b=-1,x=0,B=1,T=o.height;break;case t._ORIGIN_BR:y=o.width-1,A=-1,b=-1,x=o.height-1,B=-1,T=-1}var M="_getImageData"+(c?"Grey":"")+o.pixel_size+"bits",L=t[M](o,l,u,x,B,T,y,A,b);i.texImage2D(i.TEXTURE_2D,0,i.RGBA,o.width,o.height,0,i.RGBA,i.UNSIGNED_BYTE,L)},t._getImageData8bits=function(e,t,i,r,n,o,s,a,h){var c,u,l,f=i,d=t,p=e.width,m=e.height,_=0,g=new Uint8Array(p*m*4);for(l=r;l!==o;l+=n)for(u=s;u!==h;u+=a,_++)c=f[_],g[4*(u+p*l)+3]=255,g[4*(u+p*l)+2]=d[3*c+0],g[4*(u+p*l)+1]=d[3*c+1],g[4*(u+p*l)+0]=d[3*c+2];return g},t._getImageData16bits=function(e,t,i,r,n,o,s,a,h){var c,u,l,f=i,d=e.width,p=e.height,m=0,_=new Uint8Array(d*p*4);for(l=r;l!==o;l+=n)for(u=s;u!==h;u+=a,m+=2)c=f[m+0]+(f[m+1]<<8),_[4*(u+d*l)+0]=(31744&c)>>7,_[4*(u+d*l)+1]=(992&c)>>2,_[4*(u+d*l)+2]=(31&c)>>3,_[4*(u+d*l)+3]=32768&c?0:255;return _},t._getImageData24bits=function(e,t,i,r,n,o,s,a,h){var c,u,l=i,f=e.width,d=e.height,p=0,m=new Uint8Array(f*d*4);for(u=r;u!==o;u+=n)for(c=s;c!==h;c+=a,p+=3)m[4*(c+f*u)+3]=255,m[4*(c+f*u)+2]=l[p+0],m[4*(c+f*u)+1]=l[p+1],m[4*(c+f*u)+0]=l[p+2];return m},t._getImageData32bits=function(e,t,i,r,n,o,s,a,h){var c,u,l=i,f=e.width,d=e.height,p=0,m=new Uint8Array(f*d*4);for(u=r;u!==o;u+=n)for(c=s;c!==h;c+=a,p+=4)m[4*(c+f*u)+2]=l[p+0],m[4*(c+f*u)+1]=l[p+1],m[4*(c+f*u)+0]=l[p+2],m[4*(c+f*u)+3]=l[p+3];return m},t._getImageDataGrey8bits=function(e,t,i,r,n,o,s,a,h){var c,u,l,f=i,d=e.width,p=e.height,m=0,_=new Uint8Array(d*p*4);for(l=r;l!==o;l+=n)for(u=s;u!==h;u+=a,m++)c=f[m],_[4*(u+d*l)+0]=c,_[4*(u+d*l)+1]=c,_[4*(u+d*l)+2]=c,_[4*(u+d*l)+3]=255;return _},t._getImageDataGrey16bits=function(e,t,i,r,n,o,s,a,h){var c,u,l=i,f=e.width,d=e.height,p=0,m=new Uint8Array(f*d*4);for(u=r;u!==o;u+=n)for(c=s;c!==h;c+=a,p+=2)m[4*(c+f*u)+0]=l[p+0],m[4*(c+f*u)+1]=l[p+0],m[4*(c+f*u)+2]=l[p+0],m[4*(c+f*u)+3]=l[p+1];return m},t._TYPE_NO_DATA=0,t._TYPE_INDEXED=1,t._TYPE_RGB=2,t._TYPE_GREY=3,t._TYPE_RLE_INDEXED=9,t._TYPE_RLE_RGB=10,t._TYPE_RLE_GREY=11,t._ORIGIN_MASK=48,t._ORIGIN_SHIFT=4,t._ORIGIN_BL=0,t._ORIGIN_BR=1,t._ORIGIN_UL=2,t._ORIGIN_UR=3,t}();t.TGATools=i}(e.Internals||(e.Internals={}));e.Internals}(BABYLON||(BABYLON={}));var BABYLON;!function(e){!function(t){function i(e){return e.charCodeAt(0)+(e.charCodeAt(1)<<8)+(e.charCodeAt(2)<<16)+(e.charCodeAt(3)<<24)}function r(e){return String.fromCharCode(255&e,e>>8&255,e>>16&255,e>>24&255)}var n=542327876,o=131072,s=512,a=4,h=64,c=131072,u=i("DXT1"),l=i("DXT3"),f=i("DXT5"),d=31,p=0,m=1,_=2,g=3,v=4,y=7,x=20,A=21,B=22,T=28,b=function(){function t(){}return t.GetDDSInfo=function(e){var t=new Int32Array(e,0,d),i=1;return t[_]&o&&(i=Math.max(1,t[y])),{width:t[v],height:t[g],mipmapCount:i,isFourCC:(t[x]&a)===a,isRGB:(t[x]&h)===h,isLuminance:(t[x]&c)===c,isCube:(t[T]&s)===s}},t.GetRGBAArrayBuffer=function(e,t,i,r,n){for(var o=new Uint8Array(r),s=new Uint8Array(n),a=0,h=t-1;h>=0;h--)for(var c=0;e>c;c++){var u=i+4*(c+h*e);o[a+2]=s[u],o[a+1]=s[u+1],o[a]=s[u+2],o[a+3]=s[u+3],a+=4}return o},t.GetRGBArrayBuffer=function(e,t,i,r,n){for(var o=new Uint8Array(r),s=new Uint8Array(n),a=0,h=t-1;h>=0;h--)for(var c=0;e>c;c++){var u=i+3*(c+h*e);o[a+2]=s[u],o[a+1]=s[u+1],o[a]=s[u+2],a+=3}return o},t.GetLuminanceArrayBuffer=function(e,t,i,r,n){for(var o=new Uint8Array(r),s=new Uint8Array(n),a=0,h=t-1;h>=0;h--)for(var c=0;e>c;c++){var u=i+(c+h*e);o[a]=s[u],a++}return o},t.UploadDDSLevels=function(i,s,a,h,c,x){var T,b,M,L,E,O,P,S,w,C,I=new Int32Array(a,0,d);if(I[p]!=n)return void e.Tools.Error("Invalid magic number in DDS header");if(!h.isFourCC&&!h.isRGB&&!h.isLuminance)return void e.Tools.Error("Unsupported format, must contain a FourCC, RGB or LUMINANCE code");if(h.isFourCC)switch(T=I[A]){case u:b=8,M=s.COMPRESSED_RGBA_S3TC_DXT1_EXT;break;case l:b=16,M=s.COMPRESSED_RGBA_S3TC_DXT3_EXT;break;case f:b=16,M=s.COMPRESSED_RGBA_S3TC_DXT5_EXT;break;default:return void console.error("Unsupported FourCC code:",r(T))}w=1,I[_]&o&&c!==!1&&(w=Math.max(1,I[y]));for(var D=I[B],R=0;x>R;R++){var N=1==x?i.TEXTURE_2D:i.TEXTURE_CUBE_MAP_POSITIVE_X+R;for(L=I[v],E=I[g],P=I[m]+4,C=0;w>C&&(h.isRGB?24==D?(O=L*E*3,S=t.GetRGBArrayBuffer(L,E,P,O,a),i.texImage2D(N,C,i.RGB,L,E,0,i.RGB,i.UNSIGNED_BYTE,S)):(O=L*E*4,S=t.GetRGBAArrayBuffer(L,E,P,O,a),i.texImage2D(N,C,i.RGBA,L,E,0,i.RGBA,i.UNSIGNED_BYTE,S)):h.isLuminance?(O=L*E,S=t.GetLuminanceArrayBuffer(L,E,P,O,a),i.texImage2D(N,C,i.LUMINANCE,L,E,0,i.LUMINANCE,i.UNSIGNED_BYTE,S)):(O=Math.max(4,L)/4*Math.max(4,E)/4*b,S=new Uint8Array(a,P,O),i.compressedTexImage2D(N,C,M,L,E,0,S)),P+=O,L*=.5,E*=.5,!(2>=L||2>=E));++C);}},t}();t.DDSTools=b}(e.Internals||(e.Internals={}));e.Internals}(BABYLON||(BABYLON={}));var BABYLON;!function(e){var t=function(){function e(t){this.length=0,this._duplicateId=0,this.data=new Array(t),this._id=e._GlobalId++}return e.prototype.push=function(e){this.data[this.length++]=e,this.length>this.data.length&&(this.data.length*=2),e.__smartArrayFlags||(e.__smartArrayFlags={}),e.__smartArrayFlags[this._id]=this._duplicateId},e.prototype.pushNoDuplicate=function(e){e.__smartArrayFlags&&e.__smartArrayFlags[this._id]===this._duplicateId||this.push(e)},e.prototype.sort=function(e){this.data.sort(e)},e.prototype.reset=function(){this.length=0,this._duplicateId++},e.prototype.concat=function(e){if(0!==e.length){this.length+e.length>this.data.length&&(this.data.length=2*(this.length+e.length));for(var t=0;t<e.length;t++)this.data[this.length++]=(e.data||e)[t]}},e.prototype.concatWithNoDuplicate=function(e){if(0!==e.length){this.length+e.length>this.data.length&&(this.data.length=2*(this.length+e.length));for(var t=0;t<e.length;t++){var i=(e.data||e)[t];this.pushNoDuplicate(i)}}},e.prototype.indexOf=function(e){var t=this.data.indexOf(e);return t>=this.length?-1:t},e._GlobalId=0,e}();e.SmartArray=t}(BABYLON||(BABYLON={}));var BABYLON;!function(e){var t,i=60,r=[],n=60,o=0,s=function(t,i){return t?t instanceof e.Mesh?null:t instanceof e.SubMesh?t.clone(i):t.clone?t.clone():null:null},a=function(){function a(){}return a.GetFilename=function(e){var t=e.lastIndexOf("/");return 0>t?e:e.substring(t+1)},a.GetDOMTextContent=function(e){for(var t="",i=e.firstChild;i;)3==i.nodeType&&(t+=i.textContent),i=i.nextSibling;return t},a.ToDegrees=function(e){return 180*e/Math.PI},a.ToRadians=function(e){return e*Math.PI/180},a.ExtractMinAndMaxIndexed=function(t,i,r,n){for(var o=new e.Vector3(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),s=new e.Vector3(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),a=r;r+n>a;a++){var h=new e.Vector3(t[3*i[a]],t[3*i[a]+1],t[3*i[a]+2]);o=e.Vector3.Minimize(h,o),s=e.Vector3.Maximize(h,s)}return{minimum:o,maximum:s}},a.ExtractMinAndMax=function(t,i,r){for(var n=new e.Vector3(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),o=new e.Vector3(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),s=i;i+r>s;s++){var a=new e.Vector3(t[3*s],t[3*s+1],t[3*s+2]);n=e.Vector3.Minimize(a,n),o=e.Vector3.Maximize(a,o)}return{minimum:n,maximum:o}},a.MakeArray=function(e,t){return t===!0||void 0!==e&&null!=e?Array.isArray(e)?e:[e]:void 0},a.GetPointerPrefix=function(){var e="pointer";return navigator.pointerEnabled||(e="mouse"),e},a.QueueNewFrame=function(e){window.requestAnimationFrame?window.requestAnimationFrame(e):window.msRequestAnimationFrame?window.msRequestAnimationFrame(e):window.webkitRequestAnimationFrame?window.webkitRequestAnimationFrame(e):window.mozRequestAnimationFrame?window.mozRequestAnimationFrame(e):window.oRequestAnimationFrame?window.oRequestAnimationFrame(e):window.setTimeout(e,16)},a.RequestFullscreen=function(e){e.requestFullscreen?e.requestFullscreen():e.msRequestFullscreen?e.msRequestFullscreen():e.webkitRequestFullscreen?e.webkitRequestFullscreen():e.mozRequestFullScreen&&e.mozRequestFullScreen()},a.ExitFullscreen=function(){document.exitFullscreen?document.exitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitCancelFullScreen?document.webkitCancelFullScreen():document.msCancelFullScreen&&document.msCancelFullScreen()},a.CleanUrl=function(e){return e=e.replace(/#/gm,"%23")},a.LoadImage=function(t,i,r,n){t=a.CleanUrl(t);var o=new Image;o.crossOrigin="anonymous",o.onload=function(){i(o)},o.onerror=function(e){r(o,e)};var s=function(){o.src=t},h=function(){n.loadImageFromDB(t,o)};if(n&&n.enableTexturesOffline&&e.Database.isUASupportingBlobStorage)n.openAsync(h,s);else if(-1===t.indexOf("file:"))s();else try{var c,u=t.substring(5);try{c=URL.createObjectURL(e.FilesInput.FilesTextures[u],{oneTimeOnly:!0})}catch(l){c=URL.createObjectURL(e.FilesInput.FilesTextures[u])}o.src=c}catch(f){a.Log("Error while trying to load texture: "+u),o.src=null}return o},a.LoadFile=function(t,i,r,n,o){t=a.CleanUrl(t);var s=function(){var e=new XMLHttpRequest,n=a.BaseUrl+t;e.open("GET",n,!0),o&&(e.responseType="arraybuffer"),e.onprogress=r,e.onreadystatechange=function(){if(4==e.readyState){if(200!=e.status)throw new Error("Error status: "+e.status+" - Unable to load "+n);i(o?e.response:e.responseText)}},e.send(null)},h=function(){n.loadSceneFromDB(t,i,r,s)};if(-1!==t.indexOf("file:")){var c=t.substring(5);e.Tools.ReadFile(e.FilesInput.FilesToLoad[c],i,r,!0)}else n&&-1!==t.indexOf(".babylon")&&n.enableSceneOffline?n.openAsync(h,s):s()},a.ReadFile=function(e,t,i,r){var n=new FileReader;n.onload=function(e){t(e.target.result)},n.onprogress=i,r?n.readAsArrayBuffer(e):n.readAsText(e)},a.CheckExtends=function(e,t,i){e.x<t.x&&(t.x=e.x),e.y<t.y&&(t.y=e.y),e.z<t.z&&(t.z=e.z),e.x>i.x&&(i.x=e.x),e.y>i.y&&(i.y=e.y),e.z>i.z&&(i.z=e.z)},a.WithinEpsilon=function(e,t){var i=e-t;return i>=-1.401298e-45&&1.401298e-45>=i},a.DeepCopy=function(e,t,i,r){for(var n in e)if(("_"!==n[0]||r&&-1!==r.indexOf(n))&&(!i||-1===i.indexOf(n))){var o=e[n],a=typeof o;if("function"!=a)if("object"==a)if(o instanceof Array){if(t[n]=[],o.length>0)if("object"==typeof o[0])for(var h=0;h<o.length;h++){var c=s(o[h],t);-1===t[n].indexOf(c)&&t[n].push(c)}else t[n]=o.slice(0)}else t[n]=s(o,t);else t[n]=o}},a.IsEmpty=function(e){for(var t in e)return!1;return!0},a.RegisterTopRootEvents=function(e){for(var t=0;t<e.length;t++){var i=e[t];window.addEventListener(i.name,i.handler,!1);try{window.parent&&window.parent.addEventListener(i.name,i.handler,!1)}catch(r){}}},a.UnregisterTopRootEvents=function(e){for(var t=0;t<e.length;t++){var i=e[t];window.removeEventListener(i.name,i.handler);try{window.parent&&window.parent.removeEventListener(i.name,i.handler)}catch(r){}}},a.GetFps=function(){return n},a.GetDeltaTime=function(){return o},a._MeasureFps=function(){r.push((new Date).getTime());var e=r.length;if(e>=2&&(o=r[e-1]-r[e-2]),e>=i){e>i&&(r.splice(0,1),e=r.length);for(var t=0,s=0;e-1>s;s++)t+=r[s+1]-r[s];n=1e3/(t/(e-1))}},a.CreateScreenshot=function(i,r,n){var o,s,h=r.getScene(),c=null;if(h.activeCamera!==r&&(c=h.activeCamera,h.activeCamera=r),n.precision)o=Math.round(i.getRenderWidth()*n.precision),s=Math.round(o/i.getAspectRatio(r)),n={width:o,height:s};else if(n.width&&n.height)o=n.width,s=n.height;else if(n.width&&!n.height)o=n.width,s=Math.round(o/i.getAspectRatio(r)),n={width:o,height:s};else if(n.height&&!n.width)s=n.height,o=Math.round(s*i.getAspectRatio(r)),n={width:o,height:s};else{if(isNaN(n))return void a.Error("Invalid 'size' parameter !");s=n,o=n}var u=new e.RenderTargetTexture("screenShot",n,i.scenes[0],!1,!1);u.renderList=i.scenes[0].meshes,u.onAfterRender=function(){for(var e=4*o,r=s/2,n=i.readPixels(0,0,o,s),a=0;r>a;a++)for(var h=0;e>h;h++){var c=h+a*e,u=s-a-1,l=h+u*e,f=n[c];n[c]=n[l],n[l]=f}t||(t=document.createElement("canvas")),t.width=o,t.height=s;var d=t.getContext("2d"),p=d.createImageData(o,s);p.data.set(n),d.putImageData(p,0,0);var m=t.toDataURL();if("download"in document.createElement("a")){var _=window.document.createElement("a");_.href=m;var g=new Date,v=g.getFullYear()+"/"+g.getMonth()+"/"+g.getDate()+"-"+g.getHours()+":"+g.getMinutes();_.setAttribute("download","screenshot-"+v+".png"),window.document.body.appendChild(_),_.addEventListener("click",function(){_.parentElement.removeChild(_)}),_.click()}else{var y=window.open(""),x=y.document.createElement("img");x.src=m,y.document.body.appendChild(x)}},u.render(!0),u.dispose(),c&&(h.activeCamera=c)},Object.defineProperty(a,"NoneLogLevel",{get:function(){return a._NoneLogLevel},enumerable:!0,configurable:!0}),Object.defineProperty(a,"MessageLogLevel",{get:function(){return a._MessageLogLevel},enumerable:!0,configurable:!0}),Object.defineProperty(a,"WarningLogLevel",{get:function(){return a._WarningLogLevel},enumerable:!0,configurable:!0}),Object.defineProperty(a,"ErrorLogLevel",{get:function(){return a._ErrorLogLevel},enumerable:!0,configurable:!0}),Object.defineProperty(a,"AllLogLevel",{get:function(){return a._MessageLogLevel|a._WarningLogLevel|a._ErrorLogLevel},enumerable:!0,configurable:!0}),a._FormatMessage=function(e){var t=function(e){return 10>e?"0"+e:""+e},i=new Date;return"BJS - ["+t(i.getHours())+":"+t(i.getMinutes())+":"+t(i.getSeconds())+"]: "+e},a._LogDisabled=function(){},a._LogEnabled=function(e){console.log(a._FormatMessage(e))},a._WarnDisabled=function(){},a._WarnEnabled=function(e){console.warn(a._FormatMessage(e))},a._ErrorDisabled=function(){},a._ErrorEnabled=function(e){console.error(a._FormatMessage(e))},Object.defineProperty(a,"LogLevels",{set:function(e){a.Log=(e&a.MessageLogLevel)===a.MessageLogLevel?a._LogEnabled:a._LogDisabled,a.Warn=(e&a.WarningLogLevel)===a.WarningLogLevel?a._WarnEnabled:a._WarnDisabled,a.Error=(e&a.ErrorLogLevel)===a.ErrorLogLevel?a._ErrorEnabled:a._ErrorDisabled},enumerable:!0,configurable:!0}),a.BaseUrl="",a._NoneLogLevel=0,a._MessageLogLevel=1,a._WarningLogLevel=2,a._ErrorLogLevel=4,a.Log=a._LogEnabled,a.Warn=a._WarnEnabled,a.Error=a._ErrorEnabled,a}();e.Tools=a}(BABYLON||(BABYLON={}));var BABYLON;!function(e){var t=function(e,t,i,r){var n=e.createShader("vertex"===i?e.VERTEX_SHADER:e.FRAGMENT_SHADER);if(e.shaderSource(n,(r?r+"\n":"")+t),e.compileShader(n),!e.getShaderParameter(n,e.COMPILE_STATUS))throw new Error(e.getShaderInfoLog(n));return n},i=function(t,i,r){var n=r.NEAREST,o=r.NEAREST;return t===e.Texture.BILINEAR_SAMPLINGMODE?(n=r.LINEAR,o=i?r.LINEAR_MIPMAP_NEAREST:r.LINEAR):t===e.Texture.TRILINEAR_SAMPLINGMODE?(n=r.LINEAR,o=i?r.LINEAR_MIPMAP_LINEAR:r.LINEAR):t===e.Texture.NEAREST_SAMPLINGMODE&&(n=r.NEAREST,o=i?r.NEAREST_MIPMAP_LINEAR:r.NEAREST),{min:o,mag:n}},r=function(e,t){var i=1;do i*=2;while(e>i);return i>t&&(i=t),i},n=function(t,n,o,s,a,h,c,u,l,f){"undefined"==typeof f&&(f=e.Texture.TRILINEAR_SAMPLINGMODE);var d=o.getEngine(),p=r(s,d.getCaps().maxTextureSize),m=r(a,d.getCaps().maxTextureSize);n.bindTexture(n.TEXTURE_2D,t),n.pixelStorei(n.UNPACK_FLIP_Y_WEBGL,void 0===h?1:h?1:0),l(p,m);var _=i(f,!c,n);n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,_.mag),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,_.min),c||u||n.generateMipmap(n.TEXTURE_2D),n.bindTexture(n.TEXTURE_2D,null),d._activeTexturesCache=[],t._baseWidth=s,t._baseHeight=a,t._width=p,t._height=m,t.isReady=!0,o._removePendingData(t)},o=function(t,i,r,n,s,a){var h,c=function(){r.push(h),n._removePendingData(h),i!=a.length-1?o(t,i+1,r,n,s,a):s(r)},u=function(){n._removePendingData(h)};h=e.Tools.LoadImage(t+a[i],c,u,n.database),n._addPendingData(h)},s=function(){function e(){}return e}();e.EngineCapabilities=s;var a=function(){function a(e,t,i){var r=this;this.isFullscreen=!1,this.isPointerLock=!1,this.forceWireframe=!1,this.cullBackFaces=!0,this.renderEvenInBackground=!0,this.scenes=new Array,this._windowIsBackground=!1,this._runningLoop=!1,this._loadedTexturesCache=new Array,this._activeTexturesCache=new Array,this._compiledEffects={},this._depthMask=!1,this._renderingCanvas=e,i=i||{},i.antialias=t;try{this._gl=e.getContext("webgl",i)||e.getContext("experimental-webgl",i)}catch(n){throw new Error("WebGL not supported")}if(!this._gl)throw new Error("WebGL not supported");this._onBlur=function(){r._windowIsBackground=!0},this._onFocus=function(){r._windowIsBackground=!1},window.addEventListener("blur",this._onBlur),window.addEventListener("focus",this._onFocus),this._workingCanvas=document.createElement("canvas"),this._workingContext=this._workingCanvas.getContext("2d"),this._hardwareScalingLevel=1/(window.devicePixelRatio||1),this.resize(),this._caps=new s,this._caps.maxTexturesImageUnits=this._gl.getParameter(this._gl.MAX_TEXTURE_IMAGE_UNITS),this._caps.maxTextureSize=this._gl.getParameter(this._gl.MAX_TEXTURE_SIZE),this._caps.maxCubemapTextureSize=this._gl.getParameter(this._gl.MAX_CUBE_MAP_TEXTURE_SIZE),this._caps.maxRenderTextureSize=this._gl.getParameter(this._gl.MAX_RENDERBUFFER_SIZE),this._caps.standardDerivatives=null!==this._gl.getExtension("OES_standard_derivatives"),this._caps.s3tc=this._gl.getExtension("WEBGL_compressed_texture_s3tc"),this._caps.textureFloat=null!==this._gl.getExtension("OES_texture_float"),this._caps.textureAnisotropicFilterExtension=this._gl.getExtension("EXT_texture_filter_anisotropic")||this._gl.getExtension("WEBKIT_EXT_texture_filter_anisotropic")||this._gl.getExtension("MOZ_EXT_texture_filter_anisotropic"),this._caps.maxAnisotropy=this._caps.textureAnisotropicFilterExtension?this._gl.getParameter(this._caps.textureAnisotropicFilterExtension.MAX_TEXTURE_MAX_ANISOTROPY_EXT):0,this._caps.instancedArrays=this._gl.getExtension("ANGLE_instanced_arrays"),this.setDepthBuffer(!0),this.setDepthFunctionToLessOrEqual(),this.setDepthWrite(!0),this._onFullscreenChange=function(){void 0!==document.fullscreen?r.isFullscreen=document.fullscreen:void 0!==document.mozFullScreen?r.isFullscreen=document.mozFullScreen:void 0!==document.webkitIsFullScreen?r.isFullscreen=document.webkitIsFullScreen:void 0!==document.msIsFullScreen&&(r.isFullscreen=document.msIsFullScreen),r.isFullscreen&&r._pointerLockRequested&&(e.requestPointerLock=e.requestPointerLock||e.msRequestPointerLock||e.mozRequestPointerLock||e.webkitRequestPointerLock,e.requestPointerLock&&e.requestPointerLock())},document.addEventListener("fullscreenchange",this._onFullscreenChange,!1),document.addEventListener("mozfullscreenchange",this._onFullscreenChange,!1),document.addEventListener("webkitfullscreenchange",this._onFullscreenChange,!1),document.addEventListener("msfullscreenchange",this._onFullscreenChange,!1),this._onPointerLockChange=function(){r.isPointerLock=document.mozPointerLockElement===e||document.webkitPointerLockElement===e||document.msPointerLockElement===e||document.pointerLockElement===e},document.addEventListener("pointerlockchange",this._onPointerLockChange,!1),document.addEventListener("mspointerlockchange",this._onPointerLockChange,!1),document.addEventListener("mozpointerlockchange",this._onPointerLockChange,!1),document.addEventListener("webkitpointerlockchange",this._onPointerLockChange,!1)}return Object.defineProperty(a,"ALPHA_DISABLE",{get:function(){return a._ALPHA_DISABLE},enumerable:!0,configurable:!0}),Object.defineProperty(a,"ALPHA_ADD",{get:function(){return a._ALPHA_ADD},enumerable:!0,configurable:!0}),Object.defineProperty(a,"ALPHA_COMBINE",{get:function(){return a._ALPHA_COMBINE},enumerable:!0,configurable:!0}),Object.defineProperty(a,"DELAYLOADSTATE_NONE",{get:function(){return a._DELAYLOADSTATE_NONE},enumerable:!0,configurable:!0}),Object.defineProperty(a,"DELAYLOADSTATE_LOADED",{get:function(){return a._DELAYLOADSTATE_LOADED},enumerable:!0,configurable:!0}),Object.defineProperty(a,"DELAYLOADSTATE_LOADING",{get:function(){return a._DELAYLOADSTATE_LOADING},enumerable:!0,configurable:!0}),Object.defineProperty(a,"DELAYLOADSTATE_NOTLOADED",{get:function(){return a._DELAYLOADSTATE_NOTLOADED},enumerable:!0,configurable:!0}),a.prototype.getAspectRatio=function(e){var t=e.viewport;return this.getRenderWidth()*t.width/(this.getRenderHeight()*t.height)},a.prototype.getRenderWidth=function(){return this._currentRenderTarget?this._currentRenderTarget._width:this._renderingCanvas.width},a.prototype.getRenderHeight=function(){return this._currentRenderTarget?this._currentRenderTarget._height:this._renderingCanvas.height},a.prototype.getRenderingCanvas=function(){return this._renderingCanvas},a.prototype.setHardwareScalingLevel=function(e){this._hardwareScalingLevel=e,this.resize()},a.prototype.getHardwareScalingLevel=function(){return this._hardwareScalingLevel},a.prototype.getLoadedTexturesCache=function(){return this._loadedTexturesCache},a.prototype.getCaps=function(){return this._caps},a.prototype.setDepthFunctionToGreater=function(){this._gl.depthFunc(this._gl.GREATER)},a.prototype.setDepthFunctionToGreaterOrEqual=function(){this._gl.depthFunc(this._gl.GEQUAL)},a.prototype.setDepthFunctionToLess=function(){this._gl.depthFunc(this._gl.LESS)},a.prototype.setDepthFunctionToLessOrEqual=function(){this._gl.depthFunc(this._gl.LEQUAL)},a.prototype.stopRenderLoop=function(){this._renderFunction=null,this._runningLoop=!1},a.prototype._renderLoop=function(){var t=this,i=!0;!this.renderEvenInBackground&&this._windowIsBackground&&(i=!1),i&&(this.beginFrame(),this._renderFunction&&this._renderFunction(),this.endFrame()),this._runningLoop&&e.Tools.QueueNewFrame(function(){t._renderLoop()})},a.prototype.runRenderLoop=function(t){var i=this;this._runningLoop=!0,this._renderFunction=t,e.Tools.QueueNewFrame(function(){i._renderLoop()})},a.prototype.switchFullscreen=function(t){this.isFullscreen?e.Tools.ExitFullscreen():(this._pointerLockRequested=t,e.Tools.RequestFullscreen(this._renderingCanvas))},a.prototype.clear=function(e,t,i){this._gl.clearColor(e.r,e.g,e.b,void 0!==e.a?e.a:1),this._depthMask&&this._gl.clearDepth(1);var r=0;t&&(r|=this._gl.COLOR_BUFFER_BIT),i&&this._depthMask&&(r|=this._gl.DEPTH_BUFFER_BIT),this._gl.clear(r)},a.prototype.setViewport=function(e,t,i){var r=t||this._renderingCanvas.width,n=i||this._renderingCanvas.height,o=e.x||0,s=e.y||0;this._cachedViewport=e,this._gl.viewport(o*r,s*n,r*e.width,n*e.height)},a.prototype.setDirectViewport=function(e,t,i,r){this._cachedViewport=null,this._gl.viewport(e,t,i,r)},a.prototype.beginFrame=function(){e.Tools._MeasureFps()},a.prototype.endFrame=function(){this.flushFramebuffer()},a.prototype.resize=function(){this._renderingCanvas.width=this._renderingCanvas.clientWidth/this._hardwareScalingLevel,this._renderingCanvas.height=this._renderingCanvas.clientHeight/this._hardwareScalingLevel},a.prototype.bindFramebuffer=function(e){this._currentRenderTarget=e;var t=this._gl;t.bindFramebuffer(t.FRAMEBUFFER,e._framebuffer),this._gl.viewport(0,0,e._width,e._height),this.wipeCaches()},a.prototype.unBindFramebuffer=function(e){if(this._currentRenderTarget=null,e.generateMipMaps){var t=this._gl;t.bindTexture(t.TEXTURE_2D,e),t.generateMipmap(t.TEXTURE_2D),t.bindTexture(t.TEXTURE_2D,null)}this._gl.bindFramebuffer(this._gl.FRAMEBUFFER,null)},a.prototype.flushFramebuffer=function(){this._gl.flush()},a.prototype.restoreDefaultFramebuffer=function(){this._gl.bindFramebuffer(this._gl.FRAMEBUFFER,null),this.setViewport(this._cachedViewport),this.wipeCaches()},a.prototype._resetVertexBufferBinding=function(){this._gl.bindBuffer(this._gl.ARRAY_BUFFER,null),this._cachedVertexBuffers=null},a.prototype.createVertexBuffer=function(e){var t=this._gl.createBuffer();return this._gl.bindBuffer(this._gl.ARRAY_BUFFER,t),this._gl.bufferData(this._gl.ARRAY_BUFFER,new Float32Array(e),this._gl.STATIC_DRAW),this._resetVertexBufferBinding(),t.references=1,t},a.prototype.createDynamicVertexBuffer=function(e){var t=this._gl.createBuffer();return this._gl.bindBuffer(this._gl.ARRAY_BUFFER,t),this._gl.bufferData(this._gl.ARRAY_BUFFER,e,this._gl.DYNAMIC_DRAW),this._resetVertexBufferBinding(),t.references=1,t},a.prototype.updateDynamicVertexBuffer=function(e,t){this._gl.bindBuffer(this._gl.ARRAY_BUFFER,e),t instanceof Float32Array?this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,t):this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,new Float32Array(t)),this._resetVertexBufferBinding()},a.prototype._resetIndexBufferBinding=function(){this._gl.bindBuffer(this._gl.ELEMENT_ARRAY_BUFFER,null),this._cachedIndexBuffer=null},a.prototype.createIndexBuffer=function(e){var t=this._gl.createBuffer();return this._gl.bindBuffer(this._gl.ELEMENT_ARRAY_BUFFER,t),this._gl.bufferData(this._gl.ELEMENT_ARRAY_BUFFER,new Uint16Array(e),this._gl.STATIC_DRAW),this._resetIndexBufferBinding(),t.references=1,t},a.prototype.bindBuffers=function(e,t,i,r,n){if(this._cachedVertexBuffers!==e||this._cachedEffectForVertexBuffers!==n){this._cachedVertexBuffers=e,this._cachedEffectForVertexBuffers=n,this._gl.bindBuffer(this._gl.ARRAY_BUFFER,e);for(var o=0,s=0;s<i.length;s++){var a=n.getAttributeLocation(s);a>=0&&this._gl.vertexAttribPointer(a,i[s],this._gl.FLOAT,!1,r,o),o+=4*i[s]}}this._cachedIndexBuffer!==t&&(this._cachedIndexBuffer=t,this._gl.bindBuffer(this._gl.ELEMENT_ARRAY_BUFFER,t))},a.prototype.bindMultiBuffers=function(e,t,i){if(this._cachedVertexBuffers!==e||this._cachedEffectForVertexBuffers!==i){this._cachedVertexBuffers=e,this._cachedEffectForVertexBuffers=i;for(var r=i.getAttributesNames(),n=0;n<r.length;n++){var o=i.getAttributeLocation(n);if(o>=0){var s=e[r[n]];if(!s)continue;var a=s.getStrideSize();this._gl.bindBuffer(this._gl.ARRAY_BUFFER,s.getBuffer()),this._gl.vertexAttribPointer(o,a,this._gl.FLOAT,!1,4*a,0)}}}this._cachedIndexBuffer!==t&&(this._cachedIndexBuffer=t,this._gl.bindBuffer(this._gl.ELEMENT_ARRAY_BUFFER,t))},a.prototype._releaseBuffer=function(e){return e.references--,0===e.references?(this._gl.deleteBuffer(e),!0):!1},a.prototype.createInstancesBuffer=function(e){var t=this._gl.createBuffer();return t.capacity=e,this._gl.bindBuffer(this._gl.ARRAY_BUFFER,t),this._gl.bufferData(this._gl.ARRAY_BUFFER,e,this._gl.DYNAMIC_DRAW),t},a.prototype.deleteInstancesBuffer=function(e){this._gl.deleteBuffer(e)},a.prototype.updateAndBindInstancesBuffer=function(e,t,i){this._gl.bindBuffer(this._gl.ARRAY_BUFFER,e),this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,t);for(var r=0;4>r;r++){var n=i[r];this._gl.enableVertexAttribArray(n),this._gl.vertexAttribPointer(n,4,this._gl.FLOAT,!1,64,16*r),this._caps.instancedArrays.vertexAttribDivisorANGLE(n,1)}},a.prototype.unBindInstancesBuffer=function(e,t){this._gl.bindBuffer(this._gl.ARRAY_BUFFER,e);for(var i=0;4>i;i++){var r=t[i];this._gl.disableVertexAttribArray(r),this._caps.instancedArrays.vertexAttribDivisorANGLE(r,0)}},a.prototype.draw=function(e,t,i,r){return r?void this._caps.instancedArrays.drawElementsInstancedANGLE(e?this._gl.TRIANGLES:this._gl.LINES,i,this._gl.UNSIGNED_SHORT,2*t,r):void this._gl.drawElements(e?this._gl.TRIANGLES:this._gl.LINES,i,this._gl.UNSIGNED_SHORT,2*t)},a.prototype._releaseEffect=function(e){this._compiledEffects[e._key]&&(delete this._compiledEffects[e._key],e.getProgram()&&this._gl.deleteProgram(e.getProgram()))},a.prototype.createEffect=function(t,i,r,n,o,s,a,h){var c=t.vertexElement||t.vertex||t,u=t.fragmentElement||t.fragment||t,l=c+"+"+u+"@"+o;
if(this._compiledEffects[l])return this._compiledEffects[l];var f=new e.Effect(t,i,r,n,this,o,s,a,h);return f._key=l,this._compiledEffects[l]=f,f},a.prototype.createShaderProgram=function(e,i,r){var n=t(this._gl,e,"vertex",r),o=t(this._gl,i,"fragment",r),s=this._gl.createProgram();this._gl.attachShader(s,n),this._gl.attachShader(s,o),this._gl.linkProgram(s);var a=this._gl.getProgramParameter(s,this._gl.LINK_STATUS);if(!a){var h=this._gl.getProgramInfoLog(s);if(h)throw new Error(h)}return this._gl.deleteShader(n),this._gl.deleteShader(o),s},a.prototype.getUniforms=function(e,t){for(var i=[],r=0;r<t.length;r++)i.push(this._gl.getUniformLocation(e,t[r]));return i},a.prototype.getAttributes=function(e,t){for(var i=[],r=0;r<t.length;r++)try{i.push(this._gl.getAttribLocation(e,t[r]))}catch(n){i.push(-1)}return i},a.prototype.enableEffect=function(e){if(e&&e.getAttributesCount()&&this._currentEffect!==e){this._vertexAttribArrays=this._vertexAttribArrays||[],this._gl.useProgram(e.getProgram());for(var t in this._vertexAttribArrays)t>this._gl.VERTEX_ATTRIB_ARRAY_ENABLED||!this._vertexAttribArrays[t]||(this._vertexAttribArrays[t]=!1,this._gl.disableVertexAttribArray(t));for(var i=e.getAttributesCount(),r=0;i>r;r++){var n=e.getAttributeLocation(r);n>=0&&(this._vertexAttribArrays[n]=!0,this._gl.enableVertexAttribArray(n))}this._currentEffect=e}},a.prototype.setArray=function(e,t){e&&this._gl.uniform1fv(e,t)},a.prototype.setMatrices=function(e,t){e&&this._gl.uniformMatrix4fv(e,!1,t)},a.prototype.setMatrix=function(e,t){e&&this._gl.uniformMatrix4fv(e,!1,t.toArray())},a.prototype.setFloat=function(e,t){e&&this._gl.uniform1f(e,t)},a.prototype.setFloat2=function(e,t,i){e&&this._gl.uniform2f(e,t,i)},a.prototype.setFloat3=function(e,t,i,r){e&&this._gl.uniform3f(e,t,i,r)},a.prototype.setBool=function(e,t){e&&this._gl.uniform1i(e,t)},a.prototype.setFloat4=function(e,t,i,r,n){e&&this._gl.uniform4f(e,t,i,r,n)},a.prototype.setColor3=function(e,t){e&&this._gl.uniform3f(e,t.r,t.g,t.b)},a.prototype.setColor4=function(e,t,i){e&&this._gl.uniform4f(e,t.r,t.g,t.b,i)},a.prototype.setState=function(e){this._cullingState!==e&&(e?(this._gl.cullFace(this.cullBackFaces?this._gl.BACK:this._gl.FRONT),this._gl.enable(this._gl.CULL_FACE)):this._gl.disable(this._gl.CULL_FACE),this._cullingState=e)},a.prototype.setDepthBuffer=function(e){e?this._gl.enable(this._gl.DEPTH_TEST):this._gl.disable(this._gl.DEPTH_TEST)},a.prototype.setDepthWrite=function(e){this._gl.depthMask(e),this._depthMask=e},a.prototype.setColorWrite=function(e){this._gl.colorMask(e,e,e,e)},a.prototype.setAlphaMode=function(t){switch(t){case e.Engine.ALPHA_DISABLE:this.setDepthWrite(!0),this._gl.disable(this._gl.BLEND);break;case e.Engine.ALPHA_COMBINE:this.setDepthWrite(!1),this._gl.blendFuncSeparate(this._gl.SRC_ALPHA,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE),this._gl.enable(this._gl.BLEND);break;case e.Engine.ALPHA_ADD:this.setDepthWrite(!1),this._gl.blendFuncSeparate(this._gl.ONE,this._gl.ONE,this._gl.ZERO,this._gl.ONE),this._gl.enable(this._gl.BLEND)}},a.prototype.setAlphaTesting=function(e){this._alphaTest=e},a.prototype.getAlphaTesting=function(){return this._alphaTest},a.prototype.wipeCaches=function(){this._activeTexturesCache=[],this._currentEffect=null,this._cullingState=null,this._cachedVertexBuffers=null,this._cachedIndexBuffer=null,this._cachedEffectForVertexBuffers=null},a.prototype.setSamplingMode=function(t,i){var r=this._gl;r.bindTexture(r.TEXTURE_2D,t);var n=r.NEAREST,o=r.NEAREST;i===e.Texture.BILINEAR_SAMPLINGMODE?(n=r.LINEAR,o=r.LINEAR):i===e.Texture.TRILINEAR_SAMPLINGMODE&&(n=r.LINEAR,o=r.LINEAR_MIPMAP_LINEAR),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,n),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,o),r.bindTexture(r.TEXTURE_2D,null)},a.prototype.createTexture=function(t,i,r,o,s){var a=this;"undefined"==typeof s&&(s=e.Texture.TRILINEAR_SAMPLINGMODE);var h=this._gl.createTexture(),c=t.substr(t.length-4,4).toLowerCase(),u=this.getCaps().s3tc&&".dds"===c,l=".tga"===c;if(o._addPendingData(h),h.url=t,h.noMipmap=i,h.references=1,this._loadedTexturesCache.push(h),l)e.Tools.LoadFile(t,function(t){var c=new Uint8Array(t),u=e.Internals.TGATools.GetTGAHeader(c);n(h,a._gl,o,u.width,u.height,r,i,!1,function(){e.Internals.TGATools.UploadContent(a._gl,c)},s)},null,o.database,!0);else if(u)e.Tools.LoadFile(t,function(t){var c=e.Internals.DDSTools.GetDDSInfo(t),u=(c.isRGB||c.isLuminance||c.mipmapCount>1)&&!i;n(h,a._gl,o,c.width,c.height,r,!u,c.isFourCC,function(){e.Internals.DDSTools.UploadDDSLevels(a._gl,a.getCaps().s3tc,t,c,u,1)},s)},null,o.database,!0);else{var f=function(e){n(h,a._gl,o,e.width,e.height,r,i,!1,function(t,i){var r=e.width==t&&e.height==i;r||(a._workingCanvas.width=t,a._workingCanvas.height=i,a._workingContext.drawImage(e,0,0,e.width,e.height,0,0,t,i)),a._gl.texImage2D(a._gl.TEXTURE_2D,0,a._gl.RGBA,a._gl.RGBA,a._gl.UNSIGNED_BYTE,r?e:a._workingCanvas)},s)},d=function(){o._removePendingData(h)};e.Tools.LoadImage(t,f,d,o.database)}return h},a.prototype.createDynamicTexture=function(e,t,n,o){var s=this._gl.createTexture();e=r(e,this._caps.maxTextureSize),t=r(t,this._caps.maxTextureSize),this._gl.bindTexture(this._gl.TEXTURE_2D,s);var a=i(o,n,this._gl);return this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MAG_FILTER,a.mag),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MIN_FILTER,a.min),this._gl.bindTexture(this._gl.TEXTURE_2D,null),this._activeTexturesCache=[],s._baseWidth=e,s._baseHeight=t,s._width=e,s._height=t,s.isReady=!1,s.generateMipMaps=n,s.references=1,this._loadedTexturesCache.push(s),s},a.prototype.updateDynamicTexture=function(e,t,i){this._gl.bindTexture(this._gl.TEXTURE_2D,e),this._gl.pixelStorei(this._gl.UNPACK_FLIP_Y_WEBGL,i?1:0),this._gl.texImage2D(this._gl.TEXTURE_2D,0,this._gl.RGBA,this._gl.RGBA,this._gl.UNSIGNED_BYTE,t),e.generateMipMaps&&this._gl.generateMipmap(this._gl.TEXTURE_2D),this._gl.bindTexture(this._gl.TEXTURE_2D,null),this._activeTexturesCache=[],e.isReady=!0},a.prototype.updateVideoTexture=function(e,t,i){this._gl.bindTexture(this._gl.TEXTURE_2D,e),this._gl.pixelStorei(this._gl.UNPACK_FLIP_Y_WEBGL,i?0:1),t.videoWidth!==e._width||t.videoHeight!==e._height?(e._workingCanvas||(e._workingCanvas=document.createElement("canvas"),e._workingContext=e._workingCanvas.getContext("2d"),e._workingCanvas.width=e._width,e._workingCanvas.height=e._height),e._workingContext.drawImage(t,0,0,t.videoWidth,t.videoHeight,0,0,e._width,e._height),this._gl.texImage2D(this._gl.TEXTURE_2D,0,this._gl.RGBA,this._gl.RGBA,this._gl.UNSIGNED_BYTE,e._workingCanvas)):this._gl.texImage2D(this._gl.TEXTURE_2D,0,this._gl.RGBA,this._gl.RGBA,this._gl.UNSIGNED_BYTE,t),e.generateMipMaps&&this._gl.generateMipmap(this._gl.TEXTURE_2D),this._gl.bindTexture(this._gl.TEXTURE_2D,null),this._activeTexturesCache=[],e.isReady=!0},a.prototype.createRenderTargetTexture=function(t,r){var n=!1,o=!0,s=e.Texture.TRILINEAR_SAMPLINGMODE;void 0!==r&&(n=void 0===r.generateMipMaps?r:r.generateMipmaps,o=void 0===r.generateDepthBuffer?!0:r.generateDepthBuffer,void 0!==r.samplingMode&&(s=r.samplingMode));var a=this._gl,h=a.createTexture();a.bindTexture(a.TEXTURE_2D,h);var c=t.width||t,u=t.height||t,l=i(s,n,a);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,l.mag),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,l.min),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE),a.texImage2D(a.TEXTURE_2D,0,a.RGBA,c,u,0,a.RGBA,a.UNSIGNED_BYTE,null);var f;o&&(f=a.createRenderbuffer(),a.bindRenderbuffer(a.RENDERBUFFER,f),a.renderbufferStorage(a.RENDERBUFFER,a.DEPTH_COMPONENT16,c,u));var d=a.createFramebuffer();return a.bindFramebuffer(a.FRAMEBUFFER,d),a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,a.TEXTURE_2D,h,0),o&&a.framebufferRenderbuffer(a.FRAMEBUFFER,a.DEPTH_ATTACHMENT,a.RENDERBUFFER,f),a.bindTexture(a.TEXTURE_2D,null),a.bindRenderbuffer(a.RENDERBUFFER,null),a.bindFramebuffer(a.FRAMEBUFFER,null),h._framebuffer=d,o&&(h._depthBuffer=f),h._width=c,h._height=u,h.isReady=!0,h.generateMipMaps=n,h.references=1,this._activeTexturesCache=[],this._loadedTexturesCache.push(h),h},a.prototype.createCubeTexture=function(t,i,n,s){var a=this,h=this._gl,c=h.createTexture();c.isCube=!0,c.url=t,c.references=1,this._loadedTexturesCache.push(c);var u=t.substr(t.length-4,4).toLowerCase(),l=this.getCaps().s3tc&&".dds"===u;return l?e.Tools.LoadFile(t,function(t){var i=e.Internals.DDSTools.GetDDSInfo(t),r=(i.isRGB||i.isLuminance||i.mipmapCount>1)&&!s;h.bindTexture(h.TEXTURE_CUBE_MAP,c),h.pixelStorei(h.UNPACK_FLIP_Y_WEBGL,1),e.Internals.DDSTools.UploadDDSLevels(a._gl,a.getCaps().s3tc,t,i,r,6),s||i.isFourCC||1!=i.mipmapCount||h.generateMipmap(h.TEXTURE_CUBE_MAP),h.texParameteri(h.TEXTURE_CUBE_MAP,h.TEXTURE_MAG_FILTER,h.LINEAR),h.texParameteri(h.TEXTURE_CUBE_MAP,h.TEXTURE_MIN_FILTER,r?h.LINEAR_MIPMAP_LINEAR:h.LINEAR),h.texParameteri(h.TEXTURE_CUBE_MAP,h.TEXTURE_WRAP_S,h.CLAMP_TO_EDGE),h.texParameteri(h.TEXTURE_CUBE_MAP,h.TEXTURE_WRAP_T,h.CLAMP_TO_EDGE),h.bindTexture(h.TEXTURE_CUBE_MAP,null),a._activeTexturesCache=[],c._width=i.width,c._height=i.height,c.isReady=!0}):o(t,0,[],i,function(e){var t=r(e[0].width,a._caps.maxCubemapTextureSize),i=t;a._workingCanvas.width=t,a._workingCanvas.height=i;var n=[h.TEXTURE_CUBE_MAP_POSITIVE_X,h.TEXTURE_CUBE_MAP_POSITIVE_Y,h.TEXTURE_CUBE_MAP_POSITIVE_Z,h.TEXTURE_CUBE_MAP_NEGATIVE_X,h.TEXTURE_CUBE_MAP_NEGATIVE_Y,h.TEXTURE_CUBE_MAP_NEGATIVE_Z];h.bindTexture(h.TEXTURE_CUBE_MAP,c),h.pixelStorei(h.UNPACK_FLIP_Y_WEBGL,0);for(var o=0;o<n.length;o++)a._workingContext.drawImage(e[o],0,0,e[o].width,e[o].height,0,0,t,i),h.texImage2D(n[o],0,h.RGBA,h.RGBA,h.UNSIGNED_BYTE,a._workingCanvas);s||h.generateMipmap(h.TEXTURE_CUBE_MAP),h.texParameteri(h.TEXTURE_CUBE_MAP,h.TEXTURE_MAG_FILTER,h.LINEAR),h.texParameteri(h.TEXTURE_CUBE_MAP,h.TEXTURE_MIN_FILTER,s?h.LINEAR:h.LINEAR_MIPMAP_LINEAR),h.texParameteri(h.TEXTURE_CUBE_MAP,h.TEXTURE_WRAP_S,h.CLAMP_TO_EDGE),h.texParameteri(h.TEXTURE_CUBE_MAP,h.TEXTURE_WRAP_T,h.CLAMP_TO_EDGE),h.bindTexture(h.TEXTURE_CUBE_MAP,null),a._activeTexturesCache=[],c._width=t,c._height=i,c.isReady=!0},n),c},a.prototype._releaseTexture=function(e){var t=this._gl;e._framebuffer&&t.deleteFramebuffer(e._framebuffer),e._depthBuffer&&t.deleteRenderbuffer(e._depthBuffer),t.deleteTexture(e);for(var i=0;i<this._caps.maxTexturesImageUnits;i++)this._gl.activeTexture(this._gl["TEXTURE"+i]),this._gl.bindTexture(this._gl.TEXTURE_2D,null),this._gl.bindTexture(this._gl.TEXTURE_CUBE_MAP,null),this._activeTexturesCache[i]=null;var r=this._loadedTexturesCache.indexOf(e);-1!==r&&this._loadedTexturesCache.splice(r,1)},a.prototype.bindSamplers=function(e){this._gl.useProgram(e.getProgram());for(var t=e.getSamplers(),i=0;i<t.length;i++){var r=e.getUniform(t[i]);this._gl.uniform1i(r,i)}this._currentEffect=null},a.prototype._bindTexture=function(e,t){this._gl.activeTexture(this._gl["TEXTURE"+e]),this._gl.bindTexture(this._gl.TEXTURE_2D,t),this._activeTexturesCache[e]=null},a.prototype.setTextureFromPostProcess=function(e,t){this._bindTexture(e,t._textures.data[t._currentRenderTextureInd])},a.prototype.setTexture=function(t,i){if(!(0>t)){if(!i||!i.isReady())return void(null!=this._activeTexturesCache[t]&&(this._gl.activeTexture(this._gl["TEXTURE"+t]),this._gl.bindTexture(this._gl.TEXTURE_2D,null),this._gl.bindTexture(this._gl.TEXTURE_CUBE_MAP,null),this._activeTexturesCache[t]=null));if(i instanceof e.VideoTexture)i.update()&&(this._activeTexturesCache[t]=null);else if(i.delayLoadState==e.Engine.DELAYLOADSTATE_NOTLOADED)return void i.delayLoad();if(this._activeTexturesCache[t]!=i){this._activeTexturesCache[t]=i;var r=i.getInternalTexture();if(this._gl.activeTexture(this._gl["TEXTURE"+t]),r.isCube){if(this._gl.bindTexture(this._gl.TEXTURE_CUBE_MAP,r),r._cachedCoordinatesMode!==i.coordinatesMode){r._cachedCoordinatesMode=i.coordinatesMode;var n=i.coordinatesMode!==e.Texture.CUBIC_MODE&&i.coordinatesMode!==e.Texture.SKYBOX_MODE?this._gl.REPEAT:this._gl.CLAMP_TO_EDGE;this._gl.texParameteri(this._gl.TEXTURE_CUBE_MAP,this._gl.TEXTURE_WRAP_S,n),this._gl.texParameteri(this._gl.TEXTURE_CUBE_MAP,this._gl.TEXTURE_WRAP_T,n)}this._setAnisotropicLevel(this._gl.TEXTURE_CUBE_MAP,i)}else{if(this._gl.bindTexture(this._gl.TEXTURE_2D,r),r._cachedWrapU!==i.wrapU)switch(r._cachedWrapU=i.wrapU,i.wrapU){case e.Texture.WRAP_ADDRESSMODE:this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_WRAP_S,this._gl.REPEAT);break;case e.Texture.CLAMP_ADDRESSMODE:this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_WRAP_S,this._gl.CLAMP_TO_EDGE);break;case e.Texture.MIRROR_ADDRESSMODE:this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_WRAP_S,this._gl.MIRRORED_REPEAT)}if(r._cachedWrapV!==i.wrapV)switch(r._cachedWrapV=i.wrapV,i.wrapV){case e.Texture.WRAP_ADDRESSMODE:this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_WRAP_T,this._gl.REPEAT);break;case e.Texture.CLAMP_ADDRESSMODE:this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_WRAP_T,this._gl.CLAMP_TO_EDGE);break;case e.Texture.MIRROR_ADDRESSMODE:this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_WRAP_T,this._gl.MIRRORED_REPEAT)}this._setAnisotropicLevel(this._gl.TEXTURE_2D,i)}}}},a.prototype._setAnisotropicLevel=function(e,t){var i=this._caps.textureAnisotropicFilterExtension;i&&t._cachedAnisotropicFilteringLevel!==t.anisotropicFilteringLevel&&(this._gl.texParameterf(e,i.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(t.anisotropicFilteringLevel,this._caps.maxAnisotropy)),t._cachedAnisotropicFilteringLevel=t.anisotropicFilteringLevel)},a.prototype.readPixels=function(e,t,i,r){var n=new Uint8Array(r*i*4);return this._gl.readPixels(0,0,i,r,this._gl.RGBA,this._gl.UNSIGNED_BYTE,n),n},a.prototype.dispose=function(){for(this.stopRenderLoop();this.scenes.length;)this.scenes[0].dispose();for(var e in this._compiledEffects)this._gl.deleteProgram(this._compiledEffects[e]._program);window.removeEventListener("blur",this._onBlur),window.removeEventListener("focus",this._onFocus),document.removeEventListener("fullscreenchange",this._onFullscreenChange),document.removeEventListener("mozfullscreenchange",this._onFullscreenChange),document.removeEventListener("webkitfullscreenchange",this._onFullscreenChange),document.removeEventListener("msfullscreenchange",this._onFullscreenChange),document.removeEventListener("pointerlockchange",this._onPointerLockChange),document.removeEventListener("mspointerlockchange",this._onPointerLockChange),document.removeEventListener("mozpointerlockchange",this._onPointerLockChange),document.removeEventListener("webkitpointerlockchange",this._onPointerLockChange)},a.isSupported=function(){try{var e=document.createElement("canvas"),t=e.getContext("webgl")||e.getContext("experimental-webgl");return null!=t&&!!window.WebGLRenderingContext}catch(i){return!1}},a._ALPHA_DISABLE=0,a._ALPHA_ADD=1,a._ALPHA_COMBINE=2,a._DELAYLOADSTATE_NONE=0,a._DELAYLOADSTATE_LOADED=1,a._DELAYLOADSTATE_LOADING=2,a._DELAYLOADSTATE_NOTLOADED=4,a.Epsilon=.001,a.CollisionsEpsilon=.001,a.ShadersRepository="Babylon/Shaders/",a}();e.Engine=a}(BABYLON||(BABYLON={}));var BABYLON;!function(e){var t=function(){function t(e,t){this.state="",this.animations=new Array,this._childrenFlag=-1,this._isEnabled=!0,this._isReady=!0,this._currentRenderId=-1,this.name=e,this.id=e,this._scene=t,this._initCache()}return t.prototype.getScene=function(){return this._scene},t.prototype.getEngine=function(){return this._scene.getEngine()},t.prototype.getWorldMatrix=function(){return e.Matrix.Identity()},t.prototype._initCache=function(){this._cache={},this._cache.parent=void 0},t.prototype.updateCache=function(e){(e||!this.isSynchronized())&&(this._cache.parent=this.parent,this._updateCache())},t.prototype._updateCache=function(){},t.prototype._isSynchronized=function(){return!0},t.prototype.isSynchronizedWithParent=function(){return this.parent?this.parent._currentRenderId<=this._currentRenderId:!0},t.prototype.isSynchronized=function(e){var t=this.hasNewParent();return t=t||!this.isSynchronizedWithParent(),t=t||!this._isSynchronized(),e&&this.updateCache(!0),!t},t.prototype.hasNewParent=function(e){return this._cache.parent===this.parent?!1:(e&&(this._cache.parent=this.parent),!0)},t.prototype.isReady=function(){return this._isReady},t.prototype.isEnabled=function(){return this._isEnabled?this.parent?this.parent.isEnabled():!0:!1},t.prototype.setEnabled=function(e){this._isEnabled=e},t.prototype.isDescendantOf=function(e){return this.parent?this.parent===e?!0:this.parent.isDescendantOf(e):!1},t.prototype._getDescendants=function(e,t){for(var i=0;i<e.length;i++){var r=e[i];r.isDescendantOf(this)&&t.push(r)}},t.prototype.getDescendants=function(){var e=[];return this._getDescendants(this._scene.meshes,e),this._getDescendants(this._scene.lights,e),this._getDescendants(this._scene.cameras,e),e},t.prototype._setReady=function(e){if(e!=this._isReady){if(!e)return void(this._isReady=!1);this._isReady=!0,this.onReady&&this.onReady(this)}},t}();e.Node=t}(BABYLON||(BABYLON={}));var BABYLON;!function(e){var t=function(){function t(e,t,i,r,n,o,s,a){this.engine=e,this.canvas=i,this.currentScene=t,this.sceneLoadedCallback=r,this.progressCallback=n,this.additionnalRenderLoopLogicCallback=o,this.textureLoadingCallback=s,this.startingProcessingFilesCallback=a}return t.prototype.monitorElementForDragNDrop=function(e){var t=this;e&&(this.elementToMonitor=e,this.elementToMonitor.addEventListener("dragenter",function(e){t.drag(e)},!1),this.elementToMonitor.addEventListener("dragover",function(e){t.drag(e)},!1),this.elementToMonitor.addEventListener("drop",function(e){t.drop(e)},!1))},t.prototype.renderFunction=function(){if(this.additionnalRenderLoopLogicCallback&&this.additionnalRenderLoopLogicCallback(),this.currentScene){if(this.textureLoadingCallback){var e=this.currentScene.getWaitingItemsCount();e>0&&this.textureLoadingCallback(e)}this.currentScene.render()}},t.prototype.drag=function(e){e.stopPropagation(),e.preventDefault()},t.prototype.drop=function(e){e.stopPropagation(),e.preventDefault(),this.loadFiles(e)},t.prototype.loadFiles=function(t){var i=this,r=this;this.startingProcessingFilesCallback&&this.startingProcessingFilesCallback();var n,o;if(t&&t.dataTransfer&&t.dataTransfer.files&&(o=t.dataTransfer.files),t&&t.target&&t.target.files&&(o=t.target.files),o&&o.length>0){for(var s=0;s<o.length;s++)switch(o[s].type){case"image/jpeg":case"image/png":e.FilesInput.FilesTextures[o[s].name]=o[s];break;case"image/targa":case"image/vnd.ms-dds":e.FilesInput.FilesToLoad[o[s].name]=o[s];break;default:-1!==o[s].name.indexOf(".babylon")&&-1===o[s].name.indexOf(".manifest")&&-1===o[s].name.indexOf(".incremental")&&-1===o[s].name.indexOf(".babylonmeshdata")&&-1===o[s].name.indexOf(".babylongeometrydata")&&(n=o[s])}n?(this.currentScene&&(this.engine.stopRenderLoop(),this.currentScene.dispose()),e.SceneLoader.Load("file:",n,this.engine,function(e){r.currentScene=e,r.currentScene.executeWhenReady(function(){r.currentScene.activeCamera&&r.currentScene.activeCamera.attachControl(r.canvas),r.sceneLoadedCallback&&r.sceneLoadedCallback(n,r.currentScene),r.engine.runRenderLoop(function(){r.renderFunction()})})},function(e){i.progressCallback&&i.progressCallback(e)})):e.Tools.Error("Please provide a valid .babylon file.")}},t.FilesTextures=new Array,t.FilesToLoad=new Array,t}();e.FilesInput=t}(BABYLON||(BABYLON={}));var BABYLON;!function(e){var t=function(){function e(e,t,i){this.bu=e,this.bv=t,this.distance=i,this.faceId=0}return e}();e.IntersectionInfo=t;var i=function(){function t(){this.hit=!1,this.distance=0,this.pickedPoint=null,this.pickedMesh=null,this.bu=0,this.bv=0,this.faceId=-1}return t.prototype.getNormal=function(){if(!this.pickedMesh)return null;var t=this.pickedMesh.getIndices(),i=this.pickedMesh.getVerticesData(e.VertexBuffer.NormalKind),r=e.Vector3.FromArray(i,3*t[3*this.faceId]),n=e.Vector3.FromArray(i,3*t[3*this.faceId+1]),o=e.Vector3.FromArray(i,3*t[3*this.faceId+2]);return r=r.scale(this.bu),n=n.scale(this.bv),o=o.scale(1-this.bu-this.bv),new e.Vector3(r.x+n.x+o.x,r.y+n.y+o.y,r.z+n.z+o.z)},t}();e.PickingInfo=i}(BABYLON||(BABYLON={}));var BABYLON;!function(e){var t=function(){function t(t,i){this.minimum=t,this.maximum=i,this._tempRadiusVector=e.Vector3.Zero();var r=e.Vector3.Distance(t,i);this.center=e.Vector3.Lerp(t,i,.5),this.radius=.5*r,this.centerWorld=e.Vector3.Zero(),this._update(e.Matrix.Identity())}return t.prototype._update=function(t){e.Vector3.TransformCoordinatesToRef(this.center,t,this.centerWorld),e.Vector3.TransformNormalFromFloatsToRef(1,1,1,t,this._tempRadiusVector),this.radiusWorld=Math.max(Math.abs(this._tempRadiusVector.x),Math.abs(this._tempRadiusVector.y),Math.abs(this._tempRadiusVector.z))*this.radius},t.prototype.isInFrustum=function(e){for(var t=0;6>t;t++)if(e[t].dotCoordinate(this.centerWorld)<=-this.radiusWorld)return!1;return!0},t.prototype.intersectsPoint=function(t){var i=this.centerWorld.x-t.x,r=this.centerWorld.y-t.y,n=this.centerWorld.z-t.z,o=Math.sqrt(i*i+r*r+n*n);return Math.abs(this.radiusWorld-o)<e.Engine.Epsilon?!1:!0},t.Intersects=function(e,t){var i=e.centerWorld.x-t.centerWorld.x,r=e.centerWorld.y-t.centerWorld.y,n=e.centerWorld.z-t.centerWorld.z,o=Math.sqrt(i*i+r*r+n*n);return e.radiusWorld+t.radiusWorld<o?!1:!0},t}();e.BoundingSphere=t}(BABYLON||(BABYLON={}));var BABYLON;!function(e){var t=function(){function t(t,i){this.minimum=t,this.maximum=i,this.vectors=new Array,this.vectorsWorld=new Array,this.vectors.push(this.minimum.clone()),this.vectors.push(this.maximum.clone()),this.vectors.push(this.minimum.clone()),this.vectors[2].x=this.maximum.x,this.vectors.push(this.minimum.clone()),this.vectors[3].y=this.maximum.y,this.vectors.push(this.minimum.clone()),this.vectors[4].z=this.maximum.z,this.vectors.push(this.maximum.clone()),this.vectors[5].z=this.minimum.z,this.vectors.push(this.maximum.clone()),this.vectors[6].x=this.minimum.x,this.vectors.push(this.maximum.clone()),this.vectors[7].y=this.minimum.y,this.center=this.maximum.add(this.minimum).scale(.5),this.extends=this.maximum.subtract(this.minimum).scale(.5),this.directions=[e.Vector3.Zero(),e.Vector3.Zero(),e.Vector3.Zero()];for(var r=0;r<this.vectors.length;r++)this.vectorsWorld[r]=e.Vector3.Zero();this.minimumWorld=e.Vector3.Zero(),this.maximumWorld=e.Vector3.Zero(),this._update(e.Matrix.Identity())}return t.prototype.getWorldMatrix=function(){return this._worldMatrix},t.prototype._update=function(t){e.Vector3.FromFloatsToRef(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE,this.minimumWorld),e.Vector3.FromFloatsToRef(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE,this.maximumWorld);for(var i=0;i<this.vectors.length;i++){var r=this.vectorsWorld[i];e.Vector3.TransformCoordinatesToRef(this.vectors[i],t,r),r.x<this.minimumWorld.x&&(this.minimumWorld.x=r.x),r.y<this.minimumWorld.y&&(this.minimumWorld.y=r.y),r.z<this.minimumWorld.z&&(this.minimumWorld.z=r.z),r.x>this.maximumWorld.x&&(this.maximumWorld.x=r.x),r.y>this.maximumWorld.y&&(this.maximumWorld.y=r.y),r.z>this.maximumWorld.z&&(this.maximumWorld.z=r.z)}this.maximumWorld.addToRef(this.minimumWorld,this.center),this.center.scaleInPlace(.5),e.Vector3.FromFloatArrayToRef(t.m,0,this.directions[0]),e.Vector3.FromFloatArrayToRef(t.m,4,this.directions[1]),e.Vector3.FromFloatArrayToRef(t.m,8,this.directions[2]),this._worldMatrix=t},t.prototype.isInFrustum=function(e){return t.IsInFrustum(this.vectorsWorld,e)},t.prototype.intersectsPoint=function(t){var i=e.Engine.Epsilon;return this.maximumWorld.x-t.x<i||i>t.x-this.minimumWorld.x?!1:this.maximumWorld.y-t.y<i||i>t.y-this.minimumWorld.y?!1:this.maximumWorld.z-t.z<i||i>t.z-this.minimumWorld.z?!1:!0},t.prototype.intersectsSphere=function(e){return t.IntersectsSphere(this.minimumWorld,this.maximumWorld,e.centerWorld,e.radiusWorld)},t.prototype.intersectsMinMax=function(e,t){return this.maximumWorld.x<e.x||this.minimumWorld.x>t.x?!1:this.maximumWorld.y<e.y||this.minimumWorld.y>t.y?!1:this.maximumWorld.z<e.z||this.minimumWorld.z>t.z?!1:!0},t.Intersects=function(e,t){return e.maximumWorld.x<t.minimumWorld.x||e.minimumWorld.x>t.maximumWorld.x?!1:e.maximumWorld.y<t.minimumWorld.y||e.minimumWorld.y>t.maximumWorld.y?!1:e.maximumWorld.z<t.minimumWorld.z||e.minimumWorld.z>t.maximumWorld.z?!1:!0},t.IntersectsSphere=function(t,i,r,n){var o=e.Vector3.Clamp(r,t,i),s=e.Vector3.DistanceSquared(r,o);return n*n>=s},t.IsInFrustum=function(e,t){for(var i=0;6>i;i++){for(var r=8,n=0;8>n&&t[i].dotCoordinate(e[n])<0;n++)--r;if(0==r)return!1}return!0},t}();e.BoundingBox=t}(BABYLON||(BABYLON={}));var BABYLON;!function(e){var t=function(t,i){var r=e.Vector3.Dot(i.center,t),n=Math.abs(e.Vector3.Dot(i.directions[0],t))*i.extends.x,o=Math.abs(e.Vector3.Dot(i.directions[1],t))*i.extends.y,s=Math.abs(e.Vector3.Dot(i.directions[2],t))*i.extends.z,a=n+o+s;return{min:r-a,max:r+a}},i=function(e,t,i,r){return!(e>r||i>t)},r=function(e,r,n){var o=t(e,r),s=t(e,n);return i(o.min,o.max,s.min,s.max)},n=function(){function t(t,i){this.minimum=t,this.maximum=i,this.boundingBox=new e.BoundingBox(t,i),this.boundingSphere=new e.BoundingSphere(t,i)}return t.prototype._update=function(e){this.boundingBox._update(e),this.boundingSphere._update(e)},t.prototype.isInFrustum=function(e){return this.boundingSphere.isInFrustum(e)?this.boundingBox.isInFrustum(e):!1},t.prototype._checkCollision=function(e){return e._canDoCollision(this.boundingSphere.centerWorld,this.boundingSphere.radiusWorld,this.boundingBox.minimumWorld,this.boundingBox.maximumWorld)},t.prototype.intersectsPoint=function(e){return this.boundingSphere.centerWorld&&this.boundingSphere.intersectsPoint(e)&&this.boundingBox.intersectsPoint(e)?!0:!1},t.prototype.intersects=function(t,i){if(!this.boundingSphere.centerWorld||!t.boundingSphere.centerWorld)return!1;if(!e.BoundingSphere.Intersects(this.boundingSphere,t.boundingSphere))return!1;if(!e.BoundingBox.Intersects(this.boundingBox,t.boundingBox))return!1;if(!i)return!0;var n=this.boundingBox,o=t.boundingBox;return r(n.directions[0],n,o)&&r(n.directions[1],n,o)&&r(n.directions[2],n,o)&&r(o.directions[0],n,o)&&r(o.directions[1],n,o)&&r(o.directions[2],n,o)&&r(e.Vector3.Cross(n.directions[0],o.directions[0]),n,o)&&r(e.Vector3.Cross(n.directions[0],o.directions[1]),n,o)&&r(e.Vector3.Cross(n.directions[0],o.directions[2]),n,o)&&r(e.Vector3.Cross(n.directions[1],o.directions[0]),n,o)&&r(e.Vector3.Cross(n.directions[1],o.directions[1]),n,o)&&r(e.Vector3.Cross(n.directions[1],o.directions[2]),n,o)&&r(e.Vector3.Cross(n.directions[2],o.directions[0]),n,o)&&r(e.Vector3.Cross(n.directions[2],o.directions[1]),n,o)&&r(e.Vector3.Cross(n.directions[2],o.directions[2]),n,o)?!0:!1},t}();e.BoundingInfo=n}(BABYLON||(BABYLON={}));var __extends=this.__extends||function(e,t){function i(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);i.prototype=t.prototype,e.prototype=new i},BABYLON;!function(e){var t=function(t){function i(i,r){t.call(this,i,r),this.position=new e.Vector3(0,0,0),this.rotation=new e.Vector3(0,0,0),this.scaling=new e.Vector3(1,1,1),this.billboardMode=e.AbstractMesh.BILLBOARDMODE_NONE,this.visibility=1,this.infiniteDistance=!1,this.isVisible=!0,this.isPickable=!0,this.showBoundingBox=!1,this.showSubMeshesBoundingBox=!1,this.onDispose=null,this.checkCollisions=!1,this.renderingGroupId=0,this.receiveShadows=!1,this.useOctreeForRenderingSelection=!0,this.useOctreeForPicking=!0,this.useOctreeForCollisions=!0,this.layerMask=4294967295,this._physicImpostor=e.PhysicsEngine.NoImpostor,this._localScaling=e.Matrix.Zero(),this._localRotation=e.Matrix.Zero(),this._localTranslation=e.Matrix.Zero(),this._localBillboard=e.Matrix.Zero(),this._localPivotScaling=e.Matrix.Zero(),this._localPivotScalingRotation=e.Matrix.Zero(),this._localWorld=e.Matrix.Zero(),this._worldMatrix=e.Matrix.Zero(),this._rotateYByPI=e.Matrix.RotationY(Math.PI),this._absolutePosition=e.Vector3.Zero(),this._collisionsTransformMatrix=e.Matrix.Zero(),this._collisionsScalingMatrix=e.Matrix.Zero(),this._isDirty=!1,this._pivotMatrix=e.Matrix.Identity(),this._isDisposed=!1,this._renderId=0,r.meshes.push(this)}return __extends(i,t),Object.defineProperty(i,"BILLBOARDMODE_NONE",{get:function(){return i._BILLBOARDMODE_NONE},enumerable:!0,configurable:!0}),Object.defineProperty(i,"BILLBOARDMODE_X",{get:function(){return i._BILLBOARDMODE_X},enumerable:!0,configurable:!0}),Object.defineProperty(i,"BILLBOARDMODE_Y",{get:function(){return i._BILLBOARDMODE_Y},enumerable:!0,configurable:!0}),Object.defineProperty(i,"BILLBOARDMODE_Z",{get:function(){return i._BILLBOARDMODE_Z},enumerable:!0,configurable:!0}),Object.defineProperty(i,"BILLBOARDMODE_ALL",{get:function(){return i._BILLBOARDMODE_ALL},enumerable:!0,configurable:!0}),i.prototype.getTotalVertices=function(){return 0},i.prototype.getIndices=function(){return null},i.prototype.getVerticesData=function(){return null},i.prototype.isVerticesDataPresent=function(){return!1},i.prototype.getBoundingInfo=function(){return this._boundingInfo},i.prototype._preActivate=function(){},i.prototype._activate=function(e){this._renderId=e},i.prototype.getWorldMatrix=function(){return this._currentRenderId!==this.getScene().getRenderId()&&this.computeWorldMatrix(),this._worldMatrix},Object.defineProperty(i.prototype,"worldMatrixFromCache",{get:function(){return this._worldMatrix},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"absolutePosition",{get:function(){return this._absolutePosition},enumerable:!0,configurable:!0}),i.prototype.rotate=function(t,i,r){if(this.rotationQuaternion||(this.rotationQuaternion=e.Quaternion.RotationYawPitchRoll(this.rotation.y,this.rotation.x,this.rotation.z),this.rotation=e.Vector3.Zero()),r&&0!=r){if(this.parent){var n=this.parent.getWorldMatrix().clone();n.invert(),t=e.Vector3.TransformNormal(t,n)}o=e.Quaternion.RotationAxis(t,i),this.rotationQuaternion=o.multiply(this.rotationQuaternion)}else{var o=e.Quaternion.RotationAxis(t,i);this.rotationQuaternion=this.rotationQuaternion.multiply(o)}},i.prototype.translate=function(e,t,i){var r=e.scale(t);if(i&&0!=i)this.setAbsolutePosition(this.getAbsolutePosition().add(r));else{var n=this.getPositionExpressedInLocalSpace().add(r);this.setPositionWithLocalVector(n)}},i.prototype.getAbsolutePosition=function(){return this.computeWorldMatrix(),this._absolutePosition},i.prototype.setAbsolutePosition=function(t){if(t){var i,r,n;if(void 0===t.x){if(arguments.length<3)return;i=arguments[0],r=arguments[1],n=arguments[2]}else i=t.x,r=t.y,n=t.z;if(this.parent){var o=this.parent.getWorldMatrix().clone();o.invert();var s=new e.Vector3(i,r,n);this.position=e.Vector3.TransformCoordinates(s,o)}else this.position.x=i,this.position.y=r,this.position.z=n}},i.prototype.setPivotMatrix=function(e){this._pivotMatrix=e,this._cache.pivotMatrixUpdated=!0},i.prototype.getPivotMatrix=function(){return this._pivotMatrix},i.prototype._isSynchronized=function(){if(this._isDirty)return!1;if(this.billboardMode!==i.BILLBOARDMODE_NONE)return!1;if(this._cache.pivotMatrixUpdated)return!1;if(this.infiniteDistance)return!1;if(!this._cache.position.equals(this.position))return!1;if(this.rotationQuaternion){if(!this._cache.rotationQuaternion.equals(this.rotationQuaternion))return!1}else if(!this._cache.rotation.equals(this.rotation))return!1;return this._cache.scaling.equals(this.scaling)?!0:!1},i.prototype._initCache=function(){t.prototype._initCache.call(this),this._cache.localMatrixUpdated=!1,this._cache.position=e.Vector3.Zero(),this._cache.scaling=e.Vector3.Zero(),this._cache.rotation=e.Vector3.Zero(),this._cache.rotationQuaternion=new e.Quaternion(0,0,0,0)},i.prototype.markAsDirty=function(e){"rotation"===e&&(this.rotationQuaternion=null),this._currentRenderId=Number.MAX_VALUE,this._isDirty=!0},i.prototype._updateBoundingInfo=function(){if(this._boundingInfo=this._boundingInfo||new e.BoundingInfo(this.absolutePosition,this.absolutePosition),this._boundingInfo._update(this.worldMatrixFromCache),this.subMeshes)for(var t=0;t<this.subMeshes.length;t++){var i=this.subMeshes[t];
i.updateBoundingInfo(this.worldMatrixFromCache)}},i.prototype.computeWorldMatrix=function(t){if(!t&&(this._currentRenderId==this.getScene().getRenderId()||this.isSynchronized(!0)))return this._worldMatrix;if(this._cache.position.copyFrom(this.position),this._cache.scaling.copyFrom(this.scaling),this._cache.pivotMatrixUpdated=!1,this._currentRenderId=this.getScene().getRenderId(),this._isDirty=!1,e.Matrix.ScalingToRef(this.scaling.x,this.scaling.y,this.scaling.z,this._localScaling),this.rotationQuaternion?(this.rotationQuaternion.toRotationMatrix(this._localRotation),this._cache.rotationQuaternion.copyFrom(this.rotationQuaternion)):(e.Matrix.RotationYawPitchRollToRef(this.rotation.y,this.rotation.x,this.rotation.z,this._localRotation),this._cache.rotation.copyFrom(this.rotation)),this.infiniteDistance&&!this.parent){var r=this.getScene().activeCamera,n=r.getWorldMatrix(),o=new e.Vector3(n.m[12],n.m[13],n.m[14]);e.Matrix.TranslationToRef(this.position.x+o.x,this.position.y+o.y,this.position.z+o.z,this._localTranslation)}else e.Matrix.TranslationToRef(this.position.x,this.position.y,this.position.z,this._localTranslation);if(this._pivotMatrix.multiplyToRef(this._localScaling,this._localPivotScaling),this._localPivotScaling.multiplyToRef(this._localRotation,this._localPivotScalingRotation),this.billboardMode!==i.BILLBOARDMODE_NONE){var s=this.position.clone(),a=this.getScene().activeCamera.position.clone();this.parent&&this.parent.position&&(s.addInPlace(this.parent.position),e.Matrix.TranslationToRef(s.x,s.y,s.z,this._localTranslation)),(this.billboardMode&i.BILLBOARDMODE_ALL)===i.BILLBOARDMODE_ALL?a=this.getScene().activeCamera.position:(this.billboardMode&e.AbstractMesh.BILLBOARDMODE_X&&(a.x=s.x+e.Engine.Epsilon),this.billboardMode&e.AbstractMesh.BILLBOARDMODE_Y&&(a.y=s.y+.001),this.billboardMode&e.AbstractMesh.BILLBOARDMODE_Z&&(a.z=s.z+.001)),e.Matrix.LookAtLHToRef(s,a,e.Vector3.Up(),this._localBillboard),this._localBillboard.m[12]=this._localBillboard.m[13]=this._localBillboard.m[14]=0,this._localBillboard.invert(),this._localPivotScalingRotation.multiplyToRef(this._localBillboard,this._localWorld),this._rotateYByPI.multiplyToRef(this._localWorld,this._localPivotScalingRotation)}return this._localPivotScalingRotation.multiplyToRef(this._localTranslation,this._localWorld),this.parent&&this.parent.getWorldMatrix&&this.billboardMode===e.AbstractMesh.BILLBOARDMODE_NONE?this._localWorld.multiplyToRef(this.parent.getWorldMatrix(),this._worldMatrix):this._worldMatrix.copyFrom(this._localWorld),this._updateBoundingInfo(),this._absolutePosition.copyFromFloats(this._worldMatrix.m[12],this._worldMatrix.m[13],this._worldMatrix.m[14]),this._worldMatrix},i.prototype.setPositionWithLocalVector=function(t){this.computeWorldMatrix(),this.position=e.Vector3.TransformNormal(t,this._localWorld)},i.prototype.getPositionExpressedInLocalSpace=function(){this.computeWorldMatrix();var t=this._localWorld.clone();return t.invert(),e.Vector3.TransformNormal(this.position,t)},i.prototype.locallyTranslate=function(t){this.computeWorldMatrix(),this.position=e.Vector3.TransformCoordinates(t,this._localWorld)},i.prototype.lookAt=function(t,i,r,n){i=i||0,r=r||0,n=n||0;var o=t.subtract(this.position),s=-Math.atan2(o.z,o.x)-Math.PI/2,a=Math.sqrt(o.x*o.x+o.z*o.z),h=Math.atan2(o.y,a);this.rotationQuaternion=e.Quaternion.RotationYawPitchRoll(s+i,h+r,n)},i.prototype.isInFrustum=function(e){return this._boundingInfo.isInFrustum(e)?!0:!1},i.prototype.intersectsMesh=function(e,t){return this._boundingInfo&&e._boundingInfo?this._boundingInfo.intersects(e._boundingInfo,t):!1},i.prototype.intersectsPoint=function(e){return this._boundingInfo?this._boundingInfo.intersectsPoint(e):!1},i.prototype.setPhysicsState=function(t,i){var r=this.getScene().getPhysicsEngine();if(r){if(t.impostor&&(i=t,t=t.impostor),t=t||e.PhysicsEngine.NoImpostor,t===e.PhysicsEngine.NoImpostor)return void r._unregisterMesh(this);i.mass=i.mass||0,i.friction=i.friction||.2,i.restitution=i.restitution||.9,this._physicImpostor=t,this._physicsMass=i.mass,this._physicsFriction=i.friction,this._physicRestitution=i.restitution,r._registerMesh(this,t,i)}},i.prototype.getPhysicsImpostor=function(){return this._physicImpostor?this._physicImpostor:e.PhysicsEngine.NoImpostor},i.prototype.getPhysicsMass=function(){return this._physicsMass?this._physicsMass:0},i.prototype.getPhysicsFriction=function(){return this._physicsFriction?this._physicsFriction:0},i.prototype.getPhysicsRestitution=function(){return this._physicRestitution?this._physicRestitution:0},i.prototype.applyImpulse=function(e,t){this._physicImpostor&&this.getScene().getPhysicsEngine()._applyImpulse(this,e,t)},i.prototype.setPhysicsLinkWith=function(e,t,i){this._physicImpostor&&this.getScene().getPhysicsEngine()._createLink(this,e,t,i)},i.prototype.createOrUpdateSubmeshesOctree=function(t,i){"undefined"==typeof t&&(t=64),"undefined"==typeof i&&(i=2),this._submeshesOctree||(this._submeshesOctree=new e.Octree(e.Octree.CreationFuncForSubMeshes,t,i)),this.computeWorldMatrix(!0);var r=this.getBoundingInfo().boundingBox;return this._submeshesOctree.update(r.minimumWorld,r.maximumWorld,this.subMeshes),this._submeshesOctree},i.prototype._collideForSubMesh=function(t,i,r){if(this._generatePointsArray(),!t._lastColliderWorldVertices||!t._lastColliderTransformMatrix.equals(i)){t._lastColliderTransformMatrix=i.clone(),t._lastColliderWorldVertices=[],t._trianglePlanes=[];for(var n=t.verticesStart,o=t.verticesStart+t.verticesCount,s=n;o>s;s++)t._lastColliderWorldVertices.push(e.Vector3.TransformCoordinates(this._positions[s],i))}r._collide(t,t._lastColliderWorldVertices,this.getIndices(),t.indexStart,t.indexStart+t.indexCount,t.verticesStart)},i.prototype._processCollisionsForSubMeshes=function(e,t){var i,r;if(this._submeshesOctree&&this.useOctreeForCollisions){var n=e.velocityWorldLength+Math.max(e.radius.x,e.radius.y,e.radius.z),o=this._submeshesOctree.intersects(e.basePointWorld,n);r=o.length,i=o.data}else i=this.subMeshes,r=i.length;for(var s=0;r>s;s++){var a=i[s];r>1&&!a._checkCollision(e)||this._collideForSubMesh(a,t,e)}},i.prototype._checkCollision=function(t){this._boundingInfo._checkCollision(t)&&(e.Matrix.ScalingToRef(1/t.radius.x,1/t.radius.y,1/t.radius.z,this._collisionsScalingMatrix),this.worldMatrixFromCache.multiplyToRef(this._collisionsScalingMatrix,this._collisionsTransformMatrix),this._processCollisionsForSubMeshes(t,this._collisionsTransformMatrix))},i.prototype._generatePointsArray=function(){return!1},i.prototype.intersects=function(t,i){var r=new e.PickingInfo;if(!(this.subMeshes&&this._boundingInfo&&t.intersectsSphere(this._boundingInfo.boundingSphere)&&t.intersectsBox(this._boundingInfo.boundingBox)))return r;if(!this._generatePointsArray())return r;var n,o,s=null;if(this._submeshesOctree&&this.useOctreeForPicking){var a=e.Ray.Transform(t,this.getWorldMatrix()),h=this._submeshesOctree.intersectsRay(a);o=h.length,n=h.data}else n=this.subMeshes,o=n.length;for(var c=0;o>c;c++){var u=n[c];if(!(o>1)||u.canIntersects(t)){var l=u.intersects(t,this._positions,this.getIndices(),i);if(l&&(i||!s||l.distance<s.distance)&&(s=l,i))break}}if(s){var f=this.getWorldMatrix(),d=e.Vector3.TransformCoordinates(t.origin,f),p=t.direction.clone();p.normalize(),p=p.scale(s.distance);var m=e.Vector3.TransformNormal(p,f),_=d.add(m);return r.hit=!0,r.distance=e.Vector3.Distance(d,_),r.pickedPoint=_,r.pickedMesh=this,r.bu=s.bu,r.bv=s.bv,r.faceId=s.faceId,r}return r},i.prototype.clone=function(){return null},i.prototype.releaseSubMeshes=function(){if(this.subMeshes)for(;this.subMeshes.length;)this.subMeshes[0].dispose();else this.subMeshes=new Array},i.prototype.dispose=function(t){this.getPhysicsImpostor()!=e.PhysicsEngine.NoImpostor&&this.setPhysicsState(e.PhysicsEngine.NoImpostor),this.releaseSubMeshes();var i=this.getScene().meshes.indexOf(this);if(this.getScene().meshes.splice(i,1),t)for(i=0;i<this.getScene().meshes.length;i++){var r=this.getScene().meshes[i];r.parent===this&&(r.parent=null,r.computeWorldMatrix(!0))}else{for(i=0;i<this.getScene().particleSystems.length;i++)this.getScene().particleSystems[i].emitter==this&&(this.getScene().particleSystems[i].dispose(),i--);var n=this.getScene().meshes.slice(0);for(i=0;i<n.length;i++)n[i].parent==this&&n[i].dispose()}this._isDisposed=!0,this.onDispose&&this.onDispose()},i._BILLBOARDMODE_NONE=0,i._BILLBOARDMODE_X=1,i._BILLBOARDMODE_Y=2,i._BILLBOARDMODE_Z=4,i._BILLBOARDMODE_ALL=7,i}(e.Node);e.AbstractMesh=t}(BABYLON||(BABYLON={}));var __extends=this.__extends||function(e,t){function i(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);i.prototype=t.prototype,e.prototype=new i},BABYLON;!function(e){var t=function(t){function i(i,r){t.call(this,i,r),this.diffuse=new e.Color3(1,1,1),this.specular=new e.Color3(1,1,1),this.intensity=1,this.range=Number.MAX_VALUE,this.excludedMeshes=new Array,this._excludedMeshesIds=new Array,r.lights.push(this)}return __extends(i,t),i.prototype.getShadowGenerator=function(){return this._shadowGenerator},i.prototype.transferToEffect=function(){},i.prototype._getWorldMatrix=function(){return e.Matrix.Identity()},i.prototype.getWorldMatrix=function(){this._currentRenderId=this.getScene().getRenderId();var t=this._getWorldMatrix();return this.parent&&this.parent.getWorldMatrix?(this._parentedWorldMatrix||(this._parentedWorldMatrix=e.Matrix.Identity()),t.multiplyToRef(this.parent.getWorldMatrix(),this._parentedWorldMatrix),this._parentedWorldMatrix):t},i.prototype.dispose=function(){this._shadowGenerator&&(this._shadowGenerator.dispose(),this._shadowGenerator=null);var e=this.getScene().lights.indexOf(this);this.getScene().lights.splice(e,1)},i}(e.Node);e.Light=t}(BABYLON||(BABYLON={}));var __extends=this.__extends||function(e,t){function i(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);i.prototype=t.prototype,e.prototype=new i},BABYLON;!function(e){var t=function(t){function i(e,i,r){t.call(this,e,r),this.position=i}return __extends(i,t),i.prototype.transferToEffect=function(t,i){return this.parent&&this.parent.getWorldMatrix?(this._transformedPosition||(this._transformedPosition=e.Vector3.Zero()),e.Vector3.TransformCoordinatesToRef(this.position,this.parent.getWorldMatrix(),this._transformedPosition),void t.setFloat4(i,this._transformedPosition.x,this._transformedPosition.y,this._transformedPosition.z,0)):void t.setFloat4(i,this.position.x,this.position.y,this.position.z,0)},i.prototype.getShadowGenerator=function(){return null},i.prototype._getWorldMatrix=function(){return this._worldMatrix||(this._worldMatrix=e.Matrix.Identity()),e.Matrix.TranslationToRef(this.position.x,this.position.y,this.position.z,this._worldMatrix),this._worldMatrix},i}(e.Light);e.PointLight=t}(BABYLON||(BABYLON={}));var __extends=this.__extends||function(e,t){function i(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);i.prototype=t.prototype,e.prototype=new i},BABYLON;!function(e){var t=function(t){function i(e,i,r,n,o,s){t.call(this,e,s),this.position=i,this.direction=r,this.angle=n,this.exponent=o}return __extends(i,t),i.prototype.setDirectionToTarget=function(t){return this.direction=e.Vector3.Normalize(t.subtract(this.position)),this.direction},i.prototype.transferToEffect=function(t,i,r){var n;if(this.parent&&this.parent.getWorldMatrix){this._transformedDirection||(this._transformedDirection=e.Vector3.Zero()),this._transformedPosition||(this._transformedPosition=e.Vector3.Zero());var o=this.parent.getWorldMatrix();e.Vector3.TransformCoordinatesToRef(this.position,o,this._transformedPosition),e.Vector3.TransformNormalToRef(this.direction,o,this._transformedDirection),t.setFloat4(i,this._transformedPosition.x,this._transformedPosition.y,this._transformedPosition.z,this.exponent),n=e.Vector3.Normalize(this._transformedDirection)}else t.setFloat4(i,this.position.x,this.position.y,this.position.z,this.exponent),n=e.Vector3.Normalize(this.direction);t.setFloat4(r,n.x,n.y,n.z,Math.cos(.5*this.angle))},i.prototype._getWorldMatrix=function(){return this._worldMatrix||(this._worldMatrix=e.Matrix.Identity()),e.Matrix.TranslationToRef(this.position.x,this.position.y,this.position.z,this._worldMatrix),this._worldMatrix},i}(e.Light);e.SpotLight=t}(BABYLON||(BABYLON={}));var __extends=this.__extends||function(e,t){function i(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);i.prototype=t.prototype,e.prototype=new i},BABYLON;!function(e){var t=function(t){function i(i,r,n){t.call(this,i,n),this.direction=r,this.groundColor=new e.Color3(0,0,0)}return __extends(i,t),i.prototype.setDirectionToTarget=function(t){return this.direction=e.Vector3.Normalize(t.subtract(e.Vector3.Zero())),this.direction},i.prototype.getShadowGenerator=function(){return null},i.prototype.transferToEffect=function(t,i,r){var n=e.Vector3.Normalize(this.direction);t.setFloat4(i,n.x,n.y,n.z,0),t.setColor3(r,this.groundColor.scale(this.intensity))},i.prototype._getWorldMatrix=function(){return this._worldMatrix||(this._worldMatrix=e.Matrix.Identity()),this._worldMatrix},i}(e.Light);e.HemisphericLight=t}(BABYLON||(BABYLON={}));var __extends=this.__extends||function(e,t){function i(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);i.prototype=t.prototype,e.prototype=new i},BABYLON;!function(e){var t=function(t){function i(e,i,r){t.call(this,e,r),this.direction=i,this.position=i.scale(-1)}return __extends(i,t),i.prototype.setDirectionToTarget=function(t){return this.direction=e.Vector3.Normalize(t.subtract(this.position)),this.direction},i.prototype._computeTransformedPosition=function(){return this.parent&&this.parent.getWorldMatrix?(this._transformedPosition||(this._transformedPosition=e.Vector3.Zero()),e.Vector3.TransformCoordinatesToRef(this.position,this.parent.getWorldMatrix(),this._transformedPosition),!0):!1},i.prototype.transferToEffect=function(t,i){return this.parent&&this.parent.getWorldMatrix?(this._transformedDirection||(this._transformedDirection=e.Vector3.Zero()),e.Vector3.TransformNormalToRef(this.direction,this.parent.getWorldMatrix(),this._transformedDirection),void t.setFloat4(i,this._transformedDirection.x,this._transformedDirection.y,this._transformedDirection.z,1)):void t.setFloat4(i,this.direction.x,this.direction.y,this.direction.z,1)},i.prototype._getWorldMatrix=function(){return this._worldMatrix||(this._worldMatrix=e.Matrix.Identity()),e.Matrix.TranslationToRef(this.position.x,this.position.y,this.position.z,this._worldMatrix),this._worldMatrix},i}(e.Light);e.DirectionalLight=t}(BABYLON||(BABYLON={}));var BABYLON;!function(e){var t=function(){function t(t,i){var r=this;this.useVarianceShadowMap=!0,this._darkness=0,this._transparencyShadow=!1,this._viewMatrix=e.Matrix.Zero(),this._projectionMatrix=e.Matrix.Zero(),this._transformMatrix=e.Matrix.Zero(),this._worldViewProjection=e.Matrix.Zero(),this._light=i,this._scene=i.getScene(),i._shadowGenerator=this,this._shadowMap=new e.RenderTargetTexture(i.name+"_shadowMap",t,this._scene,!1),this._shadowMap.wrapU=e.Texture.CLAMP_ADDRESSMODE,this._shadowMap.wrapV=e.Texture.CLAMP_ADDRESSMODE,this._shadowMap.renderParticles=!1;var n=function(t){var i=t.getRenderingMesh(),n=r._scene,o=n.getEngine(),s=i._getInstancesRenderList();if(!s.mustReturn){var a=null!==o.getCaps().instancedArrays&&null!==s.visibleInstances;if(r.isReady(i,a)){if(o.enableEffect(r._effect),i._bind(t,r._effect,!1),r._effect.setMatrix("viewProjection",r.getTransformMatrix()),i.material&&i.material.needAlphaTesting()){var h=i.material.getAlphaTestTexture();r._effect.setTexture("diffuseSampler",h),r._effect.setMatrix("diffuseMatrix",h.getTextureMatrix())}var c=i.skeleton&&i.isVerticesDataPresent(e.VertexBuffer.MatricesIndicesKind)&&i.isVerticesDataPresent(e.VertexBuffer.MatricesWeightsKind);if(c&&r._effect.setMatrices("mBones",i.skeleton.getTransformMatrices()),a)i._renderWithInstances(t,!1,s,r._effect,o);else if(s.renderSelf&&(r._effect.setMatrix("world",i.getWorldMatrix()),i._draw(t,!0)),s.visibleInstances)for(var u=0;u<s.visibleInstances.length;u++){var l=s.visibleInstances[u];r._effect.setMatrix("world",l.getWorldMatrix()),i._draw(t,!0)}}else r._shadowMap.resetRefreshCounter()}};this._shadowMap.customRenderFunction=function(e,t,i){var o;for(o=0;o<e.length;o++)n(e.data[o]);for(o=0;o<t.length;o++)n(t.data[o]);if(r._transparencyShadow)for(o=0;o<i.length;o++)n(i.data[o])}}return t.prototype.isReady=function(t,i){var r=[];this.useVarianceShadowMap&&r.push("#define VSM");var n=[e.VertexBuffer.PositionKind];t.material&&t.material.needAlphaTesting()&&(r.push("#define ALPHATEST"),t.isVerticesDataPresent(e.VertexBuffer.UVKind)&&(n.push(e.VertexBuffer.UVKind),r.push("#define UV1")),t.isVerticesDataPresent(e.VertexBuffer.UV2Kind)&&(n.push(e.VertexBuffer.UV2Kind),r.push("#define UV2"))),t.skeleton&&t.isVerticesDataPresent(e.VertexBuffer.MatricesIndicesKind)&&t.isVerticesDataPresent(e.VertexBuffer.MatricesWeightsKind)&&(n.push(e.VertexBuffer.MatricesIndicesKind),n.push(e.VertexBuffer.MatricesWeightsKind),r.push("#define BONES"),r.push("#define BonesPerMesh "+(t.skeleton.bones.length+1))),i&&(r.push("#define INSTANCES"),n.push("world0"),n.push("world1"),n.push("world2"),n.push("world3"));var o=r.join("\n");return this._cachedDefines!=o&&(this._cachedDefines=o,this._effect=this._scene.getEngine().createEffect("shadowMap",n,["world","mBones","viewProjection","diffuseMatrix"],["diffuseSampler"],o)),this._effect.isReady()},t.prototype.getShadowMap=function(){return this._shadowMap},t.prototype.getLight=function(){return this._light},t.prototype.getTransformMatrix=function(){var t=this._light.position,i=this._light.direction;if(this._light._computeTransformedPosition()&&(t=this._light._transformedPosition),!(this._cachedPosition&&this._cachedDirection&&t.equals(this._cachedPosition)&&i.equals(this._cachedDirection))){this._cachedPosition=t.clone(),this._cachedDirection=i.clone();var r=this._scene.activeCamera;e.Matrix.LookAtLHToRef(t,this._light.position.add(i),e.Vector3.Up(),this._viewMatrix),e.Matrix.PerspectiveFovLHToRef(Math.PI/2,1,r.minZ,r.maxZ,this._projectionMatrix),this._viewMatrix.multiplyToRef(this._projectionMatrix,this._transformMatrix)}return this._transformMatrix},t.prototype.getDarkness=function(){return this._darkness},t.prototype.setDarkness=function(e){this._darkness=e>=1?1:0>=e?0:e},t.prototype.setTransparencyShadow=function(e){this._transparencyShadow=e},t.prototype.dispose=function(){this._shadowMap.dispose()},t}();e.ShadowGenerator=t}(BABYLON||(BABYLON={}));var BABYLON;!function(e){var t=function(e,t,i,r){return e.x>i.x+r?!1:i.x-r>t.x?!1:e.y>i.y+r?!1:i.y-r>t.y?!1:e.z>i.z+r?!1:i.z-r>t.z?!1:!0},i=function(e,t,i,r){var n=t*t-4*e*i,o={root:0,found:!1};if(0>n)return o;var s=Math.sqrt(n),a=(-t-s)/(2*e),h=(-t+s)/(2*e);if(a>h){var c=h;h=a,a=c}return a>0&&r>a?(o.root=a,o.found=!0,o):h>0&&r>h?(o.root=h,o.found=!0,o):o},r=function(){function r(){this.radius=new e.Vector3(1,1,1),this.retry=0,this.basePointWorld=e.Vector3.Zero(),this.velocityWorld=e.Vector3.Zero(),this.normalizedVelocity=e.Vector3.Zero(),this._collisionPoint=e.Vector3.Zero(),this._planeIntersectionPoint=e.Vector3.Zero(),this._tempVector=e.Vector3.Zero(),this._tempVector2=e.Vector3.Zero(),this._tempVector3=e.Vector3.Zero(),this._tempVector4=e.Vector3.Zero(),this._edge=e.Vector3.Zero(),this._baseToVertex=e.Vector3.Zero(),this._destinationPoint=e.Vector3.Zero(),this._slidePlaneNormal=e.Vector3.Zero(),this._displacementVector=e.Vector3.Zero()}return r.prototype._initialize=function(t,i,r){this.velocity=i,e.Vector3.NormalizeToRef(i,this.normalizedVelocity),this.basePoint=t,t.multiplyToRef(this.radius,this.basePointWorld),i.multiplyToRef(this.radius,this.velocityWorld),this.velocityWorldLength=this.velocityWorld.length(),this.epsilon=r,this.collisionFound=!1},r.prototype._checkPointInTriangle=function(t,i,r,n,o){i.subtractToRef(t,this._tempVector),r.subtractToRef(t,this._tempVector2),e.Vector3.CrossToRef(this._tempVector,this._tempVector2,this._tempVector4);var s=e.Vector3.Dot(this._tempVector4,o);return 0>s?!1:(n.subtractToRef(t,this._tempVector3),e.Vector3.CrossToRef(this._tempVector2,this._tempVector3,this._tempVector4),s=e.Vector3.Dot(this._tempVector4,o),0>s?!1:(e.Vector3.CrossToRef(this._tempVector3,this._tempVector,this._tempVector4),s=e.Vector3.Dot(this._tempVector4,o),s>=0))},r.prototype._canDoCollision=function(i,r,n,o){var s=e.Vector3.Distance(this.basePointWorld,i),a=Math.max(this.radius.x,this.radius.y,this.radius.z);return s>this.velocityWorldLength+a+r?!1:t(n,o,this.basePointWorld,this.velocityWorldLength+a)?!0:!1},r.prototype._testTriangle=function(t,r,n,o,s){var a,h=!1;r._trianglePlanes||(r._trianglePlanes=[]),r._trianglePlanes[t]||(r._trianglePlanes[t]=new e.Plane(0,0,0,0),r._trianglePlanes[t].copyFromPoints(n,o,s));var c=r._trianglePlanes[t];if(r.getMaterial()||c.isFrontFacingTo(this.normalizedVelocity,0)){var u=c.signedDistanceTo(this.basePoint),l=e.Vector3.Dot(c.normal,this.velocity);if(0==l){if(Math.abs(u)>=1)return;h=!0,a=0}else{a=(-1-u)/l;var f=(1-u)/l;if(a>f){var d=f;f=a,a=d}if(a>1||0>f)return;0>a&&(a=0),a>1&&(a=1)}this._collisionPoint.copyFromFloats(0,0,0);var p=!1,m=1;if(h||(this.basePoint.subtractToRef(c.normal,this._planeIntersectionPoint),this.velocity.scaleToRef(a,this._tempVector),this._planeIntersectionPoint.addInPlace(this._tempVector),this._checkPointInTriangle(this._planeIntersectionPoint,n,o,s,c.normal)&&(p=!0,m=a,this._collisionPoint.copyFrom(this._planeIntersectionPoint))),!p){var _=this.velocity.lengthSquared(),g=_;this.basePoint.subtractToRef(n,this._tempVector);var v=2*e.Vector3.Dot(this.velocity,this._tempVector),y=this._tempVector.lengthSquared()-1,x=i(g,v,y,m);x.found&&(m=x.root,p=!0,this._collisionPoint.copyFrom(n)),this.basePoint.subtractToRef(o,this._tempVector),v=2*e.Vector3.Dot(this.velocity,this._tempVector),y=this._tempVector.lengthSquared()-1,x=i(g,v,y,m),x.found&&(m=x.root,p=!0,this._collisionPoint.copyFrom(o)),this.basePoint.subtractToRef(s,this._tempVector),v=2*e.Vector3.Dot(this.velocity,this._tempVector),y=this._tempVector.lengthSquared()-1,x=i(g,v,y,m),x.found&&(m=x.root,p=!0,this._collisionPoint.copyFrom(s)),o.subtractToRef(n,this._edge),n.subtractToRef(this.basePoint,this._baseToVertex);var A=this._edge.lengthSquared(),B=e.Vector3.Dot(this._edge,this.velocity),T=e.Vector3.Dot(this._edge,this._baseToVertex);if(g=A*-_+B*B,v=2*A*e.Vector3.Dot(this.velocity,this._baseToVertex)-2*B*T,y=A*(1-this._baseToVertex.lengthSquared())+T*T,x=i(g,v,y,m),x.found){var b=(B*x.root-T)/A;b>=0&&1>=b&&(m=x.root,p=!0,this._edge.scaleInPlace(b),n.addToRef(this._edge,this._collisionPoint))}s.subtractToRef(o,this._edge),o.subtractToRef(this.basePoint,this._baseToVertex),A=this._edge.lengthSquared(),B=e.Vector3.Dot(this._edge,this.velocity),T=e.Vector3.Dot(this._edge,this._baseToVertex),g=A*-_+B*B,v=2*A*e.Vector3.Dot(this.velocity,this._baseToVertex)-2*B*T,y=A*(1-this._baseToVertex.lengthSquared())+T*T,x=i(g,v,y,m),x.found&&(b=(B*x.root-T)/A,b>=0&&1>=b&&(m=x.root,p=!0,this._edge.scaleInPlace(b),o.addToRef(this._edge,this._collisionPoint))),n.subtractToRef(s,this._edge),s.subtractToRef(this.basePoint,this._baseToVertex),A=this._edge.lengthSquared(),B=e.Vector3.Dot(this._edge,this.velocity),T=e.Vector3.Dot(this._edge,this._baseToVertex),g=A*-_+B*B,v=2*A*e.Vector3.Dot(this.velocity,this._baseToVertex)-2*B*T,y=A*(1-this._baseToVertex.lengthSquared())+T*T,x=i(g,v,y,m),x.found&&(b=(B*x.root-T)/A,b>=0&&1>=b&&(m=x.root,p=!0,this._edge.scaleInPlace(b),s.addToRef(this._edge,this._collisionPoint)))}if(p){var M=m*this.velocity.length();(!this.collisionFound||M<this.nearestDistance)&&(this.intersectionPoint?this.intersectionPoint.copyFrom(this._collisionPoint):this.intersectionPoint=this._collisionPoint.clone(),this.nearestDistance=M,this.collisionFound=!0,this.collidedMesh=r.getMesh())}}},r.prototype._collide=function(e,t,i,r,n,o){for(var s=r;n>s;s+=3){var a=t[i[s]-o],h=t[i[s+1]-o],c=t[i[s+2]-o];this._testTriangle(s,e,c,h,a)}},r.prototype._getResponse=function(t,i){t.addToRef(i,this._destinationPoint),i.scaleInPlace(this.nearestDistance/i.length()),this.basePoint.addToRef(i,t),t.subtractToRef(this.intersectionPoint,this._slidePlaneNormal),this._slidePlaneNormal.normalize(),this._slidePlaneNormal.scaleToRef(this.epsilon,this._displacementVector),t.addInPlace(this._displacementVector),this.intersectionPoint.addInPlace(this._displacementVector),this._slidePlaneNormal.scaleInPlace(e.Plane.SignedDistanceToPlaneFromPositionAndNormal(this.intersectionPoint,this._slidePlaneNormal,this._destinationPoint)),this._destinationPoint.subtractInPlace(this._slidePlaneNormal),this._destinationPoint.subtractToRef(this.intersectionPoint,i)},r}();e.Collider=r}(BABYLON||(BABYLON={}));var BABYLON=BABYLON||{};!function(){BABYLON.InputControllerTarget=function(){this._position=new BABYLON.Vector3(0,0,0),this._orientation={yaw:0,pitch:0,roll:0}},BABYLON.InputControllerTarget.prototype.getPosition=function(){return this._position},BABYLON.InputControllerTarget.prototype.getOrientation=function(){return this._orientation},BABYLON.InputControllerTarget.prototype.moveRelative=function(){},BABYLON.InputControllerTarget.prototype.rotateRelative=function(){},BABYLON.InputControllerTarget.prototype.getOrientationMatrix=function(){return new BABYLON.Matrix},BABYLON.InputControllerTarget.prototype.getInvertOrientationMatrix=function(){return new BABYLON.Matrix},BABYLON.InputControllerMultiTarget=function(e){this.targets=e;var t=this.targets[0];t.controllers?t.controllers.push(this):t.controllers=[this]},BABYLON.InputControllerMultiTarget.prototype.getPosition=function(){return this.targets[0].getPosition()},BABYLON.InputControllerMultiTarget.prototype.getOrientation=function(){return this.targets[0].getOrientation()},BABYLON.InputControllerMultiTarget.prototype.getOrientationMatrix=function(){return this.targets[0].getOrientationMatrix()},BABYLON.InputControllerMultiTarget.prototype.getInvertOrientationMatrix=function(){return this.targets[0].getInvertOrientationMatrix()},BABYLON.InputControllerMultiTarget.prototype.moveRelative=function(e){for(var t=0;t<this.targets.length;++t)this.targets[t].moveRelative(e)},BABYLON.InputControllerMultiTarget.prototype.rotateRelative=function(e){for(var t=0;t<this.targets.length;++t)this.targets[t].rotateRelative(e)},BABYLON.InputControllerMultiTarget.prototype.update=function(){if(this.controllers)for(var e=0;e<this.controllers.length;++e)this.controllers[e].update()},BABYLON.InputController=function(e,t){this.scene=e,this.target=t,this.target.controllers?this.target.controllers.push(this):this.target.controllers=[this]},BABYLON.InputController.prototype.attachToCanvas=function(){},BABYLON.InputController.prototype.detachFromCanvas=function(){},BABYLON.InputController.prototype.update=function(){},BABYLON.InputController.prototype.dispose=function(){},BABYLON.inputFilter=function(e,t){BABYLON.InputController.call(this,e,t)},BABYLON.inputFilter.prototype=Object.create(BABYLON.InputController.prototype),BABYLON.inputFilter.prototype.update=function(){if(this.controllers)for(var e=0;e<this.controllers.length;++e)this.controllers[e].update()},BABYLON.inputFilter.prototype.getPosition=function(){return this.target.getPosition()},BABYLON.inputFilter.prototype.getOrientation=function(){return this.target.getOrientation()},BABYLON.inputFilter.prototype.getOrientationMatrix=function(){return this.target.getOrientationMatrix()},BABYLON.inputFilter.prototype.getInvertOrientationMatrix=function(){return this.target.getInvertOrientationMatrix()},BABYLON.inputFilter.prototype.moveRelative=function(e){this.target.moveRelative(e)},BABYLON.inputFilter.prototype.rotateRelative=function(e){this.target.rotateRelative(e)}}();var __extends=this.__extends||function(e,t){function i(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);i.prototype=t.prototype,e.prototype=new i},BABYLON;!function(e){var t=function(t){function i(r,n,o){t.call(this,r,o),this.position=n,this.upVector=e.Vector3.Up(),this.orthoLeft=null,this.orthoRight=null,this.orthoBottom=null,this.orthoTop=null,this.fov=.8,this.minZ=.1,this.maxZ=1e3,this.inertia=.9,this.mode=i.PERSPECTIVE_CAMERA,this.isIntermediate=!1,this.viewport=new e.Viewport(0,0,1,1),this.subCameras=[],this.layerMask=4294967295,this._computedViewMatrix=e.Matrix.Identity(),this._projectionMatrix=new e.Matrix,this._postProcesses=new Array,this._postProcessesTakenIndices=[],o.cameras.push(this),o.activeCamera||(o.activeCamera=this)}return __extends(i,t),i.prototype._initCache=function(){t.prototype._initCache.call(this),this._cache.position=new e.Vector3(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.upVector=new e.Vector3(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.mode=void 0,this._cache.minZ=void 0,this._cache.maxZ=void 0,this._cache.fov=void 0,this._cache.aspectRatio=void 0,this._cache.orthoLeft=void 0,this._cache.orthoRight=void 0,this._cache.orthoBottom=void 0,this._cache.orthoTop=void 0,this._cache.renderWidth=void 0,this._cache.renderHeight=void 0},i.prototype._updateCache=function(e){e||t.prototype._updateCache.call(this);var i=this.getEngine();this._cache.position.copyFrom(this.position),this._cache.upVector.copyFrom(this.upVector),this._cache.mode=this.mode,this._cache.minZ=this.minZ,this._cache.maxZ=this.maxZ,this._cache.fov=this.fov,this._cache.aspectRatio=i.getAspectRatio(this),this._cache.orthoLeft=this.orthoLeft,this._cache.orthoRight=this.orthoRight,this._cache.orthoBottom=this.orthoBottom,this._cache.orthoTop=this.orthoTop,this._cache.renderWidth=i.getRenderWidth(),this._cache.renderHeight=i.getRenderHeight()},i.prototype._updateFromScene=function(){this.updateCache(),this._update()},i.prototype._isSynchronized=function(){return this._isSynchronizedViewMatrix()&&this._isSynchronizedProjectionMatrix()},i.prototype._isSynchronizedViewMatrix=function(){return t.prototype._isSynchronized.call(this)?this._cache.position.equals(this.position)&&this._cache.upVector.equals(this.upVector)&&this.isSynchronizedWithParent():!1},i.prototype._isSynchronizedProjectionMatrix=function(){var t=this._cache.mode===this.mode&&this._cache.minZ===this.minZ&&this._cache.maxZ===this.maxZ;if(!t)return!1;var i=this.getEngine();return t=this.mode===e.Camera.PERSPECTIVE_CAMERA?this._cache.fov===this.fov&&this._cache.aspectRatio===i.getAspectRatio(this):this._cache.orthoLeft===this.orthoLeft&&this._cache.orthoRight===this.orthoRight&&this._cache.orthoBottom===this.orthoBottom&&this._cache.orthoTop===this.orthoTop&&this._cache.renderWidth===i.getRenderWidth()&&this._cache.renderHeight===i.getRenderHeight()},i.prototype.attachControl=function(){},i.prototype.detachControl=function(){},i.prototype._update=function(){},i.prototype.attachPostProcess=function(t,i){if("undefined"==typeof i&&(i=null),!t.isReusable()&&this._postProcesses.indexOf(t)>-1)return e.Tools.Error("You're trying to reuse a post process not defined as reusable."),0;if(null==i||0>i)return this._postProcesses.push(t),this._postProcessesTakenIndices.push(this._postProcesses.length-1),this._postProcesses.length-1;var r=0;if(this._postProcesses[i]){for(var n=this._postProcesses.length-1,o=n;o>=i+1;--o)this._postProcesses[o+1]=this._postProcesses[o];r=1}for(o=0;o<this._postProcessesTakenIndices.length;++o)if(!(this._postProcessesTakenIndices[o]<i)){n=this._postProcessesTakenIndices.length-1;for(var s=n;s>=o;--s)this._postProcessesTakenIndices[s+1]=this._postProcessesTakenIndices[s]+r;this._postProcessesTakenIndices[o]=i;break}r||-1!=this._postProcessesTakenIndices.indexOf(i)||this._postProcessesTakenIndices.push(i);var a=i+r;return this._postProcesses[a]=t,a},i.prototype.detachPostProcess=function(e,t){"undefined"==typeof t&&(t=null);var i=[];if(t)for(t=t instanceof Array?t:[t],o=0;o<t.length;o++){var r=this._postProcesses[t[o]];r===e?(delete this._postProcesses[t[o]],s=this._postProcessesTakenIndices.indexOf(t[o]),this._postProcessesTakenIndices.splice(s,1)):i.push(o)}else for(var n=this._postProcesses.length,o=0;n>o;o++)if(this._postProcesses[o]===e){delete this._postProcesses[o];
var s=this._postProcessesTakenIndices.indexOf(o);this._postProcessesTakenIndices.splice(s,1)}return i},i.prototype.getWorldMatrix=function(){this._worldMatrix||(this._worldMatrix=e.Matrix.Identity());var t=this.getViewMatrix();return t.invertToRef(this._worldMatrix),this._worldMatrix},i.prototype._getViewMatrix=function(){return e.Matrix.Identity()},i.prototype.getViewMatrix=function(){return this._computedViewMatrix=this._computeViewMatrix(),this.parent&&this.parent.getWorldMatrix&&!this.isSynchronized()?(this._worldMatrix||(this._worldMatrix=e.Matrix.Identity()),this._computedViewMatrix.invertToRef(this._worldMatrix),this._worldMatrix.multiplyToRef(this.parent.getWorldMatrix(),this._computedViewMatrix),this._computedViewMatrix.invert(),this._currentRenderId=this.getScene().getRenderId(),this._computedViewMatrix):this._computedViewMatrix},i.prototype._computeViewMatrix=function(e){return!e&&this._isSynchronizedViewMatrix()?this._computedViewMatrix:(this._computedViewMatrix=this._getViewMatrix(),this.parent&&this.parent.getWorldMatrix||(this._currentRenderId=this.getScene().getRenderId()),this._computedViewMatrix)},i.prototype.getProjectionMatrix=function(t){if(!t&&this._isSynchronizedProjectionMatrix())return this._projectionMatrix;var i=this.getEngine();if(this.mode===e.Camera.PERSPECTIVE_CAMERA)return this.minZ<=0&&(this.minZ=.1),e.Matrix.PerspectiveFovLHToRef(this.fov,i.getAspectRatio(this),this.minZ,this.maxZ,this._projectionMatrix),this._projectionMatrix;var r=i.getRenderWidth()/2,n=i.getRenderHeight()/2;return e.Matrix.OrthoOffCenterLHToRef(this.orthoLeft||-r,this.orthoRight||r,this.orthoBottom||-n,this.orthoTop||n,this.minZ,this.maxZ,this._projectionMatrix),this._projectionMatrix},i.prototype.dispose=function(){var e=this.getScene().cameras.indexOf(this);this.getScene().cameras.splice(e,1);for(var t=0;t<this._postProcessesTakenIndices.length;++t)this._postProcesses[this._postProcessesTakenIndices[t]].dispose(this)},i.PERSPECTIVE_CAMERA=0,i.ORTHOGRAPHIC_CAMERA=1,i}(e.Node);e.Camera=t}(BABYLON||(BABYLON={}));var __extends=this.__extends||function(e,t){function i(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);i.prototype=t.prototype,e.prototype=new i},BABYLON;!function(e){var t=function(t){function i(i,r,n){t.call(this,i,r,n),this.cameraDirection=new e.Vector3(0,0,0),this.cameraRotation=new e.Vector2(0,0),this.rotation=new e.Vector3(0,0,0),this.ellipsoid=new e.Vector3(.5,1,.5),this.keysUp=[38],this.keysDown=[40],this.keysLeft=[37],this.keysRight=[39],this.speed=2,this.checkCollisions=!1,this.applyGravity=!1,this.noRotationConstraint=!1,this.angularSensibility=2e3,this.lockedTarget=null,this.onCollide=null,this._keys=[],this._collider=new e.Collider,this._needMoveForGravity=!0,this._currentTarget=e.Vector3.Zero(),this._viewMatrix=e.Matrix.Zero(),this._camMatrix=e.Matrix.Zero(),this._cameraTransformMatrix=e.Matrix.Zero(),this._cameraRotationMatrix=e.Matrix.Zero(),this._referencePoint=e.Vector3.Zero(),this._transformedReferencePoint=e.Vector3.Zero(),this._oldPosition=e.Vector3.Zero(),this._diffPosition=e.Vector3.Zero(),this._newPosition=e.Vector3.Zero(),this._lookAtTemp=e.Matrix.Zero(),this._tempMatrix=e.Matrix.Zero()}return __extends(i,t),i.prototype._getLockedTargetPosition=function(){return this.lockedTarget?this.lockedTarget.position||this.lockedTarget:null},i.prototype._initCache=function(){t.prototype._initCache.call(this),this._cache.lockedTarget=new e.Vector3(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.rotation=new e.Vector3(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE)},i.prototype._updateCache=function(e){e||t.prototype._updateCache.call(this);var i=this._getLockedTargetPosition();i?this._cache.lockedTarget?this._cache.lockedTarget.copyFrom(i):this._cache.lockedTarget=i.clone():this._cache.lockedTarget=null,this._cache.rotation.copyFrom(this.rotation)},i.prototype._isSynchronizedViewMatrix=function(){if(!t.prototype._isSynchronizedViewMatrix.call(this))return!1;var e=this._getLockedTargetPosition();return(this._cache.lockedTarget?this._cache.lockedTarget.equals(e):!e)&&this._cache.rotation.equals(this.rotation)},i.prototype._computeLocalCameraSpeed=function(){return this.speed*(e.Tools.GetDeltaTime()/(10*e.Tools.GetFps()))},i.prototype.setTarget=function(t){this.upVector.normalize(),e.Matrix.LookAtLHToRef(this.position,t,this.upVector,this._camMatrix),this._camMatrix.invert(),this.rotation.x=Math.atan(this._camMatrix.m[6]/this._camMatrix.m[10]);var i=t.subtract(this.position);this.rotation.y=i.x>=0?-Math.atan(i.z/i.x)+Math.PI/2:-Math.atan(i.z/i.x)-Math.PI/2,this.rotation.z=-Math.acos(e.Vector3.Dot(new e.Vector3(0,1,0),this.upVector)),isNaN(this.rotation.x)&&(this.rotation.x=0),isNaN(this.rotation.y)&&(this.rotation.y=0),isNaN(this.rotation.z)&&(this.rotation.z=0)},i.prototype.getTarget=function(){return this._currentTarget},i.prototype.attachControl=function(t,i){var r,n=this,o=this.getEngine();this._attachedElement||(this._attachedElement=t,void 0===this._onMouseDown&&(this._onMouseDown=function(e){r={x:e.clientX,y:e.clientY},i||e.preventDefault()},this._onMouseUp=function(e){r=null,i||e.preventDefault()},this._onMouseOut=function(e){r=null,n._keys=[],i||e.preventDefault()},this._onMouseMove=function(e){if(r||o.isPointerLock){var t,s;o.isPointerLock?(t=e.movementX||e.mozMovementX||e.webkitMovementX||e.msMovementX||0,s=e.movementY||e.mozMovementY||e.webkitMovementY||e.msMovementY||0):(t=e.clientX-r.x,s=e.clientY-r.y),n.cameraRotation.y+=t/n.angularSensibility,n.cameraRotation.x+=s/n.angularSensibility,r={x:e.clientX,y:e.clientY},i||e.preventDefault()}},this._onKeyDown=function(e){if(-1!==n.keysUp.indexOf(e.keyCode)||-1!==n.keysDown.indexOf(e.keyCode)||-1!==n.keysLeft.indexOf(e.keyCode)||-1!==n.keysRight.indexOf(e.keyCode)){var t=n._keys.indexOf(e.keyCode);-1===t&&n._keys.push(e.keyCode),i||e.preventDefault()}},this._onKeyUp=function(e){if(-1!==n.keysUp.indexOf(e.keyCode)||-1!==n.keysDown.indexOf(e.keyCode)||-1!==n.keysLeft.indexOf(e.keyCode)||-1!==n.keysRight.indexOf(e.keyCode)){var t=n._keys.indexOf(e.keyCode);t>=0&&n._keys.splice(t,1),i||e.preventDefault()}},this._onLostFocus=function(){n._keys=[]},this._reset=function(){n._keys=[],r=null,n.cameraDirection=new e.Vector3(0,0,0),n.cameraRotation=new e.Vector2(0,0)}),t.addEventListener("mousedown",this._onMouseDown,!1),t.addEventListener("mouseup",this._onMouseUp,!1),t.addEventListener("mouseout",this._onMouseOut,!1),t.addEventListener("mousemove",this._onMouseMove,!1),e.Tools.RegisterTopRootEvents([{name:"keydown",handler:this._onKeyDown},{name:"keyup",handler:this._onKeyUp},{name:"blur",handler:this._onLostFocus}]))},i.prototype.detachControl=function(t){this._attachedElement==t&&(t.removeEventListener("mousedown",this._onMouseDown),t.removeEventListener("mouseup",this._onMouseUp),t.removeEventListener("mouseout",this._onMouseOut),t.removeEventListener("mousemove",this._onMouseMove),e.Tools.UnregisterTopRootEvents([{name:"keydown",handler:this._onKeyDown},{name:"keyup",handler:this._onKeyUp},{name:"blur",handler:this._onLostFocus}]),this._attachedElement=null,this._reset&&this._reset())},i.prototype._collideWithWorld=function(t){var i;i=this.parent?e.Vector3.TransformCoordinates(this.position,this.parent.getWorldMatrix()):this.position,i.subtractFromFloatsToRef(0,this.ellipsoid.y,0,this._oldPosition),this._collider.radius=this.ellipsoid,this.getScene()._getNewPosition(this._oldPosition,t,this._collider,3,this._newPosition),this._newPosition.subtractToRef(this._oldPosition,this._diffPosition),this._diffPosition.length()>e.Engine.CollisionsEpsilon&&(this.position.addInPlace(this._diffPosition),this.onCollide&&this.onCollide(this._collider.collidedMesh))},i.prototype._checkInputs=function(){this._localDirection||(this._localDirection=e.Vector3.Zero(),this._transformedDirection=e.Vector3.Zero());for(var t=0;t<this._keys.length;t++){var i=this._keys[t],r=this._computeLocalCameraSpeed();-1!==this.keysLeft.indexOf(i)?this._localDirection.copyFromFloats(-r,0,0):-1!==this.keysUp.indexOf(i)?this._localDirection.copyFromFloats(0,0,r):-1!==this.keysRight.indexOf(i)?this._localDirection.copyFromFloats(r,0,0):-1!==this.keysDown.indexOf(i)&&this._localDirection.copyFromFloats(0,0,-r),this.getViewMatrix().invertToRef(this._cameraTransformMatrix),e.Vector3.TransformNormalToRef(this._localDirection,this._cameraTransformMatrix,this._transformedDirection),this.cameraDirection.addInPlace(this._transformedDirection)}},i.prototype._update=function(){this._checkInputs();var t=this._needMoveForGravity||Math.abs(this.cameraDirection.x)>0||Math.abs(this.cameraDirection.y)>0||Math.abs(this.cameraDirection.z)>0,i=Math.abs(this.cameraRotation.x)>0||Math.abs(this.cameraRotation.y)>0;if(t)if(this.checkCollisions&&this.getScene().collisionsEnabled){if(this._collideWithWorld(this.cameraDirection),this.applyGravity){var r=this.position;this._collideWithWorld(this.getScene().gravity),this._needMoveForGravity=0!=e.Vector3.DistanceSquared(r,this.position)}}else this.position.addInPlace(this.cameraDirection);if(i&&(this.rotation.x+=this.cameraRotation.x,this.rotation.y+=this.cameraRotation.y,!this.noRotationConstraint)){var n=Math.PI/2*.95;this.rotation.x>n&&(this.rotation.x=n),this.rotation.x<-n&&(this.rotation.x=-n)}t&&(Math.abs(this.cameraDirection.x)<e.Engine.Epsilon&&(this.cameraDirection.x=0),Math.abs(this.cameraDirection.y)<e.Engine.Epsilon&&(this.cameraDirection.y=0),Math.abs(this.cameraDirection.z)<e.Engine.Epsilon&&(this.cameraDirection.z=0),this.cameraDirection.scaleInPlace(this.inertia)),i&&(Math.abs(this.cameraRotation.x)<e.Engine.Epsilon&&(this.cameraRotation.x=0),Math.abs(this.cameraRotation.y)<e.Engine.Epsilon&&(this.cameraRotation.y=0),this.cameraRotation.scaleInPlace(this.inertia))},i.prototype._getViewMatrix=function(){return e.Vector3.FromFloatsToRef(0,0,1,this._referencePoint),this.lockedTarget?this._currentTarget.copyFrom(this._getLockedTargetPosition()):(0!=this.upVector.x||1!=this.upVector.y||0!=this.upVector.z?(e.Matrix.LookAtLHToRef(e.Vector3.Zero(),this._referencePoint,this.upVector,this._lookAtTemp),e.Matrix.RotationYawPitchRollToRef(this.rotation.y,this.rotation.x,this.rotation.z,this._cameraRotationMatrix),this._lookAtTemp.multiplyToRef(this._cameraRotationMatrix,this._tempMatrix),this._lookAtTemp.invert(),this._tempMatrix.multiplyToRef(this._lookAtTemp,this._cameraRotationMatrix)):e.Matrix.RotationYawPitchRollToRef(this.rotation.y,this.rotation.x,this.rotation.z,this._cameraRotationMatrix),e.Vector3.TransformCoordinatesToRef(this._referencePoint,this._cameraRotationMatrix,this._transformedReferencePoint),this.position.addToRef(this._transformedReferencePoint,this._currentTarget)),e.Matrix.LookAtLHToRef(this.position,this._currentTarget,this.upVector,this._viewMatrix),this._viewMatrix},i}(e.Camera);e.FreeCamera=t}(BABYLON||(BABYLON={}));var BABYLON=BABYLON||{};!function(){BABYLON.TouchCamera=function(e,t,i){BABYLON.FreeCamera.call(this,e,t,i),this._offsetX=null,this._offsetY=null,this._pointerCount=0,this._pointerPressed=[],this.angularSensibility=2e5,this.moveSensibility=500},BABYLON.TouchCamera.prototype=Object.create(BABYLON.FreeCamera.prototype),BABYLON.TouchCamera.prototype.attachControl=function(e,t){var i,r=this;this._attachedCanvas||(this._attachedCanvas=e,void 0===this._onPointerDown&&(this._onPointerDown=function(e){t||e.preventDefault(),r._pointerPressed.push(e.pointerId),1===r._pointerPressed.length&&(i={x:e.clientX,y:e.clientY})},this._onPointerUp=function(e){t||e.preventDefault();var n=r._pointerPressed.indexOf(e.pointerId);-1!==n&&(r._pointerPressed.splice(n,1),0==n&&(i=null,r._offsetX=null,r._offsetY=null))},this._onPointerMove=function(e){if(t||e.preventDefault(),i){var n=r._pointerPressed.indexOf(e.pointerId);0==n&&(r._offsetX=e.clientX-i.x,r._offsetY=-(e.clientY-i.y))}},this._onLostFocus=function(){r._offsetX=null,r._offsetY=null}),e.addEventListener("pointerdown",this._onPointerDown),e.addEventListener("pointerup",this._onPointerUp),e.addEventListener("pointerout",this._onPointerUp),e.addEventListener("pointermove",this._onPointerMove),BABYLON.Tools.RegisterTopRootEvents([{name:"blur",handler:this._onLostFocus}]))},BABYLON.TouchCamera.prototype.detachControl=function(e){this._attachedCanvas==e&&(e.removeEventListener("pointerdown",this._onPointerDown),e.removeEventListener("pointerup",this._onPointerUp),e.removeEventListener("pointerout",this._onPointerUp),e.removeEventListener("pointermove",this._onPointerMove),BABYLON.Tools.UnregisterTopRootEvents([{name:"blur",handler:this._onLostFocus}]),this._attachedCanvas=null)},BABYLON.TouchCamera.prototype._checkInputs=function(){if(this._offsetX)if(this.cameraRotation.y+=this._offsetX/this.angularSensibility,this._pointerPressed.length>1)this.cameraRotation.x+=-this._offsetY/this.angularSensibility;else{var e=this._computeLocalCameraSpeed(),t=new BABYLON.Vector3(0,0,e*this._offsetY/this.moveSensibility);BABYLON.Matrix.RotationYawPitchRollToRef(this.rotation.y,this.rotation.x,0,this._cameraRotationMatrix),this.cameraDirection.addInPlace(BABYLON.Vector3.TransformCoordinates(t,this._cameraRotationMatrix))}}}();var __extends=this.__extends||function(e,t){function i(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);i.prototype=t.prototype,e.prototype=new i},BABYLON;!function(e){var t=e.Tools.GetPointerPrefix(),i=function(i){function r(t,r,n,o,s,a){i.call(this,t,e.Vector3.Zero(),a),this.alpha=r,this.beta=n,this.radius=o,this.target=s,this.inertialAlphaOffset=0,this.inertialBetaOffset=0,this.inertialRadiusOffset=0,this.lowerAlphaLimit=null,this.upperAlphaLimit=null,this.lowerBetaLimit=.01,this.upperBetaLimit=Math.PI,this.lowerRadiusLimit=null,this.upperRadiusLimit=null,this.angularSensibility=1e3,this.wheelPrecision=3,this.keysUp=[38],this.keysDown=[40],this.keysLeft=[37],this.keysRight=[39],this.zoomOnFactor=1,this._keys=[],this._viewMatrix=new e.Matrix,this.getViewMatrix()}return __extends(r,i),r.prototype._getTargetPosition=function(){return this.target.position||this.target},r.prototype._initCache=function(){i.prototype._initCache.call(this),this._cache.target=new e.Vector3(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.alpha=void 0,this._cache.beta=void 0,this._cache.radius=void 0},r.prototype._updateCache=function(e){e||i.prototype._updateCache.call(this),this._cache.target.copyFrom(this._getTargetPosition()),this._cache.alpha=this.alpha,this._cache.beta=this.beta,this._cache.radius=this.radius},r.prototype._isSynchronizedViewMatrix=function(){return i.prototype._isSynchronizedViewMatrix.call(this)?this._cache.target.equals(this._getTargetPosition())&&this._cache.alpha===this.alpha&&this._cache.beta===this.beta&&this._cache.radius===this.radius:!1},r.prototype.attachControl=function(i,r){var n,o,s=this;if(!this._attachedElement){this._attachedElement=i;var a=this.getEngine();void 0===this._onPointerDown&&(this._onPointerDown=function(e){o||(o=e.pointerId,n={x:e.clientX,y:e.clientY},r||e.preventDefault())},this._onPointerUp=function(e){n=null,o=null,r||e.preventDefault()},this._onPointerMove=function(e){if(n&&o===e.pointerId){var t=e.clientX-n.x,i=e.clientY-n.y;s.inertialAlphaOffset-=t/s.angularSensibility,s.inertialBetaOffset-=i/s.angularSensibility,n={x:e.clientX,y:e.clientY},r||e.preventDefault()}},this._onMouseMove=function(e){if(a.isPointerLock){var t=e.movementX||e.mozMovementX||e.webkitMovementX||e.msMovementX||0,i=e.movementY||e.mozMovementY||e.webkitMovementY||e.msMovementY||0;s.inertialAlphaOffset-=t/s.angularSensibility,s.inertialBetaOffset-=i/s.angularSensibility,r||e.preventDefault()}},this._wheel=function(e){var t=0;e.wheelDelta?t=e.wheelDelta/(40*s.wheelPrecision):e.detail&&(t=-e.detail/s.wheelPrecision),t&&(s.inertialRadiusOffset+=t),e.preventDefault&&(r||e.preventDefault())},this._onKeyDown=function(e){if(-1!==s.keysUp.indexOf(e.keyCode)||-1!==s.keysDown.indexOf(e.keyCode)||-1!==s.keysLeft.indexOf(e.keyCode)||-1!==s.keysRight.indexOf(e.keyCode)){var t=s._keys.indexOf(e.keyCode);-1===t&&s._keys.push(e.keyCode),e.preventDefault&&(r||e.preventDefault())}},this._onKeyUp=function(e){if(-1!==s.keysUp.indexOf(e.keyCode)||-1!==s.keysDown.indexOf(e.keyCode)||-1!==s.keysLeft.indexOf(e.keyCode)||-1!==s.keysRight.indexOf(e.keyCode)){var t=s._keys.indexOf(e.keyCode);t>=0&&s._keys.splice(t,1),e.preventDefault&&(r||e.preventDefault())}},this._onLostFocus=function(){s._keys=[],o=null},this._onGestureStart=function(e){void 0!==window.MSGesture&&(s._MSGestureHandler||(s._MSGestureHandler=new MSGesture,s._MSGestureHandler.target=i),s._MSGestureHandler.addPointer(e.pointerId))},this._onGesture=function(e){s.radius*=e.scale,e.preventDefault&&(r||(e.stopPropagation(),e.preventDefault()))},this._reset=function(){s._keys=[],s.inertialAlphaOffset=0,s.inertialBetaOffset=0,s.inertialRadiusOffset=0,n=null,o=null}),i.addEventListener(t+"down",this._onPointerDown,!1),i.addEventListener(t+"up",this._onPointerUp,!1),i.addEventListener(t+"out",this._onPointerUp,!1),i.addEventListener(t+"move",this._onPointerMove,!1),i.addEventListener("mousemove",this._onMouseMove,!1),i.addEventListener("MSPointerDown",this._onGestureStart,!1),i.addEventListener("MSGestureChange",this._onGesture,!1),i.addEventListener("mousewheel",this._wheel,!1),i.addEventListener("DOMMouseScroll",this._wheel,!1),e.Tools.RegisterTopRootEvents([{name:"keydown",handler:this._onKeyDown},{name:"keyup",handler:this._onKeyUp},{name:"blur",handler:this._onLostFocus}])}},r.prototype.detachControl=function(i){this._attachedElement==i&&(i.removeEventListener(t+"down",this._onPointerDown),i.removeEventListener(t+"up",this._onPointerUp),i.removeEventListener(t+"out",this._onPointerUp),i.removeEventListener(t+"move",this._onPointerMove),i.removeEventListener("mousemove",this._onMouseMove),i.removeEventListener("MSPointerDown",this._onGestureStart),i.removeEventListener("MSGestureChange",this._onGesture),i.removeEventListener("mousewheel",this._wheel),i.removeEventListener("DOMMouseScroll",this._wheel),e.Tools.UnregisterTopRootEvents([{name:"keydown",handler:this._onKeyDown},{name:"keyup",handler:this._onKeyUp},{name:"blur",handler:this._onLostFocus}]),this._MSGestureHandler=null,this._attachedElement=null,this._reset&&this._reset())},r.prototype._update=function(){for(var t=0;t<this._keys.length;t++){var i=this._keys[t];-1!==this.keysLeft.indexOf(i)?this.inertialAlphaOffset-=.01:-1!==this.keysUp.indexOf(i)?this.inertialBetaOffset-=.01:-1!==this.keysRight.indexOf(i)?this.inertialAlphaOffset+=.01:-1!==this.keysDown.indexOf(i)&&(this.inertialBetaOffset+=.01)}(0!=this.inertialAlphaOffset||0!=this.inertialBetaOffset||0!=this.inertialRadiusOffset)&&(this.alpha+=this.inertialAlphaOffset,this.beta+=this.inertialBetaOffset,this.radius-=this.inertialRadiusOffset,this.inertialAlphaOffset*=this.inertia,this.inertialBetaOffset*=this.inertia,this.inertialRadiusOffset*=this.inertia,Math.abs(this.inertialAlphaOffset)<e.Engine.Epsilon&&(this.inertialAlphaOffset=0),Math.abs(this.inertialBetaOffset)<e.Engine.Epsilon&&(this.inertialBetaOffset=0),Math.abs(this.inertialRadiusOffset)<e.Engine.Epsilon&&(this.inertialRadiusOffset=0)),this.lowerAlphaLimit&&this.alpha<this.lowerAlphaLimit&&(this.alpha=this.lowerAlphaLimit),this.upperAlphaLimit&&this.alpha>this.upperAlphaLimit&&(this.alpha=this.upperAlphaLimit),this.lowerBetaLimit&&this.beta<this.lowerBetaLimit&&(this.beta=this.lowerBetaLimit),this.upperBetaLimit&&this.beta>this.upperBetaLimit&&(this.beta=this.upperBetaLimit),this.lowerRadiusLimit&&this.radius<this.lowerRadiusLimit&&(this.radius=this.lowerRadiusLimit),this.upperRadiusLimit&&this.radius>this.upperRadiusLimit&&(this.radius=this.upperRadiusLimit)},r.prototype.setPosition=function(e){var t=e.subtract(this._getTargetPosition());this.radius=t.length(),this.alpha=Math.acos(t.x/Math.sqrt(Math.pow(t.x,2)+Math.pow(t.z,2))),t.z<0&&(this.alpha=2*Math.PI-this.alpha),this.beta=Math.acos(t.y/this.radius)},r.prototype._getViewMatrix=function(){var t=Math.cos(this.alpha),i=Math.sin(this.alpha),r=Math.cos(this.beta),n=Math.sin(this.beta),o=this._getTargetPosition();return o.addToRef(new e.Vector3(this.radius*t*n,this.radius*r,this.radius*i*n),this.position),e.Matrix.LookAtLHToRef(this.position,o,this.upVector,this._viewMatrix),this._viewMatrix},r.prototype.zoomOn=function(t){t=t||this.getScene().meshes;var i=e.Mesh.MinMax(t),r=e.Vector3.Distance(i.min,i.max);this.radius=r*this.zoomOnFactor,this.focusOn({min:i.min,max:i.max,distance:r})},r.prototype.focusOn=function(t){var i,r;void 0===t.min?(i=t||this.getScene().meshes,i=e.Mesh.MinMax(i),r=e.Vector3.Distance(i.min,i.max)):(i=t,r=t.distance),this.target=e.Mesh.Center(i),this.maxZ=2*r},r}(e.Camera);e.ArcRotateCamera=i}(BABYLON||(BABYLON={}));var BABYLON=BABYLON||{};!function(){BABYLON.DeviceOrientationCamera=function(e,t,i){BABYLON.FreeCamera.call(this,e,t,i),this._offsetX=null,this._offsetY=null,this._orientationGamma=0,this._orientationBeta=0,this._initialOrientationGamma=0,this._initialOrientationBeta=0},BABYLON.DeviceOrientationCamera.prototype=Object.create(BABYLON.FreeCamera.prototype),BABYLON.DeviceOrientationCamera.prototype.angularSensibility=1e4,BABYLON.DeviceOrientationCamera.prototype.moveSensibility=50,BABYLON.DeviceOrientationCamera.prototype.attachControl=function(e){if(!this._attachedCanvas){this._attachedCanvas=e;var t=this;this._orientationChanged||(this._orientationChanged=function(e){t._initialOrientationGamma||(t._initialOrientationGamma=e.gamma,t._initialOrientationBeta=e.beta),t._orientationGamma=e.gamma,t._orientationBeta=e.beta,t._offsetY=t._initialOrientationBeta-t._orientationBeta,t._offsetX=t._initialOrientationGamma-t._orientationGamma}),window.addEventListener("deviceorientation",this._orientationChanged)}},BABYLON.DeviceOrientationCamera.prototype.detachControl=function(e){this._attachedCanvas==e&&(window.removeEventListener("deviceorientation",this._orientationChanged),this._attachedCanvas=null,this._orientationGamma=0,this._orientationBeta=0,this._initialOrientationGamma=0,this._initialOrientationBeta=0)},BABYLON.DeviceOrientationCamera.prototype._checkInputs=function(){if(this._offsetX){this.cameraRotation.y-=this._offsetX/this.angularSensibility;var e=this._computeLocalCameraSpeed(),t=new BABYLON.Vector3(0,0,e*this._offsetY/this.moveSensibility);BABYLON.Matrix.RotationYawPitchRollToRef(this.rotation.y,this.rotation.x,0,this._cameraRotationMatrix),this.cameraDirection.addInPlace(BABYLON.Vector3.TransformCoordinates(t,this._cameraRotationMatrix))}}}();var BABYLON;!function(e){var t=function(){function t(e){this._renderingGroups=new Array,this._scene=e}return t.prototype._renderParticles=function(e,t){if(0!==this._scene._activeParticleSystems.length){for(var i=(new Date).getTime(),r=0;r<this._scene._activeParticleSystems.length;r++){var n=this._scene._activeParticleSystems.data[r];n.renderingGroupId===e&&(this._clearDepthBuffer(),n.emitter.position&&t&&-1===t.indexOf(n.emitter)||(this._scene._activeParticles+=n.render()))}this._scene._particlesDuration+=(new Date).getTime()-i}},t.prototype._renderSprites=function(e){if(0!==this._scene.spriteManagers.length){for(var t=(new Date).getTime(),i=0;i<this._scene.spriteManagers.length;i++){var r=this._scene.spriteManagers[i];r.renderingGroupId===e&&(this._clearDepthBuffer(),r.render())}this._scene._spritesDuration+=(new Date).getTime()-t}},t.prototype._clearDepthBuffer=function(){this._depthBufferAlreadyCleaned||(this._scene.getEngine().clear(0,!1,!0),this._depthBufferAlreadyCleaned=!0)},t.prototype.render=function(t,i,r,n){for(var o=this,s=0;s<e.RenderingManager.MAX_RENDERINGGROUPS;s++){this._depthBufferAlreadyCleaned=!1;var a=this._renderingGroups[s];a?(this._clearDepthBuffer(),a.render(t,function(){n&&o._renderSprites(s)})||this._renderingGroups.splice(s,1)):n&&this._renderSprites(s),r&&this._renderParticles(s,i)}},t.prototype.reset=function(){for(var e in this._renderingGroups){var t=this._renderingGroups[e];t.prepare()}},t.prototype.dispatch=function(t){var i=t.getMesh(),r=i.renderingGroupId||0;this._renderingGroups[r]||(this._renderingGroups[r]=new e.RenderingGroup(r,this._scene)),this._renderingGroups[r].dispatch(t)},t.MAX_RENDERINGGROUPS=4,t}();e.RenderingManager=t}(BABYLON||(BABYLON={}));var BABYLON;!function(e){var t=function(){function t(t,i){this.index=t,this._opaqueSubMeshes=new e.SmartArray(256),this._transparentSubMeshes=new e.SmartArray(256),this._alphaTestSubMeshes=new e.SmartArray(256),this._scene=i}return t.prototype.render=function(t,i){if(t)return t(this._opaqueSubMeshes,this._alphaTestSubMeshes,this._transparentSubMeshes,i),!0;if(0===this._opaqueSubMeshes.length&&0===this._alphaTestSubMeshes.length&&0===this._transparentSubMeshes.length)return!1;var r,n,o=this._scene.getEngine();for(r=0;r<this._opaqueSubMeshes.length;r++)n=this._opaqueSubMeshes.data[r],this._activeVertices+=n.verticesCount,n.render();for(o.setAlphaTesting(!0),r=0;r<this._alphaTestSubMeshes.length;r++)n=this._alphaTestSubMeshes.data[r],this._activeVertices+=n.verticesCount,n.render();if(o.setAlphaTesting(!1),i&&i(),this._transparentSubMeshes.length){for(r=0;r<this._transparentSubMeshes.length;r++)n=this._transparentSubMeshes.data[r],n._distanceToCamera=n.getBoundingInfo().boundingSphere.centerWorld.subtract(this._scene.activeCamera.position).length();var s=this._transparentSubMeshes.data.slice(0,this._transparentSubMeshes.length);for(s.sort(function(e,t){return e._distanceToCamera<t._distanceToCamera?1:e._distanceToCamera>t._distanceToCamera?-1:0}),o.setAlphaMode(e.Engine.ALPHA_COMBINE),r=0;r<s.length;r++)n=s[r],this._activeVertices+=n.verticesCount,n.render();o.setAlphaMode(e.Engine.ALPHA_DISABLE)}return!0},t.prototype.prepare=function(){this._opaqueSubMeshes.reset(),this._transparentSubMeshes.reset(),this._alphaTestSubMeshes.reset()},t.prototype.dispatch=function(e){var t=e.getMaterial(),i=e.getMesh();t.needAlphaBlending()||i.visibility<1?(t.alpha>0||i.visibility<1)&&this._transparentSubMeshes.push(e):t.needAlphaTesting()?this._alphaTestSubMeshes.push(e):this._opaqueSubMeshes.push(e)},t}();e.RenderingGroup=t}(BABYLON||(BABYLON={}));var BABYLON;!function(e){var t=function(){function t(t){this.autoClear=!0,this.clearColor=new e.Color3(.2,.2,.3),this.ambientColor=new e.Color3(0,0,0),this.forceWireframe=!1,this.fogMode=e.Scene.FOGMODE_NONE,this.fogColor=new e.Color3(.2,.2,.3),this.fogDensity=.1,this.fogStart=0,this.fogEnd=1e3,this.lightsEnabled=!0,this.lights=new Array,this.cameras=new Array,this.activeCameras=new Array,this.meshes=new Array,this._geometries=new Array,this.materials=new Array,this.multiMaterials=new Array,this.defaultMaterial=new e.StandardMaterial("default material",this),this.texturesEnabled=!0,this.textures=new Array,this.particlesEnabled=!0,this.particleSystems=new Array,this.spriteManagers=new Array,this.layers=new Array,this.skeletons=new Array,this.lensFlareSystems=new Array,this.collisionsEnabled=!0,this.gravity=new e.Vector3(0,-9,0),this.postProcessesEnabled=!0,this.renderTargetsEnabled=!0,this.customRenderTargets=new Array,this.importedMeshesFiles=new Array,this._totalVertices=0,this._activeVertices=0,this._activeParticles=0,this._lastFrameDuration=0,this._evaluateActiveMeshesDuration=0,this._renderTargetsDuration=0,this._particlesDuration=0,this._renderDuration=0,this._spritesDuration=0,this._animationRatio=0,this._renderId=0,this._executeWhenReadyTimeoutId=-1,this._toBeDisposed=new e.SmartArray(256),this._onReadyCallbacks=new Array,this._pendingData=[],this._onBeforeRenderCallbacks=new Array,this._activeMeshes=new e.SmartArray(256),this._processedMaterials=new e.SmartArray(256),this._renderTargets=new e.SmartArray(256),this._activeParticleSystems=new e.SmartArray(256),this._activeSkeletons=new e.SmartArray(32),this._activeAnimatables=new Array,this._transformMatrix=e.Matrix.Zero(),this._scaledPosition=e.Vector3.Zero(),this._scaledVelocity=e.Vector3.Zero(),this._engine=t,t.scenes.push(this),this._renderingManager=new e.RenderingManager(this),this.postProcessManager=new e.PostProcessManager(this),this.postProcessRenderPipelineManager=new e.PostProcessRenderPipelineManager,this._boundingBoxRenderer=new e.BoundingBoxRenderer(this),this.attachControl()}return Object.defineProperty(t.prototype,"meshUnderPointer",{get:function(){return this._meshUnderPointer},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"pointerX",{get:function(){return this._pointerX},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"pointerY",{get:function(){return this._pointerY},enumerable:!0,configurable:!0}),t.prototype.getBoundingBoxRenderer=function(){return this._boundingBoxRenderer},t.prototype.getEngine=function(){return this._engine},t.prototype.getTotalVertices=function(){return this._totalVertices},t.prototype.getActiveVertices=function(){return this._activeVertices},t.prototype.getActiveParticles=function(){return this._activeParticles},t.prototype.getLastFrameDuration=function(){return this._lastFrameDuration},t.prototype.getEvaluateActiveMeshesDuration=function(){return this._evaluateActiveMeshesDuration},t.prototype.getActiveMeshes=function(){return this._activeMeshes},t.prototype.getRenderTargetsDuration=function(){return this._renderTargetsDuration},t.prototype.getRenderDuration=function(){return this._renderDuration},t.prototype.getParticlesDuration=function(){return this._particlesDuration},t.prototype.getSpritesDuration=function(){return this._spritesDuration},t.prototype.getAnimationRatio=function(){return this._animationRatio},t.prototype.getRenderId=function(){return this._renderId},t.prototype.attachControl=function(){var t=this;this._onPointerMove=function(e){var i=t._engine.getRenderingCanvas();t._pointerX=e.offsetX||e.layerX,t._pointerY=e.offsetY||e.layerY;var r=t.pick(t._pointerX,t._pointerY,function(e){return e.actionManager&&e.isPickable});r.hit?(t.setPointerOverMesh(r.pickedMesh),i.style.cursor="pointer",t._meshUnderPointer=r.pickedMesh):(t.setPointerOverMesh(null),i.style.cursor="",t._meshUnderPointer=null)},this._onPointerDown=function(i){var r=t.pick(i.offsetX||i.layerX,i.offsetY||i.layerY);if(r.hit&&r.pickedMesh.actionManager){switch(i.buttons){case 1:r.pickedMesh.actionManager.processTrigger(e.ActionManager.OnLeftPickTrigger,e.ActionEvent.CreateNew(r.pickedMesh));break;case 2:r.pickedMesh.actionManager.processTrigger(e.ActionManager.OnRightPickTrigger,e.ActionEvent.CreateNew(r.pickedMesh));break;case 3:r.pickedMesh.actionManager.processTrigger(e.ActionManager.OnCenterPickTrigger,e.ActionEvent.CreateNew(r.pickedMesh))}r.pickedMesh.actionManager.processTrigger(e.ActionManager.OnPickTrigger,e.ActionEvent.CreateNew(r.pickedMesh))}t.onPointerDown&&t.onPointerDown(i,r)};var i=e.Tools.GetPointerPrefix();this._engine.getRenderingCanvas().addEventListener(i+"move",this._onPointerMove,!1),this._engine.getRenderingCanvas().addEventListener(i+"down",this._onPointerDown,!1)},t.prototype.detachControl=function(){var t=e.Tools.GetPointerPrefix();this._engine.getRenderingCanvas().removeEventListener(t+"move",this._onPointerMove),this._engine.getRenderingCanvas().removeEventListener(t+"down",this._onPointerDown)},t.prototype.isReady=function(){if(this._pendingData.length>0)return!1;for(var t=0;t<this._geometries.length;t++){var i=this._geometries[t];if(i.delayLoadState===e.Engine.DELAYLOADSTATE_LOADING)return!1}for(t=0;t<this.meshes.length;t++){var r=this.meshes[t];if(!r.isReady())return!1;var n=r.material;if(n&&!n.isReady(r))return!1}return!0},t.prototype.registerBeforeRender=function(e){this._onBeforeRenderCallbacks.push(e)},t.prototype.unregisterBeforeRender=function(e){var t=this._onBeforeRenderCallbacks.indexOf(e);t>-1&&this._onBeforeRenderCallbacks.splice(t,1)},t.prototype._addPendingData=function(e){this._pendingData.push(e)},t.prototype._removePendingData=function(e){var t=this._pendingData.indexOf(e);-1!==t&&this._pendingData.splice(t,1)},t.prototype.getWaitingItemsCount=function(){return this._pendingData.length},t.prototype.executeWhenReady=function(e){var t=this;this._onReadyCallbacks.push(e),-1===this._executeWhenReadyTimeoutId&&(this._executeWhenReadyTimeoutId=setTimeout(function(){t._checkIsReady()
},150))},t.prototype._checkIsReady=function(){var e=this;return this.isReady()?(this._onReadyCallbacks.forEach(function(e){e()}),this._onReadyCallbacks=[],void(this._executeWhenReadyTimeoutId=-1)):void(this._executeWhenReadyTimeoutId=setTimeout(function(){e._checkIsReady()},150))},t.prototype.beginAnimation=function(t,i,r,n,o,s,a){if(void 0===o&&(o=1),this.stopAnimation(t),a||(a=new e.Animatable(this,t,i,r,n,o,s)),t.animations&&a.appendAnimations(t,t.animations),t.getAnimatables)for(var h=t.getAnimatables(),c=0;c<h.length;c++)this.beginAnimation(h[c],i,r,n,o,s,a);return a},t.prototype.beginDirectAnimation=function(t,i,r,n,o,s,a){void 0===s&&(s=1);var h=new e.Animatable(this,t,r,n,o,s,a,i);return h},t.prototype.getAnimatableByTarget=function(e){for(var t=0;t<this._activeAnimatables.length;t++)if(this._activeAnimatables[t].target===e)return this._activeAnimatables[t];return null},t.prototype.stopAnimation=function(e){var t=this.getAnimatableByTarget(e);t&&t.stop()},t.prototype._animate=function(){this._animationStartDate||(this._animationStartDate=(new Date).getTime());for(var e=(new Date).getTime(),t=e-this._animationStartDate,i=0;i<this._activeAnimatables.length;i++)this._activeAnimatables[i]._animate(t)||(this._activeAnimatables.splice(i,1),i--)},t.prototype.getViewMatrix=function(){return this._viewMatrix},t.prototype.getProjectionMatrix=function(){return this._projectionMatrix},t.prototype.getTransformMatrix=function(){return this._transformMatrix},t.prototype.setTransformMatrix=function(e,t){this._viewMatrix=e,this._projectionMatrix=t,this._viewMatrix.multiplyToRef(this._projectionMatrix,this._transformMatrix)},t.prototype.setActiveCameraByID=function(e){var t=this.getCameraByID(e);return t?(this.activeCamera=t,t):null},t.prototype.setActiveCameraByName=function(e){var t=this.getCameraByName(e);return t?(this.activeCamera=t,t):null},t.prototype.getMaterialByID=function(e){for(var t=0;t<this.materials.length;t++)if(this.materials[t].id===e)return this.materials[t];return null},t.prototype.getMaterialByName=function(e){for(var t=0;t<this.materials.length;t++)if(this.materials[t].name===e)return this.materials[t];return null},t.prototype.getCameraByID=function(e){for(var t=0;t<this.cameras.length;t++)if(this.cameras[t].id===e)return this.cameras[t];return null},t.prototype.getCameraByName=function(e){for(var t=0;t<this.cameras.length;t++)if(this.cameras[t].name===e)return this.cameras[t];return null},t.prototype.getLightByName=function(e){for(var t=0;t<this.lights.length;t++)if(this.lights[t].name===e)return this.lights[t];return null},t.prototype.getLightByID=function(e){for(var t=0;t<this.lights.length;t++)if(this.lights[t].id===e)return this.lights[t];return null},t.prototype.getGeometryByID=function(e){for(var t=0;t<this._geometries.length;t++)if(this._geometries[t].id===e)return this._geometries[t];return null},t.prototype.pushGeometry=function(e,t){return!t&&this.getGeometryByID(e.id)?!1:(this._geometries.push(e),!0)},t.prototype.getGeometries=function(){return this._geometries},t.prototype.getMeshByID=function(e){for(var t=0;t<this.meshes.length;t++)if(this.meshes[t].id===e)return this.meshes[t];return null},t.prototype.getLastMeshByID=function(e){for(var t=this.meshes.length-1;t>=0;t--)if(this.meshes[t].id===e)return this.meshes[t];return null},t.prototype.getLastEntryByID=function(e){for(var t=this.meshes.length-1;t>=0;t--)if(this.meshes[t].id===e)return this.meshes[t];for(t=this.cameras.length-1;t>=0;t--)if(this.cameras[t].id===e)return this.cameras[t];for(t=this.lights.length-1;t>=0;t--)if(this.lights[t].id===e)return this.lights[t];return null},t.prototype.getMeshByName=function(e){for(var t=0;t<this.meshes.length;t++)if(this.meshes[t].name===e)return this.meshes[t];return null},t.prototype.getLastSkeletonByID=function(e){for(var t=this.skeletons.length-1;t>=0;t--)if(this.skeletons[t].id===e)return this.skeletons[t];return null},t.prototype.getSkeletonById=function(e){for(var t=0;t<this.skeletons.length;t++)if(this.skeletons[t].id===e)return this.skeletons[t];return null},t.prototype.getSkeletonByName=function(e){for(var t=0;t<this.skeletons.length;t++)if(this.skeletons[t].name===e)return this.skeletons[t];return null},t.prototype.isActiveMesh=function(e){return-1!==this._activeMeshes.indexOf(e)},t.prototype._evaluateSubMesh=function(e,t){if(1==t.subMeshes.length||e.isInFrustum(this._frustumPlanes)){var i=e.getMaterial();t.showSubMeshesBoundingBox&&this._boundingBoxRenderer.renderList.push(e.getBoundingInfo().boundingBox),i&&(i.getRenderTargetTextures&&-1===this._processedMaterials.indexOf(i)&&(this._processedMaterials.push(i),this._renderTargets.concat(i.getRenderTargetTextures())),this._activeVertices+=e.verticesCount,this._renderingManager.dispatch(e))}},t.prototype._evaluateActiveMeshes=function(){this._activeMeshes.reset(),this._renderingManager.reset(),this._processedMaterials.reset(),this._activeParticleSystems.reset(),this._activeSkeletons.reset(),this._boundingBoxRenderer.reset(),this._frustumPlanes?e.Frustum.GetPlanesToRef(this._transformMatrix,this._frustumPlanes):this._frustumPlanes=e.Frustum.GetPlanes(this._transformMatrix);var t,i;if(this._selectionOctree){var r=this._selectionOctree.select(this._frustumPlanes);t=r.data,i=r.length}else i=this.meshes.length,t=this.meshes;for(var n=0;i>n;n++){var o=t[n];this._totalVertices+=o.getTotalVertices(),o.isReady()&&(o.computeWorldMatrix(),o._preActivate(),o.isEnabled()&&o.isVisible&&o.visibility>0&&0!=(o.layerMask&this.activeCamera.layerMask)&&o.isInFrustum(this._frustumPlanes)&&(this._activeMeshes.push(o),o._activate(this._renderId),this._activeMesh(o)))}var s=(new Date).getTime();if(this.particlesEnabled)for(var a=0;a<this.particleSystems.length;a++){var h=this.particleSystems[a];h.isStarted()&&(!h.emitter.position||h.emitter&&h.emitter.isEnabled())&&(this._activeParticleSystems.push(h),h.animate())}this._particlesDuration+=(new Date).getTime()-s},t.prototype._activeMesh=function(e){if(e.skeleton&&this._activeSkeletons.pushNoDuplicate(e.skeleton),e.showBoundingBox&&this._boundingBoxRenderer.renderList.push(e.getBoundingInfo().boundingBox),e.subMeshes){var t,i;if(e._submeshesOctree&&e.useOctreeForRenderingSelection){var r=e._submeshesOctree.select(this._frustumPlanes);t=r.length,i=r.data}else i=e.subMeshes,t=i.length;for(var n=0;t>n;n++){var o=i[n];this._evaluateSubMesh(o,e)}}},t.prototype.updateTransformMatrix=function(e){this.setTransformMatrix(this.activeCamera.getViewMatrix(),this.activeCamera.getProjectionMatrix(e))},t.prototype._renderForCamera=function(e){var t=this._engine;if(this.activeCamera=e,!this.activeCamera)throw new Error("Active camera not set");t.setViewport(this.activeCamera.viewport),this._renderId++,this.updateTransformMatrix(),this.beforeCameraRender&&this.beforeCameraRender(this.activeCamera);var i=(new Date).getTime();this._evaluateActiveMeshes(),this._evaluateActiveMeshesDuration+=(new Date).getTime()-i;for(var r=0;r<this._activeSkeletons.length;r++){var n=this._activeSkeletons.data[r];n.prepare()}for(var o=0;o<this.customRenderTargets.length;o++){var s=this.customRenderTargets[o];this._renderTargets.push(s)}var a=(new Date).getTime();if(this.renderTargetsEnabled){for(var h=0;h<this._renderTargets.length;h++)s=this._renderTargets.data[h],s._shouldRender()&&(this._renderId++,s.render());this._renderId++}this._renderTargets.length>0&&t.restoreDefaultFramebuffer(),this._renderTargetsDuration=(new Date).getTime()-a,this.postProcessManager._prepareFrame();var c=(new Date).getTime();if(this.layers.length){t.setDepthBuffer(!1);var u,l;for(u=0;u<this.layers.length;u++)l=this.layers[u],l.isBackground&&l.render();t.setDepthBuffer(!0)}this._renderingManager.render(null,null,!0,!0),this._boundingBoxRenderer.render();for(var f=0;f<this.lensFlareSystems.length;f++)this.lensFlareSystems[f].render();if(this.layers.length){for(t.setDepthBuffer(!1),u=0;u<this.layers.length;u++)l=this.layers[u],l.isBackground||l.render();t.setDepthBuffer(!0)}this._renderDuration+=(new Date).getTime()-c,this.postProcessManager._finalizeFrame(e.isIntermediate),this.activeCamera._updateFromScene(),this._renderTargets.reset(),this.afterCameraRender&&this.afterCameraRender(this.activeCamera)},t.prototype._processSubCameras=function(e){if(0==e.subCameras.length)return void this._renderForCamera(e);for(var t=0;t<e.subCameras.length;t++)this._renderForCamera(e.subCameras[t]);this.activeCamera=e,this.setTransformMatrix(this.activeCamera.getViewMatrix(),this.activeCamera.getProjectionMatrix()),this.activeCamera._updateFromScene()},t.prototype.render=function(){var t=(new Date).getTime();this._particlesDuration=0,this._spritesDuration=0,this._activeParticles=0,this._renderDuration=0,this._evaluateActiveMeshesDuration=0,this._totalVertices=0,this._activeVertices=0,this.actionManager&&this.actionManager.processTrigger(e.ActionManager.OnEveryFrameTrigger,null),this.beforeRender&&this.beforeRender();for(var i=0;i<this._onBeforeRenderCallbacks.length;i++)this._onBeforeRenderCallbacks[i]();var r=e.Tools.GetDeltaTime();this._animationRatio=.06*r,this._animate(),this._physicsEngine&&this._physicsEngine._runOneStep(r/1e3),this._engine.clear(this.clearColor,this.autoClear||this.forceWireframe,!0);for(var n=0;n<this.lights.length;n++){var o=this.lights[n],s=o.getShadowGenerator();o.isEnabled()&&s&&-1!==s.getShadowMap().getScene().textures.indexOf(s.getShadowMap())&&this._renderTargets.push(s.getShadowMap())}if(this.postProcessRenderPipelineManager.update(),this.activeCameras.length>0)for(var a=this._renderId,h=0;h<this.activeCameras.length;h++)this._renderId=a,this._processSubCameras(this.activeCameras[h]);else this._processSubCameras(this.activeCamera);this.afterRender&&this.afterRender();for(var c=0;c<this._toBeDisposed.length;c++)this._toBeDisposed.data[c].dispose(),this._toBeDisposed[c]=null;this._toBeDisposed.reset(),this._lastFrameDuration=(new Date).getTime()-t},t.prototype.dispose=function(){this.beforeRender=null,this.afterRender=null,this.skeletons=[],this._boundingBoxRenderer.dispose(),this.detachControl();var e,t=this._engine.getRenderingCanvas();for(e=0;e<this.cameras.length;e++)this.cameras[e].detachControl(t);for(;this.lights.length;)this.lights[0].dispose();for(;this.meshes.length;)this.meshes[0].dispose(!0);for(;this.cameras.length;)this.cameras[0].dispose();for(;this.materials.length;)this.materials[0].dispose();for(;this.particleSystems.length;)this.particleSystems[0].dispose();for(;this.spriteManagers.length;)this.spriteManagers[0].dispose();for(;this.layers.length;)this.layers[0].dispose();for(;this.textures.length;)this.textures[0].dispose();this.postProcessManager.dispose(),this._physicsEngine&&this.disablePhysicsEngine(),e=this._engine.scenes.indexOf(this),this._engine.scenes.splice(e,1),this._engine.wipeCaches()},t.prototype._getNewPosition=function(e,t,i,r,n){e.divideToRef(i.radius,this._scaledPosition),t.divideToRef(i.radius,this._scaledVelocity),i.retry=0,i.initialVelocity=this._scaledVelocity,i.initialPosition=this._scaledPosition,this._collideWithWorld(this._scaledPosition,this._scaledVelocity,i,r,n),n.multiplyInPlace(i.radius)},t.prototype._collideWithWorld=function(t,i,r,n,o){var s=10*e.Engine.CollisionsEpsilon;if(r.retry>=n)return void o.copyFrom(t);r._initialize(t,i,s);for(var a=0;a<this.meshes.length;a++){var h=this.meshes[a];h.isEnabled()&&h.checkCollisions&&h._checkCollision(r)}return r.collisionFound?((0!=i.x||0!=i.y||0!=i.z)&&r._getResponse(t,i),i.length()<=s?void o.copyFrom(t):(r.retry++,void this._collideWithWorld(t,i,r,n,o))):void t.addToRef(i,o)},t.prototype.createOrUpdateSelectionOctree=function(t,i){"undefined"==typeof t&&(t=64),"undefined"==typeof i&&(i=2),this._selectionOctree||(this._selectionOctree=new e.Octree(e.Octree.CreationFuncForMeshes,t,i));for(var r=new e.Vector3(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),n=new e.Vector3(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),o=0;o<this.meshes.length;o++){var s=this.meshes[o];s.computeWorldMatrix(!0);var a=s.getBoundingInfo().boundingBox.minimumWorld,h=s.getBoundingInfo().boundingBox.maximumWorld;e.Tools.CheckExtends(a,r,n),e.Tools.CheckExtends(h,r,n)}return this._selectionOctree.update(r,n,this.meshes),this._selectionOctree},t.prototype.createPickingRay=function(t,i,r,n){var o=this._engine;if(!n){if(!this.activeCamera)throw new Error("Active camera not set");n=this.activeCamera}var s=n.viewport,a=s.toGlobal(o);return t=t/this._engine.getHardwareScalingLevel()-a.x,i=i/this._engine.getHardwareScalingLevel()-(this._engine.getRenderHeight()-a.y-a.height),e.Ray.CreateNew(t,i,a.width,a.height,r?r:e.Matrix.Identity(),n.getViewMatrix(),n.getProjectionMatrix())},t.prototype._internalPick=function(t,i,r){for(var n=null,o=0;o<this.meshes.length;o++){var s=this.meshes[o];if(i){if(!i(s))continue}else if(!s.isEnabled()||!s.isVisible||!s.isPickable)continue;var a=s.getWorldMatrix(),h=t(a),c=s.intersects(h,r);if(c&&c.hit&&(r||null==n||!(c.distance>=n.distance))&&(n=c,r))break}return n||new e.PickingInfo},t.prototype.pick=function(e,t,i,r,n){var o=this;return this._internalPick(function(i){return o.createPickingRay(e,t,i,n)},i,r)},t.prototype.pickWithRay=function(t,i,r){var n=this;return this._internalPick(function(i){return n._pickWithRayInverseMatrix||(n._pickWithRayInverseMatrix=e.Matrix.Identity()),i.invertToRef(n._pickWithRayInverseMatrix),e.Ray.Transform(t,n._pickWithRayInverseMatrix)},i,r)},t.prototype.setPointerOverMesh=function(t){this._pointerOverMesh!==t&&(this._pointerOverMesh&&this._pointerOverMesh.actionManager&&this._pointerOverMesh.actionManager.processTrigger(e.ActionManager.OnPointerOutTrigger,e.ActionEvent.CreateNew(this._pointerOverMesh)),this._pointerOverMesh=t,this._pointerOverMesh&&this._pointerOverMesh.actionManager&&this._pointerOverMesh.actionManager.processTrigger(e.ActionManager.OnPointerOverTrigger,e.ActionEvent.CreateNew(this._pointerOverMesh)))},t.prototype.getPointerOverMesh=function(){return this._pointerOverMesh},t.prototype.getPhysicsEngine=function(){return this._physicsEngine},t.prototype.enablePhysics=function(t,i){return this._physicsEngine?!0:(this._physicsEngine=new e.PhysicsEngine(i),this._physicsEngine.isSupported()?(this._physicsEngine._initialize(t),!0):(this._physicsEngine=null,!1))},t.prototype.disablePhysicsEngine=function(){this._physicsEngine&&(this._physicsEngine.dispose(),this._physicsEngine=void 0)},t.prototype.isPhysicsEnabled=function(){return void 0!==this._physicsEngine},t.prototype.setGravity=function(e){this._physicsEngine&&this._physicsEngine._setGravity(e)},t.prototype.createCompoundImpostor=function(e,t){if(e.parts&&(t=e,e=e.parts),!this._physicsEngine)return null;for(var i=0;i<e.length;i++){var r=e[i].mesh;r._physicImpostor=e[i].impostor,r._physicsMass=t.mass/e.length,r._physicsFriction=t.friction,r._physicRestitution=t.restitution}return this._physicsEngine._registerMeshesAsCompound(e,t)},t.prototype.deleteCompoundImpostor=function(t){for(var i=0;i<t.parts.length;i++){var r=t.parts[i].mesh;r._physicImpostor=e.PhysicsEngine.NoImpostor,this._physicsEngine._unregisterMesh(r)}},t.prototype._getByTags=function(t,i){if(void 0===i)return t;var r=[];for(var n in t){var o=t[n];e.Tags.MatchesQuery(o,i)&&r.push(o)}return r},t.prototype.getMeshesByTags=function(e){return this._getByTags(this.meshes,e)},t.prototype.getCamerasByTags=function(e){return this._getByTags(this.cameras,e)},t.prototype.getLightsByTags=function(e){return this._getByTags(this.lights,e)},t.prototype.getMaterialByTags=function(e){return this._getByTags(this.materials,e).concat(this._getByTags(this.multiMaterials,e))},t.FOGMODE_NONE=0,t.FOGMODE_EXP=1,t.FOGMODE_EXP2=2,t.FOGMODE_LINEAR=3,t}();e.Scene=t}(BABYLON||(BABYLON={}));var BABYLON;!function(e){var t=function(){function t(i,r,n,o,s){switch(this._engine=i instanceof e.Mesh?i.getScene().getEngine():i,this._updatable=o,this._data=r,s||this.create(),this._kind=n,n){case t.PositionKind:this._strideSize=3;break;case t.NormalKind:this._strideSize=3;break;case t.UVKind:this._strideSize=2;break;case t.UV2Kind:this._strideSize=2;break;case t.ColorKind:this._strideSize=3;break;case t.MatricesIndicesKind:this._strideSize=4;break;case t.MatricesWeightsKind:this._strideSize=4}}return t.prototype.isUpdatable=function(){return this._updatable},t.prototype.getData=function(){return this._data},t.prototype.getBuffer=function(){return this._buffer},t.prototype.getStrideSize=function(){return this._strideSize},t.prototype.create=function(e){(e||!this._buffer)&&(e=e||this._data,this._buffer||(this._buffer=this._updatable?this._engine.createDynamicVertexBuffer(4*e.length):this._engine.createVertexBuffer(e)),this._updatable&&(this._engine.updateDynamicVertexBuffer(this._buffer,e),this._data=e))},t.prototype.update=function(e){this.create(e)},t.prototype.dispose=function(){this._buffer&&this._engine._releaseBuffer(this._buffer)&&(this._buffer=null)},Object.defineProperty(t,"PositionKind",{get:function(){return t._PositionKind},enumerable:!0,configurable:!0}),Object.defineProperty(t,"NormalKind",{get:function(){return t._NormalKind},enumerable:!0,configurable:!0}),Object.defineProperty(t,"UVKind",{get:function(){return t._UVKind},enumerable:!0,configurable:!0}),Object.defineProperty(t,"UV2Kind",{get:function(){return t._UV2Kind},enumerable:!0,configurable:!0}),Object.defineProperty(t,"ColorKind",{get:function(){return t._ColorKind},enumerable:!0,configurable:!0}),Object.defineProperty(t,"MatricesIndicesKind",{get:function(){return t._MatricesIndicesKind},enumerable:!0,configurable:!0}),Object.defineProperty(t,"MatricesWeightsKind",{get:function(){return t._MatricesWeightsKind},enumerable:!0,configurable:!0}),t._PositionKind="position",t._NormalKind="normal",t._UVKind="uv",t._UV2Kind="uv2",t._ColorKind="color",t._MatricesIndicesKind="matricesIndices",t._MatricesWeightsKind="matricesWeights",t}();e.VertexBuffer=t}(BABYLON||(BABYLON={}));var __extends=this.__extends||function(e,t){function i(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);i.prototype=t.prototype,e.prototype=new i},BABYLON;!function(e){var t=function(t){function i(e,i){t.call(this,e,i.getScene()),i.instances.push(this),this._sourceMesh=i,this.position.copyFrom(i.position),this.rotation.copyFrom(i.rotation),this.scaling.copyFrom(i.scaling),i.rotationQuaternion&&(this.rotationQuaternion=i.rotationQuaternion.clone()),this.infiniteDistance=i.infiniteDistance,this.setPivotMatrix(i.getPivotMatrix()),this.refreshBoundingInfo(),this._syncSubMeshes()}return __extends(i,t),Object.defineProperty(i.prototype,"receiveShadows",{get:function(){return this._sourceMesh.receiveShadows},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"material",{get:function(){return this._sourceMesh.material},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"visibility",{get:function(){return this._sourceMesh.visibility},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"skeleton",{get:function(){return this._sourceMesh.skeleton},enumerable:!0,configurable:!0}),i.prototype.getTotalVertices=function(){return this._sourceMesh.getTotalVertices()},Object.defineProperty(i.prototype,"sourceMesh",{get:function(){return this._sourceMesh},enumerable:!0,configurable:!0}),i.prototype.getVerticesData=function(e){return this._sourceMesh.getVerticesData(e)},i.prototype.isVerticesDataPresent=function(e){return this._sourceMesh.isVerticesDataPresent(e)},i.prototype.getIndices=function(){return this._sourceMesh.getIndices()},Object.defineProperty(i.prototype,"_positions",{get:function(){return this._sourceMesh._positions},enumerable:!0,configurable:!0}),i.prototype.refreshBoundingInfo=function(){var t=this._sourceMesh.getVerticesData(e.VertexBuffer.PositionKind);if(t){var i=e.Tools.ExtractMinAndMax(t,0,this._sourceMesh.getTotalVertices());this._boundingInfo=new e.BoundingInfo(i.minimum,i.maximum)}this._updateBoundingInfo()},i.prototype._activate=function(e){this.sourceMesh._registerInstanceForRenderId(this,e)},i.prototype._syncSubMeshes=function(){this.releaseSubMeshes();for(var e=0;e<this._sourceMesh.subMeshes.length;e++)this._sourceMesh.subMeshes[e].clone(this,this._sourceMesh)},i.prototype._generatePointsArray=function(){return this._sourceMesh._generatePointsArray()},i.prototype.clone=function(t,i,r){var n=this._sourceMesh.createInstance(t);if(e.Tools.DeepCopy(this,n,["name"],[]),this.refreshBoundingInfo(),i&&(n.parent=i),!r)for(var o=0;o<this.getScene().meshes.length;o++){var s=this.getScene().meshes[o];s.parent==this&&s.clone(s.name,n)}return n.computeWorldMatrix(!0),n},i.prototype.dispose=function(e){var i=this._sourceMesh.instances.indexOf(this);this._sourceMesh.instances.splice(i,1),t.prototype.dispose.call(this,e)},i}(e.AbstractMesh);e.InstancedMesh=t}(BABYLON||(BABYLON={}));var __extends=this.__extends||function(e,t){function i(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);i.prototype=t.prototype,e.prototype=new i},BABYLON;!function(e){var t=function(){function e(){this.mustReturn=!1,this.renderSelf=!0}return e}();e._InstancesBatch=t;var i=function(i){function r(r,n){i.call(this,r,n),this.delayLoadState=e.Engine.DELAYLOADSTATE_NONE,this.instances=new Array,this._onBeforeRenderCallbacks=[],this._visibleInstances={},this._renderIdForInstances=-1,this._batchCache=new t,this._instancesBufferSize=2048}return __extends(r,i),r.prototype.getTotalVertices=function(){return this._geometry?this._geometry.getTotalVertices():0},r.prototype.getVerticesData=function(e){return this._geometry?this._geometry.getVerticesData(e):null},r.prototype.getVertexBuffer=function(e){return this._geometry?this._geometry.getVertexBuffer(e):void 0},r.prototype.isVerticesDataPresent=function(e){return this._geometry?this._geometry.isVerticesDataPresent(e):this._delayInfo?-1!==this._delayInfo.indexOf(e):!1},r.prototype.getVerticesDataKinds=function(){if(!this._geometry){var e=[];if(this._delayInfo)for(var t in this._delayInfo)e.push(t);return e}return this._geometry.getVerticesDataKinds()},r.prototype.getTotalIndices=function(){return this._geometry?this._geometry.getTotalIndices():0},r.prototype.getIndices=function(){return this._geometry?this._geometry.getIndices():[]},r.prototype.isReady=function(){return this.delayLoadState===e.Engine.DELAYLOADSTATE_LOADING?!1:i.prototype.isReady.call(this)},r.prototype.isDisposed=function(){return this._isDisposed},r.prototype._preActivate=function(){this._visibleInstances=null},r.prototype._registerInstanceForRenderId=function(e,t){this._visibleInstances||(this._visibleInstances={},this._visibleInstances.defaultRenderId=t,this._visibleInstances.selfDefaultRenderId=this._renderId),this._visibleInstances[t]||(this._visibleInstances[t]=new Array),this._visibleInstances[t].push(e)},r.prototype.refreshBoundingInfo=function(){var t=this.getVerticesData(e.VertexBuffer.PositionKind);if(t){var i=e.Tools.ExtractMinAndMax(t,0,this.getTotalVertices());this._boundingInfo=new e.BoundingInfo(i.minimum,i.maximum)}if(this.subMeshes)for(var r=0;r<this.subMeshes.length;r++)this.subMeshes[r].refreshBoundingInfo();this._updateBoundingInfo()},r.prototype._createGlobalSubMesh=function(){var t=this.getTotalVertices();return t&&this.getIndices()?(this.releaseSubMeshes(),new e.SubMesh(0,0,t,0,this.getTotalIndices(),this)):null},r.prototype.subdivide=function(t){if(!(1>t)){for(var i=this.getTotalIndices(),r=i/t|0,n=0;r%3!=0;)r++;this.releaseSubMeshes();for(var o=0;t>o&&!(n>=i);o++)e.SubMesh.CreateFromIndices(0,n,Math.min(r,i-n),this),n+=r;this.synchronizeInstances()}},r.prototype.setVerticesData=function(t,i,r){if(t instanceof Array){var n=i;i=t,t=n,e.Tools.Warn("Deprecated usage of setVerticesData detected (since v1.12). Current signature is setVerticesData(kind, data, updatable).")}if(this._geometry)this._geometry.setVerticesData(t,i,r);else{var o=new e.VertexData;o.set(i,t);var s=this.getScene();new e.Geometry(e.Geometry.RandomId(),s,o,r,this)}},r.prototype.updateVerticesData=function(e,t,i,r){this._geometry&&(r?(this.makeGeometryUnique(),this.updateVerticesData(e,t,i,!1)):this._geometry.updateVerticesData(e,t,i))},r.prototype.makeGeometryUnique=function(){if(this._geometry){var t=this._geometry.copy(e.Geometry.RandomId());t.applyToMesh(this)}},r.prototype.setIndices=function(t){if(this._geometry)this._geometry.setIndices(t);else{var i=new e.VertexData;i.indices=t;var r=this.getScene();new e.Geometry(e.Geometry.RandomId(),r,i,!1,this)}},r.prototype._bind=function(e,t,i){var r=this.getScene().getEngine(),n=this._geometry.getIndexBuffer();i&&(n=e.getLinesIndexBuffer(this.getIndices(),r)),r.bindMultiBuffers(this._geometry.getVertexBuffers(),n,t)},r.prototype._draw=function(e,t,i){if(this._geometry&&this._geometry.getVertexBuffers()&&this._geometry.getIndexBuffer()){var r=this.getScene().getEngine();r.draw(t,t?e.indexStart:0,t?e.indexCount:e.linesIndexCount,i)}},r.prototype.registerBeforeRender=function(e){this._onBeforeRenderCallbacks.push(e)},r.prototype.unregisterBeforeRender=function(e){var t=this._onBeforeRenderCallbacks.indexOf(e);t>-1&&this._onBeforeRenderCallbacks.splice(t,1)},r.prototype._getInstancesRenderList=function(){var e=this.getScene();if(this._batchCache.mustReturn=!1,this._batchCache.renderSelf=!0,this._batchCache.visibleInstances=null,this._visibleInstances){var t=e.getRenderId();this._batchCache.visibleInstances=this._visibleInstances[t];var i=this._renderId;if(!this._batchCache.visibleInstances&&this._visibleInstances.defaultRenderId&&(this._batchCache.visibleInstances=this._visibleInstances[this._visibleInstances.defaultRenderId],t=this._visibleInstances.defaultRenderId,i=this._visibleInstances.selfDefaultRenderId),this._batchCache.visibleInstances&&this._batchCache.visibleInstances.length){if(this._renderIdForInstances===t)return this._batchCache.mustReturn=!0,this._batchCache;t!==i&&(this._batchCache.renderSelf=!1)}this._renderIdForInstances=t}return this._batchCache},r.prototype._renderWithInstances=function(e,t,i,r,n){for(var o=this.instances.length+1,s=16*o*4;this._instancesBufferSize<s;)this._instancesBufferSize*=2;(!this._worldMatricesInstancesBuffer||this._worldMatricesInstancesBuffer.capacity<this._instancesBufferSize)&&(this._worldMatricesInstancesBuffer&&n.deleteInstancesBuffer(this._worldMatricesInstancesBuffer),this._worldMatricesInstancesBuffer=n.createInstancesBuffer(this._instancesBufferSize),this._worldMatricesInstancesArray=new Float32Array(this._instancesBufferSize/4));var a=0,h=0,c=this.getWorldMatrix();i.renderSelf&&(c.copyToArray(this._worldMatricesInstancesArray,a),a+=16,h++);for(var u=0;u<i.visibleInstances.length;u++){var l=i.visibleInstances[u];l.getWorldMatrix().copyToArray(this._worldMatricesInstancesArray,a),a+=16,h++}var f=r.getAttributeLocationByName("world0"),d=r.getAttributeLocationByName("world1"),p=r.getAttributeLocationByName("world2"),m=r.getAttributeLocationByName("world3"),_=[f,d,p,m];n.updateAndBindInstancesBuffer(this._worldMatricesInstancesBuffer,this._worldMatricesInstancesArray,_),this._draw(e,!t,h),n.unBindInstancesBuffer(this._worldMatricesInstancesBuffer,_)},r.prototype.render=function(e){var t=this.getScene(),i=this._getInstancesRenderList();if(!i.mustReturn&&this._geometry&&this._geometry.getVertexBuffers()&&this._geometry.getIndexBuffer()){for(var r=0;r<this._onBeforeRenderCallbacks.length;r++)this._onBeforeRenderCallbacks[r]();var n=t.getEngine(),o=null!==n.getCaps().instancedArrays&&null!==i.visibleInstances,s=e.getMaterial();if(s&&s.isReady(this,o)){s._preBind();var a=s.getEffect(),h=n.forceWireframe||s.wireframe;this._bind(e,a,h);var c=this.getWorldMatrix();if(s.bind(c,this),o)this._renderWithInstances(e,h,i,a,n);else if(i.renderSelf&&this._draw(e,!h),i.visibleInstances)for(var u=0;u<i.visibleInstances.length;u++){var l=i.visibleInstances[u];c=l.getWorldMatrix(),s.bindOnlyWorldMatrix(c),this._draw(e,!h)}s.unbind()}}},r.prototype.getEmittedParticleSystems=function(){for(var e=new Array,t=0;t<this.getScene().particleSystems.length;t++){var i=this.getScene().particleSystems[t];i.emitter===this&&e.push(i)}return e},r.prototype.getHierarchyEmittedParticleSystems=function(){var e=new Array,t=this.getDescendants();t.push(this);for(var i=0;i<this.getScene().particleSystems.length;i++){var r=this.getScene().particleSystems[i];-1!==t.indexOf(r.emitter)&&e.push(r)}return e},r.prototype.getChildren=function(){for(var e=[],t=0;t<this.getScene().meshes.length;t++){var i=this.getScene().meshes[t];i.parent==this&&e.push(i)}return e},r.prototype._checkDelayState=function(){var t=this,i=this,r=this.getScene();this._geometry?this._geometry.load(r):i.delayLoadState===e.Engine.DELAYLOADSTATE_NOTLOADED&&(i.delayLoadState=e.Engine.DELAYLOADSTATE_LOADING,r._addPendingData(i),e.Tools.LoadFile(this.delayLoadingFile,function(i){t._delayLoadingFunction(JSON.parse(i),t),t.delayLoadState=e.Engine.DELAYLOADSTATE_LOADED,r._removePendingData(t)},function(){},r.database))},r.prototype.isInFrustum=function(t){return this.delayLoadState===e.Engine.DELAYLOADSTATE_LOADING?!1:i.prototype.isInFrustum.call(this,t)?(this._checkDelayState(),!0):!1},r.prototype.setMaterialByID=function(e){for(var t=this.getScene().materials,i=0;i<t.length;i++)if(t[i].id==e)return void(this.material=t[i]);var r=this.getScene().multiMaterials;for(i=0;i<r.length;i++)if(r[i].id==e)return void(this.material=r[i])},r.prototype.getAnimatables=function(){var e=[];return this.material&&e.push(this.material),e},r.prototype.bakeTransformIntoVertices=function(t){if(this.isVerticesDataPresent(e.VertexBuffer.PositionKind)){this._resetPointsArrayCache();for(var i=this.getVerticesData(e.VertexBuffer.PositionKind),r=[],n=0;n<i.length;n+=3)e.Vector3.TransformCoordinates(e.Vector3.FromArray(i,n),t).toArray(r,n);if(this.setVerticesData(e.VertexBuffer.PositionKind,r,this.getVertexBuffer(e.VertexBuffer.PositionKind).isUpdatable()),this.isVerticesDataPresent(e.VertexBuffer.NormalKind)){for(i=this.getVerticesData(e.VertexBuffer.NormalKind),n=0;n<i.length;n+=3)e.Vector3.TransformNormal(e.Vector3.FromArray(i,n),t).toArray(r,n);this.setVerticesData(e.VertexBuffer.NormalKind,r,this.getVertexBuffer(e.VertexBuffer.NormalKind).isUpdatable())}}},r.prototype._resetPointsArrayCache=function(){this._positions=null},r.prototype._generatePointsArray=function(){if(this._positions)return!0;this._positions=[];var t=this.getVerticesData(e.VertexBuffer.PositionKind);if(!t)return!1;for(var i=0;i<t.length;i+=3)this._positions.push(e.Vector3.FromArray(t,i));return!0},r.prototype.clone=function(t,i,r){var n=new e.Mesh(t,this.getScene());if(this._geometry.applyToMesh(n),e.Tools.DeepCopy(this,n,["name","material","skeleton"],[]),n.material=this.material,i&&(n.parent=i),!r)for(var o=0;o<this.getScene().meshes.length;o++){var s=this.getScene().meshes[o];s.parent==this&&s.clone(s.name,n)}for(o=0;o<this.getScene().particleSystems.length;o++){var a=this.getScene().particleSystems[o];a.emitter==this&&a.clone(a.name,n)}return n.computeWorldMatrix(!0),n},r.prototype.dispose=function(e){for(this._geometry&&this._geometry.releaseForMesh(this,!0),this._worldMatricesInstancesBuffer&&(this.getEngine().deleteInstancesBuffer(this._worldMatricesInstancesBuffer),this._worldMatricesInstancesBuffer=null);this.instances.length;)this.instances[0].dispose();i.prototype.dispose.call(this,e)},r.prototype.convertToFlatShadedMesh=function(){for(var t=this.getVerticesDataKinds(),i=[],r=[],n=[],o=!1,s=0;s<t.length;s++){var a=t[s],h=this.getVertexBuffer(a);a!==e.VertexBuffer.NormalKind?(i[a]=h,r[a]=i[a].getData(),n[a]=[]):(o=h.isUpdatable(),t.splice(s,1),s--)}var c=this.subMeshes.slice(0),u=this.getIndices(),l=this.getTotalIndices();for(g=0;l>g;g++){var f=u[g];for(s=0;s<t.length;s++){a=t[s];for(var d=i[a].getStrideSize(),p=0;d>p;p++)n[a].push(r[a][f*d+p])}}for(var m=[],_=n[e.VertexBuffer.PositionKind],g=0;l>g;g+=3){u[g]=g,u[g+1]=g+1,u[g+2]=g+2;for(var v=e.Vector3.FromArray(_,3*g),y=e.Vector3.FromArray(_,3*(g+1)),x=e.Vector3.FromArray(_,3*(g+2)),A=v.subtract(y),B=x.subtract(y),T=e.Vector3.Normalize(e.Vector3.Cross(A,B)),b=0;3>b;b++)m.push(T.x),m.push(T.y),m.push(T.z)
}for(this.setIndices(u),this.setVerticesData(e.VertexBuffer.NormalKind,m,o),s=0;s<t.length;s++)a=t[s],this.setVerticesData(a,n[a],i[a].isUpdatable());this.releaseSubMeshes();for(var M=0;M<c.length;M++){var L=c[M];new e.SubMesh(L.materialIndex,L.indexStart,L.indexCount,L.indexStart,L.indexCount,this)}this.synchronizeInstances()},r.prototype.createInstance=function(t){return new e.InstancedMesh(t,this)},r.prototype.synchronizeInstances=function(){for(var e=0;e<this.instances.length;e++){var t=this.instances[e];t._syncSubMeshes()}},r.CreateBox=function(t,i,r,n){var o=new e.Mesh(t,r),s=e.VertexData.CreateBox(i);return s.applyToMesh(o,n),o},r.CreateSphere=function(t,i,r,n,o){var s=new e.Mesh(t,n),a=e.VertexData.CreateSphere(i,r);return a.applyToMesh(s,o),s},r.CreateCylinder=function(t,i,r,n,o,s,a){var h=new e.Mesh(t,s),c=e.VertexData.CreateCylinder(i,r,n,o);return c.applyToMesh(h,a),h},r.CreateTorus=function(t,i,r,n,o,s){var a=new e.Mesh(t,o),h=e.VertexData.CreateTorus(i,r,n);return h.applyToMesh(a,s),a},r.CreateTorusKnot=function(t,i,r,n,o,s,a,h,c){var u=new e.Mesh(t,h),l=e.VertexData.CreateTorusKnot(i,r,n,o,s,a);return l.applyToMesh(u,c),u},r.CreatePlane=function(t,i,r,n){var o=new e.Mesh(t,r),s=e.VertexData.CreatePlane(i);return s.applyToMesh(o,n),o},r.CreateGround=function(t,i,r,n,o,s){var a=new e.GroundMesh(t,o);a._setReady(!1),a._subdivisions=n;var h=e.VertexData.CreateGround(i,r,n);return h.applyToMesh(a,s),a._setReady(!0),a},r.CreateGroundFromHeightMap=function(t,i,r,n,o,s,a,h,c){var u=new e.GroundMesh(t,h);u._subdivisions=o,u._setReady(!1);var l=function(t){var i=document.createElement("canvas"),h=i.getContext("2d"),l=t.width,f=t.height;i.width=l,i.height=f,h.drawImage(t,0,0);var d=h.getImageData(0,0,l,f).data,p=e.VertexData.CreateGroundFromHeightMap(r,n,o,s,a,d,l,f);p.applyToMesh(u,c),u._setReady(!0)};return e.Tools.LoadImage(i,l,function(){},h.database),u},r.MinMax=function(e){var t=null,i=null;for(var r in e){var n=e[r],o=n.getBoundingInfo().boundingBox;t?(t.MinimizeInPlace(o.minimumWorld),i.MaximizeInPlace(o.maximumWorld)):(t=o.minimumWorld,i=o.maximumWorld)}return{min:t,max:i}},r.Center=function(t){var i=void 0!==t.min?t:e.Mesh.MinMax(t);return e.Vector3.Center(i.min,i.max)},r}(e.AbstractMesh);e.Mesh=i}(BABYLON||(BABYLON={}));var BABYLON;!function(e){var t=function(){function t(e,t,i,r,n,o,s,a){"undefined"==typeof a&&(a=!0),this.materialIndex=e,this.verticesStart=t,this.verticesCount=i,this.indexStart=r,this.indexCount=n,this._renderId=0,this._mesh=o,this._renderingMesh=s||o,o.subMeshes.push(this),a&&this.refreshBoundingInfo()}return t.prototype.getBoundingInfo=function(){return this._boundingInfo},t.prototype.getMesh=function(){return this._mesh},t.prototype.getRenderingMesh=function(){return this._renderingMesh},t.prototype.getMaterial=function(){var t=this._renderingMesh.material;if(t&&t instanceof e.MultiMaterial){var i=t;return i.getSubMaterial(this.materialIndex)}return t?t:this._mesh.getScene().defaultMaterial},t.prototype.refreshBoundingInfo=function(){var t=this._renderingMesh.getVerticesData(e.VertexBuffer.PositionKind);if(!t)return void(this._boundingInfo=this._mesh._boundingInfo);var i,r=this._renderingMesh.getIndices();i=0===this.indexStart&&this.indexCount===r.length?e.Tools.ExtractMinAndMax(t,this.verticesStart,this.verticesCount):e.Tools.ExtractMinAndMaxIndexed(t,r,this.indexStart,this.indexCount),this._boundingInfo=new e.BoundingInfo(i.minimum,i.maximum)},t.prototype._checkCollision=function(e){return this._boundingInfo._checkCollision(e)},t.prototype.updateBoundingInfo=function(e){this._boundingInfo||this.refreshBoundingInfo(),this._boundingInfo._update(e)},t.prototype.isInFrustum=function(e){return this._boundingInfo.isInFrustum(e)},t.prototype.render=function(){this._renderingMesh.render(this)},t.prototype.getLinesIndexBuffer=function(e,t){if(!this._linesIndexBuffer){for(var i=[],r=this.indexStart;r<this.indexStart+this.indexCount;r+=3)i.push(e[r],e[r+1],e[r+1],e[r+2],e[r+2],e[r]);this._linesIndexBuffer=t.createIndexBuffer(i),this.linesIndexCount=i.length}return this._linesIndexBuffer},t.prototype.canIntersects=function(e){return e.intersectsBox(this._boundingInfo.boundingBox)},t.prototype.intersects=function(e,t,i,r){for(var n=null,o=this.indexStart;o<this.indexStart+this.indexCount;o+=3){var s=t[i[o]],a=t[i[o+1]],h=t[i[o+2]],c=e.intersectsTriangle(s,a,h);if(c&&(r||!n||c.distance<n.distance)&&(n=c,n.faceId=o/3,r))break}return n},t.prototype.clone=function(i,r){var n=new t(this.materialIndex,this.verticesStart,this.verticesCount,this.indexStart,this.indexCount,i,r,!1);return n._boundingInfo=new e.BoundingInfo(this._boundingInfo.minimum,this._boundingInfo.maximum),n},t.prototype.dispose=function(){this._linesIndexBuffer&&(this._mesh.getScene().getEngine()._releaseBuffer(this._linesIndexBuffer),this._linesIndexBuffer=null);var e=this._mesh.subMeshes.indexOf(this);this._mesh.subMeshes.splice(e,1)},t.CreateFromIndices=function(t,i,r,n,o){var s=Number.MAX_VALUE,a=-Number.MAX_VALUE;o=o||n;for(var h=o.getIndices(),c=i;i+r>c;c++){var u=h[c];s>u?s=u:u>a&&(a=u)}return new e.SubMesh(t,s,a-s+1,i,r,n,o)},t}();e.SubMesh=t}(BABYLON||(BABYLON={}));var BABYLON;!function(e){var t=function(){function t(t){this.delayLoadState=e.Engine.DELAYLOADSTATE_NONE,this.hasAlpha=!1,this.getAlphaFromRGB=!1,this.level=1,this.isCube=!1,this.isRenderTarget=!1,this.animations=new Array,this.coordinatesIndex=0,this.coordinatesMode=e.Texture.EXPLICIT_MODE,this.wrapU=e.Texture.WRAP_ADDRESSMODE,this.wrapV=e.Texture.WRAP_ADDRESSMODE,this.anisotropicFilteringLevel=4,this._scene=t,this._scene.textures.push(this)}return t.prototype.getScene=function(){return this._scene},t.prototype.getTextureMatrix=function(){return null},t.prototype.getReflectionTextureMatrix=function(){return null},t.prototype.getInternalTexture=function(){return this._texture},t.prototype.isReady=function(){return this.delayLoadState===e.Engine.DELAYLOADSTATE_NOTLOADED?!0:this._texture?this._texture.isReady:!1},t.prototype.getSize=function(){return this._texture._width?{width:this._texture._width,height:this._texture._height}:this._texture._size?{width:this._texture._size,height:this._texture._size}:{width:0,height:0}},t.prototype.getBaseSize=function(){return this.isReady()?this._texture._size?{width:this._texture._size,height:this._texture._size}:{width:this._texture._baseWidth,height:this._texture._baseHeight}:{width:0,height:0}},t.prototype._getFromCache=function(e,t){for(var i=this._scene.getEngine().getLoadedTexturesCache(),r=0;r<i.length;r++){var n=i[r];if(n.url===e&&n.noMipmap===t)return n.references++,n}return null},t.prototype.delayLoad=function(){},t.prototype.releaseInternalTexture=function(){if(this._texture){var e=this._scene.getEngine().getLoadedTexturesCache();if(this._texture.references--,0==this._texture.references){var t=e.indexOf(this._texture);e.splice(t,1),this._scene.getEngine()._releaseTexture(this._texture),delete this._texture}}},t.prototype.clone=function(){return null},t.prototype.dispose=function(){var e=this._scene.textures.indexOf(this);e>=0&&this._scene.textures.splice(e,1),void 0!==this._texture&&(this.releaseInternalTexture(),this.onDispose&&this.onDispose())},t}();e.BaseTexture=t}(BABYLON||(BABYLON={}));var __extends=this.__extends||function(e,t){function i(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);i.prototype=t.prototype,e.prototype=new i},BABYLON;!function(e){var t=function(t){function i(r,n,o,s,a){"undefined"==typeof a&&(a=i.TRILINEAR_SAMPLINGMODE),t.call(this,n),this.uOffset=0,this.vOffset=0,this.uScale=1,this.vScale=1,this.uAng=0,this.vAng=0,this.wAng=0,this.name=r,this.url=r,this._noMipmap=o,this._invertY=s,this._samplingMode=a,r&&(this._texture=this._getFromCache(r,o),this._texture||(n.useDelayedTextureLoading?this.delayLoadState=e.Engine.DELAYLOADSTATE_NOTLOADED:this._texture=n.getEngine().createTexture(r,o,s,n,this._samplingMode)))}return __extends(i,t),i.prototype.delayLoad=function(){this.delayLoadState==e.Engine.DELAYLOADSTATE_NOTLOADED&&(this.delayLoadState=e.Engine.DELAYLOADSTATE_LOADED,this._texture=this._getFromCache(this.url,this._noMipmap),this._texture||(this._texture=this.getScene().getEngine().createTexture(this.url,this._noMipmap,this._invertY,this.getScene(),this._samplingMode)))},i.prototype._prepareRowForTextureGeneration=function(t,i,r,n){t-=this.uOffset+.5,i-=this.vOffset+.5,r-=.5,e.Vector3.TransformCoordinatesFromFloatsToRef(t,i,r,this._rowGenerationMatrix,n),n.x*=this.uScale,n.y*=this.vScale,n.x+=.5,n.y+=.5,n.z+=.5},i.prototype.getTextureMatrix=function(){return this.uOffset===this._cachedUOffset&&this.vOffset===this._cachedVOffset&&this.uScale===this._cachedUScale&&this.vScale===this._cachedVScale&&this.uAng===this._cachedUAng&&this.vAng===this._cachedVAng&&this.wAng===this._cachedWAng?this._cachedTextureMatrix:(this._cachedUOffset=this.uOffset,this._cachedVOffset=this.vOffset,this._cachedUScale=this.uScale,this._cachedVScale=this.vScale,this._cachedUAng=this.uAng,this._cachedVAng=this.vAng,this._cachedWAng=this.wAng,this._cachedTextureMatrix||(this._cachedTextureMatrix=e.Matrix.Zero(),this._rowGenerationMatrix=new e.Matrix,this._t0=e.Vector3.Zero(),this._t1=e.Vector3.Zero(),this._t2=e.Vector3.Zero()),e.Matrix.RotationYawPitchRollToRef(this.vAng,this.uAng,this.wAng,this._rowGenerationMatrix),this._prepareRowForTextureGeneration(0,0,0,this._t0),this._prepareRowForTextureGeneration(1,0,0,this._t1),this._prepareRowForTextureGeneration(0,1,0,this._t2),this._t1.subtractInPlace(this._t0),this._t2.subtractInPlace(this._t0),e.Matrix.IdentityToRef(this._cachedTextureMatrix),this._cachedTextureMatrix.m[0]=this._t1.x,this._cachedTextureMatrix.m[1]=this._t1.y,this._cachedTextureMatrix.m[2]=this._t1.z,this._cachedTextureMatrix.m[4]=this._t2.x,this._cachedTextureMatrix.m[5]=this._t2.y,this._cachedTextureMatrix.m[6]=this._t2.z,this._cachedTextureMatrix.m[8]=this._t0.x,this._cachedTextureMatrix.m[9]=this._t0.y,this._cachedTextureMatrix.m[10]=this._t0.z,this._cachedTextureMatrix)},i.prototype.getReflectionTextureMatrix=function(){if(this.uOffset===this._cachedUOffset&&this.vOffset===this._cachedVOffset&&this.uScale===this._cachedUScale&&this.vScale===this._cachedVScale&&this.coordinatesMode===this._cachedCoordinatesMode)return this._cachedTextureMatrix;switch(this._cachedTextureMatrix||(this._cachedTextureMatrix=e.Matrix.Zero(),this._projectionModeMatrix=e.Matrix.Zero()),this.coordinatesMode){case e.Texture.SPHERICAL_MODE:e.Matrix.IdentityToRef(this._cachedTextureMatrix),this._cachedTextureMatrix[0]=-.5*this.uScale,this._cachedTextureMatrix[5]=-.5*this.vScale,this._cachedTextureMatrix[12]=.5+this.uOffset,this._cachedTextureMatrix[13]=.5+this.vOffset;break;case e.Texture.PLANAR_MODE:e.Matrix.IdentityToRef(this._cachedTextureMatrix),this._cachedTextureMatrix[0]=this.uScale,this._cachedTextureMatrix[5]=this.vScale,this._cachedTextureMatrix[12]=this.uOffset,this._cachedTextureMatrix[13]=this.vOffset;break;case e.Texture.PROJECTION_MODE:e.Matrix.IdentityToRef(this._projectionModeMatrix),this._projectionModeMatrix.m[0]=.5,this._projectionModeMatrix.m[5]=-.5,this._projectionModeMatrix.m[10]=0,this._projectionModeMatrix.m[12]=.5,this._projectionModeMatrix.m[13]=.5,this._projectionModeMatrix.m[14]=1,this._projectionModeMatrix.m[15]=1,this.getScene().getProjectionMatrix().multiplyToRef(this._projectionModeMatrix,this._cachedTextureMatrix);break;default:e.Matrix.IdentityToRef(this._cachedTextureMatrix)}return this._cachedTextureMatrix},i.prototype.clone=function(){var t=new e.Texture(this._texture.url,this.getScene(),this._noMipmap,this._invertY);return t.hasAlpha=this.hasAlpha,t.level=this.level,t.wrapU=this.wrapU,t.wrapV=this.wrapV,t.coordinatesIndex=this.coordinatesIndex,t.coordinatesMode=this.coordinatesMode,t.uOffset=this.uOffset,t.vOffset=this.vOffset,t.uScale=this.uScale,t.vScale=this.vScale,t.uAng=this.uAng,t.vAng=this.vAng,t.wAng=this.wAng,t},i.NEAREST_SAMPLINGMODE=1,i.BILINEAR_SAMPLINGMODE=2,i.TRILINEAR_SAMPLINGMODE=3,i.EXPLICIT_MODE=0,i.SPHERICAL_MODE=1,i.PLANAR_MODE=2,i.CUBIC_MODE=3,i.PROJECTION_MODE=4,i.SKYBOX_MODE=5,i.CLAMP_ADDRESSMODE=0,i.WRAP_ADDRESSMODE=1,i.MIRROR_ADDRESSMODE=2,i}(e.BaseTexture);e.Texture=t}(BABYLON||(BABYLON={}));var __extends=this.__extends||function(e,t){function i(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);i.prototype=t.prototype,e.prototype=new i},BABYLON;!function(e){var t=function(t){function i(i,r,n,o){t.call(this,r),this.coordinatesMode=e.Texture.CUBIC_MODE,this.name=i,this.url=i,this._noMipmap=o,this.hasAlpha=!1,this._texture=this._getFromCache(i,o),n||(n=["_px.jpg","_py.jpg","_pz.jpg","_nx.jpg","_ny.jpg","_nz.jpg"]),this._extensions=n,this._texture||(r.useDelayedTextureLoading?this.delayLoadState=e.Engine.DELAYLOADSTATE_NOTLOADED:this._texture=r.getEngine().createCubeTexture(i,r,n,o)),this.isCube=!0,this._textureMatrix=e.Matrix.Identity()}return __extends(i,t),i.prototype.clone=function(){var t=new e.CubeTexture(this.url,this.getScene(),this._extensions,this._noMipmap);return t.level=this.level,t.wrapU=this.wrapU,t.wrapV=this.wrapV,t.coordinatesIndex=this.coordinatesIndex,t.coordinatesMode=this.coordinatesMode,t},i.prototype.delayLoad=function(){this.delayLoadState==e.Engine.DELAYLOADSTATE_NOTLOADED&&(this.delayLoadState=e.Engine.DELAYLOADSTATE_LOADED,this._texture=this._getFromCache(this.url,this._noMipmap),this._texture||(this._texture=this.getScene().getEngine().createCubeTexture(this.url,this.getScene(),this._extensions)))},i.prototype.getReflectionTextureMatrix=function(){return this._textureMatrix},i}(e.BaseTexture);e.CubeTexture=t}(BABYLON||(BABYLON={}));var __extends=this.__extends||function(e,t){function i(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);i.prototype=t.prototype,e.prototype=new i},BABYLON;!function(e){var t=function(t){function i(i,r,n,o,s){"undefined"==typeof s&&(s=!0),t.call(this,null,n,!o),this.renderList=new Array,this.renderParticles=!0,this.renderSprites=!1,this.coordinatesMode=e.Texture.PROJECTION_MODE,this._currentRefreshId=-1,this._refreshRate=1,this.name=i,this.isRenderTarget=!0,this._size=r,this._generateMipMaps=o,this._doNotChangeAspectRatio=s,this._texture=n.getEngine().createRenderTargetTexture(r,o),this._renderingManager=new e.RenderingManager(n)}return __extends(i,t),i.prototype.resetRefreshCounter=function(){this._currentRefreshId=-1},Object.defineProperty(i.prototype,"refreshRate",{get:function(){return this._refreshRate},set:function(e){this._refreshRate=e,this.resetRefreshCounter()},enumerable:!0,configurable:!0}),i.prototype._shouldRender=function(){return-1===this._currentRefreshId?(this._currentRefreshId=1,!0):this.refreshRate==this._currentRefreshId?(this._currentRefreshId=1,!0):(this._currentRefreshId++,!1)},i.prototype.getRenderSize=function(){return this._size},i.prototype.resize=function(e,t){this.releaseInternalTexture(),this._texture=this.getScene().getEngine().createRenderTargetTexture(e,t)},i.prototype.render=function(e){var t=this.getScene(),i=t.getEngine();if(this._waitingRenderList){this.renderList=[];for(var r=0;r<this._waitingRenderList.length;r++){var n=this._waitingRenderList[r];this.renderList.push(t.getMeshByID(n))}delete this._waitingRenderList}if(this.renderList&&0!=this.renderList.length){e&&t.postProcessManager._prepareFrame(this._texture)||i.bindFramebuffer(this._texture),i.clear(t.clearColor,!0,!0),this._renderingManager.reset();for(var o=0;o<this.renderList.length;o++){var s=this.renderList[o];if(s){if(!s.isReady()||s.material&&!s.material.isReady()){this.resetRefreshCounter();continue}if(s.isEnabled()&&s.isVisible&&s.subMeshes&&0!=(s.layerMask&t.activeCamera.layerMask)){s._activate(t.getRenderId());for(var a=0;a<s.subMeshes.length;a++){var h=s.subMeshes[a];t._activeVertices+=h.verticesCount,this._renderingManager.dispatch(h)}}}}this._doNotChangeAspectRatio||t.updateTransformMatrix(!0),this.onBeforeRender&&this.onBeforeRender(),this._renderingManager.render(this.customRenderFunction,this.renderList,this.renderParticles,this.renderSprites),e&&t.postProcessManager._finalizeFrame(!1,this._texture),this.onAfterRender&&this.onAfterRender(),i.unBindFramebuffer(this._texture),this._doNotChangeAspectRatio||t.updateTransformMatrix(!0)}},i.prototype.clone=function(){var t=this.getSize(),i=new e.RenderTargetTexture(this.name,t.width,this.getScene(),this._generateMipMaps);return i.hasAlpha=this.hasAlpha,i.level=this.level,i.coordinatesMode=this.coordinatesMode,i.renderList=this.renderList.slice(0),i},i}(e.Texture);e.RenderTargetTexture=t}(BABYLON||(BABYLON={}));var __extends=this.__extends||function(e,t){function i(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);i.prototype=t.prototype,e.prototype=new i},BABYLON;!function(e){var t=function(t){function i(i,r,n,o){var s=this;t.call(this,i,r,n,o,!0),this.mirrorPlane=new e.Plane(0,1,0,1),this._transformMatrix=e.Matrix.Zero(),this._mirrorMatrix=e.Matrix.Zero(),this.onBeforeRender=function(){e.Matrix.ReflectionToRef(s.mirrorPlane,s._mirrorMatrix),s._savedViewMatrix=n.getViewMatrix(),s._mirrorMatrix.multiplyToRef(s._savedViewMatrix,s._transformMatrix),n.setTransformMatrix(s._transformMatrix,n.getProjectionMatrix()),n.clipPlane=s.mirrorPlane,n.getEngine().cullBackFaces=!1},this.onAfterRender=function(){n.setTransformMatrix(s._savedViewMatrix,n.getProjectionMatrix()),n.getEngine().cullBackFaces=!0,delete n.clipPlane}}return __extends(i,t),i.prototype.clone=function(){var t=this.getSize(),i=new e.MirrorTexture(this.name,t.width,this.getScene(),this._generateMipMaps);return i.hasAlpha=this.hasAlpha,i.level=this.level,i.mirrorPlane=this.mirrorPlane.clone(),i.renderList=this.renderList.slice(0),i},i}(e.RenderTargetTexture);e.MirrorTexture=t}(BABYLON||(BABYLON={}));var __extends=this.__extends||function(e,t){function i(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);i.prototype=t.prototype,e.prototype=new i},BABYLON;!function(e){var t=function(t){function i(i,r,n,o,s){"undefined"==typeof s&&(s=e.Texture.TRILINEAR_SAMPLINGMODE),t.call(this,null,n,!o),this.name=i,this.wrapU=e.Texture.CLAMP_ADDRESSMODE,this.wrapV=e.Texture.CLAMP_ADDRESSMODE,this._generateMipMaps=o,r.getContext?(this._canvas=r,this._texture=n.getEngine().createDynamicTexture(r.width,r.height,o,s)):(this._canvas=document.createElement("canvas"),this._texture=r.width?n.getEngine().createDynamicTexture(r.width,r.height,o,s):n.getEngine().createDynamicTexture(r,r,o,s));var a=this.getSize();this._canvas.width=a.width,this._canvas.height=a.height,this._context=this._canvas.getContext("2d")}return __extends(i,t),i.prototype.getContext=function(){return this._context},i.prototype.update=function(e){this.getScene().getEngine().updateDynamicTexture(this._texture,this._canvas,void 0===e?!0:e)},i.prototype.drawText=function(e,t,i,r,n,o,s){var a=this.getSize();if(o&&(this._context.fillStyle=o,this._context.fillRect(0,0,a.width,a.height)),this._context.font=r,null===t){var h=this._context.measureText(e);t=(a.width-h.width)/2}this._context.fillStyle=n,this._context.fillText(e,t,i),this.update(s)},i.prototype.clone=function(){var t=this.getSize(),i=new e.DynamicTexture(this.name,t.width,this.getScene(),this._generateMipMaps);return i.hasAlpha=this.hasAlpha,i.level=this.level,i.wrapU=this.wrapU,i.wrapV=this.wrapV,i},i}(e.Texture);e.DynamicTexture=t}(BABYLON||(BABYLON={}));var __extends=this.__extends||function(e,t){function i(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);i.prototype=t.prototype,e.prototype=new i},BABYLON;!function(e){var t=function(t){function i(i,r,n,o,s,a,h){"undefined"==typeof h&&(h=e.Texture.TRILINEAR_SAMPLINGMODE);var c=this;t.call(this,null,o,!s,a),this._autoLaunch=!0,this.name=i,this.wrapU=e.Texture.WRAP_ADDRESSMODE,this.wrapV=e.Texture.WRAP_ADDRESSMODE;var u=n.width||n,l=n.height||n;this._texture=o.getEngine().createDynamicTexture(u,l,s,h);var f=this.getSize();this.video=document.createElement("video"),this.video.width=f.width,this.video.height=f.height,this.video.autoplay=!1,this.video.loop=!0,this.video.addEventListener("canplaythrough",function(){c._texture&&(c._texture.isReady=!0)}),r.forEach(function(e){var t=document.createElement("source");t.src=e,c.video.appendChild(t)}),this._lastUpdate=(new Date).getTime()}return __extends(i,t),i.prototype.update=function(){this._autoLaunch&&(this._autoLaunch=!1,this.video.play());var e=(new Date).getTime();return e-this._lastUpdate<15?!1:(this._lastUpdate=e,this.getScene().getEngine().updateVideoTexture(this._texture,this.video,this._invertY),!0)},i}(e.Texture);e.VideoTexture=t}(BABYLON||(BABYLON={}));var BABYLON;!function(e){var t=function(){function t(e,t,i,r,n,o,s,a,h){var c=this;this._isReady=!1,this._compilationError="",this._valueCache=[],this._engine=n,this.name=e,this.defines=o,this._uniformsNames=i.concat(r),this._samplers=r,this._attributesNames=t,this.onError=h,this.onCompiled=a;var u,l;e.vertexElement?(u=document.getElementById(e.vertexElement),l=document.getElementById(e.fragmentElement)):(u=e.vertexElement||e.vertex||e,l=e.fragmentElement||e.fragment||e),this._loadVertexShader(u,function(e){c._loadFragmentShader(l,function(i){c._prepareEffect(e,i,t,o,s)})})}return t.prototype.isReady=function(){return this._isReady},t.prototype.getProgram=function(){return this._program},t.prototype.getAttributesNames=function(){return this._attributesNames},t.prototype.getAttributeLocation=function(e){return this._attributes[e]},t.prototype.getAttributeLocationByName=function(e){var t=this._attributesNames.indexOf(e);return this._attributes[t]},t.prototype.getAttributesCount=function(){return this._attributes.length},t.prototype.getUniformIndex=function(e){return this._uniformsNames.indexOf(e)},t.prototype.getUniform=function(e){return this._uniforms[this._uniformsNames.indexOf(e)]},t.prototype.getSamplers=function(){return this._samplers},t.prototype.getCompilationError=function(){return this._compilationError},t.prototype._loadVertexShader=function(t,i){if(t instanceof HTMLElement){var r=e.Tools.GetDOMTextContent(t);return void i(r)}if(e.Effect.ShadersStore[t+"VertexShader"])return void i(e.Effect.ShadersStore[t+"VertexShader"]);var n;n="."===t[0]?t:e.Engine.ShadersRepository+t,e.Tools.LoadFile(n+".vertex.fx",i)},t.prototype._loadFragmentShader=function(t,i){if(t instanceof HTMLElement){var r=e.Tools.GetDOMTextContent(t);return void i(r)}if(e.Effect.ShadersStore[t+"PixelShader"])return void i(e.Effect.ShadersStore[t+"PixelShader"]);var n;n="."===t[0]?t:e.Engine.ShadersRepository+t,e.Tools.LoadFile(n+".fragment.fx",i)},t.prototype._prepareEffect=function(t,i,r,n,o,s){try{var a=this._engine;this._program=a.createShaderProgram(t,i,n),this._uniforms=a.getUniforms(this._program,this._uniformsNames),this._attributes=a.getAttributes(this._program,r);for(var h=0;h<this._samplers.length;h++){var c=this.getUniform(this._samplers[h]);null==c&&(this._samplers.splice(h,1),h--)}a.bindSamplers(this),this._isReady=!0,this.onCompiled&&this.onCompiled(this)}catch(u){if(!s&&o){for(h=0;h<o.length;h++)n=n.replace(o[h],"");this._prepareEffect(t,i,r,n,o,!0)}else e.Tools.Error("Unable to compile effect: "+this.name),e.Tools.Error("Defines: "+n),e.Tools.Error("Optional defines: "+o),e.Tools.Error("Error: "+u.message),this._compilationError=u.message,this.onError&&this.onError(this,this._compilationError)}},t.prototype._bindTexture=function(e,t){this._engine._bindTexture(this._samplers.indexOf(e),t)},t.prototype.setTexture=function(e,t){this._engine.setTexture(this._samplers.indexOf(e),t)},t.prototype.setTextureFromPostProcess=function(e,t){this._engine.setTextureFromPostProcess(this._samplers.indexOf(e),t)},t.prototype._cacheFloat2=function(e,t,i){return this._valueCache[e]?(this._valueCache[e][0]=t,void(this._valueCache[e][1]=i)):void(this._valueCache[e]=[t,i])},t.prototype._cacheFloat3=function(e,t,i,r){return this._valueCache[e]?(this._valueCache[e][0]=t,this._valueCache[e][1]=i,void(this._valueCache[e][2]=r)):void(this._valueCache[e]=[t,i,r])},t.prototype._cacheFloat4=function(e,t,i,r,n){return this._valueCache[e]?(this._valueCache[e][0]=t,this._valueCache[e][1]=i,this._valueCache[e][2]=r,void(this._valueCache[e][3]=n)):void(this._valueCache[e]=[t,i,r,n])},t.prototype.setArray=function(e,t){return this._engine.setArray(this.getUniform(e),t),this},t.prototype.setMatrices=function(e,t){return this._engine.setMatrices(this.getUniform(e),t),this},t.prototype.setMatrix=function(e,t){return this._engine.setMatrix(this.getUniform(e),t),this},t.prototype.setFloat=function(e,t){return this._valueCache[e]&&this._valueCache[e]===t?this:(this._valueCache[e]=t,this._engine.setFloat(this.getUniform(e),t),this)},t.prototype.setBool=function(e,t){return this._valueCache[e]&&this._valueCache[e]===t?this:(this._valueCache[e]=t,this._engine.setBool(this.getUniform(e),t?1:0),this)},t.prototype.setVector2=function(e,t){return this._valueCache[e]&&this._valueCache[e][0]==t.x&&this._valueCache[e][1]==t.y?this:(this._cacheFloat2(e,t.x,t.y),this._engine.setFloat2(this.getUniform(e),t.x,t.y),this)},t.prototype.setFloat2=function(e,t,i){return this._valueCache[e]&&this._valueCache[e][0]==t&&this._valueCache[e][1]==i?this:(this._cacheFloat2(e,t,i),this._engine.setFloat2(this.getUniform(e),t,i),this)},t.prototype.setVector3=function(e,t){return this._valueCache[e]&&this._valueCache[e][0]==t.x&&this._valueCache[e][1]==t.y&&this._valueCache[e][2]==t.z?this:(this._cacheFloat3(e,t.x,t.y,t.z),this._engine.setFloat3(this.getUniform(e),t.x,t.y,t.z),this)},t.prototype.setFloat3=function(e,t,i,r){return this._valueCache[e]&&this._valueCache[e][0]==t&&this._valueCache[e][1]==i&&this._valueCache[e][2]==r?this:(this._cacheFloat3(e,t,i,r),this._engine.setFloat3(this.getUniform(e),t,i,r),this)},t.prototype.setFloat4=function(e,t,i,r,n){return this._valueCache[e]&&this._valueCache[e][0]==t&&this._valueCache[e][1]==i&&this._valueCache[e][2]==r&&this._valueCache[e][3]==n?this:(this._cacheFloat4(e,t,i,r,n),this._engine.setFloat4(this.getUniform(e),t,i,r,n),this)},t.prototype.setColor3=function(e,t){return this._valueCache[e]&&this._valueCache[e][0]==t.r&&this._valueCache[e][1]==t.g&&this._valueCache[e][2]==t.b?this:(this._cacheFloat3(e,t.r,t.g,t.b),this._engine.setColor3(this.getUniform(e),t),this)},t.prototype.setColor4=function(e,t,i){return this._valueCache[e]&&this._valueCache[e][0]==t.r&&this._valueCache[e][1]==t.g&&this._valueCache[e][2]==t.b&&this._valueCache[e][3]==i?this:(this._cacheFloat4(e,t.r,t.g,t.b,i),this._engine.setColor4(this.getUniform(e),t,i),this)},t.ShadersStore={},t}();e.Effect=t}(BABYLON||(BABYLON={})),BABYLON.Effect.ShadersStore={anaglyphPixelShader:"ifdef GL_ES\nprecision mediump float;\n#endif\n\n// Samplers\nvarying vec2 vUV;\nuniform sampler2D textureSampler;\nuniform sampler2D leftSampler;\n\nvoid main(void)\n{\n    vec4 leftFrag = texture2D(leftSampler, vUV);\n    leftFrag = vec4(1.0, leftFrag.g, leftFrag.b, 1.0);\n\n	vec4 rightFrag = texture2D(textureSampler, vUV);\n    rightFrag = vec4(rightFrag.r, 1.0, 1.0, 1.0);\n\n    gl_FragColor = vec4(rightFrag.rgb * leftFrag.rgb, 1.0);\n}",blackAndWhitePixelShader:"ifdef GL_ES\nprecision mediump float;\n#endif\n\n// Samplers\nvarying vec2 vUV;\nuniform sampler2D textureSampler;\n\nvoid main(void) \n{\n	float luminance = dot(texture2D(textureSampler, vUV).rgb, vec3(0.3, 0.59, 0.11));\n	gl_FragColor = vec4(luminance, luminance, luminance, 1.0);\n}",blurPixelShader:"ifdef GL_ES\nprecision mediump float;\n#endif\n\n// Samplers\nvarying vec2 vUV;\nuniform sampler2D textureSampler;\n\n// Parameters\nuniform vec2 screenSize;\nuniform vec2 direction;\nuniform float blurWidth;\n\nvoid main(void)\n{\n	float weights[7];\n	weights[0] = 0.05;\n	weights[1] = 0.1;\n	weights[2] = 0.2;\n	weights[3] = 0.3;\n	weights[4] = 0.2;\n	weights[5] = 0.1;\n	weights[6] = 0.05;\n\n	vec2 texelSize = vec2(1.0 / screenSize.x, 1.0 / screenSize.y);\n	vec2 texelStep = texelSize * direction * blurWidth;\n	vec2 start = vUV - 3.0 * texelStep;\n\n	vec4 baseColor = vec4(0., 0., 0., 0.);\n	vec2 texelOffset = vec2(0., 0.);\n\n	for (int i = 0; i < 7; i++)\n	{\n		baseColor += texture2D(textureSampler, start + texelOffset) * weights[i];\n		texelOffset += texelStep;\n	}\n\n	gl_FragColor = baseColor;\n}",colorPixelShader:"recision mediump float;\n\nuniform vec3 color;\n\nvoid main(void) {\n	gl_FragColor = vec4(color, 1.);\n}",colorVertexShader:"recision mediump float;\n\n// Attributes\nattribute vec3 position;\n\n// Uniforms\nuniform mat4 worldViewProjection;\n\nvoid main(void) {\n	gl_Position = worldViewProjection * vec4(position, 1.0);\n}",convolutionPixelShader:"ifdef GL_ES\nprecision mediump float;\n#endif\n\n// Samplers\nvarying vec2 vUV;\nuniform sampler2D textureSampler;\n\nuniform vec2 screenSize;\nuniform float kernel[9];\n\nvoid main(void)\n{\n	vec2 onePixel = vec2(1.0, 1.0) / screenSize;\n	vec4 colorSum =\n		texture2D(textureSampler, vUV + onePixel * vec2(-1, -1)) * kernel[0] +\n		texture2D(textureSampler, vUV + onePixel * vec2(0, -1)) * kernel[1] +\n		texture2D(textureSampler, vUV + onePixel * vec2(1, -1)) * kernel[2] +\n		texture2D(textureSampler, vUV + onePixel * vec2(-1, 0)) * kernel[3] +\n		texture2D(textureSampler, vUV + onePixel * vec2(0, 0)) * kernel[4] +\n		texture2D(textureSampler, vUV + onePixel * vec2(1, 0)) * kernel[5] +\n		texture2D(textureSampler, vUV + onePixel * vec2(-1, 1)) * kernel[6] +\n		texture2D(textureSampler, vUV + onePixel * vec2(0, 1)) * kernel[7] +\n		texture2D(textureSampler, vUV + onePixel * vec2(1, 1)) * kernel[8];\n\n	float kernelWeight =\n		kernel[0] +\n		kernel[1] +\n		kernel[2] +\n		kernel[3] +\n		kernel[4] +\n		kernel[5] +\n		kernel[6] +\n		kernel[7] +\n		kernel[8];\n\n	if (kernelWeight <= 0.0) {\n		kernelWeight = 1.0;\n	}\n\n	gl_FragColor = vec4((colorSum / kernelWeight).rgb, 1);\n}",defaultPixelShader:"ifdef GL_ES\r\nprecision mediump float;\r\n#endif\r\n\r\n#define MAP_EXPLICIT	0.\r\n#define MAP_SPHERICAL	1.\r\n#define MAP_PLANAR		2.\r\n#define MAP_CUBIC		3.\r\n#define MAP_PROJECTION	4.\r\n#define MAP_SKYBOX		5.\r\n\r\n// Constants\r\nuniform vec3 vEyePosition;\r\nuniform vec3 vAmbientColor;\r\nuniform vec4 vDiffuseColor;\r\nuniform vec4 vSpecularColor;\r\nuniform vec3 vEmissiveColor;\r\n\r\n// Input\r\nvarying vec3 vPositionW;\r\nvarying vec3 vNormalW;\r\n\r\n#ifdef VERTEXCOLOR\r\nvarying vec3 vColor;\r\n#endif\r\n\r\n// Lights\r\n#ifdef LIGHT0\r\nuniform vec4 vLightData0;\r\nuniform vec4 vLightDiffuse0;\r\nuniform vec3 vLightSpecular0;\r\n#ifdef SHADOW0\r\nvarying vec4 vPositionFromLight0;\r\nuniform sampler2D shadowSampler0;\r\nuniform float darkness0;\r\n#endif\r\n#ifdef SPOTLIGHT0\r\nuniform vec4 vLightDirection0;\r\n#endif\r\n#ifdef HEMILIGHT0\r\nuniform vec3 vLightGround0;\r\n#endif\r\n#endif\r\n\r\n#ifdef LIGHT1\r\nuniform vec4 vLightData1;\r\nuniform vec4 vLightDiffuse1;\r\nuniform vec3 vLightSpecular1;\r\n#ifdef SHADOW1\r\nvarying vec4 vPositionFromLight1;\r\nuniform sampler2D shadowSampler1;\r\nuniform float darkness1;\r\n#endif\r\n#ifdef SPOTLIGHT1\r\nuniform vec4 vLightDirection1;\r\n#endif\r\n#ifdef HEMILIGHT1\r\nuniform vec3 vLightGround1;\r\n#endif\r\n#endif\r\n\r\n#ifdef LIGHT2\r\nuniform vec4 vLightData2;\r\nuniform vec4 vLightDiffuse2;\r\nuniform vec3 vLightSpecular2;\r\n#ifdef SHADOW2\r\nvarying vec4 vPositionFromLight2;\r\nuniform sampler2D shadowSampler2;\r\nuniform float darkness2;\r\n#endif\r\n#ifdef SPOTLIGHT2\r\nuniform vec4 vLightDirection2;\r\n#endif\r\n#ifdef HEMILIGHT2\r\nuniform vec3 vLightGround2;\r\n#endif\r\n#endif\r\n\r\n#ifdef LIGHT3\r\nuniform vec4 vLightData3;\r\nuniform vec4 vLightDiffuse3;\r\nuniform vec3 vLightSpecular3;\r\n#ifdef SHADOW3\r\nvarying vec4 vPositionFromLight3;\r\nuniform sampler2D shadowSampler3;\r\nuniform float darkness3;\r\n#endif\r\n#ifdef SPOTLIGHT3\r\nuniform vec4 vLightDirection3;\r\n#endif\r\n#ifdef HEMILIGHT3\r\nuniform vec3 vLightGround3;\r\n#endif\r\n#endif\r\n\r\n// Samplers\r\n#ifdef DIFFUSE\r\nvarying vec2 vDiffuseUV;\r\nuniform sampler2D diffuseSampler;\r\nuniform vec2 vDiffuseInfos;\r\n#endif\r\n\r\n#ifdef AMBIENT\r\nvarying vec2 vAmbientUV;\r\nuniform sampler2D ambientSampler;\r\nuniform vec2 vAmbientInfos;\r\n#endif\r\n\r\n#ifdef OPACITY	\r\nvarying vec2 vOpacityUV;\r\nuniform sampler2D opacitySampler;\r\nuniform vec2 vOpacityInfos;\r\n#endif\r\n\r\n#ifdef EMISSIVE\r\nvarying vec2 vEmissiveUV;\r\nuniform vec2 vEmissiveInfos;\r\nuniform sampler2D emissiveSampler;\r\n#endif\r\n\r\n#ifdef SPECULAR\r\nvarying vec2 vSpecularUV;\r\nuniform vec2 vSpecularInfos;\r\nuniform sampler2D specularSampler;\r\n#endif\r\n\r\n// Reflection\r\n#ifdef REFLECTION\r\nvarying vec3 vPositionUVW;\r\nuniform samplerCube reflectionCubeSampler;\r\nuniform sampler2D reflection2DSampler;\r\nuniform vec3 vReflectionInfos;\r\nuniform mat4 reflectionMatrix;\r\nuniform mat4 view;\r\n\r\nvec3 computeReflectionCoords(float mode, vec4 worldPos, vec3 worldNormal)\r\n{\r\n	if (mode == MAP_SPHERICAL)\r\n	{\r\n		vec3 coords = vec3(view * vec4(worldNormal, 0.0));\r\n\r\n		return vec3(reflectionMatrix * vec4(coords, 1.0));\r\n	}\r\n	else if (mode == MAP_PLANAR)\r\n	{\r\n		vec3 viewDir = worldPos.xyz - vEyePosition;\r\n		vec3 coords = normalize(reflect(viewDir, worldNormal));\r\n\r\n		return vec3(reflectionMatrix * vec4(coords, 1));\r\n	}\r\n	else if (mode == MAP_CUBIC)\r\n	{\r\n		vec3 viewDir = worldPos.xyz - vEyePosition;\r\n		vec3 coords = reflect(viewDir, worldNormal);\r\n\r\n		return vec3(reflectionMatrix * vec4(coords, 0));\r\n	}\r\n	else if (mode == MAP_PROJECTION)\r\n	{\r\n		return vec3(reflectionMatrix * (view * worldPos));\r\n	}\r\n	else if (mode == MAP_SKYBOX)\r\n	{\r\n		return vPositionUVW;\r\n	}\r\n\r\n	return vec3(0, 0, 0);\r\n}\r\n#endif\r\n\r\n// Shadows\r\n#ifdef SHADOWS\r\n\r\nfloat unpack(vec4 color)\r\n{\r\n	const vec4 bitShift = vec4(1. / (255. * 255. * 255.), 1. / (255. * 255.), 1. / 255., 1.);\r\n	return dot(color, bitShift);\r\n}\r\n\r\nfloat unpackHalf(vec2 color)\r\n{\r\n	return color.x + (color.y / 255.0);\r\n}\r\n\r\nfloat computeShadow(vec4 vPositionFromLight, sampler2D shadowSampler, float darkness)\r\n{\r\n	vec3 depth = vPositionFromLight.xyz / vPositionFromLight.w;\r\n	vec2 uv = 0.5 * depth.xy + vec2(0.5, 0.5);\r\n\r\n	if (uv.x < 0. || uv.x > 1.0 || uv.y < 0. || uv.y > 1.0)\r\n	{\r\n		return 1.0;\r\n	}\r\n\r\n	float shadow = unpack(texture2D(shadowSampler, uv));\r\n\r\n	if (depth.z > shadow)\r\n	{\r\n		return darkness;\r\n	}\r\n	return 1.;\r\n}\r\n\r\n// Thanks to http://devmaster.net/\r\nfloat ChebychevInequality(vec2 moments, float t)\r\n{\r\n	if (t <= moments.x)\r\n	{\r\n		return 1.0;\r\n	}\r\n\r\n	float variance = moments.y - (moments.x * moments.x);\r\n	variance = max(variance, 0.);\r\n\r\n	float d = t - moments.x;\r\n	return variance / (variance + d * d);\r\n}\r\n\r\nfloat computeShadowWithVSM(vec4 vPositionFromLight, sampler2D shadowSampler)\r\n{\r\n	vec3 depth = vPositionFromLight.xyz / vPositionFromLight.w;\r\n	vec2 uv = 0.5 * depth.xy + vec2(0.5, 0.5);\r\n\r\n	if (uv.x < 0. || uv.x > 1.0 || uv.y < 0. || uv.y > 1.0)\r\n	{\r\n		return 1.0;\r\n	}\r\n\r\n	vec4 texel = texture2D(shadowSampler, uv);\r\n\r\n	vec2 moments = vec2(unpackHalf(texel.xy), unpackHalf(texel.zw));\r\n	return clamp(1.3 - ChebychevInequality(moments, depth.z), 0., 1.0);\r\n}\r\n#endif\r\n\r\n// Bump\r\n#ifdef BUMP\r\n#extension GL_OES_standard_derivatives : enable\r\nvarying vec2 vBumpUV;\r\nuniform vec2 vBumpInfos;\r\nuniform sampler2D bumpSampler;\r\n\r\n// Thanks to http://www.thetenthplanet.de/archives/1180\r\nmat3 cotangent_frame(vec3 normal, vec3 p, vec2 uv)\r\n{\r\n	// get edge vectors of the pixel triangle\r\n	vec3 dp1 = dFdx(p);\r\n	vec3 dp2 = dFdy(p);\r\n	vec2 duv1 = dFdx(uv);\r\n	vec2 duv2 = dFdy(uv);\r\n\r\n	// solve the linear system\r\n	vec3 dp2perp = cross(dp2, normal);\r\n	vec3 dp1perp = cross(normal, dp1);\r\n	vec3 tangent = dp2perp * duv1.x + dp1perp * duv2.x;\r\n	vec3 binormal = dp2perp * duv1.y + dp1perp * duv2.y;\r\n\r\n	// construct a scale-invariant frame \r\n	float invmax = inversesqrt(max(dot(tangent, tangent), dot(binormal, binormal)));\r\n	return mat3(tangent * invmax, binormal * invmax, normal);\r\n}\r\n\r\nvec3 perturbNormal(vec3 viewDir)\r\n{\r\n	vec3 map = texture2D(bumpSampler, vBumpUV).xyz * vBumpInfos.y;\r\n	map = map * 255. / 127. - 128. / 127.;\r\n	mat3 TBN = cotangent_frame(vNormalW, -viewDir, vBumpUV);\r\n	return normalize(TBN * map);\r\n}\r\n#endif\r\n\r\n#ifdef CLIPPLANE\r\nvarying float fClipDistance;\r\n#endif\r\n\r\n// Fog\r\n#ifdef FOG\r\n\r\n#define FOGMODE_NONE    0.\r\n#define FOGMODE_EXP     1.\r\n#define FOGMODE_EXP2    2.\r\n#define FOGMODE_LINEAR  3.\r\n#define E 2.71828\r\n\r\nuniform vec4 vFogInfos;\r\nuniform vec3 vFogColor;\r\nvarying float fFogDistance;\r\n\r\nfloat CalcFogFactor()\r\n{\r\n	float fogCoeff = 1.0;\r\n	float fogStart = vFogInfos.y;\r\n	float fogEnd = vFogInfos.z;\r\n	float fogDensity = vFogInfos.w;\r\n\r\n	if (FOGMODE_LINEAR == vFogInfos.x)\r\n	{\r\n		fogCoeff = (fogEnd - fFogDistance) / (fogEnd - fogStart);\r\n	}\r\n	else if (FOGMODE_EXP == vFogInfos.x)\r\n	{\r\n		fogCoeff = 1.0 / pow(E, fFogDistance * fogDensity);\r\n	}\r\n	else if (FOGMODE_EXP2 == vFogInfos.x)\r\n	{\r\n		fogCoeff = 1.0 / pow(E, fFogDistance * fFogDistance * fogDensity * fogDensity);\r\n	}\r\n\r\n	return clamp(fogCoeff, 0.0, 1.0);\r\n}\r\n#endif\r\n\r\n// Light Computing\r\nstruct lightingInfo\r\n{\r\n	vec3 diffuse;\r\n	vec3 specular;\r\n};\r\n\r\nlightingInfo computeLighting(vec3 viewDirectionW, vec3 vNormal, vec4 lightData, vec3 diffuseColor, vec3 specularColor, float range) {\r\n	lightingInfo result;\r\n\r\n	vec3 lightVectorW;\r\n	float attenuation = 1.0;\r\n	if (lightData.w == 0.)\r\n	{\r\n		vec3 direction = lightData.xyz - vPositionW;\r\n\r\n		attenuation =  max(0., 1.0 - length(direction) / range);\r\n		lightVectorW = normalize(direction);\r\n	}\r\n	else\r\n	{\r\n		lightVectorW = normalize(-lightData.xyz);\r\n	}\r\n\r\n	// diffuse\r\n	float ndl = max(0., dot(vNormal, lightVectorW));\r\n\r\n	// Specular\r\n	vec3 angleW = normalize(viewDirectionW + lightVectorW);\r\n	float specComp = max(0., dot(vNormal, angleW));\r\n	specComp = pow(specComp, max(1., vSpecularColor.a));\r\n\r\n	result.diffuse = ndl * diffuseColor * attenuation;\r\n	result.specular = specComp * specularColor * attenuation;\r\n\r\n	return result;\r\n}\r\n\r\nlightingInfo computeSpotLighting(vec3 viewDirectionW, vec3 vNormal, vec4 lightData, vec4 lightDirection, vec3 diffuseColor, vec3 specularColor, float range) {\r\n	lightingInfo result;\r\n\r\n	vec3 direction = lightData.xyz - vPositionW;\r\n	vec3 lightVectorW = normalize(direction);\r\n	float attenuation = max(0., 1.0 - length(direction) / range);\r\n\r\n	// diffuse\r\n	float cosAngle = max(0., dot(-lightDirection.xyz, lightVectorW));\r\n	float spotAtten = 0.0;\r\n\r\n	if (cosAngle >= lightDirection.w)\r\n	{\r\n		cosAngle = max(0., pow(cosAngle, lightData.w));\r\n		spotAtten = max(0., (cosAngle - lightDirection.w) / (1. - cosAngle));\r\n\r\n		// Diffuse\r\n		float ndl = max(0., dot(vNormal, -lightDirection.xyz));\r\n\r\n		// Specular\r\n		vec3 angleW = normalize(viewDirectionW - lightDirection.xyz);\r\n		float specComp = max(0., dot(vNormal, angleW));\r\n		specComp = pow(specComp, vSpecularColor.a);\r\n\r\n		result.diffuse = ndl * spotAtten * diffuseColor * attenuation;\r\n		result.specular = specComp * specularColor * spotAtten * attenuation;\r\n\r\n		return result;\r\n	}\r\n\r\n	result.diffuse = vec3(0.);\r\n	result.specular = vec3(0.);\r\n\r\n	return result;\r\n}\r\n\r\nlightingInfo computeHemisphericLighting(vec3 viewDirectionW, vec3 vNormal, vec4 lightData, vec3 diffuseColor, vec3 specularColor, vec3 groundColor) {\r\n	lightingInfo result;\r\n\r\n	// Diffuse\r\n	float ndl = dot(vNormal, lightData.xyz) * 0.5 + 0.5;\r\n\r\n	// Specular\r\n	vec3 angleW = normalize(viewDirectionW + lightData.xyz);\r\n	float specComp = max(0., dot(vNormal, angleW));\r\n	specComp = pow(specComp, vSpecularColor.a);\r\n\r\n	result.diffuse = mix(groundColor, diffuseColor, ndl);\r\n	result.specular = specComp * specularColor;\r\n\r\n	return result;\r\n}\r\n\r\nvoid main(void) {\r\n	// Clip plane\r\n#ifdef CLIPPLANE\r\n	if (fClipDistance > 0.0)\r\n		discard;\r\n#endif\r\n\r\n	vec3 viewDirectionW = normalize(vEyePosition - vPositionW);\r\n\r\n	// Base color\r\n	vec4 baseColor = vec4(1., 1., 1., 1.);\r\n	vec3 diffuseColor = vDiffuseColor.rgb;\r\n\r\n	// Alpha\r\n	float alpha = vDiffuseColor.a;\r\n\r\n#ifdef VERTEXCOLOR\r\n	diffuseColor *= vColor;\r\n#endif\r\n\r\n#ifdef DIFFUSE\r\n	baseColor = texture2D(diffuseSampler, vDiffuseUV);\r\n\r\n#ifdef ALPHATEST\r\n	if (baseColor.a < 0.4)\r\n		discard;\r\n#endif\r\n\r\n#ifdef ALPHAFROMDIFFUSE\r\n	alpha *= baseColor.a;\r\n#endif\r\n\r\n	baseColor.rgb *= vDiffuseInfos.y;\r\n#endif\r\n\r\n	// Bump\r\n	vec3 normalW = normalize(vNormalW);\r\n\r\n#ifdef BUMP\r\n	normalW = perturbNormal(viewDirectionW);\r\n#endif\r\n\r\n	// Ambient color\r\n	vec3 baseAmbientColor = vec3(1., 1., 1.);\r\n\r\n#ifdef AMBIENT\r\n	baseAmbientColor = texture2D(ambientSampler, vAmbientUV).rgb * vAmbientInfos.y;\r\n#endif\r\n\r\n	// Lighting\r\n	vec3 diffuseBase = vec3(0., 0., 0.);\r\n	vec3 specularBase = vec3(0., 0., 0.);\r\n	float shadow = 1.;\r\n\r\n#ifdef LIGHT0\r\n#ifdef SPOTLIGHT0\r\n	lightingInfo info = computeSpotLighting(viewDirectionW, normalW, vLightData0, vLightDirection0, vLightDiffuse0.rgb, vLightSpecular0, vLightDiffuse0.a);\r\n#endif\r\n#ifdef HEMILIGHT0\r\n	lightingInfo info = computeHemisphericLighting(viewDirectionW, normalW, vLightData0, vLightDiffuse0.rgb, vLightSpecular0, vLightGround0);\r\n#endif\r\n#ifdef POINTDIRLIGHT0\r\n	lightingInfo info = computeLighting(viewDirectionW, normalW, vLightData0, vLightDiffuse0.rgb, vLightSpecular0, vLightDiffuse0.a);\r\n#endif\r\n#ifdef SHADOW0\r\n#ifdef SHADOWVSM0\r\n	shadow = computeShadowWithVSM(vPositionFromLight0, shadowSampler0);\r\n#else\r\n	shadow = computeShadow(vPositionFromLight0, shadowSampler0, darkness0);\r\n#endif\r\n#else\r\n	shadow = 1.;\r\n#endif\r\n	diffuseBase += info.diffuse * shadow;\r\n	specularBase += info.specular * shadow;\r\n#endif\r\n\r\n#ifdef LIGHT1\r\n#ifdef SPOTLIGHT1\r\n	info = computeSpotLighting(viewDirectionW, normalW, vLightData1, vLightDirection1, vLightDiffuse1.rgb, vLightSpecular1, vLightDiffuse1.a);\r\n#endif\r\n#ifdef HEMILIGHT1\r\n	info = computeHemisphericLighting(viewDirectionW, normalW, vLightData1, vLightDiffuse1.rgb, vLightSpecular1, vLightGround1);\r\n#endif\r\n#ifdef POINTDIRLIGHT1\r\n	info = computeLighting(viewDirectionW, normalW, vLightData1, vLightDiffuse1.rgb, vLightSpecular1, vLightDiffuse1.a);\r\n#endif\r\n#ifdef SHADOW1\r\n#ifdef SHADOWVSM1\r\n	shadow = computeShadowWithVSM(vPositionFromLight1, shadowSampler1);\r\n#else\r\n	shadow = computeShadow(vPositionFromLight1, shadowSampler1, darkness1);\r\n#endif\r\n#else\r\n	shadow = 1.;\r\n#endif\r\n	diffuseBase += info.diffuse * shadow;\r\n	specularBase += info.specular * shadow;\r\n#endif\r\n\r\n#ifdef LIGHT2\r\n#ifdef SPOTLIGHT2\r\n	info = computeSpotLighting(viewDirectionW, normalW, vLightData2, vLightDirection2, vLightDiffuse2.rgb, vLightSpecular2, vLightDiffuse2.a);\r\n#endif\r\n#ifdef HEMILIGHT2\r\n	info = computeHemisphericLighting(viewDirectionW, normalW, vLightData2, vLightDiffuse2.rgb, vLightSpecular2, vLightGround2);\r\n#endif\r\n#ifdef POINTDIRLIGHT2\r\n	info = computeLighting(viewDirectionW, normalW, vLightData2, vLightDiffuse2.rgb, vLightSpecular2, vLightDiffuse2.a);\r\n#endif\r\n#ifdef SHADOW2\r\n#ifdef SHADOWVSM2\r\n	shadow = computeShadowWithVSM(vPositionFromLight2, shadowSampler2);\r\n#else\r\n	shadow = computeShadow(vPositionFromLight2, shadowSampler2, darkness2);\r\n#endif	\r\n#else\r\n	shadow = 1.;\r\n#endif\r\n	diffuseBase += info.diffuse * shadow;\r\n	specularBase += info.specular * shadow;\r\n#endif\r\n\r\n#ifdef LIGHT3\r\n#ifdef SPOTLIGHT3\r\n	info = computeSpotLighting(viewDirectionW, normalW, vLightData3, vLightDirection3, vLightDiffuse3.rgb, vLightSpecular3, vLightDiffuse3.a);\r\n#endif\r\n#ifdef HEMILIGHT3\r\n	info = computeHemisphericLighting(viewDirectionW, normalW, vLightData3, vLightDiffuse3.rgb, vLightSpecular3, vLightGround3);\r\n#endif\r\n#ifdef POINTDIRLIGHT3\r\n	info = computeLighting(viewDirectionW, normalW, vLightData3, vLightDiffuse3.rgb, vLightSpecular3, vLightDiffuse3.a);\r\n#endif\r\n#ifdef SHADOW3\r\n#ifdef SHADOWVSM3\r\n	shadow = computeShadowWithVSM(vPositionFromLight3, shadowSampler3);\r\n#else\r\n	shadow = computeShadow(vPositionFromLight3, shadowSampler3, darkness3);\r\n#endif	\r\n#else\r\n	shadow = 1.;\r\n#endif\r\n	diffuseBase += info.diffuse * shadow;\r\n	specularBase += info.specular * shadow;\r\n#endif\r\n\r\n	// Reflection\r\n	vec3 reflectionColor = vec3(0., 0., 0.);\r\n\r\n#ifdef REFLECTION\r\n	vec3 vReflectionUVW = computeReflectionCoords(vReflectionInfos.x, vec4(vPositionW, 1.0), normalW);\r\n\r\n	if (vReflectionInfos.z != 0.0)\r\n	{\r\n		reflectionColor = textureCube(reflectionCubeSampler, vReflectionUVW).rgb * vReflectionInfos.y * shadow;\r\n	}\r\n	else\r\n	{\r\n		vec2 coords = vReflectionUVW.xy;\r\n\r\n		if (vReflectionInfos.x == MAP_PROJECTION)\r\n		{\r\n			coords /= vReflectionUVW.z;\r\n		}\r\n\r\n		coords.y = 1.0 - coords.y;\r\n\r\n		reflectionColor = texture2D(reflection2DSampler, coords).rgb * vReflectionInfos.y * shadow;\r\n	}\r\n#endif\r\n\r\n#ifdef OPACITY\r\n	vec4 opacityMap = texture2D(opacitySampler, vOpacityUV);\r\n\r\n#ifdef OPACITYRGB\r\n	opacityMap.rgb = opacityMap.rgb * vec3(0.3, 0.59, 0.11);\r\n	alpha *= (opacityMap.x + opacityMap.y + opacityMap.z)* vOpacityInfos.y;\r\n#else\r\n	alpha *= opacityMap.a * vOpacityInfos.y;\r\n#endif\r\n\r\n\r\n#endif\r\n\r\n	// Emissive\r\n	vec3 emissiveColor = vEmissiveColor;\r\n#ifdef EMISSIVE\r\n	emissiveColor += texture2D(emissiveSampler, vEmissiveUV).rgb * vEmissiveInfos.y;\r\n#endif\r\n\r\n	// Specular map\r\n	vec3 specularColor = vSpecularColor.rgb;\r\n#ifdef SPECULAR\r\n	specularColor = texture2D(specularSampler, vSpecularUV).rgb * vSpecularInfos.y;\r\n#endif\r\n\r\n	// Composition\r\n	vec3 finalDiffuse = clamp(diffuseBase * diffuseColor + emissiveColor + vAmbientColor, 0.0, 1.0) * baseColor.rgb;\r\n	vec3 finalSpecular = specularBase * specularColor;\r\n\r\n	vec4 color = vec4(finalDiffuse * baseAmbientColor + finalSpecular + reflectionColor, alpha);\r\n\r\n#ifdef FOG\r\n	float fog = CalcFogFactor();\r\n	color.rgb = fog * color.rgb + (1.0 - fog) * vFogColor;\r\n#endif\r\n\r\n	gl_FragColor = color;\r\n}",defaultVertexShader:"ifdef GL_ES\r\nprecision mediump float;\r\n#endif\r\n\r\n// Attributes\r\nattribute vec3 position;\r\nattribute vec3 normal;\r\n#ifdef UV1\r\nattribute vec2 uv;\r\n#endif\r\n#ifdef UV2\r\nattribute vec2 uv2;\r\n#endif\r\n#ifdef VERTEXCOLOR\r\nattribute vec3 color;\r\n#endif\r\n#ifdef BONES\r\nattribute vec4 matricesIndices;\r\nattribute vec4 matricesWeights;\r\n#endif\r\n\r\n// Uniforms\r\n\r\n#ifdef INSTANCES\r\nattribute vec4 world0;\r\nattribute vec4 world1;\r\nattribute vec4 world2;\r\nattribute vec4 world3;\r\n#else\r\nuniform mat4 world;\r\n#endif\r\n\r\nuniform mat4 view;\r\nuniform mat4 viewProjection;\r\n\r\n#ifdef DIFFUSE\r\nvarying vec2 vDiffuseUV;\r\nuniform mat4 diffuseMatrix;\r\nuniform vec2 vDiffuseInfos;\r\n#endif\r\n\r\n#ifdef AMBIENT\r\nvarying vec2 vAmbientUV;\r\nuniform mat4 ambientMatrix;\r\nuniform vec2 vAmbientInfos;\r\n#endif\r\n\r\n#ifdef OPACITY\r\nvarying vec2 vOpacityUV;\r\nuniform mat4 opacityMatrix;\r\nuniform vec2 vOpacityInfos;\r\n#endif\r\n\r\n#ifdef EMISSIVE\r\nvarying vec2 vEmissiveUV;\r\nuniform vec2 vEmissiveInfos;\r\nuniform mat4 emissiveMatrix;\r\n#endif\r\n\r\n#ifdef SPECULAR\r\nvarying vec2 vSpecularUV;\r\nuniform vec2 vSpecularInfos;\r\nuniform mat4 specularMatrix;\r\n#endif\r\n\r\n#ifdef BUMP\r\nvarying vec2 vBumpUV;\r\nuniform vec2 vBumpInfos;\r\nuniform mat4 bumpMatrix;\r\n#endif\r\n\r\n#ifdef BONES\r\nuniform mat4 mBones[BonesPerMesh];\r\n#endif\r\n\r\n// Output\r\nvarying vec3 vPositionW;\r\nvarying vec3 vNormalW;\r\n\r\n#ifdef VERTEXCOLOR\r\nvarying vec3 vColor;\r\n#endif\r\n\r\n#ifdef CLIPPLANE\r\nuniform vec4 vClipPlane;\r\nvarying float fClipDistance;\r\n#endif\r\n\r\n#ifdef FOG\r\nvarying float fFogDistance;\r\n#endif\r\n\r\n#ifdef SHADOWS\r\n#ifdef LIGHT0\r\nuniform mat4 lightMatrix0;\r\nvarying vec4 vPositionFromLight0;\r\n#endif\r\n#ifdef LIGHT1\r\nuniform mat4 lightMatrix1;\r\nvarying vec4 vPositionFromLight1;\r\n#endif\r\n#ifdef LIGHT2\r\nuniform mat4 lightMatrix2;\r\nvarying vec4 vPositionFromLight2;\r\n#endif\r\n#ifdef LIGHT3\r\nuniform mat4 lightMatrix3;\r\nvarying vec4 vPositionFromLight3;\r\n#endif\r\n#endif\r\n\r\n#ifdef REFLECTION\r\nvarying vec3 vPositionUVW;\r\n#endif\r\n\r\nvoid main(void) {\r\n	mat4 finalWorld;\r\n\r\n#ifdef REFLECTION\r\n	vPositionUVW = position;\r\n#endif \r\n\r\n#ifdef BONES\r\n	mat4 m0 = mBones[int(matricesIndices.x)] * matricesWeights.x;\r\n	mat4 m1 = mBones[int(matricesIndices.y)] * matricesWeights.y;\r\n	mat4 m2 = mBones[int(matricesIndices.z)] * matricesWeights.z;\r\n\r\n#ifdef BONES4\r\n	mat4 m3 = mBones[int(matricesIndices.w)] * matricesWeights.w;\r\n	finalWorld = world * (m0 + m1 + m2 + m3);\r\n#else\r\n	finalWorld = world * (m0 + m1 + m2);\r\n#endif \r\n\r\n#else\r\n#ifdef INSTANCES\r\n	finalWorld = mat4(world0, world1, world2, world3);\r\n#else\r\n	finalWorld = world;\r\n#endif\r\n#endif\r\n	gl_Position = viewProjection * finalWorld * vec4(position, 1.0);\r\n\r\n	vec4 worldPos = finalWorld * vec4(position, 1.0);\r\n	vPositionW = vec3(worldPos);\r\n	vNormalW = normalize(vec3(finalWorld * vec4(normal, 0.0)));\r\n\r\n	// Texture coordinates\r\n#ifndef UV1\r\n	vec2 uv = vec2(0., 0.);\r\n#endif\r\n#ifndef UV2\r\n	vec2 uv2 = vec2(0., 0.);\r\n#endif\r\n\r\n#ifdef DIFFUSE\r\n	if (vDiffuseInfos.x == 0.)\r\n	{\r\n		vDiffuseUV = vec2(diffuseMatrix * vec4(uv, 1.0, 0.0));\r\n	}\r\n	else\r\n	{\r\n		vDiffuseUV = vec2(diffuseMatrix * vec4(uv2, 1.0, 0.0));\r\n	}\r\n#endif\r\n\r\n#ifdef AMBIENT\r\n	if (vAmbientInfos.x == 0.)\r\n	{\r\n		vAmbientUV = vec2(ambientMatrix * vec4(uv, 1.0, 0.0));\r\n	}\r\n	else\r\n	{\r\n		vAmbientUV = vec2(ambientMatrix * vec4(uv2, 1.0, 0.0));\r\n	}\r\n#endif\r\n\r\n#ifdef OPACITY\r\n	if (vOpacityInfos.x == 0.)\r\n	{\r\n		vOpacityUV = vec2(opacityMatrix * vec4(uv, 1.0, 0.0));\r\n	}\r\n	else\r\n	{\r\n		vOpacityUV = vec2(opacityMatrix * vec4(uv2, 1.0, 0.0));\r\n	}\r\n#endif\r\n\r\n#ifdef EMISSIVE\r\n	if (vEmissiveInfos.x == 0.)\r\n	{\r\n		vEmissiveUV = vec2(emissiveMatrix * vec4(uv, 1.0, 0.0));\r\n	}\r\n	else\r\n	{\r\n		vEmissiveUV = vec2(emissiveMatrix * vec4(uv2, 1.0, 0.0));\r\n	}\r\n#endif\r\n\r\n#ifdef SPECULAR\r\n	if (vSpecularInfos.x == 0.)\r\n	{\r\n		vSpecularUV = vec2(specularMatrix * vec4(uv, 1.0, 0.0));\r\n	}\r\n	else\r\n	{\r\n		vSpecularUV = vec2(specularMatrix * vec4(uv2, 1.0, 0.0));\r\n	}\r\n#endif\r\n\r\n#ifdef BUMP\r\n	if (vBumpInfos.x == 0.)\r\n	{\r\n		vBumpUV = vec2(bumpMatrix * vec4(uv, 1.0, 0.0));\r\n	}\r\n	else\r\n	{\r\n		vBumpUV = vec2(bumpMatrix * vec4(uv2, 1.0, 0.0));\r\n	}\r\n#endif\r\n\r\n	// Clip plane\r\n#ifdef CLIPPLANE\r\n	fClipDistance = dot(worldPos, vClipPlane);\r\n#endif\r\n\r\n	// Fog\r\n#ifdef FOG\r\n	fFogDistance = (view * worldPos).z;\r\n#endif\r\n\r\n	// Shadows\r\n#ifdef SHADOWS\r\n#ifdef LIGHT0\r\n	vPositionFromLight0 = lightMatrix0 * worldPos;\r\n#endif\r\n#ifdef LIGHT1\r\n	vPositionFromLight1 = lightMatrix1 * worldPos;\r\n#endif\r\n#ifdef LIGHT2\r\n	vPositionFromLight2 = lightMatrix2 * worldPos;\r\n#endif\r\n#ifdef LIGHT3\r\n	vPositionFromLight3 = lightMatrix3 * worldPos;\r\n#endif\r\n#endif\r\n\r\n	// Vertex color\r\n#ifdef VERTEXCOLOR\r\n	vColor = color;\r\n#endif\r\n}",displayPassPixelShader:"ifdef GL_ES\nprecision mediump float;\n#endif\n\n// Samplers\nvarying vec2 vUV;\nuniform sampler2D textureSampler;\nuniform sampler2D passSampler;\n\nvoid main(void)\n{\n    gl_FragColor = texture2D(passSampler, vUV);\n}",filterPixelShader:"ifdef GL_ES\nprecision mediump float;\n#endif\n\n// Samplers\nvarying vec2 vUV;\nuniform sampler2D textureSampler;\n\nuniform mat4 kernelMatrix;\n\nvoid main(void)\n{\n	vec3 baseColor = texture2D(textureSampler, vUV).rgb;\n	vec3 updatedColor = (kernelMatrix * vec4(baseColor, 1.0)).rgb;\n\n	gl_FragColor = vec4(updatedColor, 1.0);\n}",fxaaPixelShader:"ifdef GL_ES\r\nprecision mediump float;\r\n#endif\r\n\r\n#define FXAA_REDUCE_MIN   (1.0/128.0)\r\n#define FXAA_REDUCE_MUL   (1.0/8.0)\r\n#define FXAA_SPAN_MAX     8.0\r\n\r\nvarying vec2 vUV;\r\nuniform sampler2D textureSampler;\r\nuniform vec2 texelSize;\r\n\r\nvoid main(){\r\n	vec2 localTexelSize = texelSize;\r\n	vec3 rgbNW = texture2D(textureSampler, (vUV + vec2(-1.0, -1.0) * localTexelSize)).xyz;\r\n	vec3 rgbNE = texture2D(textureSampler, (vUV + vec2(1.0, -1.0) * localTexelSize)).xyz;\r\n	vec3 rgbSW = texture2D(textureSampler, (vUV + vec2(-1.0, 1.0) * localTexelSize)).xyz;\r\n	vec3 rgbSE = texture2D(textureSampler, (vUV + vec2(1.0, 1.0) * localTexelSize)).xyz;\r\n	vec3 rgbM = texture2D(textureSampler, vUV ).xyz;\r\n	vec3 luma = vec3(0.299, 0.587, 0.114);\r\n	float lumaNW = dot(rgbNW, luma);\r\n	float lumaNE = dot(rgbNE, luma);\r\n	float lumaSW = dot(rgbSW, luma);\r\n	float lumaSE = dot(rgbSE, luma);\r\n	float lumaM = dot(rgbM, luma);\r\n	float lumaMin = min(lumaM, min(min(lumaNW, lumaNE), min(lumaSW, lumaSE)));\r\n	float lumaMax = max(lumaM, max(max(lumaNW, lumaNE), max(lumaSW, lumaSE)));\r\n\r\n	vec2 dir = vec2(-((lumaNW + lumaNE) - (lumaSW + lumaSE)), ((lumaNW + lumaSW) - (lumaNE + lumaSE)));\r\n\r\n	float dirReduce = max(\r\n		(lumaNW + lumaNE + lumaSW + lumaSE) * (0.25 * FXAA_REDUCE_MUL),\r\n		FXAA_REDUCE_MIN);\r\n\r\n	float rcpDirMin = 1.0 / (min(abs(dir.x), abs(dir.y)) + dirReduce);\r\n	dir = min(vec2(FXAA_SPAN_MAX, FXAA_SPAN_MAX),\r\n		max(vec2(-FXAA_SPAN_MAX, -FXAA_SPAN_MAX),\r\n		dir * rcpDirMin)) * localTexelSize;\r\n\r\n	vec3 rgbA = 0.5 * (\r\n		texture2D(textureSampler, vUV + dir * (1.0 / 3.0 - 0.5)).xyz +\r\n		texture2D(textureSampler, vUV + dir * (2.0 / 3.0 - 0.5)).xyz);\r\n\r\n	vec3 rgbB = rgbA * 0.5 + 0.25 * (\r\n		texture2D(textureSampler, vUV + dir *  -0.5).xyz +\r\n		texture2D(textureSampler, vUV + dir * 0.5).xyz);\r\n	float lumaB = dot(rgbB, luma);\r\n	if ((lumaB < lumaMin) || (lumaB > lumaMax)) {\r\n		gl_FragColor = vec4(rgbA, 1.0);\r\n	}\r\n	else {\r\n		gl_FragColor = vec4(rgbB, 1.0);\r\n	}\r\n}",layerPixelShader:"ifdef GL_ES\r\nprecision mediump float;\r\n#endif\r\n\r\n// Samplers\r\nvarying vec2 vUV;\r\nuniform sampler2D textureSampler;\r\n\r\n// Color\r\nuniform vec4 color;\r\n\r\nvoid main(void) {\r\n	vec4 baseColor = texture2D(textureSampler, vUV);\r\n\r\n	gl_FragColor = baseColor * color;\r\n}",layerVertexShader:"ifdef GL_ES\r\nprecision mediump float;\r\n#endif\r\n\r\n// Attributes\r\nattribute vec2 position;\r\n\r\n// Uniforms\r\nuniform mat4 textureMatrix;\r\n\r\n// Output\r\nvarying vec2 vUV;\r\n\r\nconst vec2 madd = vec2(0.5, 0.5);\r\n\r\nvoid main(void) {	\r\n\r\n	vUV = vec2(textureMatrix * vec4(position * madd + madd, 1.0, 0.0));\r\n	gl_Position = vec4(position, 0.0, 1.0);\r\n}",legacydefaultPixelShader:"ifdef GL_ES\nprecision mediump float;\n#endif\n\n#define MAP_PROJECTION	4.\n\n// Constants\nuniform vec3 vEyePosition;\nuniform vec3 vAmbientColor;\nuniform vec4 vDiffuseColor;\nuniform vec4 vSpecularColor;\nuniform vec3 vEmissiveColor;\n\n// Input\nvarying vec3 vPositionW;\nvarying vec3 vNormalW;\n\n#ifdef VERTEXCOLOR\nvarying vec3 vColor;\n#endif\n\n// Lights\n#ifdef LIGHT0\nuniform vec4 vLightData0;\nuniform vec4 vLightDiffuse0;\nuniform vec3 vLightSpecular0;\n#ifdef SHADOW0\nvarying vec4 vPositionFromLight0;\nuniform sampler2D shadowSampler0;\n#endif\n#ifdef SPOTLIGHT0\nuniform vec4 vLightDirection0;\n#endif\n#ifdef HEMILIGHT0\nuniform vec3 vLightGround0;\n#endif\n#endif\n\n#ifdef LIGHT1\nuniform vec4 vLightData1;\nuniform vec4 vLightDiffuse1;\nuniform vec3 vLightSpecular1;\n#ifdef SHADOW1\nvarying vec4 vPositionFromLight1;\nuniform sampler2D shadowSampler1;\n#endif\n#ifdef SPOTLIGHT1\nuniform vec4 vLightDirection1;\n#endif\n#ifdef HEMILIGHT1\nuniform vec3 vLightGround1;\n#endif\n#endif\n\n#ifdef LIGHT2\nuniform vec4 vLightData2;\nuniform vec4 vLightDiffuse2;\nuniform vec3 vLightSpecular2;\n#ifdef SHADOW2\nvarying vec4 vPositionFromLight2;\nuniform sampler2D shadowSampler2;\n#endif\n#ifdef SPOTLIGHT2\nuniform vec4 vLightDirection2;\n#endif\n#ifdef HEMILIGHT2\nuniform vec3 vLightGround2;\n#endif\n#endif\n\n#ifdef LIGHT3\nuniform vec4 vLightData3;\nuniform vec4 vLightDiffuse3;\nuniform vec3 vLightSpecular3;\n#ifdef SHADOW3\nvarying vec4 vPositionFromLight3;\nuniform sampler2D shadowSampler3;\n#endif\n#ifdef SPOTLIGHT3\nuniform vec4 vLightDirection3;\n#endif\n#ifdef HEMILIGHT3\nuniform vec3 vLightGround3;\n#endif\n#endif\n\n// Samplers\n#ifdef DIFFUSE\nvarying vec2 vDiffuseUV;\nuniform sampler2D diffuseSampler;\nuniform vec2 vDiffuseInfos;\n#endif\n\n#ifdef AMBIENT\nvarying vec2 vAmbientUV;\nuniform sampler2D ambientSampler;\nuniform vec2 vAmbientInfos;\n#endif\n\n#ifdef OPACITY	\nvarying vec2 vOpacityUV;\nuniform sampler2D opacitySampler;\nuniform vec2 vOpacityInfos;\n#endif\n\n#ifdef REFLECTION\nvarying vec3 vReflectionUVW;\nuniform samplerCube reflectionCubeSampler;\nuniform sampler2D reflection2DSampler;\nuniform vec3 vReflectionInfos;\n#endif\n\n#ifdef EMISSIVE\nvarying vec2 vEmissiveUV;\nuniform vec2 vEmissiveInfos;\nuniform sampler2D emissiveSampler;\n#endif\n\n#ifdef SPECULAR\nvarying vec2 vSpecularUV;\nuniform vec2 vSpecularInfos;\nuniform sampler2D specularSampler;\n#endif\n\n// Shadows\n#ifdef SHADOWS\n\nfloat unpack(vec4 color)\n{\n	const vec4 bitShift = vec4(1. / (255. * 255. * 255.), 1. / (255. * 255.), 1. / 255., 1.);\n	return dot(color, bitShift);\n}\n\nfloat unpackHalf(vec2 color)\n{\n	return color.x + (color.y / 255.0);\n}\n\nfloat computeShadow(vec4 vPositionFromLight, sampler2D shadowSampler)\n{\n	vec3 depth = vPositionFromLight.xyz / vPositionFromLight.w;\n	vec2 uv = 0.5 * depth.xy + vec2(0.5, 0.5);\n\n	if (uv.x < 0. || uv.x > 1.0 || uv.y < 0. || uv.y > 1.0)\n	{\n		return 1.0;\n	}\n\n	float shadow = unpack(texture2D(shadowSampler, uv));\n\n	if (depth.z > shadow)\n	{\n		return 0.;\n	}\n	return 1.;\n}\n\n// Thanks to http://devmaster.net/\nfloat ChebychevInequality(vec2 moments, float t)\n{\n	if (t <= moments.x)\n	{\n		return 1.0;\n	}\n\n	float variance = moments.y - (moments.x * moments.x);\n	variance = max(variance, 0.);\n\n	float d = t - moments.x;\n	return variance / (variance + d * d);\n}\n\nfloat computeShadowWithVSM(vec4 vPositionFromLight, sampler2D shadowSampler)\n{\n	vec3 depth = vPositionFromLight.xyz / vPositionFromLight.w;\n	vec2 uv = 0.5 * depth.xy + vec2(0.5, 0.5);\n\n	if (uv.x < 0. || uv.x > 1.0 || uv.y < 0. || uv.y > 1.0)\n	{\n		return 1.0;\n	}\n\n	vec4 texel = texture2D(shadowSampler, uv);\n\n	vec2 moments = vec2(unpackHalf(texel.xy), unpackHalf(texel.zw));\n	return clamp(1.3 - ChebychevInequality(moments, depth.z), 0., 1.0);\n}\n#endif\n\n#ifdef CLIPPLANE\nvarying float fClipDistance;\n#endif\n\n// Fog\n#ifdef FOG\n\n#define FOGMODE_NONE    0.\n#define FOGMODE_EXP     1.\n#define FOGMODE_EXP2    2.\n#define FOGMODE_LINEAR  3.\n#define E 2.71828\n\nuniform vec4 vFogInfos;\nuniform vec3 vFogColor;\nvarying float fFogDistance;\n\nfloat CalcFogFactor()\n{\n	float fogCoeff = 1.0;\n	float fogStart = vFogInfos.y;\n	float fogEnd = vFogInfos.z;\n	float fogDensity = vFogInfos.w;\n\n	if (FOGMODE_LINEAR == vFogInfos.x)\n	{\n		fogCoeff = (fogEnd - fFogDistance) / (fogEnd - fogStart);\n	}\n	else if (FOGMODE_EXP == vFogInfos.x)\n	{\n		fogCoeff = 1.0 / pow(E, fFogDistance * fogDensity);\n	}\n	else if (FOGMODE_EXP2 == vFogInfos.x)\n	{\n		fogCoeff = 1.0 / pow(E, fFogDistance * fFogDistance * fogDensity * fogDensity);\n	}\n\n	return clamp(fogCoeff, 0.0, 1.0);\n}\n#endif\n\n// Light Computing\nmat3 computeLighting(vec3 viewDirectionW, vec3 vNormal, vec4 lightData, vec4 diffuseColor, vec3 specularColor) {\n	mat3 result;\n\n	vec3 lightVectorW;\n	if (lightData.w == 0.)\n	{\n		lightVectorW = normalize(lightData.xyz - vPositionW);\n	}\n	else\n	{\n		lightVectorW = normalize(-lightData.xyz);\n	}\n\n	// diffuse\n	float ndl = max(0., dot(vNormal, lightVectorW));\n\n	// Specular\n	vec3 angleW = normalize(viewDirectionW + lightVectorW);\n	float specComp = max(0., dot(vNormal, angleW));\n	specComp = max(0., pow(specComp, max(1.0, vSpecularColor.a)));\n\n	result[0] = ndl * diffuseColor.rgb;\n	result[1] = specComp * specularColor;\n	result[2] = vec3(0.);\n\n	return result;\n}\n\nmat3 computeSpotLighting(vec3 viewDirectionW, vec3 vNormal, vec4 lightData, vec4 lightDirection, vec4 diffuseColor, vec3 specularColor) {\n	mat3 result;\n\n	vec3 lightVectorW = normalize(lightData.xyz - vPositionW);\n\n	// diffuse\n	float cosAngle = max(0., dot(-lightDirection.xyz, lightVectorW));\n	float spotAtten = 0.0;\n\n	if (cosAngle >= lightDirection.w)\n	{\n		cosAngle = max(0., pow(cosAngle, lightData.w));\n		spotAtten = max(0., (cosAngle - lightDirection.w) / (1. - cosAngle));\n\n		// Diffuse\n		float ndl = max(0., dot(vNormal, -lightDirection.xyz));\n\n		// Specular\n		vec3 angleW = normalize(viewDirectionW - lightDirection.xyz);\n		float specComp = max(0., dot(vNormal, angleW));\n		specComp = pow(specComp, vSpecularColor.a);\n\n		result[0] = ndl * spotAtten * diffuseColor.rgb;\n		result[1] = specComp * specularColor * spotAtten;\n		result[2] = vec3(0.);\n\n		return result;\n	}\n\n	result[0] = vec3(0.);\n	result[1] = vec3(0.);\n	result[2] = vec3(0.);\n\n	return result;\n}\n\nmat3 computeHemisphericLighting(vec3 viewDirectionW, vec3 vNormal, vec4 lightData, vec4 diffuseColor, vec3 specularColor, vec3 groundColor) {\n	mat3 result;\n\n	// Diffuse\n	float ndl = dot(vNormal, lightData.xyz) * 0.5 + 0.5;\n\n	// Specular\n	vec3 angleW = normalize(viewDirectionW + lightData.xyz);\n	float specComp = max(0., dot(vNormal, angleW));\n	specComp = pow(specComp, vSpecularColor.a);\n\n	result[0] = mix(groundColor, diffuseColor.rgb, ndl);\n	result[1] = specComp * specularColor;\n	result[2] = vec3(0.);\n\n	return result;\n}\n\nvoid main(void) {\n	// Clip plane\n#ifdef CLIPPLANE\n	if (fClipDistance > 0.0)\n		discard;\n#endif\n\n	vec3 viewDirectionW = normalize(vEyePosition - vPositionW);\n\n	// Base color\n	vec4 baseColor = vec4(1., 1., 1., 1.);\n	vec3 diffuseColor = vDiffuseColor.rgb;\n\n#ifdef VERTEXCOLOR\n	diffuseColor *= vColor;\n#endif\n\n#ifdef DIFFUSE\n	baseColor = texture2D(diffuseSampler, vDiffuseUV);\n\n#ifdef ALPHATEST\n	if (baseColor.a < 0.4)\n		discard;\n#endif\n\n	baseColor.rgb *= vDiffuseInfos.y;\n#endif\n\n	// Bump\n	vec3 normalW = normalize(vNormalW);\n\n	// Ambient color\n	vec3 baseAmbientColor = vec3(1., 1., 1.);\n\n#ifdef AMBIENT\n	baseAmbientColor = texture2D(ambientSampler, vAmbientUV).rgb * vAmbientInfos.y;\n#endif\n\n	// Lighting\n	vec3 diffuseBase = vec3(0., 0., 0.);\n	vec3 specularBase = vec3(0., 0., 0.);\n	float shadow = 1.;\n\n#ifdef LIGHT0\n#ifdef SPOTLIGHT0\n	mat3 info = computeSpotLighting(viewDirectionW, normalW, vLightData0, vLightDirection0, vLightDiffuse0, vLightSpecular0);\n#endif\n#ifdef HEMILIGHT0\n	mat3 info = computeHemisphericLighting(viewDirectionW, normalW, vLightData0, vLightDiffuse0, vLightSpecular0, vLightGround0);\n#endif\n#ifdef POINTDIRLIGHT0\n	mat3 info = computeLighting(viewDirectionW, normalW, vLightData0, vLightDiffuse0, vLightSpecular0);\n#endif\n#ifdef SHADOW0\n#ifdef SHADOWVSM0\n	shadow = computeShadowWithVSM(vPositionFromLight0, shadowSampler0);\n#else\n	shadow = computeShadow(vPositionFromLight0, shadowSampler0);\n#endif\n#else\n	shadow = 1.;\n#endif\n	diffuseBase += info[0] * shadow;\n	specularBase += info[1] * shadow;\n#endif\n\n#ifdef LIGHT1\n#ifdef SPOTLIGHT1\n	info = computeSpotLighting(viewDirectionW, normalW, vLightData1, vLightDirection1, vLightDiffuse1, vLightSpecular1);\n#endif\n#ifdef HEMILIGHT1\n	info = computeHemisphericLighting(viewDirectionW, normalW, vLightData1, vLightDiffuse1, vLightSpecular1, vLightGround1);\n#endif\n#ifdef POINTDIRLIGHT1\n	info = computeLighting(viewDirectionW, normalW, vLightData1, vLightDiffuse1, vLightSpecular1);\n#endif\n#ifdef SHADOW1\n#ifdef SHADOWVSM1\n	shadow = computeShadowWithVSM(vPositionFromLight1, shadowSampler1);\n#else\n	shadow = computeShadow(vPositionFromLight1, shadowSampler1);\n#endif\n#else\n	shadow = 1.;\n#endif\n	diffuseBase += info[0] * shadow;\n	specularBase += info[1] * shadow;\n#endif\n\n#ifdef LIGHT2\n#ifdef SPOTLIGHT2\n	info = computeSpotLighting(viewDirectionW, normalW, vLightData2, vLightDirection2, vLightDiffuse2, vLightSpecular2);\n#endif\n#ifdef HEMILIGHT2\n	info = computeHemisphericLighting(viewDirectionW, normalW, vLightData2, vLightDiffuse2, vLightSpecular2, vLightGround2);\n#endif\n#ifdef POINTDIRLIGHT2\n	info = computeLighting(viewDirectionW, normalW, vLightData2, vLightDiffuse2, vLightSpecular2);\n#endif\n#ifdef SHADOW2\n#ifdef SHADOWVSM2\n	shadow = computeShadowWithVSM(vPositionFromLight2, shadowSampler2);\n#else\n	shadow = computeShadow(vPositionFromLight2, shadowSampler2);\n#endif	\n#else\n	shadow = 1.;\n#endif\n	diffuseBase += info[0] * shadow;\n	specularBase += info[1] * shadow;\n#endif\n\n#ifdef LIGHT3\n#ifdef SPOTLIGHT3\n	info = computeSpotLighting(viewDirectionW, normalW, vLightData3, vLightDirection3, vLightDiffuse3, vLightSpecular3);\n#endif\n#ifdef HEMILIGHT3\n	info = computeHemisphericLighting(viewDirectionW, normalW, vLightData3, vLightDiffuse3, vLightSpecular3, vLightGround3);\n#endif\n#ifdef POINTDIRLIGHT3\n	info = computeLighting(viewDirectionW, normalW, vLightData3, vLightDiffuse3, vLightSpecular3);\n#endif\n#ifdef SHADOW3\n#ifdef SHADOWVSM3\n	shadow = computeShadowWithVSM(vPositionFromLight3, shadowSampler3);\n#else\n	shadow = computeShadow(vPositionFromLight3, shadowSampler3);\n#endif	\n#else\n	shadow = 1.;\n#endif\n	diffuseBase += info[0] * shadow;\n	specularBase += info[1] * shadow;\n#endif\n\n	// Reflection\n	vec3 reflectionColor = vec3(0., 0., 0.);\n\n#ifdef REFLECTION\n	if (vReflectionInfos.z != 0.0)\n	{\n		reflectionColor = textureCube(reflectionCubeSampler, vReflectionUVW).rgb * vReflectionInfos.y;\n	}\n	else\n	{\n		vec2 coords = vReflectionUVW.xy;\n\n		if (vReflectionInfos.x == MAP_PROJECTION)\n		{\n			coords /= vReflectionUVW.z;\n		}\n\n		coords.y = 1.0 - coords.y;\n\n		reflectionColor = texture2D(reflection2DSampler, coords).rgb * vReflectionInfos.y;\n	}\n#endif\n\n	// Alpha\n	float alpha = vDiffuseColor.a;\n\n#ifdef OPACITY\n	vec4 opacityMap = texture2D(opacitySampler, vOpacityUV);\n#ifdef OPACITYRGB\n	opacityMap.rgb = opacityMap.rgb * vec3(0.3, 0.59, 0.11);\n	alpha *= (opacityMap.x + opacityMap.y + opacityMap.z)* vOpacityInfos.y;\n#else\n	alpha *= opacityMap.a * vOpacityInfos.y;\n#endif\n#endif\n\n	// Emissive\n	vec3 emissiveColor = vEmissiveColor;\n#ifdef EMISSIVE\n	emissiveColor += texture2D(emissiveSampler, vEmissiveUV).rgb * vEmissiveInfos.y;\n#endif\n\n	// Specular map\n	vec3 specularColor = vSpecularColor.rgb;\n#ifdef SPECULAR\n	specularColor = texture2D(specularSampler, vSpecularUV).rgb * vSpecularInfos.y;\n#endif\n\n	// Composition\n	vec3 finalDiffuse = clamp(diffuseBase * diffuseColor + emissiveColor + vAmbientColor, 0.0, 1.0) * baseColor.rgb;\n	vec3 finalSpecular = specularBase * specularColor;\n\n	vec4 color = vec4(finalDiffuse * baseAmbientColor + finalSpecular + reflectionColor, alpha);\n\n#ifdef FOG\n	float fog = CalcFogFactor();\n	color.rgb = fog * color.rgb + (1.0 - fog) * vFogColor;\n#endif\n\n	gl_FragColor = color;\n}",legacydefaultVertexShader:"ifdef GL_ES\nprecision mediump float;\n#endif\n\n#define MAP_EXPLICIT	0.\n#define MAP_SPHERICAL	1.\n#define MAP_PLANAR		2.\n#define MAP_CUBIC		3.\n#define MAP_PROJECTION	4.\n#define MAP_SKYBOX		5.\n\n// Attributes\nattribute vec3 position;\nattribute vec3 normal;\n#ifdef UV1\nattribute vec2 uv;\n#endif\n#ifdef UV2\nattribute vec2 uv2;\n#endif\n#ifdef VERTEXCOLOR\nattribute vec3 color;\n#endif\n#ifdef BONES\nattribute vec4 matricesIndices;\nattribute vec4 matricesWeights;\n#endif\n\n// Uniforms\nuniform mat4 world;\nuniform mat4 view;\nuniform mat4 viewProjection;\n\n#ifdef DIFFUSE\nvarying vec2 vDiffuseUV;\nuniform mat4 diffuseMatrix;\nuniform vec2 vDiffuseInfos;\n#endif\n\n#ifdef AMBIENT\nvarying vec2 vAmbientUV;\nuniform mat4 ambientMatrix;\nuniform vec2 vAmbientInfos;\n#endif\n\n#ifdef OPACITY\nvarying vec2 vOpacityUV;\nuniform mat4 opacityMatrix;\nuniform vec2 vOpacityInfos;\n#endif\n\n#ifdef REFLECTION\nuniform vec3 vEyePosition;\nvarying vec3 vReflectionUVW;\nuniform vec3 vReflectionInfos;\nuniform mat4 reflectionMatrix;\n#endif\n\n#ifdef EMISSIVE\nvarying vec2 vEmissiveUV;\nuniform vec2 vEmissiveInfos;\nuniform mat4 emissiveMatrix;\n#endif\n\n#ifdef SPECULAR\nvarying vec2 vSpecularUV;\nuniform vec2 vSpecularInfos;\nuniform mat4 specularMatrix;\n#endif\n\n#ifdef BUMP\nvarying vec2 vBumpUV;\nuniform vec2 vBumpInfos;\nuniform mat4 bumpMatrix;\n#endif\n\n#ifdef BONES\nuniform mat4 mBones[BonesPerMesh];\n#endif\n\n// Output\nvarying vec3 vPositionW;\nvarying vec3 vNormalW;\n\n#ifdef VERTEXCOLOR\nvarying vec3 vColor;\n#endif\n\n#ifdef CLIPPLANE\nuniform vec4 vClipPlane;\nvarying float fClipDistance;\n#endif\n\n#ifdef FOG\nvarying float fFogDistance;\n#endif\n\n#ifdef SHADOWS\n#ifdef LIGHT0\nuniform mat4 lightMatrix0;\nvarying vec4 vPositionFromLight0;\n#endif\n#ifdef LIGHT1\nuniform mat4 lightMatrix1;\nvarying vec4 vPositionFromLight1;\n#endif\n#ifdef LIGHT2\nuniform mat4 lightMatrix2;\nvarying vec4 vPositionFromLight2;\n#endif\n#ifdef LIGHT3\nuniform mat4 lightMatrix3;\nvarying vec4 vPositionFromLight3;\n#endif\n#endif\n\n#ifdef REFLECTION\nvec3 computeReflectionCoords(float mode, vec4 worldPos, vec3 worldNormal)\n{\n	if (mode == MAP_SPHERICAL)\n	{\n		vec3 coords = vec3(view * vec4(worldNormal, 0.0));\n\n		return vec3(reflectionMatrix * vec4(coords, 1.0));\n	}\n	else if (mode == MAP_PLANAR)\n	{\n		vec3 viewDir = worldPos.xyz - vEyePosition;\n		vec3 coords = normalize(reflect(viewDir, worldNormal));\n\n		return vec3(reflectionMatrix * vec4(coords, 1));\n	}\n	else if (mode == MAP_CUBIC)\n	{\n		vec3 viewDir = worldPos.xyz - vEyePosition;\n		vec3 coords = reflect(viewDir, worldNormal);\n\n		return vec3(reflectionMatrix * vec4(coords, 0));\n	}\n	else if (mode == MAP_PROJECTION)\n	{\n		return vec3(reflectionMatrix * (view * worldPos));\n	}\n	else if (mode == MAP_SKYBOX)\n	{\n		return position;\n	}\n\n	return vec3(0, 0, 0);\n}\n#endif\n\nvoid main(void) {\n	mat4 finalWorld;\n\n#ifdef BONES\n	mat4 m0 = mBones[int(matricesIndices.x)] * matricesWeights.x;\n	mat4 m1 = mBones[int(matricesIndices.y)] * matricesWeights.y;\n	mat4 m2 = mBones[int(matricesIndices.z)] * matricesWeights.z;\n\n#ifdef BONES4\n	mat4 m3 = mBones[int(matricesIndices.w)] * matricesWeights.w;\n	finalWorld = world * (m0 + m1 + m2 + m3);\n#else\n	finalWorld = world * (m0 + m1 + m2);\n#endif \n\n#else\n	finalWorld = world;\n#endif\n\n	gl_Position = viewProjection * finalWorld * vec4(position, 1.0);\n\n	vec4 worldPos = finalWorld * vec4(position, 1.0);\n	vPositionW = vec3(worldPos);\n	vNormalW = normalize(vec3(finalWorld * vec4(normal, 0.0)));\n\n	// Texture coordinates\n#ifndef UV1\n	vec2 uv = vec2(0., 0.);\n#endif\n#ifndef UV2\n	vec2 uv2 = vec2(0., 0.);\n#endif\n\n#ifdef DIFFUSE\n	if (vDiffuseInfos.x == 0.)\n	{\n		vDiffuseUV = vec2(diffuseMatrix * vec4(uv, 1.0, 0.0));\n	}\n	else\n	{\n		vDiffuseUV = vec2(diffuseMatrix * vec4(uv2, 1.0, 0.0));\n	}\n#endif\n\n#ifdef AMBIENT\n	if (vAmbientInfos.x == 0.)\n	{\n		vAmbientUV = vec2(ambientMatrix * vec4(uv, 1.0, 0.0));\n	}\n	else\n	{\n		vAmbientUV = vec2(ambientMatrix * vec4(uv2, 1.0, 0.0));\n	}\n#endif\n\n#ifdef OPACITY\n	if (vOpacityInfos.x == 0.)\n	{\n		vOpacityUV = vec2(opacityMatrix * vec4(uv, 1.0, 0.0));\n	}\n	else\n	{\n		vOpacityUV = vec2(opacityMatrix * vec4(uv2, 1.0, 0.0));\n	}\n#endif\n\n#ifdef REFLECTION\n	vReflectionUVW = computeReflectionCoords(vReflectionInfos.x, vec4(vPositionW, 1.0), vNormalW);\n#endif\n\n#ifdef EMISSIVE\n	if (vEmissiveInfos.x == 0.)\n	{\n		vEmissiveUV = vec2(emissiveMatrix * vec4(uv, 1.0, 0.0));\n	}\n	else\n	{\n		vEmissiveUV = vec2(emissiveMatrix * vec4(uv2, 1.0, 0.0));\n	}\n#endif\n\n#ifdef SPECULAR\n	if (vSpecularInfos.x == 0.)\n	{\n		vSpecularUV = vec2(specularMatrix * vec4(uv, 1.0, 0.0));\n	}\n	else\n	{\n		vSpecularUV = vec2(specularMatrix * vec4(uv2, 1.0, 0.0));\n	}\n#endif\n\n#ifdef BUMP\n	if (vBumpInfos.x == 0.)\n	{\n		vBumpUV = vec2(bumpMatrix * vec4(uv, 1.0, 0.0));\n	}\n	else\n	{\n		vBumpUV = vec2(bumpMatrix * vec4(uv2, 1.0, 0.0));\n	}\n#endif\n\n	// Clip plane\n#ifdef CLIPPLANE\n	fClipDistance = dot(worldPos, vClipPlane);\n#endif\n\n	// Fog\n#ifdef FOG\n	fFogDistance = (view * worldPos).z;\n#endif\n\n	// Shadows\n#ifdef SHADOWS\n#ifdef LIGHT0\n	vPositionFromLight0 = lightMatrix0 * worldPos;\n#endif\n#ifdef LIGHT1\n	vPositionFromLight1 = lightMatrix1 * worldPos;\n#endif\n#ifdef LIGHT2\n	vPositionFromLight2 = lightMatrix2 * worldPos;\n#endif\n#ifdef LIGHT3\n	vPositionFromLight3 = lightMatrix3 * worldPos;\n#endif\n#endif\n\n	// Vertex color\n#ifdef VERTEXCOLOR\n	vColor = color;\n#endif\n}",lensFlarePixelShader:"ifdef GL_ES\nprecision mediump float;\n#endif\n\n// Samplers\nvarying vec2 vUV;\nuniform sampler2D textureSampler;\n\n// Color\nuniform vec4 color;\n\nvoid main(void) {\n	vec4 baseColor = texture2D(textureSampler, vUV);\n\n	gl_FragColor = baseColor * color;\n}",lensFlareVertexShader:"ifdef GL_ES\nprecision mediump float;\n#endif\n\n// Attributes\nattribute vec2 position;\n\n// Uniforms\nuniform mat4 viewportMatrix;\n\n// Output\nvarying vec2 vUV;\n\nconst vec2 madd = vec2(0.5, 0.5);\n\nvoid main(void) {	\n\n	vUV = position * madd + madd;\n	gl_Position = viewportMatrix * vec4(position, 0.0, 1.0);\n}",oculusDistortionCorrectionPixelShader:"ifdef GL_ES\nprecision mediump float;\n#endif\n\n// Samplers\nvarying vec2 vUV;\nuniform sampler2D textureSampler;\nuniform vec2 LensCenter;\nuniform vec2 Scale;\nuniform vec2 ScaleIn;\nuniform vec4 HmdWarpParam;\n\nvec2 HmdWarp(vec2 in01) {\n\n	vec2 theta = (in01 - LensCenter) * ScaleIn; // Scales to [-1, 1]\n	float rSq = theta.x * theta.x + theta.y * theta.y;\n	vec2 rvector = theta * (HmdWarpParam.x + HmdWarpParam.y * rSq + HmdWarpParam.z * rSq * rSq + HmdWarpParam.w * rSq * rSq * rSq);\n	return LensCenter + Scale * rvector;\n}\n\n\n\nvoid main(void)\n{\n	vec2 tc = HmdWarp(vUV);\n	if (tc.x <0.0 || tc.x>1.0 || tc.y<0.0 || tc.y>1.0)\n		gl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);\n	else{\n		gl_FragColor = vec4(texture2D(textureSampler, tc).rgb, 1.0);\n	}\n}",particlesPixelShader:"ifdef GL_ES\r\nprecision mediump float;\r\n#endif\r\n\r\n// Samplers\r\nvarying vec2 vUV;\r\nvarying vec4 vColor;\r\nuniform vec4 textureMask;\r\nuniform sampler2D diffuseSampler;\r\n\r\n#ifdef CLIPPLANE\r\nvarying float fClipDistance;\r\n#endif\r\n\r\nvoid main(void) {\r\n#ifdef CLIPPLANE\r\n	if (fClipDistance > 0.0)\r\n		discard;\r\n#endif\r\n	vec4 baseColor = texture2D(diffuseSampler, vUV);\r\n\r\n	gl_FragColor = (baseColor * textureMask + (vec4(1., 1., 1., 1.) - textureMask)) * vColor;\r\n}",particlesVertexShader:"ifdef GL_ES\r\nprecision mediump float;\r\n#endif\r\n\r\n// Attributes\r\nattribute vec3 position;\r\nattribute vec4 color;\r\nattribute vec4 options;\r\n\r\n// Uniforms\r\nuniform mat4 view;\r\nuniform mat4 projection;\r\n\r\n// Output\r\nvarying vec2 vUV;\r\nvarying vec4 vColor;\r\n\r\n#ifdef CLIPPLANE\r\nuniform vec4 vClipPlane;\r\nuniform mat4 invView;\r\nvarying float fClipDistance;\r\n#endif\r\n\r\nvoid main(void) {	\r\n	vec3 viewPos = (view * vec4(position, 1.0)).xyz; \r\n	vec3 cornerPos;\r\n	float size = options.y;\r\n	float angle = options.x;\r\n	vec2 offset = options.zw;\r\n\r\n	cornerPos = vec3(offset.x - 0.5, offset.y  - 0.5, 0.) * size;\r\n\r\n	// Rotate\r\n	vec3 rotatedCorner;\r\n	rotatedCorner.x = cornerPos.x * cos(angle) - cornerPos.y * sin(angle);\r\n	rotatedCorner.y = cornerPos.x * sin(angle) + cornerPos.y * cos(angle);\r\n	rotatedCorner.z = 0.;\r\n\r\n	// Position\r\n	viewPos += rotatedCorner;\r\n	gl_Position = projection * vec4(viewPos, 1.0);   \r\n	\r\n	vColor = color;\r\n	vUV = offset;\r\n\r\n	// Clip plane\r\n#ifdef CLIPPLANE\r\n	vec4 worldPos = invView * vec4(viewPos, 1.0);\r\n	fClipDistance = dot(worldPos, vClipPlane);\r\n#endif\r\n}",passPixelShader:"ifdef GL_ES\nprecision mediump float;\n#endif\n\n// Samplers\nvarying vec2 vUV;\nuniform sampler2D textureSampler;\n\nvoid main(void) \n{\n	gl_FragColor = texture2D(textureSampler, vUV);\n}",postprocessVertexShader:"ifdef GL_ES\nprecision mediump float;\n#endif\n\n// Attributes\nattribute vec2 position;\n\n// Output\nvarying vec2 vUV;\n\nconst vec2 madd = vec2(0.5, 0.5);\n\nvoid main(void) {	\n\n	vUV = position * madd + madd;\n	gl_Position = vec4(position, 0.0, 1.0);\n}",refractionPixelShader:"ifdef GL_ES\nprecision mediump float;\n#endif\n\n// Samplers\nvarying vec2 vUV;\nuniform sampler2D textureSampler;\nuniform sampler2D refractionSampler;\n\n// Parameters\nuniform vec3 baseColor;\nuniform float depth;\nuniform float colorLevel;\n\nvoid main() {\n	float ref = 1.0 - texture2D(refractionSampler, vUV).r;\n\n	vec2 uv = vUV - vec2(0.5);\n	vec2 offset = uv * depth * ref;\n	vec3 sourceColor = texture2D(textureSampler, vUV - offset).rgb;\n\n	gl_FragColor = vec4(sourceColor + sourceColor * ref * colorLevel, 1.0);\n}",shadowMapPixelShader:"ifdef GL_ES\nprecision mediump float;\n#endif\n\nvec4 pack(float depth)\n{\n	const vec4 bitOffset = vec4(255. * 255. * 255., 255. * 255., 255., 1.);\n	const vec4 bitMask = vec4(0., 1. / 255., 1. / 255., 1. / 255.);\n	\n	vec4 comp = mod(depth * bitOffset * vec4(254.), vec4(255.)) / vec4(254.);\n	comp -= comp.xxyz * bitMask;\n	\n	return comp;\n}\n\n// Thanks to http://devmaster.net/\nvec2 packHalf(float depth) \n{ \n	const vec2 bitOffset = vec2(1.0 / 255., 0.);\n	vec2 color = vec2(depth, fract(depth * 255.));\n\n	return color - (color.yy * bitOffset);\n}\n\n#ifndef VSM\nvarying vec4 vPosition;\n#endif\n\n#ifdef ALPHATEST\nvarying vec2 vUV;\nuniform sampler2D diffuseSampler;\n#endif\n\nvoid main(void)\n{\n#ifdef ALPHATEST\n	if (texture2D(diffuseSampler, vUV).a < 0.4)\n		discard;\n#endif\n\n#ifdef VSM\n	float moment1 = gl_FragCoord.z / gl_FragCoord.w;\n	float moment2 = moment1 * moment1;\n	gl_FragColor = vec4(packHalf(moment1), packHalf(moment2));\n#else\n	gl_FragColor = pack(vPosition.z / vPosition.w);\n#endif\n}",shadowMapVertexShader:"ifdef GL_ES\nprecision mediump float;\n#endif\n\n// Attribute\nattribute vec3 position;\n#ifdef BONES\nattribute vec4 matricesIndices;\nattribute vec4 matricesWeights;\n#endif\n\n// Uniform\n#ifdef INSTANCES\nattribute vec4 world0;\nattribute vec4 world1;\nattribute vec4 world2;\nattribute vec4 world3;\n#else\nuniform mat4 world;\n#endif\n\nuniform mat4 viewProjection;\n#ifdef BONES\nuniform mat4 mBones[BonesPerMesh];\n#endif\n\n#ifndef VSM\nvarying vec4 vPosition;\n#endif\n\n#ifdef ALPHATEST\nvarying vec2 vUV;\nuniform mat4 diffuseMatrix;\n#ifdef UV1\nattribute vec2 uv;\n#endif\n#ifdef UV2\nattribute vec2 uv2;\n#endif\n#endif\n\nvoid main(void)\n{\n#ifdef INSTANCES\n	mat4 finalWorld = mat4(world0, world1, world2, world3);\n#else\n	mat4 finalWorld = world;\n#endif\n\n#ifdef BONES\n	mat4 m0 = mBones[int(matricesIndices.x)] * matricesWeights.x;\n	mat4 m1 = mBones[int(matricesIndices.y)] * matricesWeights.y;\n	mat4 m2 = mBones[int(matricesIndices.z)] * matricesWeights.z;\n	mat4 m3 = mBones[int(matricesIndices.w)] * matricesWeights.w;\n	finalWorld = finalWorld * (m0 + m1 + m2 + m3);\n	gl_Position = viewProjection * finalWorld * vec4(position, 1.0);\n#else\n#ifndef VSM\n	vPosition = viewProjection * finalWorld * vec4(position, 1.0);\n#endif\n	gl_Position = viewProjection * finalWorld * vec4(position, 1.0);\n#endif\n\n#ifdef ALPHATEST\n#ifdef UV1\n	vUV = vec2(diffuseMatrix * vec4(uv, 1.0, 0.0));\n#endif\n#ifdef UV2\n	vUV = vec2(diffuseMatrix * vec4(uv2, 1.0, 0.0));\n#endif\n#endif\n}",spritesPixelShader:"ifdef GL_ES\r\nprecision mediump float;\r\n#endif\r\n\r\nuniform bool alphaTest;\r\n\r\nvarying vec4 vColor;\r\n\r\n// Samplers\r\nvarying vec2 vUV;\r\nuniform sampler2D diffuseSampler;\r\n\r\n// Fog\r\n#ifdef FOG\r\n\r\n#define FOGMODE_NONE    0.\r\n#define FOGMODE_EXP     1.\r\n#define FOGMODE_EXP2    2.\r\n#define FOGMODE_LINEAR  3.\r\n#define E 2.71828\r\n\r\nuniform vec4 vFogInfos;\r\nuniform vec3 vFogColor;\r\nvarying float fFogDistance;\r\n\r\nfloat CalcFogFactor()\r\n{\r\n	float fogCoeff = 1.0;\r\n	float fogStart = vFogInfos.y;\r\n	float fogEnd = vFogInfos.z;\r\n	float fogDensity = vFogInfos.w;\r\n\r\n	if (FOGMODE_LINEAR == vFogInfos.x)\r\n	{\r\n		fogCoeff = (fogEnd - fFogDistance) / (fogEnd - fogStart);\r\n	}\r\n	else if (FOGMODE_EXP == vFogInfos.x)\r\n	{\r\n		fogCoeff = 1.0 / pow(E, fFogDistance * fogDensity);\r\n	}\r\n	else if (FOGMODE_EXP2 == vFogInfos.x)\r\n	{\r\n		fogCoeff = 1.0 / pow(E, fFogDistance * fFogDistance * fogDensity * fogDensity);\r\n	}\r\n\r\n	return min(1., max(0., fogCoeff));\r\n}\r\n#endif\r\n\r\n\r\nvoid main(void) {\r\n	vec4 baseColor = texture2D(diffuseSampler, vUV);\r\n\r\n	if (alphaTest) \r\n	{\r\n		if (baseColor.a < 0.95)\r\n			discard;\r\n	}\r\n\r\n	baseColor *= vColor;\r\n\r\n#ifdef FOG\r\n	float fog = CalcFogFactor();\r\n	baseColor.rgb = fog * baseColor.rgb + (1.0 - fog) * vFogColor;\r\n#endif\r\n\r\n	gl_FragColor = baseColor;\r\n}",spritesVertexShader:"ifdef GL_ES\r\nprecision mediump float;\r\n#endif\r\n\r\n// Attributes\r\nattribute vec3 position;\r\nattribute vec4 options;\r\nattribute vec4 cellInfo;\r\nattribute vec4 color;\r\n\r\n// Uniforms\r\nuniform vec2 textureInfos;\r\nuniform mat4 view;\r\nuniform mat4 projection;\r\n\r\n// Output\r\nvarying vec2 vUV;\r\nvarying vec4 vColor;\r\n\r\n#ifdef FOG\r\nvarying float fFogDistance;\r\n#endif\r\n\r\nvoid main(void) {	\r\n	vec3 viewPos = (view * vec4(position, 1.0)).xyz; \r\n	vec3 cornerPos;\r\n	\r\n	float angle = options.x;\r\n	float size = options.y;\r\n	vec2 offset = options.zw;\r\n	vec2 uvScale = textureInfos.xy;\r\n\r\n	cornerPos = vec3(offset.x - 0.5, offset.y  - 0.5, 0.) * size;\r\n\r\n	// Rotate\r\n	vec3 rotatedCorner;\r\n	rotatedCorner.x = cornerPos.x * cos(angle) - cornerPos.y * sin(angle);\r\n	rotatedCorner.y = cornerPos.x * sin(angle) + cornerPos.y * cos(angle);\r\n	rotatedCorner.z = 0.;\r\n\r\n	// Position\r\n	viewPos += rotatedCorner;\r\n	gl_Position = projection * vec4(viewPos, 1.0);   \r\n\r\n	// Color\r\n	vColor = color;\r\n	\r\n	// Texture\r\n	vec2 uvOffset = vec2(abs(offset.x - cellInfo.x), 1.0 - abs(offset.y - cellInfo.y));\r\n\r\n	vUV = (uvOffset + cellInfo.zw) * uvScale;\r\n\r\n	// Fog\r\n#ifdef FOG\r\n	fFogDistance = viewPos.z;\r\n#endif\r\n}"};
var BABYLON;!function(e){var t=function(){function e(e,t,i){this.name=e,this.checkReadyOnEveryCall=!0,this.checkReadyOnlyOnce=!1,this.state="",this.alpha=1,this.wireframe=!1,this.backFaceCulling=!0,this._wasPreviouslyReady=!1,this.id=e,this._scene=t,i||t.materials.push(this)}return e.prototype.isReady=function(){return!0},e.prototype.getEffect=function(){return this._effect},e.prototype.getScene=function(){return this._scene},e.prototype.needAlphaBlending=function(){return this.alpha<1},e.prototype.needAlphaTesting=function(){return!1},e.prototype.getAlphaTestTexture=function(){return null},e.prototype.trackCreation=function(){},e.prototype._preBind=function(){var e=this._scene.getEngine();e.enableEffect(this._effect),e.setState(this.backFaceCulling)},e.prototype.bind=function(){},e.prototype.bindOnlyWorldMatrix=function(){},e.prototype.unbind=function(){},e.prototype.dispose=function(e){var t=this._scene.materials.indexOf(this);this._scene.materials.splice(t,1),e&&this._effect&&(this._scene.getEngine()._releaseEffect(this._effect),this._effect=null),this.onDispose&&this.onDispose()},e}();e.Material=t}(BABYLON||(BABYLON={}));var __extends=this.__extends||function(e,t){function i(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);i.prototype=t.prototype,e.prototype=new i},BABYLON;!function(e){var t=4,i=function(i){function r(t,r){var n=this;i.call(this,t,r),this.ambientColor=new e.Color3(0,0,0),this.diffuseColor=new e.Color3(1,1,1),this.specularColor=new e.Color3(1,1,1),this.specularPower=64,this.emissiveColor=new e.Color3(0,0,0),this.useAlphaFromDiffuseTexture=!1,this._cachedDefines=null,this._renderTargets=new e.SmartArray(16),this._worldViewProjectionMatrix=e.Matrix.Zero(),this._globalAmbientColor=new e.Color3(0,0,0),this._baseColor=new e.Color3,this._scaledDiffuse=new e.Color3,this._scaledSpecular=new e.Color3,this.getRenderTargetTextures=function(){return n._renderTargets.reset(),n.reflectionTexture&&n.reflectionTexture.isRenderTarget&&n._renderTargets.push(n.reflectionTexture),n._renderTargets}}return __extends(r,i),r.prototype.needAlphaBlending=function(){return this.alpha<1||null!=this.opacityTexture||this._shouldUseAlphaFromDiffuseTexture()},r.prototype.needAlphaTesting=function(){return null!=this.diffuseTexture&&this.diffuseTexture.hasAlpha&&!this.diffuseTexture.getAlphaFromRGB},r.prototype._shouldUseAlphaFromDiffuseTexture=function(){return null!=this.diffuseTexture&&this.diffuseTexture.hasAlpha&&this.useAlphaFromDiffuseTexture},r.prototype.getAlphaTestTexture=function(){return this.diffuseTexture},r.prototype.isReady=function(i,r){if(this.checkReadyOnlyOnce&&this._wasPreviouslyReady)return!0;var n=this.getScene();if(!this.checkReadyOnEveryCall&&this._renderId===n.getRenderId())return!0;var o=n.getEngine(),s=[],a=new Array;if(n.texturesEnabled){if(this.diffuseTexture&&e.StandardMaterial.DiffuseTextureEnabled){if(!this.diffuseTexture.isReady())return!1;s.push("#define DIFFUSE")}if(this.ambientTexture&&e.StandardMaterial.AmbientTextureEnabled){if(!this.ambientTexture.isReady())return!1;s.push("#define AMBIENT")}if(this.opacityTexture&&e.StandardMaterial.OpacityTextureEnabled){if(!this.opacityTexture.isReady())return!1;s.push("#define OPACITY"),this.opacityTexture.getAlphaFromRGB&&s.push("#define OPACITYRGB")}if(this.reflectionTexture&&e.StandardMaterial.ReflectionTextureEnabled){if(!this.reflectionTexture.isReady())return!1;s.push("#define REFLECTION")}if(this.emissiveTexture&&e.StandardMaterial.EmissiveTextureEnabled){if(!this.emissiveTexture.isReady())return!1;s.push("#define EMISSIVE")}if(this.specularTexture&&e.StandardMaterial.SpecularTextureEnabled){if(!this.specularTexture.isReady())return!1;s.push("#define SPECULAR"),a.push(s[s.length-1])}}if(n.getEngine().getCaps().standardDerivatives&&this.bumpTexture&&e.StandardMaterial.BumpTextureEnabled){if(!this.bumpTexture.isReady())return!1;s.push("#define BUMP"),a.push(s[s.length-1])}n.clipPlane&&s.push("#define CLIPPLANE"),o.getAlphaTesting()&&s.push("#define ALPHATEST"),this._shouldUseAlphaFromDiffuseTexture()&&s.push("#define ALPHAFROMDIFFUSE"),n.fogMode!==e.Scene.FOGMODE_NONE&&(s.push("#define FOG"),a.push(s[s.length-1]));var h=!1,c=0;if(n.lightsEnabled)for(var u=0;u<n.lights.length;u++){var l=n.lights[u];if(l.isEnabled()){if(l._excludedMeshesIds.length>0){for(var f=0;f<l._excludedMeshesIds.length;f++){var d=n.getMeshByID(l._excludedMeshesIds[f]);d&&l.excludedMeshes.push(d)}l._excludedMeshesIds=[]}if(!i||-1===l.excludedMeshes.indexOf(i)){s.push("#define LIGHT"+c),c>0&&a.push(s[s.length-1]);var p;p=l instanceof e.SpotLight?"#define SPOTLIGHT"+c:l instanceof e.HemisphericLight?"#define HEMILIGHT"+c:"#define POINTDIRLIGHT"+c,s.push(p),c>0&&a.push(s[s.length-1]);var m=l.getShadowGenerator();if(i&&i.receiveShadows&&m&&(s.push("#define SHADOW"+c),c>0&&a.push(s[s.length-1]),h||(s.push("#define SHADOWS"),h=!0),m.useVarianceShadowMap&&(s.push("#define SHADOWVSM"+c),c>0&&a.push(s[s.length-1]))),c++,c==t)break}}}var _=[e.VertexBuffer.PositionKind,e.VertexBuffer.NormalKind];i&&(i.isVerticesDataPresent(e.VertexBuffer.UVKind)&&(_.push(e.VertexBuffer.UVKind),s.push("#define UV1")),i.isVerticesDataPresent(e.VertexBuffer.UV2Kind)&&(_.push(e.VertexBuffer.UV2Kind),s.push("#define UV2")),i.isVerticesDataPresent(e.VertexBuffer.ColorKind)&&(_.push(e.VertexBuffer.ColorKind),s.push("#define VERTEXCOLOR")),i.skeleton&&i.isVerticesDataPresent(e.VertexBuffer.MatricesIndicesKind)&&i.isVerticesDataPresent(e.VertexBuffer.MatricesWeightsKind)&&(_.push(e.VertexBuffer.MatricesIndicesKind),_.push(e.VertexBuffer.MatricesWeightsKind),s.push("#define BONES"),s.push("#define BonesPerMesh "+(i.skeleton.bones.length+1)),s.push("#define BONES4"),a.push(s[s.length-1])),r&&(s.push("#define INSTANCES"),_.push("world0"),_.push("world1"),_.push("world2"),_.push("world3")));var g=s.join("\n");if(this._cachedDefines!=g){this._cachedDefines=g;var v="default";n.getEngine().getCaps().standardDerivatives||(v="legacydefault"),this._effect=n.getEngine().createEffect(v,_,["world","view","viewProjection","vEyePosition","vLightsType","vAmbientColor","vDiffuseColor","vSpecularColor","vEmissiveColor","vLightData0","vLightDiffuse0","vLightSpecular0","vLightDirection0","vLightGround0","lightMatrix0","vLightData1","vLightDiffuse1","vLightSpecular1","vLightDirection1","vLightGround1","lightMatrix1","vLightData2","vLightDiffuse2","vLightSpecular2","vLightDirection2","vLightGround2","lightMatrix2","vLightData3","vLightDiffuse3","vLightSpecular3","vLightDirection3","vLightGround3","lightMatrix3","vFogInfos","vFogColor","vDiffuseInfos","vAmbientInfos","vOpacityInfos","vReflectionInfos","vEmissiveInfos","vSpecularInfos","vBumpInfos","mBones","vClipPlane","diffuseMatrix","ambientMatrix","opacityMatrix","reflectionMatrix","emissiveMatrix","specularMatrix","bumpMatrix","darkness0","darkness1","darkness2","darkness3"],["diffuseSampler","ambientSampler","opacitySampler","reflectionCubeSampler","reflection2DSampler","emissiveSampler","specularSampler","bumpSampler","shadowSampler0","shadowSampler1","shadowSampler2","shadowSampler3"],g,a,this.onCompiled,this.onError)}return this._effect.isReady()?(this._renderId=n.getRenderId(),this._wasPreviouslyReady=!0,!0):!1},r.prototype.unbind=function(){this.reflectionTexture&&this.reflectionTexture.isRenderTarget&&this._effect.setTexture("reflection2DSampler",null)},r.prototype.bindOnlyWorldMatrix=function(e){this._effect.setMatrix("world",e)},r.prototype.bind=function(i,r){var n=this.getScene();if(this._baseColor.copyFrom(this.diffuseColor),this.bindOnlyWorldMatrix(i),this._effect.setMatrix("viewProjection",n.getTransformMatrix()),r.skeleton&&r.isVerticesDataPresent(e.VertexBuffer.MatricesIndicesKind)&&r.isVerticesDataPresent(e.VertexBuffer.MatricesWeightsKind)&&this._effect.setMatrices("mBones",r.skeleton.getTransformMatrices()),this.diffuseTexture&&e.StandardMaterial.DiffuseTextureEnabled&&(this._effect.setTexture("diffuseSampler",this.diffuseTexture),this._effect.setFloat2("vDiffuseInfos",this.diffuseTexture.coordinatesIndex,this.diffuseTexture.level),this._effect.setMatrix("diffuseMatrix",this.diffuseTexture.getTextureMatrix()),this._baseColor.copyFromFloats(1,1,1)),this.ambientTexture&&e.StandardMaterial.AmbientTextureEnabled&&(this._effect.setTexture("ambientSampler",this.ambientTexture),this._effect.setFloat2("vAmbientInfos",this.ambientTexture.coordinatesIndex,this.ambientTexture.level),this._effect.setMatrix("ambientMatrix",this.ambientTexture.getTextureMatrix())),this.opacityTexture&&e.StandardMaterial.OpacityTextureEnabled&&(this._effect.setTexture("opacitySampler",this.opacityTexture),this._effect.setFloat2("vOpacityInfos",this.opacityTexture.coordinatesIndex,this.opacityTexture.level),this._effect.setMatrix("opacityMatrix",this.opacityTexture.getTextureMatrix())),this.reflectionTexture&&e.StandardMaterial.ReflectionTextureEnabled&&(this.reflectionTexture.isCube?this._effect.setTexture("reflectionCubeSampler",this.reflectionTexture):this._effect.setTexture("reflection2DSampler",this.reflectionTexture),this._effect.setMatrix("reflectionMatrix",this.reflectionTexture.getReflectionTextureMatrix()),this._effect.setFloat3("vReflectionInfos",this.reflectionTexture.coordinatesMode,this.reflectionTexture.level,this.reflectionTexture.isCube?1:0)),this.emissiveTexture&&e.StandardMaterial.EmissiveTextureEnabled&&(this._effect.setTexture("emissiveSampler",this.emissiveTexture),this._effect.setFloat2("vEmissiveInfos",this.emissiveTexture.coordinatesIndex,this.emissiveTexture.level),this._effect.setMatrix("emissiveMatrix",this.emissiveTexture.getTextureMatrix())),this.specularTexture&&e.StandardMaterial.SpecularTextureEnabled&&(this._effect.setTexture("specularSampler",this.specularTexture),this._effect.setFloat2("vSpecularInfos",this.specularTexture.coordinatesIndex,this.specularTexture.level),this._effect.setMatrix("specularMatrix",this.specularTexture.getTextureMatrix())),this.bumpTexture&&n.getEngine().getCaps().standardDerivatives&&e.StandardMaterial.BumpTextureEnabled&&(this._effect.setTexture("bumpSampler",this.bumpTexture),this._effect.setFloat2("vBumpInfos",this.bumpTexture.coordinatesIndex,this.bumpTexture.level),this._effect.setMatrix("bumpMatrix",this.bumpTexture.getTextureMatrix())),n.ambientColor.multiplyToRef(this.ambientColor,this._globalAmbientColor),this._effect.setVector3("vEyePosition",n.activeCamera.position),this._effect.setColor3("vAmbientColor",this._globalAmbientColor),this._effect.setColor4("vDiffuseColor",this._baseColor,this.alpha*r.visibility),this._effect.setColor4("vSpecularColor",this.specularColor,this.specularPower),this._effect.setColor3("vEmissiveColor",this.emissiveColor),n.lightsEnabled)for(var o=0,s=0;s<n.lights.length;s++){var a=n.lights[s];if(a.isEnabled()&&(!r||-1===a.excludedMeshes.indexOf(r))){a instanceof e.PointLight?a.transferToEffect(this._effect,"vLightData"+o):a instanceof e.DirectionalLight?a.transferToEffect(this._effect,"vLightData"+o):a instanceof e.SpotLight?a.transferToEffect(this._effect,"vLightData"+o,"vLightDirection"+o):a instanceof e.HemisphericLight&&a.transferToEffect(this._effect,"vLightData"+o,"vLightGround"+o),a.diffuse.scaleToRef(a.intensity,this._scaledDiffuse),a.specular.scaleToRef(a.intensity,this._scaledSpecular),this._effect.setColor4("vLightDiffuse"+o,this._scaledDiffuse,a.range),this._effect.setColor3("vLightSpecular"+o,this._scaledSpecular);var h=a.getShadowGenerator();if(r.receiveShadows&&h&&(this._effect.setMatrix("lightMatrix"+o,h.getTransformMatrix()),this._effect.setTexture("shadowSampler"+o,h.getShadowMap()),this._effect.setFloat("darkness"+o,h.getDarkness())),o++,o==t)break}}if(n.clipPlane){var c=n.clipPlane;this._effect.setFloat4("vClipPlane",c.normal.x,c.normal.y,c.normal.z,c.d)}(n.fogMode!==e.Scene.FOGMODE_NONE||this.reflectionTexture)&&this._effect.setMatrix("view",n.getViewMatrix()),n.fogMode!==e.Scene.FOGMODE_NONE&&(this._effect.setFloat4("vFogInfos",n.fogMode,n.fogStart,n.fogEnd,n.fogDensity),this._effect.setColor3("vFogColor",n.fogColor))},r.prototype.getAnimatables=function(){var e=[];return this.diffuseTexture&&this.diffuseTexture.animations&&this.diffuseTexture.animations.length>0&&e.push(this.diffuseTexture),this.ambientTexture&&this.ambientTexture.animations&&this.ambientTexture.animations.length>0&&e.push(this.ambientTexture),this.opacityTexture&&this.opacityTexture.animations&&this.opacityTexture.animations.length>0&&e.push(this.opacityTexture),this.reflectionTexture&&this.reflectionTexture.animations&&this.reflectionTexture.animations.length>0&&e.push(this.reflectionTexture),this.emissiveTexture&&this.emissiveTexture.animations&&this.emissiveTexture.animations.length>0&&e.push(this.emissiveTexture),this.specularTexture&&this.specularTexture.animations&&this.specularTexture.animations.length>0&&e.push(this.specularTexture),this.bumpTexture&&this.bumpTexture.animations&&this.bumpTexture.animations.length>0&&e.push(this.bumpTexture),e},r.prototype.dispose=function(e){this.diffuseTexture&&this.diffuseTexture.dispose(),this.ambientTexture&&this.ambientTexture.dispose(),this.opacityTexture&&this.opacityTexture.dispose(),this.reflectionTexture&&this.reflectionTexture.dispose(),this.emissiveTexture&&this.emissiveTexture.dispose(),this.specularTexture&&this.specularTexture.dispose(),this.bumpTexture&&this.bumpTexture.dispose(),i.prototype.dispose.call(this,e)},r.prototype.clone=function(t){var i=new e.StandardMaterial(t,this.getScene());return i.checkReadyOnEveryCall=this.checkReadyOnEveryCall,i.alpha=this.alpha,i.wireframe=this.wireframe,i.backFaceCulling=this.backFaceCulling,this.diffuseTexture&&this.diffuseTexture.clone&&(i.diffuseTexture=this.diffuseTexture.clone()),this.ambientTexture&&this.ambientTexture.clone&&(i.ambientTexture=this.ambientTexture.clone()),this.opacityTexture&&this.opacityTexture.clone&&(i.opacityTexture=this.opacityTexture.clone()),this.reflectionTexture&&this.reflectionTexture.clone&&(i.reflectionTexture=this.reflectionTexture.clone()),this.emissiveTexture&&this.emissiveTexture.clone&&(i.emissiveTexture=this.emissiveTexture.clone()),this.specularTexture&&this.specularTexture.clone&&(i.specularTexture=this.specularTexture.clone()),this.bumpTexture&&this.bumpTexture.clone&&(i.bumpTexture=this.bumpTexture.clone()),i.ambientColor=this.ambientColor.clone(),i.diffuseColor=this.diffuseColor.clone(),i.specularColor=this.specularColor.clone(),i.specularPower=this.specularPower,i.emissiveColor=this.emissiveColor.clone(),i},r.DiffuseTextureEnabled=!0,r.AmbientTextureEnabled=!0,r.OpacityTextureEnabled=!0,r.ReflectionTextureEnabled=!0,r.EmissiveTextureEnabled=!0,r.SpecularTextureEnabled=!0,r.BumpTextureEnabled=!0,r}(e.Material);e.StandardMaterial=i}(BABYLON||(BABYLON={}));var __extends=this.__extends||function(e,t){function i(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);i.prototype=t.prototype,e.prototype=new i},BABYLON;!function(e){var t=function(e){function t(t,i){e.call(this,t,i,!0),this.subMaterials=new Array,i.multiMaterials.push(this)}return __extends(t,e),t.prototype.getSubMaterial=function(e){return 0>e||e>=this.subMaterials.length?this.getScene().defaultMaterial:this.subMaterials[e]},t.prototype.isReady=function(e){for(var t=0;t<this.subMaterials.length;t++){var i=this.subMaterials[t];if(i&&!this.subMaterials[t].isReady(e))return!1}return!0},t}(e.Material);e.MultiMaterial=t}(BABYLON||(BABYLON={}));var BABYLON=BABYLON||{};!function(){BABYLON.SceneLoader={_registeredPlugins:[],_getPluginForFilename:function(e){for(var t=e.lastIndexOf("."),i=e.substring(t).toLowerCase(),r=0;r<this._registeredPlugins.length;r++){var n=this._registeredPlugins[r];if(-1!==n.extensions.indexOf(i))return n}return this._registeredPlugins[this._registeredPlugins.length-1]},ForceFullSceneLoadingForIncremental:!1,RegisterPlugin:function(e){e.extensions=e.extensions.toLowerCase(),this._registeredPlugins.push(e)},ImportMesh:function(e,t,i,r,n,o,s){var a=new BABYLON.Database(t+i);r.database=a;var h=this._getPluginForFilename(i),c=function(o){var a=[],c=[],u=[];return h.importMesh(e,r,o,t,a,c,u)?void(n&&(r.importedMeshesFiles.push(t+i),n(a,c,u))):void(s&&s(r))};return i.substr&&"data:"===i.substr(0,5)?void c(i.substr(5)):void BABYLON.Tools.LoadFile(t+i,function(e){c(e)},o,a)},Load:function(e,t,i,r,n,o){var s,a=this._getPluginForFilename(t.name||t),h=function(t){var n=new BABYLON.Scene(i);return n.database=s,a.load(n,t,e)?void(r&&r(n)):void(o&&o(n))};return t.substr&&"data:"===t.substr(0,5)?void h(t.substr(5)):void(-1===e.indexOf("file:")?(s=new BABYLON.Database(e+t),BABYLON.Tools.LoadFile(e+t,h,n,s)):BABYLON.Tools.ReadFile(t,h,n))}}}();var BABYLON=BABYLON||{};!function(){var e=function(e,t,i){var r=new BABYLON.CubeTexture(e+t.name,i);return r.name=t.name,r.hasAlpha=t.hasAlpha,r.level=t.level,r.coordinatesMode=t.coordinatesMode,r},t=function(t,i,r){if(!i.name&&!i.isRenderTarget)return null;if(i.isCube)return e(t,i,r);var n;if(i.mirrorPlane?(n=new BABYLON.MirrorTexture(i.name,i.renderTargetSize,r),n._waitingRenderList=i.renderList,n.mirrorPlane=BABYLON.Plane.FromArray(i.mirrorPlane)):i.isRenderTarget?(n=new BABYLON.RenderTargetTexture(i.name,i.renderTargetSize,r),n._waitingRenderList=i.renderList):n=new BABYLON.Texture(t+i.name,r),n.name=i.name,n.hasAlpha=i.hasAlpha,n.getAlphaFromRGB=i.getAlphaFromRGB,n.level=i.level,n.coordinatesIndex=i.coordinatesIndex,n.coordinatesMode=i.coordinatesMode,n.uOffset=i.uOffset,n.vOffset=i.vOffset,n.uScale=i.uScale,n.vScale=i.vScale,n.uAng=i.uAng,n.vAng=i.vAng,n.wAng=i.wAng,n.wrapU=i.wrapU,n.wrapV=i.wrapV,i.animations)for(var o=0;o<i.animations.length;o++){var s=i.animations[o];n.animations.push(c(s))}return n},i=function(e,t){for(var i=new BABYLON.Skeleton(e.name,e.id,t),r=0;r<e.bones.length;r++){var n=e.bones[r],o=null;n.parentBoneIndex>-1&&(o=i.bones[n.parentBoneIndex]);var s=new BABYLON.Bone(n.name,i,o,BABYLON.Matrix.FromArray(n.matrix));n.animation&&s.animations.push(c(n.animation))}return i},r=function(e,i,r){var n;return n=new BABYLON.StandardMaterial(e.name,i),n.ambientColor=BABYLON.Color3.FromArray(e.ambient),n.diffuseColor=BABYLON.Color3.FromArray(e.diffuse),n.specularColor=BABYLON.Color3.FromArray(e.specular),n.specularPower=e.specularPower,n.emissiveColor=BABYLON.Color3.FromArray(e.emissive),n.alpha=e.alpha,n.id=e.id,BABYLON.Tags.AddTagsTo(n,e.tags),n.backFaceCulling=e.backFaceCulling,e.diffuseTexture&&(n.diffuseTexture=t(r,e.diffuseTexture,i)),e.ambientTexture&&(n.ambientTexture=t(r,e.ambientTexture,i)),e.opacityTexture&&(n.opacityTexture=t(r,e.opacityTexture,i)),e.reflectionTexture&&(n.reflectionTexture=t(r,e.reflectionTexture,i)),e.emissiveTexture&&(n.emissiveTexture=t(r,e.emissiveTexture,i)),e.specularTexture&&(n.specularTexture=t(r,e.specularTexture,i)),e.bumpTexture&&(n.bumpTexture=t(r,e.bumpTexture,i)),n},n=function(e,t,i,n){for(var o=0;o<t.materials.length;o++){var s=t.materials[o];if(s.id===e)return r(s,i,n)}return null},o=function(e,t){var i=new BABYLON.MultiMaterial(e.name,t);i.id=e.id,BABYLON.Tags.AddTagsTo(i,e.tags);for(var r=0;r<e.materials.length;r++){var n=e.materials[r];i.subMaterials.push(n?t.getMaterialByID(n):null)}return i},s=function(e,t,i){var r=t.getLastEntryByID(e.emitterId),n=new BABYLON.LensFlareSystem("lensFlareSystem#"+e.emitterId,r,t);n.borderLimit=e.borderLimit;for(var o=0;o<e.flares.length;o++){var s=e.flares[o];new BABYLON.LensFlare(s.size,s.position,BABYLON.Color3.FromArray(s.color),i+s.textureName,n)}return n},a=function(e,t,i){var r=t.getLastMeshByID(e.emitterId),n=new BABYLON.ParticleSystem("particles#"+r.name,e.capacity,t);return e.textureName&&(n.particleTexture=new BABYLON.Texture(i+e.textureName,t),n.particleTexture.name=e.textureName),n.minAngularSpeed=e.minAngularSpeed,n.maxAngularSpeed=e.maxAngularSpeed,n.minSize=e.minSize,n.maxSize=e.maxSize,n.minLifeTime=e.minLifeTime,n.maxLifeTime=e.maxLifeTime,n.emitter=r,n.emitRate=e.emitRate,n.minEmitBox=BABYLON.Vector3.FromArray(e.minEmitBox),n.maxEmitBox=BABYLON.Vector3.FromArray(e.maxEmitBox),n.gravity=BABYLON.Vector3.FromArray(e.gravity),n.direction1=BABYLON.Vector3.FromArray(e.direction1),n.direction2=BABYLON.Vector3.FromArray(e.direction2),n.color1=BABYLON.Color4.FromArray(e.color1),n.color2=BABYLON.Color4.FromArray(e.color2),n.colorDead=BABYLON.Color4.FromArray(e.colorDead),n.updateSpeed=e.updateSpeed,n.targetStopDuration=e.targetStopFrame,n.textureMask=BABYLON.Color4.FromArray(e.textureMask),n.blendMode=e.blendMode,n.start(),n},h=function(e,t){for(var i=t.getLightByID(e.lightId),r=new BABYLON.ShadowGenerator(e.mapSize,i),n=0;n<e.renderList.length;n++){var o=t.getMeshByID(e.renderList[n]);r.getShadowMap().renderList.push(o)}return r.useVarianceShadowMap=e.useVarianceShadowMap,r},c=function(e){for(var t=new BABYLON.Animation(e.name,e.property,e.framePerSecond,e.dataType,e.loopBehavior),i=e.dataType,r=[],n=0;n<e.keys.length;n++){var o,s=e.keys[n];switch(i){case BABYLON.Animation.ANIMATIONTYPE_FLOAT:o=s.values[0];break;case BABYLON.Animation.ANIMATIONTYPE_QUATERNION:o=BABYLON.Quaternion.FromArray(s.values);break;case BABYLON.Animation.ANIMATIONTYPE_MATRIX:o=BABYLON.Matrix.FromArray(s.values);break;case BABYLON.Animation.ANIMATIONTYPE_VECTOR3:default:o=BABYLON.Vector3.FromArray(s.values)}r.push({frame:s.frame,value:o})}return t.setKeys(r),t},u=function(e,t){var i;switch(e.type){case 0:i=new BABYLON.PointLight(e.name,BABYLON.Vector3.FromArray(e.position),t);break;case 1:i=new BABYLON.DirectionalLight(e.name,BABYLON.Vector3.FromArray(e.direction),t),i.position=BABYLON.Vector3.FromArray(e.position);break;case 2:i=new BABYLON.SpotLight(e.name,BABYLON.Vector3.FromArray(e.position),BABYLON.Vector3.FromArray(e.direction),e.angle,e.exponent,t);break;case 3:i=new BABYLON.HemisphericLight(e.name,BABYLON.Vector3.FromArray(e.direction),t),i.groundColor=BABYLON.Color3.FromArray(e.groundColor)}if(i.id=e.id,BABYLON.Tags.AddTagsTo(i,e.tags),void 0!==e.intensity&&(i.intensity=e.intensity),e.range&&(i.range=e.range),i.diffuse=BABYLON.Color3.FromArray(e.diffuse),i.specular=BABYLON.Color3.FromArray(e.specular),e.excludedMeshesIds&&(i._excludedMeshesIds=e.excludedMeshesIds),e.animations)for(var r=0;r<e.animations.length;r++){var n=e.animations[r];i.animations.push(c(n))}e.autoAnimate&&t.beginAnimation(i,e.autoAnimateFrom,e.autoAnimateTo,e.autoAnimateLoop,1)},l=function(e,t){var i=new BABYLON.FreeCamera(e.name,BABYLON.Vector3.FromArray(e.position),t);if(i.id=e.id,BABYLON.Tags.AddTagsTo(i,e.tags),e.parentId&&(i._waitingParentId=e.parentId),e.target?i.setTarget(BABYLON.Vector3.FromArray(e.target)):i.rotation=BABYLON.Vector3.FromArray(e.rotation),e.lockedTargetId&&(i._waitingLockedTargetId=e.lockedTargetId),i.fov=e.fov,i.minZ=e.minZ,i.maxZ=e.maxZ,i.speed=e.speed,i.inertia=e.inertia,i.checkCollisions=e.checkCollisions,i.applyGravity=e.applyGravity,e.ellipsoid&&(i.ellipsoid=BABYLON.Vector3.FromArray(e.ellipsoid)),e.animations)for(var r=0;r<e.animations.length;r++){var n=e.animations[r];i.animations.push(c(n))}return e.autoAnimate&&t.beginAnimation(i,e.autoAnimateFrom,e.autoAnimateTo,e.autoAnimateLoop,1),i.layerMask=e.layerMask&&!isNaN(e.layerMask)?Math.abs(parseInt(e.layerMask)):4294967295,i},f=function(e,t){var i=e.id;return t.getGeometryByID(i)},d=function(e,t){if(f(e,t))return null;var i=new BABYLON.Geometry.Primitives.Box(e.id,t.getEngine(),e.size,e.canBeRegenerated,null);return BABYLON.Tags.AddTagsTo(i,e.tags),t.pushGeometry(i,!0),i},p=function(e,t){if(f(e,t))return null;var i=new BABYLON.Geometry.Primitives.Sphere(e.id,t.getEngine(),e.segments,e.diameter,e.canBeRegenerated,null);return BABYLON.Tags.AddTagsTo(i,e.tags),t.pushGeometry(i,!0),i},m=function(e,t){if(f(e,t))return null;var i=new BABYLON.Geometry.Primitives.Cylinder(e.id,t.getEngine(),e.height,e.diameterTop,e.diameterBottom,e.tessellation,e.canBeRegenerated,null);return BABYLON.Tags.AddTagsTo(i,e.tags),t.pushGeometry(i,!0),i},_=function(e,t){if(f(e,t))return null;var i=new BABYLON.Geometry.Primitives.Torus(e.id,t.getEngine(),e.diameter,e.thickness,e.tessellation,e.canBeRegenerated,null);return BABYLON.Tags.AddTagsTo(i,e.tags),t.pushGeometry(i,!0),i},g=function(e,t){if(f(e,t))return null;var i=new BABYLON.Geometry.Primitives.Ground(e.id,t.getEngine(),e.width,e.height,e.subdivisions,e.canBeRegenerated,null);return BABYLON.Tags.AddTagsTo(i,e.tags),t.pushGeometry(i,!0),i},v=function(e,t){if(f(e,t))return null;var i=new BABYLON.Geometry.Primitives.Plane(e.id,t.getEngine(),e.size,e.canBeRegenerated,null);return BABYLON.Tags.AddTagsTo(i,e.tags),t.pushGeometry(i,!0),i},y=function(e,t){if(f(e,t))return null;var i=new BABYLON.Geometry.Primitives.TorusKnot(e.id,t.getEngine(),e.radius,e.tube,e.radialSegments,e.tubularSegments,e.p,e.q,e.canBeRegenerated,null);return BABYLON.Tags.AddTagsTo(i,e.tags),t.pushGeometry(i,!0),i},x=function(e,t,i){if(f(e,t))return null;var r=new BABYLON.Geometry(e.id,t);return BABYLON.Tags.AddTagsTo(r,e.tags),e.delayLoadingFile?(r.delayLoadState=BABYLON.Engine.DELAYLOADSTATE_NOTLOADED,r.delayLoadingFile=i+e.delayLoadingFile,r._boundingInfo=new BABYLON.BoundingInfo(BABYLON.Vector3.FromArray(e.boundingBoxMinimum),BABYLON.Vector3.FromArray(e.boundingBoxMaximum)),r._delayInfo=[],e.hasUVs&&r._delayInfo.push(BABYLON.VertexBuffer.UVKind),e.hasUVs2&&r._delayInfo.push(BABYLON.VertexBuffer.UV2Kind),e.hasColors&&r._delayInfo.push(BABYLON.VertexBuffer.ColorKind),e.hasMatricesIndices&&r._delayInfo.push(BABYLON.VertexBuffer.MatricesIndicesKind),e.hasMatricesWeights&&r._delayInfo.push(BABYLON.VertexBuffer.MatricesWeightsKind),r._delayLoadingFunction=T):T(e,r),t.pushGeometry(r,!0),r},A=function(e,t,i){var r=new BABYLON.Mesh(e.name,t);if(r.id=e.id,BABYLON.Tags.AddTagsTo(r,e.tags),r.position=BABYLON.Vector3.FromArray(e.position),e.rotationQuaternion?r.rotationQuaternion=BABYLON.Quaternion.FromArray(e.rotationQuaternion):e.rotation&&(r.rotation=BABYLON.Vector3.FromArray(e.rotation)),r.scaling=BABYLON.Vector3.FromArray(e.scaling),e.localMatrix?r.setPivotMatrix(BABYLON.Matrix.FromArray(e.localMatrix)):e.pivotMatrix&&r.setPivotMatrix(BABYLON.Matrix.FromArray(e.pivotMatrix)),r.setEnabled(e.isEnabled),r.isVisible=e.isVisible,r.infiniteDistance=e.infiniteDistance,r.showBoundingBox=e.showBoundingBox,r.showSubMeshesBoundingBox=e.showSubMeshesBoundingBox,void 0!==e.pickable&&(r.isPickable=e.pickable),r.receiveShadows=e.receiveShadows,r.billboardMode=e.billboardMode,void 0!==e.visibility&&(r.visibility=e.visibility),r.checkCollisions=e.checkCollisions,r._shouldGenerateFlatShading=e.useFlatShading,e.parentId&&(r.parent=t.getLastEntryByID(e.parentId)),e.delayLoadingFile?(r.delayLoadState=BABYLON.Engine.DELAYLOADSTATE_NOTLOADED,r.delayLoadingFile=i+e.delayLoadingFile,r._boundingInfo=new BABYLON.BoundingInfo(BABYLON.Vector3.FromArray(e.boundingBoxMinimum),BABYLON.Vector3.FromArray(e.boundingBoxMaximum)),r._delayInfo=[],e.hasUVs&&r._delayInfo.push(BABYLON.VertexBuffer.UVKind),e.hasUVs2&&r._delayInfo.push(BABYLON.VertexBuffer.UV2Kind),e.hasColors&&r._delayInfo.push(BABYLON.VertexBuffer.ColorKind),e.hasMatricesIndices&&r._delayInfo.push(BABYLON.VertexBuffer.MatricesIndicesKind),e.hasMatricesWeights&&r._delayInfo.push(BABYLON.VertexBuffer.MatricesWeightsKind),r._delayLoadingFunction=b,BABYLON.SceneLoader.ForceFullSceneLoadingForIncremental&&r._checkDelayState()):b(e,r),e.materialId?r.setMaterialByID(e.materialId):r.material=null,e.skeletonId>-1&&(r.skeleton=t.getLastSkeletonByID(e.skeletonId)),e.physicsImpostor)switch(t.isPhysicsEnabled()||t.enablePhysics(),e.physicsImpostor){case 1:r.setPhysicsState({impostor:BABYLON.PhysicsEngine.BoxImpostor,mass:e.physicsMass,friction:e.physicsFriction,restitution:e.physicsRestitution});break;case 2:r.setPhysicsState({impostor:BABYLON.PhysicsEngine.SphereImpostor,mass:e.physicsMass,friction:e.physicsFriction,restitution:e.physicsRestitution})}if(e.animations)for(var n=0;n<e.animations.length;n++){var o=e.animations[n];r.animations.push(c(o))}if(e.autoAnimate&&t.beginAnimation(r,e.autoAnimateFrom,e.autoAnimateTo,e.autoAnimateLoop,1),r.layerMask=e.layerMask&&!isNaN(e.layerMask)?Math.abs(parseInt(e.layerMask)):4294967295,e.instances)for(var s=0;s<e.instances.length;s++){var a=e.instances[s],h=r.createInstance(a.name);if(BABYLON.Tags.AddTagsTo(h,a.tags),h.position=BABYLON.Vector3.FromArray(a.position),a.rotationQuaternion?h.rotationQuaternion=BABYLON.Quaternion.FromArray(a.rotationQuaternion):a.rotation&&(h.rotation=BABYLON.Vector3.FromArray(a.rotation)),h.scaling=BABYLON.Vector3.FromArray(a.scaling),h.checkCollisions=r.checkCollisions,e.animations)for(n=0;n<e.animations.length;n++)o=e.animations[n],h.animations.push(c(o))}return r},B=function(e,t,i){t=t instanceof Array?t:[t];for(var r in t)if(e.name===t[r])return i.push(e.id),!0;return e.parentId&&-1!==i.indexOf(e.parentId)?(i.push(e.id),!0):!1},T=function(e,t){var i=new BABYLON.VertexData,r=e.positions;r&&i.set(r,BABYLON.VertexBuffer.PositionKind);var n=e.normals;n&&i.set(n,BABYLON.VertexBuffer.NormalKind);var o=e.uvs;o&&i.set(o,BABYLON.VertexBuffer.UVKind);var s=e.uv2s;s&&i.set(s,BABYLON.VertexBuffer.UV2Kind);var a=e.colors;a&&i.set(a,BABYLON.VertexBuffer.ColorKind);var h=e.matricesIndices;h&&i.set(h,BABYLON.VertexBuffer.MatricesIndicesKind);var c=e.matricesWeights;c&&i.set(c,BABYLON.VertexBuffer.MatricesWeightsKind);var u=e.indices;u&&(i.indices=u),t.setAllVerticesData(i,e.updatable)},b=function(e,t){var i=t.getScene(),r=e.geometryId;if(r){var n=i.getGeometryByID(r);n&&n.applyToMesh(t)}else if(e.positions&&e.normals&&e.indices){if(t.setVerticesData(BABYLON.VertexBuffer.PositionKind,e.positions,!1),t.setVerticesData(BABYLON.VertexBuffer.NormalKind,e.normals,!1),e.uvs&&t.setVerticesData(BABYLON.VertexBuffer.UVKind,e.uvs,!1),e.uvs2&&t.setVerticesData(BABYLON.VertexBuffer.UV2Kind,e.uvs2,!1),e.colors&&t.setVerticesData(BABYLON.VertexBuffer.ColorKind,e.colors,!1),e.matricesIndices)if(e.matricesIndices._isExpanded)delete e.matricesIndices._isExpanded,t.setVerticesData(BABYLON.VertexBuffer.MatricesIndicesKind,e.matricesIndices,!1);else{for(var o=[],s=0;s<e.matricesIndices.length;s++){var a=e.matricesIndices[s];o.push(255&a),o.push((65280&a)>>8),o.push((16711680&a)>>16),o.push(a>>24)}t.setVerticesData(BABYLON.VertexBuffer.MatricesIndicesKind,o,!1)}e.matricesWeights&&t.setVerticesData(BABYLON.VertexBuffer.MatricesWeightsKind,e.matricesWeights,!1),t.setIndices(e.indices)}if(e.subMeshes){t.subMeshes=[];for(var h=0;h<e.subMeshes.length;h++){var c=e.subMeshes[h];new BABYLON.SubMesh(c.materialIndex,c.verticesStart,c.verticesCount,c.indexStart,c.indexCount,t)}}t.computeWorldMatrix(!0),t._shouldGenerateFlatShading&&(t.convertToFlatShadedMesh(),delete t._shouldGenerateFlatShading),i._selectionOctree&&i._selectionOctree.addMesh(t)};BABYLON.SceneLoader.RegisterPlugin({extensions:".babylon",importMesh:function(e,t,r,s,h,c,u){for(var l=JSON.parse(r),f=[],d=[],p=[],m=0;m<l.meshes.length;m++){var _=l.meshes[m];if(!e||B(_,e,p)){if(e instanceof Array&&delete e[e.indexOf(_.name)],_.materialId){var g=-1!==d.indexOf(_.materialId);if(!g)for(var v=0;v<l.multiMaterials.length;v++){var y=l.multiMaterials[v];if(y.id==_.materialId){for(var x=0;x<y.materials.length;x++){var T=y.materials[x];d.push(T),n(T,l,t,s)}d.push(y.id),o(y,t),g=!0;break}}g||(d.push(_.materialId),n(_.materialId,l,t,s))}if(_.skeletonId>-1&&t.skeletons){var b=f.indexOf(_.skeletonId)>-1;if(!b)for(var M=0;M<l.skeletons.length;M++){var L=l.skeletons[M];L.id===_.skeletonId&&(u.push(i(L,t)),f.push(L.id))}}var E=A(_,t,s);h.push(E)}}if(l.particleSystems)for(var m=0;m<l.particleSystems.length;m++){var O=l.particleSystems[m];-1!==p.indexOf(O.emitterId)&&c.push(a(O,t,s))}return!0},load:function(e,t,n){var c=JSON.parse(t);e.useDelayedTextureLoading=c.useDelayedTextureLoading&&!BABYLON.SceneLoader.ForceFullSceneLoadingForIncremental,e.autoClear=c.autoClear,e.clearColor=BABYLON.Color3.FromArray(c.clearColor),e.ambientColor=BABYLON.Color3.FromArray(c.ambientColor),e.gravity=BABYLON.Vector3.FromArray(c.gravity),c.fogMode&&0!==c.fogMode&&(e.fogMode=c.fogMode,e.fogColor=BABYLON.Color3.FromArray(c.fogColor),e.fogStart=c.fogStart,e.fogEnd=c.fogEnd,e.fogDensity=c.fogDensity);for(var f=0;f<c.lights.length;f++){var B=c.lights[f];
u(B,e)}for(var f=0;f<c.cameras.length;f++){var T=c.cameras[f];l(T,e)}if(c.activeCameraID&&e.setActiveCameraByID(c.activeCameraID),c.materials)for(var f=0;f<c.materials.length;f++){var b=c.materials[f];r(b,e,n)}if(c.multiMaterials)for(var f=0;f<c.multiMaterials.length;f++){var M=c.multiMaterials[f];o(M,e)}if(c.skeletons)for(var f=0;f<c.skeletons.length;f++){var L=c.skeletons[f];i(L,e)}var E=c.geometries;if(E){var O=E.boxes;if(O)for(var f=0;f<O.length;f++){var P=O[f];d(P,e)}var S=E.spheres;if(S)for(var f=0;f<S.length;f++){var w=S[f];p(w,e)}var C=E.cylinders;if(C)for(var f=0;f<C.length;f++){var I=C[f];m(I,e)}var D=E.toruses;if(D)for(var f=0;f<D.length;f++){var R=D[f];_(R,e)}var N=E.grounds;if(N)for(var f=0;f<N.length;f++){var V=N[f];g(V,e)}var F=E.planes;if(F)for(var f=0;f<F.length;f++){var k=F[f];v(k,e)}var Y=E.torusKnots;if(Y)for(var f=0;f<Y.length;f++){var z=Y[f];y(z,e)}var U=E.vertexData;if(U)for(var f=0;f<U.length;f++){var W=U[f];x(W,e,n)}}for(var f=0;f<c.meshes.length;f++){var G=c.meshes[f];A(G,e,n)}for(var f=0;f<e.cameras.length;f++){var H=e.cameras[f];H._waitingParentId&&(H.parent=e.getLastEntryByID(H._waitingParentId),delete H._waitingParentId),H._waitingLockedTargetId&&(H.lockedTarget=e.getLastEntryByID(H._waitingLockedTargetId),delete H._waitingLockedTargetId)}if(c.particleSystems)for(var f=0;f<c.particleSystems.length;f++){var X=c.particleSystems[f];a(X,e,n)}if(c.lensFlareSystems)for(var f=0;f<c.lensFlareSystems.length;f++){var j=c.lensFlareSystems[f];s(j,e,n)}if(c.shadowGenerators)for(var f=0;f<c.shadowGenerators.length;f++){var K=c.shadowGenerators[f];h(K,e)}return!0}})}();var BABYLON;!function(e){var t=function(){function t(t,i,r,n,o,s){this.name=t,this.cellSize=n,this.sprites=new Array,this.renderingGroupId=0,this._vertexDeclaration=[3,4,4,4],this._vertexStrideSize=60,this._capacity=r,this._spriteTexture=new e.Texture(i,o,!0,!1),this._spriteTexture.wrapU=e.Texture.CLAMP_ADDRESSMODE,this._spriteTexture.wrapV=e.Texture.CLAMP_ADDRESSMODE,this._epsilon=void 0===s?.01:s,this._scene=o,this._scene.spriteManagers.push(this),this._vertexDeclaration=[3,4,4,4],this._vertexStrideSize=60,this._vertexBuffer=o.getEngine().createDynamicVertexBuffer(r*this._vertexStrideSize*4);for(var a=[],h=0,c=0;r>c;c++)a.push(h),a.push(h+1),a.push(h+2),a.push(h),a.push(h+2),a.push(h+3),h+=4;this._indexBuffer=o.getEngine().createIndexBuffer(a),this._vertices=new Float32Array(r*this._vertexStrideSize),this._effectBase=this._scene.getEngine().createEffect("sprites",["position","options","cellInfo","color"],["view","projection","textureInfos","alphaTest"],["diffuseSampler"],""),this._effectFog=this._scene.getEngine().createEffect("sprites",["position","options","cellInfo","color"],["view","projection","textureInfos","alphaTest","vFogInfos","vFogColor"],["diffuseSampler"],"#define FOG")}return t.prototype._appendSpriteVertex=function(e,t,i,r,n){var o=15*e;0==i?i=this._epsilon:1==i&&(i=1-this._epsilon),0==r?r=this._epsilon:1==r&&(r=1-this._epsilon),this._vertices[o]=t.position.x,this._vertices[o+1]=t.position.y,this._vertices[o+2]=t.position.z,this._vertices[o+3]=t.angle,this._vertices[o+4]=t.size,this._vertices[o+5]=i,this._vertices[o+6]=r,this._vertices[o+7]=t.invertU?1:0,this._vertices[o+8]=t.invertV?1:0;var s=t.cellIndex/n>>0;this._vertices[o+9]=t.cellIndex-s*n,this._vertices[o+10]=s,this._vertices[o+11]=t.color.r,this._vertices[o+12]=t.color.g,this._vertices[o+13]=t.color.b,this._vertices[o+14]=t.color.a},t.prototype.render=function(){if(this._effectBase.isReady()&&this._effectFog.isReady()&&this._spriteTexture&&this._spriteTexture.isReady()){for(var t=this._scene.getEngine(),i=this._spriteTexture.getBaseSize(),r=e.Tools.GetDeltaTime(),n=Math.min(this._capacity,this.sprites.length),o=i.width/this.cellSize,s=0,a=0;n>a;a++){var h=this.sprites[a];h&&(h._animate(r),this._appendSpriteVertex(s++,h,0,0,o),this._appendSpriteVertex(s++,h,1,0,o),this._appendSpriteVertex(s++,h,1,1,o),this._appendSpriteVertex(s++,h,0,1,o))}t.updateDynamicVertexBuffer(this._vertexBuffer,this._vertices,n*this._vertexStrideSize);var c=this._effectBase;this._scene.fogMode!==e.Scene.FOGMODE_NONE&&(c=this._effectFog),t.enableEffect(c);var u=this._scene.getViewMatrix();c.setTexture("diffuseSampler",this._spriteTexture),c.setMatrix("view",u),c.setMatrix("projection",this._scene.getProjectionMatrix()),c.setFloat2("textureInfos",this.cellSize/i.width,this.cellSize/i.height),this._scene.fogMode!==e.Scene.FOGMODE_NONE&&(c.setFloat4("vFogInfos",this._scene.fogMode,this._scene.fogStart,this._scene.fogEnd,this._scene.fogDensity),c.setColor3("vFogColor",this._scene.fogColor)),t.bindBuffers(this._vertexBuffer,this._indexBuffer,this._vertexDeclaration,this._vertexStrideSize,c),c.setBool("alphaTest",!0),t.setColorWrite(!1),t.draw(!0,0,6*n),t.setColorWrite(!0),c.setBool("alphaTest",!1),t.setAlphaMode(e.Engine.ALPHA_COMBINE),t.draw(!0,0,6*n),t.setAlphaMode(e.Engine.ALPHA_DISABLE)}},t.prototype.dispose=function(){this._vertexBuffer&&(this._scene.getEngine()._releaseBuffer(this._vertexBuffer),this._vertexBuffer=null),this._indexBuffer&&(this._scene.getEngine()._releaseBuffer(this._indexBuffer),this._indexBuffer=null),this._spriteTexture&&(this._spriteTexture.dispose(),this._spriteTexture=null);var e=this._scene.spriteManagers.indexOf(this);this._scene.spriteManagers.splice(e,1),this.onDispose&&this.onDispose()},t}();e.SpriteManager=t}(BABYLON||(BABYLON={}));var BABYLON;!function(e){var t=function(){function t(t,i){this.name=t,this.color=new e.Color4(1,1,1,1),this.size=1,this.angle=0,this.cellIndex=0,this.invertU=0,this.invertV=0,this.animations=new Array,this._animationStarted=!1,this._loopAnimation=!1,this._fromIndex=0,this._toIndex=0,this._delay=0,this._direction=1,this._frameCount=0,this._time=0,this._manager=i,this._manager.sprites.push(this),this.position=e.Vector3.Zero()}return t.prototype.playAnimation=function(e,t,i,r){this._fromIndex=e,this._toIndex=t,this._loopAnimation=i,this._delay=r,this._animationStarted=!0,this._direction=t>e?1:-1,this.cellIndex=e,this._time=0},t.prototype.stopAnimation=function(){this._animationStarted=!1},t.prototype._animate=function(e){this._animationStarted&&(this._time+=e,this._time>this._delay&&(this._time=this._time%this._delay,this.cellIndex+=this._direction,this.cellIndex==this._toIndex&&(this._loopAnimation?this.cellIndex=this._fromIndex:(this._animationStarted=!1,this.disposeWhenFinishedAnimating&&this.dispose()))))},t.prototype.dispose=function(){for(var e=0;e<this._manager.sprites.length;e++)this._manager.sprites[e]==this&&this._manager.sprites.splice(e,1)},t}();e.Sprite=t}(BABYLON||(BABYLON={}));var BABYLON;!function(e){var t=function(){function t(t,i,r,n,o){this.name=t,this._vertexDeclaration=[2],this._vertexStrideSize=8,this.texture=i?new e.Texture(i,r,!0):null,this.isBackground=void 0===n?!0:n,this.color=void 0===o?new e.Color4(1,1,1,1):o,this._scene=r,this._scene.layers.push(this);var s=[];s.push(1,1),s.push(-1,1),s.push(-1,-1),s.push(1,-1),this._vertexBuffer=r.getEngine().createVertexBuffer(s);var a=[];a.push(0),a.push(1),a.push(2),a.push(0),a.push(2),a.push(3),this._indexBuffer=r.getEngine().createIndexBuffer(a),this._effect=this._scene.getEngine().createEffect("layer",["position"],["textureMatrix","color"],["textureSampler"],"")}return t.prototype.render=function(){if(this._effect.isReady()&&this.texture&&this.texture.isReady()){var t=this._scene.getEngine();t.enableEffect(this._effect),t.setState(!1),this._effect.setTexture("textureSampler",this.texture),this._effect.setMatrix("textureMatrix",this.texture.getTextureMatrix()),this._effect.setFloat4("color",this.color.r,this.color.g,this.color.b,this.color.a),t.bindBuffers(this._vertexBuffer,this._indexBuffer,this._vertexDeclaration,this._vertexStrideSize,this._effect),t.setAlphaMode(e.Engine.ALPHA_COMBINE),t.draw(!0,0,6),t.setAlphaMode(e.Engine.ALPHA_DISABLE)}},t.prototype.dispose=function(){this._vertexBuffer&&(this._scene.getEngine()._releaseBuffer(this._vertexBuffer),this._vertexBuffer=null),this._indexBuffer&&(this._scene.getEngine()._releaseBuffer(this._indexBuffer),this._indexBuffer=null),this.texture&&(this.texture.dispose(),this.texture=null);var e=this._scene.layers.indexOf(this);this._scene.layers.splice(e,1),this.onDispose&&this.onDispose()},t}();e.Layer=t}(BABYLON||(BABYLON={}));var BABYLON;!function(e){var t=function(){function t(){this.position=e.Vector3.Zero(),this.direction=e.Vector3.Zero(),this.color=new e.Color4(0,0,0,0),this.colorStep=new e.Color4(0,0,0,0),this.lifeTime=1,this.age=0,this.size=0,this.angle=0,this.angularSpeed=0}return t}();e.Particle=t}(BABYLON||(BABYLON={}));var BABYLON;!function(e){var t=function(e,t){if(e==t)return e;var i=Math.random();return i*(t-e)+e},i=function(){function i(i,r,n){var o=this;this.name=i,this.renderingGroupId=0,this.emitter=null,this.emitRate=10,this.manualEmitCount=-1,this.updateSpeed=.01,this.targetStopDuration=0,this.disposeOnStop=!1,this.minEmitPower=1,this.maxEmitPower=1,this.minLifeTime=1,this.maxLifeTime=1,this.minSize=1,this.maxSize=1,this.minAngularSpeed=0,this.maxAngularSpeed=0,this.blendMode=e.ParticleSystem.BLENDMODE_ONEONE,this.forceDepthWrite=!1,this.gravity=e.Vector3.Zero(),this.direction1=new e.Vector3(0,1,0),this.direction2=new e.Vector3(0,1,0),this.minEmitBox=new e.Vector3(-.5,-.5,-.5),this.maxEmitBox=new e.Vector3(.5,.5,.5),this.color1=new e.Color4(1,1,1,1),this.color2=new e.Color4(1,1,1,1),this.colorDead=new e.Color4(0,0,0,1),this.textureMask=new e.Color4(1,1,1,1),this.particles=new Array,this._vertexDeclaration=[3,4,4],this._vertexStrideSize=44,this._stockParticles=new Array,this._newPartsExcess=0,this._scaledColorStep=new e.Color4(0,0,0,0),this._colorDiff=new e.Color4(0,0,0,0),this._scaledDirection=e.Vector3.Zero(),this._scaledGravity=e.Vector3.Zero(),this._currentRenderId=-1,this._started=!1,this._stopped=!1,this._actualFrame=0,this.id=i,this._capacity=r,this._scene=n,n.particleSystems.push(this),this._vertexBuffer=n.getEngine().createDynamicVertexBuffer(r*this._vertexStrideSize*4);for(var s=[],a=0,h=0;r>h;h++)s.push(a),s.push(a+1),s.push(a+2),s.push(a),s.push(a+2),s.push(a+3),a+=4;this._indexBuffer=n.getEngine().createIndexBuffer(s),this._vertices=new Float32Array(r*this._vertexStrideSize),this.startDirectionFunction=function(i,r,n){var s=t(o.direction1.x,o.direction2.x),a=t(o.direction1.y,o.direction2.y),h=t(o.direction1.z,o.direction2.z);e.Vector3.TransformNormalFromFloatsToRef(s*i,a*i,h*i,r,n)},this.startPositionFunction=function(i,r){var n=t(o.minEmitBox.x,o.maxEmitBox.x),s=t(o.minEmitBox.y,o.maxEmitBox.y),a=t(o.minEmitBox.z,o.maxEmitBox.z);e.Vector3.TransformCoordinatesFromFloatsToRef(n,s,a,i,r)}}return i.prototype.getCapacity=function(){return this._capacity},i.prototype.isAlive=function(){return this._alive},i.prototype.isStarted=function(){return this._started},i.prototype.start=function(){this._started=!0,this._stopped=!1,this._actualFrame=0},i.prototype.stop=function(){this._stopped=!0},i.prototype._appendParticleVertex=function(e,t,i,r){var n=11*e;this._vertices[n]=t.position.x,this._vertices[n+1]=t.position.y,this._vertices[n+2]=t.position.z,this._vertices[n+3]=t.color.r,this._vertices[n+4]=t.color.g,this._vertices[n+5]=t.color.b,this._vertices[n+6]=t.color.a,this._vertices[n+7]=t.angle,this._vertices[n+8]=t.size,this._vertices[n+9]=i,this._vertices[n+10]=r},i.prototype._update=function(i){this._alive=this.particles.length>0;for(var r=0;r<this.particles.length;r++){var n=this.particles[r];n.age+=this._scaledUpdateSpeed,n.age>=n.lifeTime?(this._stockParticles.push(this.particles.splice(r,1)[0]),r--):(n.colorStep.scaleToRef(this._scaledUpdateSpeed,this._scaledColorStep),n.color.addInPlace(this._scaledColorStep),n.color.a<0&&(n.color.a=0),n.angle+=n.angularSpeed*this._scaledUpdateSpeed,n.direction.scaleToRef(this._scaledUpdateSpeed,this._scaledDirection),n.position.addInPlace(this._scaledDirection),this.gravity.scaleToRef(this._scaledUpdateSpeed,this._scaledGravity),n.direction.addInPlace(this._scaledGravity))}var o;for(o=this.emitter.position?this.emitter.getWorldMatrix():e.Matrix.Translation(this.emitter.x,this.emitter.y,this.emitter.z),r=0;i>r&&this.particles.length!=this._capacity;r++){0!==this._stockParticles.length?(n=this._stockParticles.pop(),n.age=0):n=new e.Particle,this.particles.push(n);var s=t(this.minEmitPower,this.maxEmitPower);this.startDirectionFunction(s,o,n.direction),n.lifeTime=t(this.minLifeTime,this.maxLifeTime),n.size=t(this.minSize,this.maxSize),n.angularSpeed=t(this.minAngularSpeed,this.maxAngularSpeed),this.startPositionFunction(o,n.position);var a=t(0,1);e.Color4.LerpToRef(this.color1,this.color2,a,n.color),this.colorDead.subtractToRef(n.color,this._colorDiff),this._colorDiff.scaleToRef(1/n.lifeTime,n.colorStep)}},i.prototype._getEffect=function(){var e=[];this._scene.clipPlane&&e.push("#define CLIPPLANE");var t=e.join("\n");return this._cachedDefines!=t&&(this._cachedDefines=t,this._effect=this._scene.getEngine().createEffect("particles",["position","color","options"],["invView","view","projection","vClipPlane","textureMask"],["diffuseSampler"],t)),this._effect},i.prototype.animate=function(){if(this._started){var e=this._getEffect();if(this.emitter&&e.isReady()&&this.particleTexture&&this.particleTexture.isReady()&&this._currentRenderId!==this._scene.getRenderId()){this._currentRenderId=this._scene.getRenderId(),this._scaledUpdateSpeed=this.updateSpeed*this._scene.getAnimationRatio();var t;this.manualEmitCount>-1?(t=this.manualEmitCount,this.manualEmitCount=0):t=this.emitRate;var i=t*this._scaledUpdateSpeed>>0;this._newPartsExcess+=t*this._scaledUpdateSpeed-i,this._newPartsExcess>1&&(i+=this._newPartsExcess>>0,this._newPartsExcess-=this._newPartsExcess>>0),this._alive=!1,this._stopped?i=0:(this._actualFrame+=this._scaledUpdateSpeed,this.targetStopDuration&&this._actualFrame>=this.targetStopDuration&&this.stop()),this._update(i),this._stopped&&(this._alive||(this._started=!1,this.disposeOnStop&&this._scene._toBeDisposed.push(this)));for(var r=0,n=0;n<this.particles.length;n++){var o=this.particles[n];this._appendParticleVertex(r++,o,0,0),this._appendParticleVertex(r++,o,1,0),this._appendParticleVertex(r++,o,1,1),this._appendParticleVertex(r++,o,0,1)}var s=this._scene.getEngine();s.updateDynamicVertexBuffer(this._vertexBuffer,this._vertices,this.particles.length*this._vertexStrideSize)}}},i.prototype.render=function(){var t=this._getEffect();if(!(this.emitter&&t.isReady()&&this.particleTexture&&this.particleTexture.isReady()&&this.particles.length))return 0;var i=this._scene.getEngine();i.enableEffect(t);var r=this._scene.getViewMatrix();if(t.setTexture("diffuseSampler",this.particleTexture),t.setMatrix("view",r),t.setMatrix("projection",this._scene.getProjectionMatrix()),t.setFloat4("textureMask",this.textureMask.r,this.textureMask.g,this.textureMask.b,this.textureMask.a),this._scene.clipPlane){var n=this._scene.clipPlane,o=r.clone();o.invert(),t.setMatrix("invView",o),t.setFloat4("vClipPlane",n.normal.x,n.normal.y,n.normal.z,n.d)}return i.bindBuffers(this._vertexBuffer,this._indexBuffer,this._vertexDeclaration,this._vertexStrideSize,t),i.setAlphaMode(this.blendMode===e.ParticleSystem.BLENDMODE_ONEONE?e.Engine.ALPHA_ADD:e.Engine.ALPHA_COMBINE),this.forceDepthWrite&&i.setDepthWrite(!0),i.draw(!0,0,6*this.particles.length),i.setAlphaMode(e.Engine.ALPHA_DISABLE),this.particles.length},i.prototype.dispose=function(){this._vertexBuffer&&(this._scene.getEngine()._releaseBuffer(this._vertexBuffer),this._vertexBuffer=null),this._indexBuffer&&(this._scene.getEngine()._releaseBuffer(this._indexBuffer),this._indexBuffer=null),this.particleTexture&&(this.particleTexture.dispose(),this.particleTexture=null);var e=this._scene.particleSystems.indexOf(this);this._scene.particleSystems.splice(e,1),this.onDispose&&this.onDispose()},i.prototype.clone=function(t,i){var r=new e.ParticleSystem(t,this._capacity,this._scene);return e.Tools.DeepCopy(this,r,["particles"],["_vertexDeclaration","_vertexStrideSize"]),void 0===i&&(i=this.emitter),r.emitter=i,this.particleTexture&&(r.particleTexture=new e.Texture(this.particleTexture.url,this._scene)),r.start(),r},i.BLENDMODE_ONEONE=0,i.BLENDMODE_STANDARD=1,i}();e.ParticleSystem=i}(BABYLON||(BABYLON={}));var BABYLON;!function(e){var t=function(){function t(e,i,r,n,o){this.name=e,this.targetProperty=i,this.framePerSecond=r,this.dataType=n,this.loopMode=o,this._offsetsCache={},this._highLimitsCache={},this._stopped=!1,this.targetPropertyPath=i.split("."),this.dataType=n,this.loopMode=void 0===o?t.ANIMATIONLOOPMODE_CYCLE:o}return t.prototype.isStopped=function(){return this._stopped},t.prototype.getKeys=function(){return this._keys},t.prototype.floatInterpolateFunction=function(e,t,i){return e+(t-e)*i},t.prototype.quaternionInterpolateFunction=function(t,i,r){return e.Quaternion.Slerp(t,i,r)},t.prototype.vector3InterpolateFunction=function(t,i,r){return e.Vector3.Lerp(t,i,r)},t.prototype.color3InterpolateFunction=function(t,i,r){return e.Color3.Lerp(t,i,r)},t.prototype.clone=function(){var e=new t(this.name,this.targetPropertyPath.join("."),this.framePerSecond,this.dataType,this.loopMode);return e.setKeys(this._keys),e},t.prototype.setKeys=function(e){this._keys=e.slice(0),this._offsetsCache={},this._highLimitsCache={}},t.prototype._interpolate=function(e,i,r,n,o){if(r===t.ANIMATIONLOOPMODE_CONSTANT&&i>0)return o.clone?o.clone():o;this.currentFrame=e;for(var s=0;s<this._keys.length;s++)if(this._keys[s+1].frame>=e){var a=this._keys[s].value,h=this._keys[s+1].value,c=(e-this._keys[s].frame)/(this._keys[s+1].frame-this._keys[s].frame);switch(this.dataType){case t.ANIMATIONTYPE_FLOAT:switch(r){case t.ANIMATIONLOOPMODE_CYCLE:case t.ANIMATIONLOOPMODE_CONSTANT:return this.floatInterpolateFunction(a,h,c);case t.ANIMATIONLOOPMODE_RELATIVE:return n*i+this.floatInterpolateFunction(a,h,c)}break;case t.ANIMATIONTYPE_QUATERNION:var u=null;switch(r){case t.ANIMATIONLOOPMODE_CYCLE:case t.ANIMATIONLOOPMODE_CONSTANT:u=this.quaternionInterpolateFunction(a,h,c);break;case t.ANIMATIONLOOPMODE_RELATIVE:u=this.quaternionInterpolateFunction(a,h,c).add(n.scale(i))}return u;case t.ANIMATIONTYPE_VECTOR3:switch(r){case t.ANIMATIONLOOPMODE_CYCLE:case t.ANIMATIONLOOPMODE_CONSTANT:return this.vector3InterpolateFunction(a,h,c);case t.ANIMATIONLOOPMODE_RELATIVE:return this.vector3InterpolateFunction(a,h,c).add(n.scale(i))}case t.ANIMATIONTYPE_COLOR3:switch(r){case t.ANIMATIONLOOPMODE_CYCLE:case t.ANIMATIONLOOPMODE_CONSTANT:return this.color3InterpolateFunction(a,h,c);case t.ANIMATIONLOOPMODE_RELATIVE:return this.color3InterpolateFunction(a,h,c).add(n.scale(i))}case t.ANIMATIONTYPE_MATRIX:switch(r){case t.ANIMATIONLOOPMODE_CYCLE:case t.ANIMATIONLOOPMODE_CONSTANT:case t.ANIMATIONLOOPMODE_RELATIVE:return a}}break}return this._keys[this._keys.length-1].value},t.prototype.animate=function(e,i,r,n,o){if(!this.targetPropertyPath||this.targetPropertyPath.length<1)return this._stopped=!0,!1;var s=!0;if(0!=this._keys[0].frame){var a={frame:0,value:this._keys[0].value};this._keys.splice(0,0,a)}(i<this._keys[0].frame||i>this._keys[this._keys.length-1].frame)&&(i=this._keys[0].frame),(r<this._keys[0].frame||r>this._keys[this._keys.length-1].frame)&&(r=this._keys[this._keys.length-1].frame);var h=r-i,c=e*this.framePerSecond*o/1e3;if(c>h&&!n)u=0,s=!1,l=this._keys[this._keys.length-1].value;else{var u=0,l=0;if(this.loopMode!=t.ANIMATIONLOOPMODE_CYCLE){var f=r.toString()+i.toString();if(!this._offsetsCache[f]){var d=this._interpolate(i,0,t.ANIMATIONLOOPMODE_CYCLE),p=this._interpolate(r,0,t.ANIMATIONLOOPMODE_CYCLE);switch(this.dataType){case t.ANIMATIONTYPE_FLOAT:this._offsetsCache[f]=p-d;break;case t.ANIMATIONTYPE_QUATERNION:this._offsetsCache[f]=p.subtract(d);break;case t.ANIMATIONTYPE_VECTOR3:this._offsetsCache[f]=p.subtract(d);case t.ANIMATIONTYPE_COLOR3:this._offsetsCache[f]=p.subtract(d)}this._highLimitsCache[f]=p}l=this._highLimitsCache[f],u=this._offsetsCache[f]}}var m=c/h>>0,_=s?i+c%h:r,g=this._interpolate(_,m,this.loopMode,u,l);if(this.targetPropertyPath.length>1){for(var v=this._target[this.targetPropertyPath[0]],y=1;y<this.targetPropertyPath.length-1;y++)v=v[this.targetPropertyPath[y]];v[this.targetPropertyPath[this.targetPropertyPath.length-1]]=g}else this._target[this.targetPropertyPath[0]]=g;return this._target.markAsDirty&&this._target.markAsDirty(this.targetProperty),s||(this._stopped=!0),s},Object.defineProperty(t,"ANIMATIONTYPE_FLOAT",{get:function(){return t._ANIMATIONTYPE_FLOAT},enumerable:!0,configurable:!0}),Object.defineProperty(t,"ANIMATIONTYPE_VECTOR3",{get:function(){return t._ANIMATIONTYPE_VECTOR3},enumerable:!0,configurable:!0}),Object.defineProperty(t,"ANIMATIONTYPE_QUATERNION",{get:function(){return t._ANIMATIONTYPE_QUATERNION},enumerable:!0,configurable:!0}),Object.defineProperty(t,"ANIMATIONTYPE_MATRIX",{get:function(){return t._ANIMATIONTYPE_MATRIX},enumerable:!0,configurable:!0}),Object.defineProperty(t,"ANIMATIONTYPE_COLOR3",{get:function(){return t._ANIMATIONTYPE_COLOR3},enumerable:!0,configurable:!0}),Object.defineProperty(t,"ANIMATIONLOOPMODE_RELATIVE",{get:function(){return t._ANIMATIONLOOPMODE_RELATIVE},enumerable:!0,configurable:!0}),Object.defineProperty(t,"ANIMATIONLOOPMODE_CYCLE",{get:function(){return t._ANIMATIONLOOPMODE_CYCLE},enumerable:!0,configurable:!0}),Object.defineProperty(t,"ANIMATIONLOOPMODE_CONSTANT",{get:function(){return t._ANIMATIONLOOPMODE_CONSTANT},enumerable:!0,configurable:!0}),t._ANIMATIONTYPE_FLOAT=0,t._ANIMATIONTYPE_VECTOR3=1,t._ANIMATIONTYPE_QUATERNION=2,t._ANIMATIONTYPE_MATRIX=3,t._ANIMATIONTYPE_COLOR3=4,t._ANIMATIONLOOPMODE_RELATIVE=0,t._ANIMATIONLOOPMODE_CYCLE=1,t._ANIMATIONLOOPMODE_CONSTANT=2,t}();e.Animation=t}(BABYLON||(BABYLON={}));var BABYLON;!function(e){var t=function(){function e(e,t,i,r,n,o,s,a){"undefined"==typeof i&&(i=0),"undefined"==typeof r&&(r=100),"undefined"==typeof n&&(n=!1),"undefined"==typeof o&&(o=1),this.target=t,this.fromFrame=i,this.toFrame=r,this.loopAnimation=n,this.speedRatio=o,this.onAnimationEnd=s,this._animations=new Array,this._paused=!1,this.animationStarted=!1,a&&this.appendAnimations(t,a),this._scene=e,e._activeAnimatables.push(this)}return e.prototype.appendAnimations=function(e,t){for(var i=0;i<t.length;i++){var r=t[i];r._target=e,this._animations.push(r)}},e.prototype.getAnimationByTargetProperty=function(e){for(var t=this._animations,i=0;i<t.length;i++)if(t[i].targetProperty===e)return t[i];return null},e.prototype.pause=function(){this._paused=!0},e.prototype.restart=function(){this._paused=!1},e.prototype.stop=function(){var e=this._scene._activeAnimatables.indexOf(this);e>-1&&this._scene._activeAnimatables.splice(e,1),this.onAnimationEnd&&this.onAnimationEnd()},e.prototype._animate=function(e){if(this._paused)return!0;this._localDelayOffset||(this._localDelayOffset=e);for(var t=!1,i=this._animations,r=0;r<i.length;r++){var n=i[r],o=n.animate(e-this._localDelayOffset,this.fromFrame,this.toFrame,this.loopAnimation,this.speedRatio);t=t||o}return!t&&this.onAnimationEnd&&this.onAnimationEnd(),t},e}();e.Animatable=t}(BABYLON||(BABYLON={}));var BABYLON;!function(e){var t=function(){function t(t,i,r){"undefined"==typeof r&&(r=2),this.maxDepth=r,this.dynamicContent=new Array,this._maxBlockCapacity=i||64,this._selectionContent=new e.SmartArray(1024),this._creationFunc=t}return t.prototype.update=function(e,i,r){t._CreateBlocks(e,i,r,this._maxBlockCapacity,0,this.maxDepth,this,this._creationFunc)},t.prototype.addMesh=function(e){for(var t=0;t<this.blocks.length;t++){var i=this.blocks[t];i.addEntry(e)}},t.prototype.select=function(e,t){this._selectionContent.reset();for(var i=0;i<this.blocks.length;i++){var r=this.blocks[i];r.select(e,this._selectionContent,t)}return t?this._selectionContent.concat(this.dynamicContent):this._selectionContent.concatWithNoDuplicate(this.dynamicContent),this._selectionContent},t.prototype.intersects=function(e,t,i){this._selectionContent.reset();for(var r=0;r<this.blocks.length;r++){var n=this.blocks[r];n.intersects(e,t,this._selectionContent,i)}return i?this._selectionContent.concat(this.dynamicContent):this._selectionContent.concatWithNoDuplicate(this.dynamicContent),this._selectionContent},t.prototype.intersectsRay=function(e){this._selectionContent.reset();for(var t=0;t<this.blocks.length;t++){var i=this.blocks[t];i.intersectsRay(e,this._selectionContent)}return this._selectionContent.concatWithNoDuplicate(this.dynamicContent),this._selectionContent},t._CreateBlocks=function(t,i,r,n,o,s,a,h){a.blocks=new Array;for(var c=new e.Vector3((i.x-t.x)/2,(i.y-t.y)/2,(i.z-t.z)/2),u=0;2>u;u++)for(var l=0;2>l;l++)for(var f=0;2>f;f++){var d=t.add(c.multiplyByFloats(u,l,f)),p=t.add(c.multiplyByFloats(u+1,l+1,f+1)),m=new e.OctreeBlock(d,p,n,o+1,s,h);m.addEntries(r),a.blocks.push(m)}},t.CreationFuncForMeshes=function(e,t){e.getBoundingInfo().boundingBox.intersectsMinMax(t.minPoint,t.maxPoint)&&t.entries.push(e)},t.CreationFuncForSubMeshes=function(e,t){e.getBoundingInfo().boundingBox.intersectsMinMax(t.minPoint,t.maxPoint)&&t.entries.push(e)},t}();e.Octree=t}(BABYLON||(BABYLON={}));var BABYLON;!function(e){var t=function(){function t(e,t,i,r,n,o){this.entries=new Array,this._boundingVectors=new Array,this._capacity=i,this._depth=r,this._maxDepth=n,this._creationFunc=o,this._minPoint=e,this._maxPoint=t,this._boundingVectors.push(e.clone()),this._boundingVectors.push(t.clone()),this._boundingVectors.push(e.clone()),this._boundingVectors[2].x=t.x,this._boundingVectors.push(e.clone()),this._boundingVectors[3].y=t.y,this._boundingVectors.push(e.clone()),this._boundingVectors[4].z=t.z,this._boundingVectors.push(t.clone()),this._boundingVectors[5].z=e.z,this._boundingVectors.push(t.clone()),this._boundingVectors[6].x=e.x,this._boundingVectors.push(t.clone()),this._boundingVectors[7].y=e.y}return Object.defineProperty(t.prototype,"capacity",{get:function(){return this._capacity},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"minPoint",{get:function(){return this._minPoint},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"maxPoint",{get:function(){return this._maxPoint},enumerable:!0,configurable:!0}),t.prototype.addEntry=function(e){if(this.blocks)for(var t=0;t<this.blocks.length;t++){var i=this.blocks[t];i.addEntry(e)}else this._creationFunc(e,this),this.entries.length>this.capacity&&this._depth<this._maxDepth&&this.createInnerBlocks()},t.prototype.addEntries=function(e){for(var t=0;t<e.length;t++){var i=e[t];this.addEntry(i)}},t.prototype.select=function(t,i,r){if(e.BoundingBox.IsInFrustum(this._boundingVectors,t)){if(this.blocks){for(var n=0;n<this.blocks.length;n++){var o=this.blocks[n];o.select(t,i,r)}return}r?i.concat(this.entries):i.concatWithNoDuplicate(this.entries)}},t.prototype.intersects=function(t,i,r,n){if(e.BoundingBox.IntersectsSphere(this._minPoint,this._maxPoint,t,i)){if(this.blocks){for(var o=0;o<this.blocks.length;o++){var s=this.blocks[o];s.intersects(t,i,r,n)}return}n?r.concat(this.entries):r.concatWithNoDuplicate(this.entries)}},t.prototype.intersectsRay=function(e,t){if(e.intersectsBoxMinMax(this._minPoint,this._maxPoint)){if(this.blocks){for(var i=0;i<this.blocks.length;i++){var r=this.blocks[i];r.intersectsRay(e,t)}return}t.concatWithNoDuplicate(this.entries)}},t.prototype.createInnerBlocks=function(){e.Octree._CreateBlocks(this._minPoint,this._maxPoint,this.entries,this._capacity,this._depth,this._maxDepth,this,this._creationFunc)},t}();e.OctreeBlock=t}(BABYLON||(BABYLON={}));var BABYLON;!function(e){var t=function(){function t(t,i,r,n){this.name=t,this.children=new Array,this.animations=new Array,this._worldTransform=new e.Matrix,this._absoluteTransform=new e.Matrix,this._invertedAbsoluteTransform=new e.Matrix,this._skeleton=i,this._matrix=n,this._baseMatrix=n,i.bones.push(this),r?(this._parent=r,r.children.push(this)):this._parent=null,this._updateDifferenceMatrix()}return t.prototype.getParent=function(){return this._parent},t.prototype.getLocalMatrix=function(){return this._matrix},t.prototype.getBaseMatrix=function(){return this._baseMatrix},t.prototype.getWorldMatrix=function(){return this._worldTransform},t.prototype.getInvertedAbsoluteTransform=function(){return this._invertedAbsoluteTransform},t.prototype.getAbsoluteMatrix=function(){for(var e=this._matrix.clone(),t=this._parent;t;)e=e.multiply(t.getLocalMatrix()),t=t.getParent();return e},t.prototype.updateMatrix=function(e){this._matrix=e,this._skeleton._markAsDirty(),this._updateDifferenceMatrix()},t.prototype._updateDifferenceMatrix=function(){this._parent?this._matrix.multiplyToRef(this._parent._absoluteTransform,this._absoluteTransform):this._absoluteTransform.copyFrom(this._matrix),this._absoluteTransform.invertToRef(this._invertedAbsoluteTransform);for(var e=0;e<this.children.length;e++)this.children[e]._updateDifferenceMatrix()},t.prototype.markAsDirty=function(){this._skeleton._markAsDirty()},t}();e.Bone=t}(BABYLON||(BABYLON={}));var BABYLON;!function(e){var t=function(){function t(t,i,r){this.name=t,this.id=i,this.bones=new Array,this._isDirty=!0,this._identity=e.Matrix.Identity(),this.bones=[],this._scene=r,r.skeletons.push(this)}return t.prototype.getTransformMatrices=function(){return this._transformMatrices},t.prototype._markAsDirty=function(){this._isDirty=!0},t.prototype.prepare=function(){if(this._isDirty){this._transformMatrices&&this._transformMatrices.length===16*(this.bones.length+1)||(this._transformMatrices=new Float32Array(16*(this.bones.length+1)));for(var e=0;e<this.bones.length;e++){var t=this.bones[e],i=t.getParent();i?t.getLocalMatrix().multiplyToRef(i.getWorldMatrix(),t.getWorldMatrix()):t.getWorldMatrix().copyFrom(t.getLocalMatrix()),t.getInvertedAbsoluteTransform().multiplyToArray(t.getWorldMatrix(),this._transformMatrices,16*e)}this._identity.copyToArray(this._transformMatrices,16*this.bones.length),this._isDirty=!1}},t.prototype.getAnimatables=function(){if(!this._animatables||this._animatables.length!=this.bones.length){this._animatables=[];for(var e=0;e<this.bones.length;e++)this._animatables.push(this.bones[e])}return this._animatables},t.prototype.clone=function(t,i){for(var r=new e.Skeleton(t,i||t,this._scene),n=0;n<this.bones.length;n++){var o=this.bones[n],s=null;if(o.getParent()){var a=this.bones.indexOf(o.getParent());s=r.bones[a]}var h=new e.Bone(o.name,r,s,o.getBaseMatrix());e.Tools.DeepCopy(o.animations,h.animations)}return r},t}();e.Skeleton=t}(BABYLON||(BABYLON={}));var BABYLON;!function(e){var t=function(){function t(t,i,r,n,o,s,a,h,c){this.name=t,this.width=-1,this.height=-1,this._reusable=!1,this._textures=new e.SmartArray(2),this._currentRenderTextureInd=0,null!=s?(this._camera=s,this._scene=s.getScene(),s.attachPostProcess(this),this._engine=this._scene.getEngine()):this._engine=h,this._renderRatio=o,this.renderTargetSamplingMode=a?a:e.Texture.NEAREST_SAMPLINGMODE,this._reusable=c||!1,n=n||[],n.push("textureSampler"),this._effect=this._engine.createEffect({vertex:"postprocess",fragment:i},["position"],r||[],n,"")}return t.prototype.isReusable=function(){return this._reusable},t.prototype.activate=function(e,t){e=e||this._camera;var i=e.getScene(),r=(t?t._width:this._engine.getRenderingCanvas().width)*this._renderRatio,n=(t?t._height:this._engine.getRenderingCanvas().height)*this._renderRatio;if(this.width!==r||this.height!==n){if(this._textures.length>0){for(var o=0;o<this._textures.length;o++)this._engine._releaseTexture(this._textures.data[o]);this._textures.reset()}this.width=r,this.height=n,this._textures.push(this._engine.createRenderTargetTexture({width:this.width,height:this.height},{generateMipMaps:!1,generateDepthBuffer:e._postProcesses.indexOf(this)===e._postProcessesTakenIndices[0],samplingMode:this.renderTargetSamplingMode})),this._reusable&&this._textures.push(this._engine.createRenderTargetTexture({width:this.width,height:this.height},{generateMipMaps:!1,generateDepthBuffer:e._postProcesses.indexOf(this)===e._postProcessesTakenIndices[0],samplingMode:this.renderTargetSamplingMode})),this.onSizeChanged&&this.onSizeChanged()}this._engine.bindFramebuffer(this._textures.data[this._currentRenderTextureInd]),this.onActivate&&this.onActivate(e),this._engine.clear(i.clearColor,i.autoClear||i.forceWireframe,!0),this._reusable&&(this._currentRenderTextureInd=(this._currentRenderTextureInd+1)%2)
},t.prototype.apply=function(){return this._effect.isReady()?(this._engine.enableEffect(this._effect),this._engine.setState(!1),this._engine.setAlphaMode(e.Engine.ALPHA_DISABLE),this._engine.setDepthBuffer(!1),this._engine.setDepthWrite(!1),this._effect._bindTexture("textureSampler",this._textures.data[this._currentRenderTextureInd]),this.onApply&&this.onApply(this._effect),this._effect):null},t.prototype.dispose=function(e){if(e=e||this._camera,this._textures.length>0){for(var t=0;t<this._textures.length;t++)this._engine._releaseTexture(this._textures.data[t]);this._textures.reset()}e.detachPostProcess(this);var i=e._postProcesses.indexOf(this);i===e._postProcessesTakenIndices[0]&&e._postProcessesTakenIndices.length>0&&(this._camera._postProcesses[e._postProcessesTakenIndices[0]].width=-1)},t}();e.PostProcess=t}(BABYLON||(BABYLON={}));var BABYLON;!function(e){var t=function(){function e(e){this._vertexDeclaration=[2],this._vertexStrideSize=8,this._scene=e;var t=[];t.push(1,1),t.push(-1,1),t.push(-1,-1),t.push(1,-1),this._vertexBuffer=e.getEngine().createVertexBuffer(t);var i=[];i.push(0),i.push(1),i.push(2),i.push(0),i.push(2),i.push(3),this._indexBuffer=e.getEngine().createIndexBuffer(i)}return e.prototype._prepareFrame=function(e){var t=this._scene.activeCamera._postProcesses,i=this._scene.activeCamera._postProcessesTakenIndices;return 0!==i.length&&this._scene.postProcessesEnabled?(t[this._scene.activeCamera._postProcessesTakenIndices[0]].activate(this._scene.activeCamera,e),!0):!1},e.prototype._finalizeFrame=function(e,t){var i=this._scene.activeCamera._postProcesses,r=this._scene.activeCamera._postProcessesTakenIndices;if(0!==r.length&&this._scene.postProcessesEnabled){for(var n=this._scene.getEngine(),o=0;o<r.length&&(o<r.length-1?i[r[o+1]].activate(this._scene.activeCamera):t?n.bindFramebuffer(t):n.restoreDefaultFramebuffer(),!e);o++){var s=i[r[o]].apply();s&&(n.bindBuffers(this._vertexBuffer,this._indexBuffer,this._vertexDeclaration,this._vertexStrideSize,s),n.draw(!0,0,6))}n.setDepthBuffer(!0),n.setDepthWrite(!0)}},e.prototype.dispose=function(){this._vertexBuffer&&(this._scene.getEngine()._releaseBuffer(this._vertexBuffer),this._vertexBuffer=null),this._indexBuffer&&(this._scene.getEngine()._releaseBuffer(this._indexBuffer),this._indexBuffer=null)},e}();e.PostProcessManager=t}(BABYLON||(BABYLON={}));var __extends=this.__extends||function(e,t){function i(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);i.prototype=t.prototype,e.prototype=new i},BABYLON;!function(e){var t=function(e){function t(t,i,r,n,o,s){e.call(this,t,"pass",null,null,i,r,n,o,s)}return __extends(t,e),t}(e.PostProcess);e.PassPostProcess=t}(BABYLON||(BABYLON={}));var __extends=this.__extends||function(e,t){function i(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);i.prototype=t.prototype,e.prototype=new i},BABYLON;!function(e){var t=function(t){function i(i,r,n,o,s,a,h,c){"undefined"==typeof a&&(a=e.Texture.BILINEAR_SAMPLINGMODE);var u=this;t.call(this,i,"blur",["screenSize","direction","blurWidth"],null,o,s,a,h,c),this.direction=r,this.blurWidth=n,this.onApply=function(e){e.setFloat2("screenSize",u.width,u.height),e.setVector2("direction",u.direction),e.setFloat("blurWidth",u.blurWidth)}}return __extends(i,t),i}(e.PostProcess);e.BlurPostProcess=t}(BABYLON||(BABYLON={}));var __extends=this.__extends||function(e,t){function i(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);i.prototype=t.prototype,e.prototype=new i},BABYLON;!function(e){var t=function(t){function i(i,r,n,o,s,a,h,c,u,l){var f=this;t.call(this,i,"refraction",["baseColor","depth","colorLevel"],["refractionSampler"],a,h,c,u,l),this.color=n,this.depth=o,this.colorLevel=s,this.onActivate=function(t){f._refRexture=f._refRexture||new e.Texture(r,t.getScene())},this.onApply=function(e){e.setColor3("baseColor",f.color),e.setFloat("depth",f.depth),e.setFloat("colorLevel",f.colorLevel),e.setTexture("refractionSampler",f._refRexture)}}return __extends(i,t),i.prototype.dispose=function(e){this._refRexture&&this._refRexture.dispose(),t.prototype.dispose.call(this,e)},i}(e.PostProcess);e.RefractionPostProcess=t}(BABYLON||(BABYLON={}));var __extends=this.__extends||function(e,t){function i(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);i.prototype=t.prototype,e.prototype=new i},BABYLON;!function(e){var t=function(e){function t(t,i,r,n,o,s){e.call(this,t,"blackAndWhite",null,null,i,r,n,o,s)}return __extends(t,e),t}(e.PostProcess);e.BlackAndWhitePostProcess=t}(BABYLON||(BABYLON={}));var __extends=this.__extends||function(e,t){function i(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);i.prototype=t.prototype,e.prototype=new i},BABYLON;!function(e){var t=function(e){function t(t,i,r,n,o,s,a){var h=this;e.call(this,t,"convolution",["kernel","screenSize"],null,r,n,o,s,a),this.kernel=i,this.onApply=function(e){e.setFloat2("screenSize",h.width,h.height),e.setArray("kernel",h.kernel)}}return __extends(t,e),t.EdgeDetect0Kernel=[1,0,-1,0,0,0,-1,0,1],t.EdgeDetect1Kernel=[0,1,0,1,-4,1,0,1,0],t.EdgeDetect2Kernel=[-1,-1,-1,-1,8,-1,-1,-1,-1],t.SharpenKernel=[0,-1,0,-1,5,-1,0,-1,0],t.EmbossKernel=[-2,-1,0,-1,1,1,0,1,2],t.GaussianKernel=[0,1,0,1,1,1,0,1,0],t}(e.PostProcess);e.ConvolutionPostProcess=t}(BABYLON||(BABYLON={}));var __extends=this.__extends||function(e,t){function i(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);i.prototype=t.prototype,e.prototype=new i},BABYLON;!function(e){var t=function(e){function t(t,i,r,n,o,s,a){var h=this;e.call(this,t,"filter",["kernelMatrix"],null,r,n,o,s,a),this.kernelMatrix=i,this.onApply=function(e){e.setMatrix("kernelMatrix",h.kernelMatrix)}}return __extends(t,e),t}(e.PostProcess);e.FilterPostProcess=t}(BABYLON||(BABYLON={}));var __extends=this.__extends||function(e,t){function i(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);i.prototype=t.prototype,e.prototype=new i},BABYLON;!function(e){var t=function(e){function t(t,i,r,n,o,s){var a=this;e.call(this,t,"fxaa",["texelSize"],null,i,r,n,o,s),this.onSizeChanged=function(){a.texelWidth=1/a.width,a.texelHeight=1/a.height},this.onApply=function(e){e.setFloat2("texelSize",a.texelWidth,a.texelHeight)}}return __extends(t,e),t}(e.PostProcess);e.FxaaPostProcess=t}(BABYLON||(BABYLON={}));var BABYLON;!function(e){var t=function(){function t(t,i,r,n,o){this.size=t,this.position=i,this.dispose=function(){this.texture&&this.texture.dispose();var e=this._system.lensFlares.indexOf(this);this._system.lensFlares.splice(e,1)},this.color=r||new e.Color3(1,1,1),this.texture=n?new e.Texture(n,o.getScene(),!0):null,this._system=o,o.lensFlares.push(this)}return t}();e.LensFlare=t}(BABYLON||(BABYLON={}));var BABYLON;!function(e){var t=function(){function t(e,t,i){this.name=e,this.lensFlares=new Array,this.borderLimit=300,this._vertexDeclaration=[2],this._vertexStrideSize=8,this._isEnabled=!0,this._scene=i,this._emitter=t,i.lensFlareSystems.push(this),this.meshesSelectionPredicate=function(e){return e.material&&e.isVisible&&e.isEnabled()&&e.checkCollisions&&0!=(e.layerMask&i.activeCamera.layerMask)};var r=[];r.push(1,1),r.push(-1,1),r.push(-1,-1),r.push(1,-1),this._vertexBuffer=i.getEngine().createVertexBuffer(r);var n=[];n.push(0),n.push(1),n.push(2),n.push(0),n.push(2),n.push(3),this._indexBuffer=i.getEngine().createIndexBuffer(n),this._effect=this._scene.getEngine().createEffect("lensFlare",["position"],["color","viewportMatrix"],["textureSampler"],"")}return Object.defineProperty(t.prototype,"isEnabled",{get:function(){return this._isEnabled},set:function(e){this._isEnabled=e},enumerable:!0,configurable:!0}),t.prototype.getScene=function(){return this._scene},t.prototype.getEmitter=function(){return this._emitter},t.prototype.getEmitterPosition=function(){return this._emitter.getAbsolutePosition?this._emitter.getAbsolutePosition():this._emitter.position},t.prototype.computeEffectivePosition=function(t){var i=this.getEmitterPosition();return i=e.Vector3.Project(i,e.Matrix.Identity(),this._scene.getTransformMatrix(),t),this._positionX=i.x,this._positionY=i.y,i=e.Vector3.TransformCoordinates(this.getEmitterPosition(),this._scene.getViewMatrix()),i.z>0&&this._positionX>t.x&&this._positionX<t.x+t.width&&this._positionY>t.y&&this._positionY<t.y+t.height?!0:!1},t.prototype._isVisible=function(){if(!this._isEnabled)return!1;var t=this.getEmitterPosition(),i=t.subtract(this._scene.activeCamera.position),r=i.length();i.normalize();var n=new e.Ray(this._scene.activeCamera.position,i),o=this._scene.pickWithRay(n,this.meshesSelectionPredicate,!0);return!o.hit||o.distance>r},t.prototype.render=function(){if(!this._effect.isReady())return!1;var t=this._scene.getEngine(),i=this._scene.activeCamera.viewport,r=i.toGlobal(t);if(!this.computeEffectivePosition(r))return!1;if(!this._isVisible())return!1;var n,o;n=this._positionX<this.borderLimit+r.x?this.borderLimit+r.x-this._positionX:this._positionX>r.x+r.width-this.borderLimit?this._positionX-r.x-r.width+this.borderLimit:0,o=this._positionY<this.borderLimit+r.y?this.borderLimit+r.y-this._positionY:this._positionY>r.y+r.height-this.borderLimit?this._positionY-r.y-r.height+this.borderLimit:0;var s=n>o?n:o;s>this.borderLimit&&(s=this.borderLimit);var a=1-s/this.borderLimit;if(0>a)return!1;a>1&&(a=1);var h=r.x+r.width/2,c=r.y+r.height/2,u=h-this._positionX,l=c-this._positionY;t.enableEffect(this._effect),t.setState(!1),t.setDepthBuffer(!1),t.setAlphaMode(e.Engine.ALPHA_ADD),t.bindBuffers(this._vertexBuffer,this._indexBuffer,this._vertexDeclaration,this._vertexStrideSize,this._effect);for(var f=0;f<this.lensFlares.length;f++){var d=this.lensFlares[f],p=h-u*d.position,m=c-l*d.position,_=d.size,g=d.size*t.getAspectRatio(this._scene.activeCamera),v=2*(p/r.width)-1,y=1-2*(m/r.height),x=e.Matrix.FromValues(_/2,0,0,0,0,g/2,0,0,0,0,1,0,v,y,0,1);this._effect.setMatrix("viewportMatrix",x),this._effect.setTexture("textureSampler",d.texture),this._effect.setFloat4("color",d.color.r*a,d.color.g*a,d.color.b*a,1),t.draw(!0,0,6)}return t.setDepthBuffer(!0),t.setAlphaMode(e.Engine.ALPHA_DISABLE),!0},t.prototype.dispose=function(){for(this._vertexBuffer&&(this._scene.getEngine()._releaseBuffer(this._vertexBuffer),this._vertexBuffer=null),this._indexBuffer&&(this._scene.getEngine()._releaseBuffer(this._indexBuffer),this._indexBuffer=null);this.lensFlares.length;)this.lensFlares[0].dispose();var e=this._scene.lensFlareSystems.indexOf(this);this._scene.lensFlareSystems.splice(e,1)},t}();e.LensFlareSystem=t}(BABYLON||(BABYLON={}));var BABYLON;!function(e){var t=function(){function t(){this._registeredMeshes=[],this._physicsMaterials=[]}return t.prototype.initialize=function(e){"undefined"==typeof e&&(e=10),this._world=new CANNON.World,this._world.broadphase=new CANNON.NaiveBroadphase,this._world.solver.iterations=e},t.prototype._checkWithEpsilon=function(t){return t<e.PhysicsEngine.Epsilon?e.PhysicsEngine.Epsilon:t},t.prototype.runOneStep=function(t){this._world.step(t);for(var i=0;i<this._registeredMeshes.length;i++){var r=this._registeredMeshes[i];r.isChild||(r.mesh.position.x=r.body.position.x,r.mesh.position.y=r.body.position.z,r.mesh.position.z=r.body.position.y,r.mesh.rotationQuaternion||(r.mesh.rotationQuaternion=new e.Quaternion(0,0,0,1)),r.mesh.rotationQuaternion.x=r.body.quaternion.x,r.mesh.rotationQuaternion.y=r.body.quaternion.z,r.mesh.rotationQuaternion.z=r.body.quaternion.y,r.mesh.rotationQuaternion.w=-r.body.quaternion.w)}},t.prototype.setGravity=function(e){this._world.gravity.set(e.x,e.z,e.y)},t.prototype.registerMesh=function(t,i,r){switch(this.unregisterMesh(t),t.computeWorldMatrix(!0),i){case e.PhysicsEngine.SphereImpostor:var n=t.getBoundingInfo().boundingBox,o=n.maximumWorld.x-n.minimumWorld.x,s=n.maximumWorld.y-n.minimumWorld.y,a=n.maximumWorld.z-n.minimumWorld.z;return this._createSphere(Math.max(this._checkWithEpsilon(o),this._checkWithEpsilon(s),this._checkWithEpsilon(a))/2,t,r);case e.PhysicsEngine.BoxImpostor:n=t.getBoundingInfo().boundingBox;var h=n.minimumWorld,c=n.maximumWorld,u=c.subtract(h).scale(.5);return this._createBox(this._checkWithEpsilon(u.x),this._checkWithEpsilon(u.y),this._checkWithEpsilon(u.z),t,r);case e.PhysicsEngine.PlaneImpostor:return this._createPlane(t,r);case e.PhysicsEngine.MeshImpostor:var l=t.getVerticesData(e.VertexBuffer.PositionKind),f=t.getIndices();return this._createConvexPolyhedron(l,f,t,r)}return null},t.prototype._createSphere=function(e,t,i){var r=new CANNON.Sphere(e);return i?this._createRigidBodyFromShape(r,t,i.mass,i.friction,i.restitution):r},t.prototype._createBox=function(e,t,i,r,n){var o=new CANNON.Box(new CANNON.Vec3(e,i,t));return n?this._createRigidBodyFromShape(o,r,n.mass,n.friction,n.restitution):o},t.prototype._createPlane=function(e,t){var i=new CANNON.Plane;return t?this._createRigidBodyFromShape(i,e,t.mass,t.friction,t.restitution):i},t.prototype._createConvexPolyhedron=function(t,i,r,n){var o=[],s=[];r.computeWorldMatrix(!0);for(var a=0;a<t.length;a+=3){var h=e.Vector3.Zero();e.Vector3.TransformNormalFromFloatsToRef(t[a],t[a+1],t[a+2],r.getWorldMatrix(),h),o.push(new CANNON.Vec3(h.x,h.z,h.y))}for(var c=0;c<i.length;c+=3)s.push([i[c],i[c+2],i[c+1]]);var u=new CANNON.ConvexPolyhedron(o,s);return n?this._createRigidBodyFromShape(u,r,n.mass,n.friction,n.restitution):u},t.prototype._addMaterial=function(e,t){var i,r;for(i=0;i<this._physicsMaterials.length;i++)if(r=this._physicsMaterials[i],r.friction===e&&r.restitution===t)return r;var n=new CANNON.Material;for(n.friction=e,n.restitution=t,this._physicsMaterials.push(n),i=0;i<this._physicsMaterials.length;i++){r=this._physicsMaterials[i];var o=new CANNON.ContactMaterial(r,n,r.friction*n.friction,r.restitution*n.restitution);o.contactEquationStiffness=1e10,o.contactEquationRegularizationTime=10,this._world.addContactMaterial(o)}return n},t.prototype._createRigidBodyFromShape=function(t,i,r,n,o){var s=null;i.rotationQuaternion&&(s=i.rotationQuaternion.clone(),i.rotationQuaternion=new e.Quaternion(0,0,0,1));var a=this._addMaterial(n,o),h=new CANNON.RigidBody(r,t,a);return s&&(h.quaternion.x=s.x,h.quaternion.z=s.y,h.quaternion.y=s.z,h.quaternion.w=-s.w),h.position.set(i.position.x,i.position.z,i.position.y),this._world.add(h),this._registeredMeshes.push({mesh:i,body:h,material:a}),h},t.prototype.registerMeshesAsCompound=function(e,t){for(var i=new CANNON.Compound,r=0;r<e.length;r++){var n=e[r].mesh,o=this.registerMesh(n,e[r].impostor);0==r?i.addChild(o,new CANNON.Vec3(0,0,0)):i.addChild(o,new CANNON.Vec3(n.position.x,n.position.z,n.position.y))}var s=e[0].mesh,a=this._createRigidBodyFromShape(i,s,t.mass,t.friction,t.restitution);return a.parts=e,a},t.prototype._unbindBody=function(e){for(var t=0;t<this._registeredMeshes.length;t++){var i=this._registeredMeshes[t];i.body===e&&(i.body=null)}},t.prototype.unregisterMesh=function(e){for(var t=0;t<this._registeredMeshes.length;t++){var i=this._registeredMeshes[t];if(i.mesh===e)return i.body&&(this._world.remove(i.body),this._unbindBody(i.body)),void this._registeredMeshes.splice(t,1)}},t.prototype.applyImpulse=function(e,t,i){for(var r=new CANNON.Vec3(i.x,i.z,i.y),n=new CANNON.Vec3(t.x,t.z,t.y),o=0;o<this._registeredMeshes.length;o++){var s=this._registeredMeshes[o];if(s.mesh===e)return void s.body.applyImpulse(n,r)}},t.prototype.createLink=function(e,t,i,r){for(var n=null,o=null,s=0;s<this._registeredMeshes.length;s++){var a=this._registeredMeshes[s];a.mesh===e?n=a.body:a.mesh===t&&(o=a.body)}if(!n||!o)return!1;var h=new CANNON.PointToPointConstraint(n,new CANNON.Vec3(i.x,i.z,i.y),o,new CANNON.Vec3(r.x,r.z,r.y));return this._world.addConstraint(h),!0},t.prototype.dispose=function(){for(;this._registeredMeshes.length;)this.unregisterMesh(this._registeredMeshes[0].mesh)},t.prototype.isSupported=function(){return void 0!==window.CANNON},t}();e.CannonJSPlugin=t}(BABYLON||(BABYLON={}));var BABYLON;!function(e){var t=function(){function t(t){this._currentPlugin=t||new e.CannonJSPlugin}return t.prototype._initialize=function(e){this._currentPlugin.initialize(),this._setGravity(e)},t.prototype._runOneStep=function(e){e>.1?e=.1:0>=e&&(e=1/60),this._currentPlugin.runOneStep(e)},t.prototype._setGravity=function(t){this.gravity=t||new e.Vector3(0,-9.82,0),this._currentPlugin.setGravity(this.gravity)},t.prototype._registerMesh=function(e,t,i){return this._currentPlugin.registerMesh(e,t,i)},t.prototype._registerMeshesAsCompound=function(e,t){return this._currentPlugin.registerMeshesAsCompound(e,t)},t.prototype._unregisterMesh=function(e){this._currentPlugin.unregisterMesh(e)},t.prototype._applyImpulse=function(e,t,i){this._currentPlugin.applyImpulse(e,t,i)},t.prototype._createLink=function(e,t,i,r){return this._currentPlugin.createLink(e,t,i,r)},t.prototype.dispose=function(){this._currentPlugin.dispose()},t.prototype.isSupported=function(){return this._currentPlugin.isSupported()},t.NoImpostor=0,t.SphereImpostor=1,t.BoxImpostor=2,t.PlaneImpostor=3,t.CompoundImpostor=4,t.MeshImpostor=4,t.Epsilon=.001,t}();e.PhysicsEngine=t}(BABYLON||(BABYLON={}));var BABYLON;!function(e){var t=function(t){var i={};if(i.name=t.name,i.id=t.id,i.tags=e.Tags.GetTags(t),t instanceof e.PointLight)i.type=0,i.position=t.position.asArray();else if(t instanceof e.DirectionalLight){i.type=1;var r=t;i.position=r.position.asArray(),i.direction=r.direction.asArray()}else if(t instanceof e.SpotLight){i.type=2;var n=t;i.position=n.position.asArray(),i.direction=n.position.asArray(),i.angle=n.angle,i.exponent=n.exponent}else if(t instanceof e.HemisphericLight){i.type=3;var o=t;i.direction=o.direction.asArray(),i.groundColor=o.groundColor.asArray()}return t.intensity&&(i.intensity=t.intensity),i.range=t.range,i.diffuse=t.diffuse.asArray(),i.specular=t.specular.asArray(),i},i=function(t){var i={};return i.name=t.name,i.tags=e.Tags.GetTags(t),i.id=t.id,i.position=t.position.asArray(),t.parent&&(i.parentId=t.parent.id),i.rotation=t.rotation.asArray(),t.lockedTarget&&t.lockedTarget.id&&(i.lockedTargetId=t.lockedTarget.id),i.fov=t.fov,i.minZ=t.minZ,i.maxZ=t.maxZ,i.speed=t.speed,i.inertia=t.inertia,i.checkCollisions=t.checkCollisions,i.applyGravity=t.applyGravity,t.ellipsoid&&(i.ellipsoid=t.ellipsoid.asArray()),r(t,i),i.layerMask=t.layerMask,i},r=function(e,t){if(e.animations){t.animations=[];for(var i=0;i<e.animations.length;i++){var r=e.animations[i];t.animations.push(n(r))}}},n=function(t){var i={};i.name=t.name,i.property=t.targetProperty,i.framePerSecond=t.framePerSecond,i.dataType=t.dataType,i.loopBehavior=t.loopMode;var r=t.dataType;i.keys=[];for(var n=t.getKeys(),o=0;o<n.length;o++){var s=n[o],a={};switch(a.frame=s.frame,r){case e.Animation.ANIMATIONTYPE_FLOAT:a.values=[s.value];break;case e.Animation.ANIMATIONTYPE_QUATERNION:case e.Animation.ANIMATIONTYPE_MATRIX:case e.Animation.ANIMATIONTYPE_VECTOR3:a.values=s.value.asArray()}i.keys.push(a)}return i},o=function(t){var i={};i.name=t.name,i.id=t.id,i.tags=e.Tags.GetTags(t),i.materials=[];for(var r=0;r<t.subMaterials.length;r++){var n=t.subMaterials[r];i.materials.push(n?n.id:null)}return i},s=function(t){var i={};return i.name=t.name,i.ambient=t.ambientColor.asArray(),i.diffuse=t.diffuseColor.asArray(),i.specular=t.specularColor.asArray(),i.specularPower=t.specularPower,i.emissive=t.emissiveColor.asArray(),i.alpha=t.alpha,i.id=t.id,i.tags=e.Tags.GetTags(t),i.backFaceCulling=t.backFaceCulling,t.diffuseTexture&&(i.diffuseTexture=a(t.diffuseTexture)),t.ambientTexture&&(i.ambientTexture=a(t.ambientTexture)),t.opacityTexture&&(i.opacityTexture=a(t.opacityTexture)),t.reflectionTexture&&(i.reflectionTexture=a(t.reflectionTexture)),t.emissiveTexture&&(i.emissiveTexture=a(t.emissiveTexture)),t.specularTexture&&(i.specularTexture=a(t.specularTexture)),t.bumpTexture&&(i.bumpTexture=a(t.bumpTexture)),i},a=function(t){var i={};if(!t.name)return null;if(t instanceof e.CubeTexture)return i.name=t.name,i.hasAlpha=t.hasAlpha,i.level=t.level,i.coordinatesMode=t.coordinatesMode,i;if(t instanceof e.MirrorTexture){var n=t;i.renderTargetSize=n.getRenderSize(),i.renderList=[];for(var o=0;o<n.renderList.length;o++)i.renderList.push(n.renderList[o].id);i.mirrorPlane=n.mirrorPlane.asArray()}else if(t instanceof e.RenderTargetTexture){var s=t;for(i.renderTargetSize=s.getRenderSize(),i.renderList=[],o=0;o<s.renderList.length;o++)i.renderList.push(s.renderList[o].id)}var a=t;return i.name=t.name,i.hasAlpha=t.hasAlpha,i.level=t.level,i.coordinatesIndex=t.coordinatesIndex,i.coordinatesMode=t.coordinatesMode,i.uOffset=a.uOffset,i.vOffset=a.vOffset,i.uScale=a.uScale,i.vScale=a.vScale,i.uAng=a.uAng,i.vAng=a.vAng,i.wAng=a.wAng,i.wrapU=t.wrapU,i.wrapV=t.wrapV,r(t,i),i},h=function(e){var t={};t.name=e.name,t.id=e.id,t.bones=[];for(var i=0;i<e.bones.length;i++){var r=e.bones[i],o={parentBoneIndex:r.getParent()?e.bones.indexOf(r.getParent()):-1,name:r.name,matrix:r.getLocalMatrix().toArray()};t.bones.push(o),r.animations&&r.animations.length>0&&(o.animation=n(r.animations[0]))}return t},c=function(e){var t={};return t.emitterId=e.emitter.id,t.capacity=e.getCapacity(),e.particleTexture&&(t.textureName=e.particleTexture.name),t.minAngularSpeed=e.minAngularSpeed,t.maxAngularSpeed=e.maxAngularSpeed,t.minSize=e.minSize,t.maxSize=e.maxSize,t.minLifeTime=e.minLifeTime,t.maxLifeTime=e.maxLifeTime,t.emitRate=e.emitRate,t.minEmitBox=e.minEmitBox.asArray(),t.maxEmitBox=e.maxEmitBox.asArray(),t.gravity=e.gravity.asArray(),t.direction1=e.direction1.asArray(),t.direction2=e.direction2.asArray(),t.color1=e.color1.asArray(),t.color2=e.color2.asArray(),t.colorDead=e.colorDead.asArray(),t.updateSpeed=e.updateSpeed,t.targetStopDuration=e.targetStopDuration,t.textureMask=e.textureMask.asArray(),t.blendMode=e.blendMode,t},u=function(t){var i={};i.emitterId=t.getEmitter().id,i.borderLimit=t.borderLimit,i.flares=[];for(var r=0;r<t.lensFlares.length;r++){var n=t.lensFlares[r];i.flares.push({size:n.size,position:n.position,color:n.color.asArray(),textureName:e.Tools.GetFilename(n.texture.name)})}return i},l=function(e){var t={},i=e.getShadowGenerator();t.lightId=e.id,t.mapSize=i.getShadowMap().getRenderSize(),t.useVarianceShadowMap=i.useVarianceShadowMap,t.renderList=[];for(var r=0;r<i.getShadowMap().renderList.length;r++){var n=i.getShadowMap().renderList[r];t.renderList.push(n.id)}return t},f=[],d=function(t,i){if(!f[t.id]){if(t instanceof e.Geometry.Primitives.Box)i.boxes.push(g(t));else if(t instanceof e.Geometry.Primitives.Sphere)i.spheres.push(v(t));else if(t instanceof e.Geometry.Primitives.Cylinder)i.cylinders.push(y(t));else if(t instanceof e.Geometry.Primitives.Torus)i.toruses.push(x(t));else if(t instanceof e.Geometry.Primitives.Ground)i.grounds.push(A(t));else if(t instanceof e.Geometry.Primitives.Plane)i.planes.push(B(t));else if(t instanceof e.Geometry.Primitives.TorusKnot)i.torusKnots.push(T(t));else{if(t instanceof e.Geometry.Primitives._Primitive)throw new Error("Unknow primitive type");i.vertexData.push(m(t))}f[t.id]=!0}},p=function(t){var i={};return i.id=t.id,e.Tags.HasTags(t)&&(i.tags=e.Tags.GetTags(t)),i},m=function(t){var i=p(t);return t.isVerticesDataPresent(e.VertexBuffer.PositionKind)&&(i.positions=t.getVerticesData(e.VertexBuffer.PositionKind)),t.isVerticesDataPresent(e.VertexBuffer.NormalKind)&&(i.normals=t.getVerticesData(e.VertexBuffer.NormalKind)),t.isVerticesDataPresent(e.VertexBuffer.UVKind)&&(i.uvs=t.getVerticesData(e.VertexBuffer.UVKind)),t.isVerticesDataPresent(e.VertexBuffer.UV2Kind)&&(i.uvs2=t.getVerticesData(e.VertexBuffer.UV2Kind)),t.isVerticesDataPresent(e.VertexBuffer.ColorKind)&&(i.colors=t.getVerticesData(e.VertexBuffer.ColorKind)),t.isVerticesDataPresent(e.VertexBuffer.MatricesIndicesKind)&&(i.matricesIndices=t.getVerticesData(e.VertexBuffer.MatricesIndicesKind),i.matricesIndices._isExpanded=!0),t.isVerticesDataPresent(e.VertexBuffer.MatricesWeightsKind)&&(i.matricesWeights=t.getVerticesData(e.VertexBuffer.MatricesWeightsKind)),i.indices=t.getIndices(),i},_=function(e){var t=p(e);return t.canBeRegenerated=e.canBeRegenerated(),t},g=function(e){var t=_(e);return t.size=e.size,t},v=function(e){var t=_(e);return t.segments=e.segments,t.diameter=e.diameter,t},y=function(e){var t=_(e);return t.height=e.height,t.diameterTop=e.diameterTop,t.diameterBottom=e.diameterBottom,t.tessellation=e.tessellation,t},x=function(e){var t=_(e);return t.diameter=e.diameter,t.thickness=e.thickness,t.tessellation=e.tessellation,t},A=function(e){var t=_(e);return t.width=e.width,t.height=e.height,t.subdivisions=e.subdivisions,t},B=function(e){var t=_(e);return t.size=e.size,t},T=function(e){var t=_(e);return t.radius=e.radius,t.tube=e.tube,t.radialSegments=e.radialSegments,t.tubularSegments=e.tubularSegments,t.p=e.p,t.q=e.q,t},b=function(t,i){var n={};n.name=t.name,n.id=t.id,e.Tags.HasTags(t)&&(n.tags=e.Tags.GetTags(t)),n.position=t.position.asArray(),t.rotationQuaternion?n.rotationQuaternion=t.rotationQuaternion.asArray():t.rotation&&(n.rotation=t.rotation.asArray()),n.scaling=t.scaling.asArray(),n.localMatrix=t.getPivotMatrix().asArray(),n.isEnabled=t.isEnabled(),n.isVisible=t.isVisible,n.infiniteDistance=t.infiniteDistance,n.pickable=t.isPickable,n.receiveShadows=t.receiveShadows,n.billboardMode=t.billboardMode,n.visibility=t.visibility,n.checkCollisions=t.checkCollisions,t.parent&&(n.parentId=t.parent.id);var o=t._geometry;if(o){var s=o.id;n.geometryId=s,t.getScene().getGeometryByID(s)||d(o,i.geometries),n.subMeshes=[];for(var a=0;a<t.subMeshes.length;a++){var h=t.subMeshes[a];n.subMeshes.push({materialIndex:h.materialIndex,verticesStart:h.verticesStart,verticesCount:h.verticesCount,indexStart:h.indexStart,indexCount:h.indexCount})}}if(t.material?n.materialId=t.material.id:t.material=null,t.skeleton&&(n.skeletonId=t.skeleton.id),t.getPhysicsImpostor()!==e.PhysicsEngine.NoImpostor)switch(n.physicsMass=t.getPhysicsMass(),n.physicsFriction=t.getPhysicsFriction(),n.physicsRestitution=t.getPhysicsRestitution(),t.getPhysicsImpostor()){case e.PhysicsEngine.BoxImpostor:n.physicsImpostor=1;break;case e.PhysicsEngine.SphereImpostor:n.physicsImpostor=2}return r(t,n),n.layerMask=t.layerMask,n},M=function(){function r(){}return r.Serialize=function(r){var n={};n.useDelayedTextureLoading=r.useDelayedTextureLoading,n.autoClear=r.autoClear,n.clearColor=r.clearColor.asArray(),n.ambientColor=r.ambientColor.asArray(),n.gravity=r.gravity.asArray(),r.fogMode&&0!==r.fogMode&&(n.fogMode=r.fogMode,n.fogColor=r.fogColor.asArray(),n.fogStart=r.fogStart,n.fogEnd=r.fogEnd,n.fogDensity=r.fogDensity),n.lights=[];for(var a=0;a<r.lights.length;a++){var p=r.lights[a];n.lights.push(t(p))}for(n.cameras=[],a=0;a<r.cameras.length;a++){var m=r.cameras[a];m instanceof e.FreeCamera&&n.cameras.push(i(m))}for(r.activeCamera&&(n.activeCameraID=r.activeCamera.id),n.materials=[],n.multiMaterials=[],a=0;a<r.materials.length;a++){var _=r.materials[a];_ instanceof e.StandardMaterial?n.materials.push(s(_)):_ instanceof e.MultiMaterial&&n.multiMaterials.push(o(_))}for(n.skeletons=[],a=0;a<r.skeletons.length;a++)n.skeletons.push(h(r.skeletons[a]));n.geometries={},n.geometries.boxes=[],n.geometries.spheres=[],n.geometries.cylinders=[],n.geometries.toruses=[],n.geometries.grounds=[],n.geometries.planes=[],n.geometries.torusKnots=[],n.geometries.vertexData=[],f=[];for(var g=r.getGeometries(),a=0;a<g.length;a++){var v=g[a];v.isReady()&&d(v,n.geometries)}for(n.meshes=[],a=0;a<r.meshes.length;a++){var y=r.meshes[a];if(y instanceof e.Mesh){var x=y;(x.delayLoadState===e.Engine.DELAYLOADSTATE_LOADED||x.delayLoadState===e.Engine.DELAYLOADSTATE_NONE)&&n.meshes.push(b(x,n))}}for(n.particleSystems=[],a=0;a<r.particleSystems.length;a++)n.particleSystems.push(c(r.particleSystems[a]));for(n.lensFlareSystems=[],a=0;a<r.lensFlareSystems.length;a++)n.lensFlareSystems.push(u(r.lensFlareSystems[a]));for(n.shadowGenerators=[],a=0;a<r.lights.length;a++)p=r.lights[a],p.getShadowGenerator()&&n.shadowGenerators.push(l(p));return n},r}();e.SceneSerializer=M}(BABYLON||(BABYLON={}));var BABYLON;!function(e){var t=0,i=function(){function t(e,t,i){this.pos=e,this.normal=t,this.uv=i}return t.prototype.clone=function(){return new t(this.pos.clone(),this.normal.clone(),this.uv.clone())},t.prototype.flip=function(){this.normal=this.normal.scale(-1)},t.prototype.interpolate=function(i,r){return new t(e.Vector3.Lerp(this.pos,i.pos,r),e.Vector3.Lerp(this.normal,i.normal,r),e.Vector2.Lerp(this.uv,i.uv,r))},t}(),r=function(){function t(e,t){this.normal=e,this.w=t}return t.FromPoints=function(i,r,n){var o=n.subtract(i),s=r.subtract(i);if(0===o.lengthSquared()||0===s.lengthSquared())return null;var a=e.Vector3.Normalize(e.Vector3.Cross(o,s));return new t(a,e.Vector3.Dot(a,i))},t.prototype.clone=function(){return new t(this.normal.clone(),this.w)},t.prototype.flip=function(){this.normal.scaleInPlace(-1),this.w=-this.w},t.prototype.splitPolygon=function(i,r,o,s,a){for(var h=0,c=1,u=2,l=3,f=0,d=[],p=0;p<i.vertices.length;p++){var m=e.Vector3.Dot(this.normal,i.vertices[p].pos)-this.w,_=m<-t.EPSILON?u:m>t.EPSILON?c:h;f|=_,d.push(_)}switch(f){case h:(e.Vector3.Dot(this.normal,i.plane.normal)>0?r:o).push(i);break;case c:s.push(i);break;case u:a.push(i);break;case l:var g=[],v=[];for(p=0;p<i.vertices.length;p++){var y=(p+1)%i.vertices.length,x=d[p],A=d[y],B=i.vertices[p],T=i.vertices[y];if(x!=u&&g.push(B),x!=c&&v.push(x!=u?B.clone():B),(x|A)==l){m=(this.w-e.Vector3.Dot(this.normal,B.pos))/e.Vector3.Dot(this.normal,T.pos.subtract(B.pos));var b=B.interpolate(T,m);g.push(b),v.push(b.clone())}}if(g.length>=3){var M=new n(g,i.shared);M.plane&&s.push(M)}v.length>=3&&(M=new n(v,i.shared),M.plane&&a.push(M))}},t.EPSILON=1e-5,t}(),n=function(){function e(e,t){this.vertices=e,this.shared=t,this.plane=r.FromPoints(e[0].pos,e[1].pos,e[2].pos)}return e.prototype.clone=function(){var t=this.vertices.map(function(e){return e.clone()});return new e(t,this.shared)},e.prototype.flip=function(){this.vertices.reverse().map(function(e){e.flip()}),this.plane.flip()},e}(),o=function(){function e(e){this.plane=null,this.front=null,this.back=null,this.polygons=[],e&&this.build(e)}return e.prototype.clone=function(){var t=new e;return t.plane=this.plane&&this.plane.clone(),t.front=this.front&&this.front.clone(),t.back=this.back&&this.back.clone(),t.polygons=this.polygons.map(function(e){return e.clone()}),t},e.prototype.invert=function(){for(var e=0;e<this.polygons.length;e++)this.polygons[e].flip();this.plane&&this.plane.flip(),this.front&&this.front.invert(),this.back&&this.back.invert();var t=this.front;this.front=this.back,this.back=t},e.prototype.clipPolygons=function(e){if(!this.plane)return e.slice();for(var t=[],i=[],r=0;r<e.length;r++)this.plane.splitPolygon(e[r],t,i,t,i);return this.front&&(t=this.front.clipPolygons(t)),i=this.back?this.back.clipPolygons(i):[],t.concat(i)},e.prototype.clipTo=function(e){this.polygons=e.clipPolygons(this.polygons),this.front&&this.front.clipTo(e),this.back&&this.back.clipTo(e)},e.prototype.allPolygons=function(){var e=this.polygons.slice();return this.front&&(e=e.concat(this.front.allPolygons())),this.back&&(e=e.concat(this.back.allPolygons())),e},e.prototype.build=function(t){if(t.length){this.plane||(this.plane=t[0].plane.clone());for(var i=[],r=[],n=0;n<t.length;n++)this.plane.splitPolygon(t[n],this.polygons,this.polygons,i,r);i.length&&(this.front||(this.front=new e),this.front.build(i)),r.length&&(this.back||(this.back=new e),this.back.build(r))}},e}(),s=function(){function r(){this.polygons=new Array}return r.FromMesh=function(o){var s,a,h,c,u,l,f=[];if(!(o instanceof e.Mesh))throw"BABYLON.CSG: Wrong Mesh type, must be BABYLON.Mesh";o.computeWorldMatrix(!0);for(var d=o.getWorldMatrix(),p=o.position.clone(),m=o.rotation.clone(),_=o.scaling.clone(),g=o.getIndices(),v=o.getVerticesData(e.VertexBuffer.PositionKind),y=o.getVerticesData(e.VertexBuffer.NormalKind),x=o.getVerticesData(e.VertexBuffer.UVKind),A=o.subMeshes,B=0,T=A.length;T>B;B++)for(var b=A[B].indexStart,M=A[B].indexCount+A[B].indexStart;M>b;b+=3){l=[];for(var L=0;3>L;L++)a=new e.Vector3(y[3*g[b+L]],y[3*g[b+L]+1],y[3*g[b+L]+2]),h=new e.Vector2(x[2*g[b+L]],x[2*g[b+L]+1]),c=new e.Vector3(v[3*g[b+L]],v[3*g[b+L]+1],v[3*g[b+L]+2]),e.Vector3.TransformCoordinatesToRef(c,d,c),e.Vector3.TransformNormalToRef(a,d,a),s=new i(c,a,h),l.push(s);
u=new n(l,{subMeshId:B,meshId:t,materialIndex:A[B].materialIndex}),u.plane&&f.push(u)}var E=r.FromPolygons(f);return E.matrix=d,E.position=p,E.rotation=m,E.scaling=_,t++,E},r.FromPolygons=function(t){var i=new e.CSG;return i.polygons=t,i},r.prototype.clone=function(){var t=new e.CSG;return t.polygons=this.polygons.map(function(e){return e.clone()}),t.copyTransformAttributes(this),t},r.prototype.toPolygons=function(){return this.polygons},r.prototype.union=function(e){var t=new o(this.clone().polygons),i=new o(e.clone().polygons);return t.clipTo(i),i.clipTo(t),i.invert(),i.clipTo(t),i.invert(),t.build(i.allPolygons()),r.FromPolygons(t.allPolygons()).copyTransformAttributes(this)},r.prototype.unionInPlace=function(e){var t=new o(this.polygons),i=new o(e.polygons);t.clipTo(i),i.clipTo(t),i.invert(),i.clipTo(t),i.invert(),t.build(i.allPolygons()),this.polygons=t.allPolygons()},r.prototype.subtract=function(e){var t=new o(this.clone().polygons),i=new o(e.clone().polygons);return t.invert(),t.clipTo(i),i.clipTo(t),i.invert(),i.clipTo(t),i.invert(),t.build(i.allPolygons()),t.invert(),r.FromPolygons(t.allPolygons()).copyTransformAttributes(this)},r.prototype.subtractInPlace=function(e){var t=new o(this.polygons),i=new o(e.polygons);t.invert(),t.clipTo(i),i.clipTo(t),i.invert(),i.clipTo(t),i.invert(),t.build(i.allPolygons()),t.invert(),this.polygons=t.allPolygons()},r.prototype.intersect=function(e){var t=new o(this.clone().polygons),i=new o(e.clone().polygons);return t.invert(),i.clipTo(t),i.invert(),t.clipTo(i),i.clipTo(t),t.build(i.allPolygons()),t.invert(),r.FromPolygons(t.allPolygons()).copyTransformAttributes(this)},r.prototype.intersectInPlace=function(e){var t=new o(this.polygons),i=new o(e.polygons);t.invert(),i.clipTo(t),i.invert(),t.clipTo(i),i.clipTo(t),t.build(i.allPolygons()),t.invert(),this.polygons=t.allPolygons()},r.prototype.inverse=function(){var e=this.clone();return e.inverseInPlace(),e},r.prototype.inverseInPlace=function(){this.polygons.map(function(e){e.flip()})},r.prototype.copyTransformAttributes=function(e){return this.matrix=e.matrix,this.position=e.position,this.rotation=e.rotation,this.scaling=e.scaling,this},r.prototype.buildMeshGeometry=function(t,i,r){var n=this.matrix.clone();n.invert();var o,s,a,h=new e.Mesh(t,i),c=[],u=[],l=[],f=[],d=e.Vector3.Zero(),p=e.Vector3.Zero(),m=e.Vector2.Zero(),_=this.polygons,g=[0,0,0],v={},y=0,x={};r&&_.sort(function(e,t){return e.shared.meshId===t.shared.meshId?e.shared.subMeshId-t.shared.subMeshId:e.shared.meshId-t.shared.meshId});for(var A=0,B=_.length;B>A;A++){o=_[A],x[o.shared.meshId]||(x[o.shared.meshId]={}),x[o.shared.meshId][o.shared.subMeshId]||(x[o.shared.meshId][o.shared.subMeshId]={indexStart:+1/0,indexEnd:-1/0,materialIndex:o.shared.materialIndex}),a=x[o.shared.meshId][o.shared.subMeshId];for(var T=2,b=o.vertices.length;b>T;T++){g[0]=0,g[1]=T-1,g[2]=T;for(var M=0;3>M;M++)d.copyFrom(o.vertices[g[M]].pos),p.copyFrom(o.vertices[g[M]].normal),m.copyFrom(o.vertices[g[M]].uv),e.Vector3.TransformCoordinatesToRef(d,n,d),e.Vector3.TransformNormalToRef(p,n,p),s=v[d.x+","+d.y+","+d.z],("undefined"==typeof s||l[3*s]!==p.x||l[3*s+1]!==p.y||l[3*s+2]!==p.z||f[2*s]!==m.x||f[2*s+1]!==m.y)&&(c.push(d.x,d.y,d.z),f.push(m.x,m.y),l.push(p.x,p.y,p.z),s=v[d.x+","+d.y+","+d.z]=c.length/3-1),u.push(s),a.indexStart=Math.min(y,a.indexStart),a.indexEnd=Math.max(y,a.indexEnd),y++}}if(h.setVerticesData(e.VertexBuffer.PositionKind,c),h.setVerticesData(e.VertexBuffer.NormalKind,l),h.setVerticesData(e.VertexBuffer.UVKind,f),h.setIndices(u),r){var L,E=0;h.subMeshes.length=0;for(var O in x){L=-1;for(var P in x[O])a=x[O][P],e.SubMesh.CreateFromIndices(a.materialIndex+E,a.indexStart,a.indexEnd-a.indexStart+1,h),L=Math.max(a.materialIndex,L);E+=++L}}return h},r.prototype.toMesh=function(e,t,i,r){var n=this.buildMeshGeometry(e,i,r);return n.material=t,n.position.copyFrom(this.position),n.rotation.copyFrom(this.rotation),n.scaling.copyFrom(this.scaling),n.computeWorldMatrix(!0),n},r}();e.CSG=s}(BABYLON||(BABYLON={}));var __extends=this.__extends||function(e,t){function i(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);i.prototype=t.prototype,e.prototype=new i},BABYLON;!function(e){var t=function(t){function i(i,r,n,o){var s=this;t.call(this,i,"oculusDistortionCorrection",["LensCenter","Scale","ScaleIn","HmdWarpParam"],null,o.PostProcessScaleFactor,r,e.Texture.BILINEAR_SAMPLINGMODE,null,null),this._isRightEye=n,this._distortionFactors=o.DistortionK,this._postProcessScaleFactor=o.PostProcessScaleFactor,this._lensCenterOffset=o.LensCenterOffset,this.onSizeChanged=function(){s.aspectRatio=.5*s.width/s.height,s._scaleIn=new e.Vector2(2,2/s.aspectRatio),s._scaleFactor=new e.Vector2(.5*(1/s._postProcessScaleFactor),.5*(1/s._postProcessScaleFactor)*s.aspectRatio),s._lensCenter=new e.Vector2(s._isRightEye?.5-.5*s._lensCenterOffset:.5+.5*s._lensCenterOffset,.5)},this.onApply=function(e){e.setFloat2("LensCenter",s._lensCenter.x,s._lensCenter.y),e.setFloat2("Scale",s._scaleFactor.x,s._scaleFactor.y),e.setFloat2("ScaleIn",s._scaleIn.x,s._scaleIn.y),e.setFloat4("HmdWarpParam",s._distortionFactors[0],s._distortionFactors[1],s._distortionFactors[2],s._distortionFactors[3])}}return __extends(i,t),i}(e.PostProcess);e.OculusDistortionCorrectionPostProcess=t}(BABYLON||(BABYLON={}));var BABYLON;!function(e){!function(e){e[e.X=0]="X",e[e.Y=1]="Y",e[e.Z=2]="Z"}(e.JoystickAxis||(e.JoystickAxis={}));var t=(e.JoystickAxis,function(){function t(i){var r=this;this._leftJoystick=i?!0:!1,this._joystickIndex=t._globalJoystickIndex,t._globalJoystickIndex++,this._axisTargetedByLeftAndRight=0,this._axisTargetedByUpAndDown=1,this.reverseLeftRight=!1,this.reverseUpDown=!1,this._touches=new e.VirtualJoystick.Collection,this.deltaPosition=e.Vector3.Zero(),this._joystickSensibility=25,this._inversedSensibility=1/(this._joystickSensibility/1e3),this._rotationSpeed=25,this._inverseRotationSpeed=1/(this._rotationSpeed/1e3),this._rotateOnAxisRelativeToMesh=!1,t.vjCanvas||(window.addEventListener("resize",function(){t.vjCanvasWidth=window.innerWidth,t.vjCanvasHeight=window.innerHeight,t.vjCanvas.width=t.vjCanvasWidth,t.vjCanvas.height=t.vjCanvasHeight,t.halfWidth=t.vjCanvasWidth/2,t.halfHeight=t.vjCanvasHeight/2},!1),t.vjCanvas=document.createElement("canvas"),t.vjCanvasWidth=window.innerWidth,t.vjCanvasHeight=window.innerHeight,t.vjCanvas.width=window.innerWidth,t.vjCanvas.height=window.innerHeight,t.vjCanvas.style.width="100%",t.vjCanvas.style.height="100%",t.vjCanvas.style.position="absolute",t.vjCanvas.style.backgroundColor="transparent",t.vjCanvas.style.top="0px",t.vjCanvas.style.left="0px",t.vjCanvas.style.zIndex="5",t.vjCanvas.style.msTouchAction="none",t.vjCanvasContext=t.vjCanvas.getContext("2d"),t.vjCanvasContext.strokeStyle="#ffffff",t.vjCanvasContext.lineWidth=2,document.body.appendChild(t.vjCanvas)),t.halfWidth=t.vjCanvas.width/2,t.halfHeight=t.vjCanvas.height/2,this.pressed=!1,this._joystickColor="cyan",this._joystickPointerID=-1,this._joystickPointerPos=new e.Vector2(0,0),this._joystickPointerStartPos=new e.Vector2(0,0),this._deltaJoystickVector=new e.Vector2(0,0),t.vjCanvas.addEventListener("pointerdown",function(e){r._onPointerDown(e)},!1),t.vjCanvas.addEventListener("pointermove",function(e){r._onPointerMove(e)},!1),t.vjCanvas.addEventListener("pointerup",function(e){r._onPointerUp(e)},!1),t.vjCanvas.addEventListener("pointerout",function(e){r._onPointerUp(e)},!1),t.vjCanvas.addEventListener("contextmenu",function(e){e.preventDefault()},!1),requestAnimationFrame(function(){r._drawVirtualJoystick()})}return t.prototype.setJoystickSensibility=function(e){this._joystickSensibility=e,this._inversedSensibility=1/(this._joystickSensibility/1e3)},t.prototype._onPointerDown=function(e){var i;e.preventDefault(),i=this._leftJoystick===!0?e.clientX<t.halfWidth:e.clientX>t.halfWidth,i&&this._joystickPointerID<0?(this._joystickPointerID=e.pointerId,this._joystickPointerStartPos.x=e.clientX,this._joystickPointerStartPos.y=e.clientY,this._joystickPointerPos=this._joystickPointerStartPos.clone(),this._deltaJoystickVector.x=0,this._deltaJoystickVector.y=0,this.pressed=!0,this._touches.add(e.pointerId.toString(),e)):t._globalJoystickIndex<2&&this._action&&(this._action(),this._touches.add(e.pointerId.toString(),e))},t.prototype._onPointerMove=function(e){if(this._joystickPointerID==e.pointerId){this._joystickPointerPos.x=e.clientX,this._joystickPointerPos.y=e.clientY,this._deltaJoystickVector=this._joystickPointerPos.clone(),this._deltaJoystickVector=this._deltaJoystickVector.subtract(this._joystickPointerStartPos);var t=this.reverseLeftRight?-1:1,i=t*this._deltaJoystickVector.x/this._inversedSensibility;switch(this._axisTargetedByLeftAndRight){case 0:this.deltaPosition.x=Math.min(1,Math.max(-1,i));break;case 1:this.deltaPosition.y=Math.min(1,Math.max(-1,i));break;case 2:this.deltaPosition.z=Math.min(1,Math.max(-1,i))}var r=this.reverseUpDown?1:-1,n=r*this._deltaJoystickVector.y/this._inversedSensibility;switch(this._axisTargetedByUpAndDown){case 0:this.deltaPosition.x=Math.min(1,Math.max(-1,n));break;case 1:this.deltaPosition.y=Math.min(1,Math.max(-1,n));break;case 2:this.deltaPosition.z=Math.min(1,Math.max(-1,n))}}else this._touches.item(e.pointerId.toString())&&(this._touches.item(e.pointerId.toString()).x=e.clientX,this._touches.item(e.pointerId.toString()).y=e.clientY)},t.prototype._onPointerUp=function(e){this._clearCanvas(),this._joystickPointerID==e.pointerId&&(this._joystickPointerID=-1,this.pressed=!1),this._deltaJoystickVector.x=0,this._deltaJoystickVector.y=0,this._touches.remove(e.pointerId.toString())},t.prototype.setJoystickColor=function(e){this._joystickColor=e},t.prototype.setActionOnTouch=function(e){this._action=e},t.prototype.setAxisForLeftRight=function(e){switch(e){case 0:case 1:case 2:this._axisTargetedByLeftAndRight=e;break;default:this._axisTargetedByLeftAndRight=0}},t.prototype.setAxisForUpDown=function(e){switch(e){case 0:case 1:case 2:this._axisTargetedByUpAndDown=e;break;default:this._axisTargetedByUpAndDown=1}},t.prototype._clearCanvas=function(){this._leftJoystick?t.vjCanvasContext.clearRect(0,0,t.vjCanvasWidth/2,t.vjCanvasHeight):t.vjCanvasContext.clearRect(t.vjCanvasWidth/2,0,t.vjCanvasWidth,t.vjCanvasHeight)},t.prototype._drawVirtualJoystick=function(){var e=this;this.pressed&&(this._clearCanvas(),this._touches.forEach(function(i){i.pointerId===e._joystickPointerID?(t.vjCanvasContext.beginPath(),t.vjCanvasContext.strokeStyle=e._joystickColor,t.vjCanvasContext.lineWidth=6,t.vjCanvasContext.arc(e._joystickPointerStartPos.x,e._joystickPointerStartPos.y,40,0,2*Math.PI,!0),t.vjCanvasContext.stroke(),t.vjCanvasContext.beginPath(),t.vjCanvasContext.strokeStyle=e._joystickColor,t.vjCanvasContext.lineWidth=2,t.vjCanvasContext.arc(e._joystickPointerStartPos.x,e._joystickPointerStartPos.y,60,0,2*Math.PI,!0),t.vjCanvasContext.stroke(),t.vjCanvasContext.beginPath(),t.vjCanvasContext.strokeStyle=e._joystickColor,t.vjCanvasContext.arc(e._joystickPointerPos.x,e._joystickPointerPos.y,40,0,2*Math.PI,!0),t.vjCanvasContext.stroke()):(t.vjCanvasContext.beginPath(),t.vjCanvasContext.fillStyle="white",t.vjCanvasContext.beginPath(),t.vjCanvasContext.strokeStyle="red",t.vjCanvasContext.lineWidth=6,t.vjCanvasContext.arc(i.x,i.y,40,0,2*Math.PI,!0),t.vjCanvasContext.stroke())})),requestAnimationFrame(function(){e._drawVirtualJoystick()})},t.prototype.releaseCanvas=function(){t.vjCanvas&&(document.body.removeChild(t.vjCanvas),t.vjCanvas=null)},t._globalJoystickIndex=0,t}());e.VirtualJoystick=t}(BABYLON||(BABYLON={}));var BABYLON;!function(e){!function(e){var t=function(){function e(){this._count=0,this._collection=new Array}return e.prototype.Count=function(){return this._count},e.prototype.add=function(e,t){return void 0!=this._collection[e]?void 0:(this._collection[e]=t,++this._count)},e.prototype.remove=function(e){return void 0==this._collection[e]?void 0:(delete this._collection[e],--this._count)},e.prototype.item=function(e){return this._collection[e]},e.prototype.forEach=function(e){var t;for(t in this._collection)this._collection.hasOwnProperty(t)&&e(this._collection[t])},e}();e.Collection=t}(e.VirtualJoystick||(e.VirtualJoystick={}));e.VirtualJoystick}(BABYLON||(BABYLON={}));var BABYLON=BABYLON||{};!function(){BABYLON.OculusController=function(e,t){BABYLON.InputController.call(this,e,t),this._deviceOrientationHandler=this.onOrientationEvent.bind(this),this._tempOrientation={yaw:0,pitch:0,roll:0},this._relativeOrientation={yaw:0,pitch:0,roll:0},window.addEventListener("deviceorientation",this._deviceOrientationHandler)},BABYLON.OculusController.prototype=Object.create(BABYLON.InputController.prototype),BABYLON.OculusController.prototype.onOrientationEvent=function(e){if(this._tempOrientation.yaw=e.alpha/180*Math.PI,this._tempOrientation.pitch=e.beta/180*Math.PI,this._tempOrientation.roll=e.gamma/180*Math.PI,this._lastOrientation){this._relativeOrientation.yaw=this._tempOrientation.yaw-this._lastOrientation.yaw,this._relativeOrientation.pitch=this._tempOrientation.pitch-this._lastOrientation.pitch,this._relativeOrientation.roll=this._tempOrientation.roll-this._lastOrientation.roll;var t=this._tempOrientation;this._tempOrientation=this._lastOrientation,this._lastOrientation=t,this.target.rotateRelative(this._relativeOrientation)}else this._lastOrientation=Object.create(this._tempOrientation)},BABYLON.OculusController.prototype.dispose=function(){window.removeEventListener("deviceorientation",this._deviceOrientationHandler)},BABYLON.OculusController.CameraSettings_OculusRiftDevKit2013_Metric={HResolution:1280,VResolution:800,HScreenSize:.149759993,VScreenSize:.0935999975,VScreenCenter:.0467999987,EyeToScreenDistance:.0410000011,LensSeparationDistance:.063500002,InterpupillaryDistance:.064000003,DistortionK:[1,.219999999,.239999995,0],ChromaAbCorrection:[.995999992,-.00400000019,1.01400006,0],PostProcessScaleFactor:1.714605507808412,LensCenterOffset:.151976421}}();var BABYLON=BABYLON||{};!function(){BABYLON.OculusOrientedCamera=function(e,t,i,r,n,o){t=t?new BABYLON.Vector3(t.x,t.y,t.z):null,BABYLON.Camera.call(this,e,t,i),this._referenceDirection=new BABYLON.Vector3(0,0,1),this._referenceUp=new BABYLON.Vector3(0,1,0),this._actualDirection=new BABYLON.Vector3(1,0,0),this._actualUp=new BABYLON.Vector3(0,1,0),this._currentTargetPoint=new BABYLON.Vector3(0,0,0),this._currentOrientation=Object.create(o||{yaw:0,pitch:0,roll:0}),this._currentViewMatrix=new BABYLON.Matrix,this._currentOrientationMatrix=new BABYLON.Matrix,this._currentInvertOrientationMatrix=new BABYLON.Matrix,this._tempMatrix=new BABYLON.Matrix,this.viewport=r?new BABYLON.Viewport(0,0,.5,1):new BABYLON.Viewport(.5,0,.5,1),this._aspectRatioAspectRatio=n.HResolution/(2*n.VResolution),this._aspectRatioFov=2*Math.atan(n.PostProcessScaleFactor*n.VScreenSize/(2*n.EyeToScreenDistance));var s=n.HScreenSize/4-n.LensSeparationDistance/2,a=4*s/n.HScreenSize;this._hMatrix=BABYLON.Matrix.Translation(r?a:-a,0,0),this._projectionMatrix=new BABYLON.Matrix,this._preViewMatrix=BABYLON.Matrix.Translation(r?.5*n.InterpupillaryDistance:-.5*n.InterpupillaryDistance,0,0),new BABYLON.OculusDistortionCorrectionPostProcess("Oculus Distortion",this,!r,n),this.resetProjectionMatrix(),this.resetViewMatrix()},BABYLON.OculusOrientedCamera.BuildOculusStereoCamera=function(e,t,i,r,n,o,s,a,h,c,u){var l=e.getEngine().getRenderingCanvas();n=n||BABYLON.Vector3.Zero(0,0,0),o=o||{yaw:0,pitch:0,roll:0},u=u||BABYLON.OculusController.CameraSettings_OculusRiftDevKit2013_Metric;var f=new BABYLON.OculusOrientedCamera(t+"_left",n,e,!0,u,o);f.minZ=i,f.maxZ=r,s&&new BABYLON.FxaaPostProcess("fxaa_left",1,f);var d=new BABYLON.OculusOrientedCamera(t+"_right",n.clone(),e,!1,u,o);d.minZ=i,d.maxZ=r,s&&new BABYLON.FxaaPostProcess("fxaa_right",1,d),e.activeCameras=[],e.activeCameras.push(f),e.activeCameras.push(d),f.attachControl(l),d.attachControl(l);var p=new BABYLON.InputControllerMultiTarget([f,d]),m=new BABYLON.OculusController(e,p),_=p;if(!h){var g=new BABYLON.InputCollisionFilter(e,p,c);_=g}if(!a){{var v=new BABYLON.GlobalAxisFactorsFilter(e,_,1,0,1);new BABYLON.GravityInputController(e,_)}_=v}var y=new BABYLON.KeyboardMoveController(e,_);y.attachToCanvas(l);var x={leftCamera:f,rightCamera:d,intermediateControllerTarget:p,oculusController:m,keyboardController:y};return x.dispose=function(){this.leftCamera.detachControl(l),this.rightCamera.detachControl(l),this.leftCamera.dispose(),this.rightCamera.dispose(),this.oculusController.dispose(),this.keyboardController.detachFromCanvas(l),this.keyboardController.dispose()}.bind(x),x},BABYLON.OculusOrientedCamera.prototype=Object.create(BABYLON.Camera.prototype),BABYLON.OculusOrientedCamera.prototype.resetViewMatrix=function(){return BABYLON.Matrix.RotationYawPitchRollToRef(this._currentOrientation.yaw,this._currentOrientation.pitch,-this._currentOrientation.roll,this._currentOrientationMatrix),this._currentOrientationMatrix.invertToRef(this._currentInvertOrientationMatrix),BABYLON.Vector3.TransformNormalToRef(this._referenceDirection,this._currentOrientationMatrix,this._actualDirection),BABYLON.Vector3.TransformNormalToRef(this._referenceUp,this._currentOrientationMatrix,this._actualUp),BABYLON.Vector3.FromFloatsToRef(this.position.x+this._actualDirection.x,this.position.y+this._actualDirection.y,this.position.z+this._actualDirection.z,this._currentTargetPoint),BABYLON.Matrix.LookAtLHToRef(this.position,this._currentTargetPoint,this._actualUp,this._tempMatrix),this._tempMatrix.multiplyToRef(this._preViewMatrix,this._currentViewMatrix),this._currentViewMatrix},BABYLON.OculusOrientedCamera.prototype.getViewMatrix=function(){return this._currentViewMatrix},BABYLON.OculusOrientedCamera.prototype._update=function(){if(this.controllers)for(var e=0;e<this.controllers.length;++e)this.controllers[e].update()},BABYLON.OculusOrientedCamera.prototype.getOrientationMatrix=function(){return this._currentOrientationMatrix},BABYLON.OculusOrientedCamera.prototype.getInvertOrientationMatrix=function(){return this._currentInvertOrientationMatrix},BABYLON.OculusOrientedCamera.prototype.resetProjectionMatrix=function(){return BABYLON.Matrix.PerspectiveFovLHToRef(this._aspectRatioFov,this._aspectRatioAspectRatio,this.minZ,this.maxZ,this._tempMatrix),this._tempMatrix.multiplyToRef(this._hMatrix,this._projectionMatrix),this._projectionMatrix},BABYLON.OculusOrientedCamera.prototype.getProjectionMatrix=function(){return this._projectionMatrix},BABYLON.OculusOrientedCamera.prototype.getOrientation=function(){return this._currentOrientation},BABYLON.OculusOrientedCamera.prototype.getPosition=function(){return this.position},BABYLON.OculusOrientedCamera.prototype.moveRelative=function(e){this._tempMoveVector||(this._tempMoveVector=new BABYLON.Vector3(0,0,0)),BABYLON.Vector3.TransformNormalToRef(e,this._currentOrientationMatrix,this._tempMoveVector),this.position.addInPlace(this._tempMoveVector),this.resetViewMatrix()},BABYLON.OculusOrientedCamera.prototype.rotateRelative=function(e){this._currentOrientation.yaw+=e.yaw,this._currentOrientation.pitch+=e.pitch,this._currentOrientation.roll+=e.roll,this.resetViewMatrix()}}();var __extends=this.__extends||function(e,t){function i(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);i.prototype=t.prototype,e.prototype=new i},BABYLON;!function(e){var t=function(t){function i(i,r,n){t.call(this,i,r,n),this._leftjoystick=new e.VirtualJoystick(!0),this._leftjoystick.setAxisForUpDown(2),this._leftjoystick.setAxisForLeftRight(0),this._leftjoystick.setJoystickSensibility(.15),this._rightjoystick=new e.VirtualJoystick(!1),this._rightjoystick.setAxisForUpDown(0),this._rightjoystick.setAxisForLeftRight(1),this._rightjoystick.reverseUpDown=!0,this._rightjoystick.setJoystickSensibility(.05),this._rightjoystick.setJoystickColor("yellow")}return __extends(i,t),i.prototype._checkInputs=function(){var t=e.Matrix.RotationYawPitchRoll(this.rotation.y,this.rotation.x,0),i=e.Vector3.TransformCoordinates(this._leftjoystick.deltaPosition,t);this.cameraDirection=this.cameraDirection.add(i),this.cameraRotation=this.cameraRotation.add(this._rightjoystick.deltaPosition),this._leftjoystick.pressed||(this._leftjoystick.deltaPosition=this._leftjoystick.deltaPosition.scale(.9)),this._rightjoystick.pressed||(this._rightjoystick.deltaPosition=this._rightjoystick.deltaPosition.scale(.9))},i.prototype.dispose=function(){this._leftjoystick.releaseCanvas()},i}(e.FreeCamera);e.VirtualJoysticksCamera=t}(BABYLON||(BABYLON={}));var BABYLON=BABYLON||{};!function(){BABYLON.KeyboardMoveController=function(e,t){BABYLON.InputController.call(this,e,t),this._keys=[],this.keysUp=[38],this.keysDown=[40],this.keysLeft=[37],this.keysRight=[39],this._currentSpeed=new BABYLON.Vector3(0,0,0),this._lastFrameSpeed=new BABYLON.Vector3(0,0,0),this._currentAcceleration=new BABYLON.Vector3(0,0,0),this._tempSpeed=new BABYLON.Vector3(0,0,0),this._tempSpeed2=new BABYLON.Vector3(0,0,0),this.maxAbsoluteSpeed=2,this.maxAbsoluteAcceleration=5,this._targetSpeed=new BABYLON.Vector3(0,0,0)},BABYLON.KeyboardMoveController.prototype=Object.create(BABYLON.InputController.prototype),BABYLON.KeyboardMoveController.prototype.attachToCanvas=function(e){var t=this;this._canvas=e,this._onKeyDown=function(e){if(-1!==t.keysUp.indexOf(e.keyCode)||-1!==t.keysDown.indexOf(e.keyCode)||-1!==t.keysLeft.indexOf(e.keyCode)||-1!==t.keysRight.indexOf(e.keyCode)){var i=t._keys.indexOf(e.keyCode);-1===i&&t._keys.push(e.keyCode)}},this._onKeyUp=function(e){if(-1!==t.keysUp.indexOf(e.keyCode)||-1!==t.keysDown.indexOf(e.keyCode)||-1!==t.keysLeft.indexOf(e.keyCode)||-1!==t.keysRight.indexOf(e.keyCode)){var i=t._keys.indexOf(e.keyCode);i>=0&&t._keys.splice(i,1)}},this._onLostFocus=function(){t._keys=[]},window.addEventListener("keydown",this._onKeyDown,!1),window.addEventListener("keyup",this._onKeyUp,!1),window.addEventListener("blur",this._onLostFocus,!1)},BABYLON.KeyboardMoveController.prototype.detachFromCanvas=function(){window.removeEventListener("keydown",this._onKeyDown,!1),window.removeEventListener("keyup",this._onKeyUp,!1),window.removeEventListener("blur",this._onLostFocus,!1)},BABYLON.KeyboardMoveController.prototype.updateCurrentSpeed=function(){if(this._lastFrameSpeed.x=this._currentSpeed.x,this._lastFrameSpeed.y=this._currentSpeed.y,this._lastFrameSpeed.z=this._currentSpeed.z,this._currentSpeed.equals(this._targetSpeed))return this._currentAcceleration.x=0,this._currentAcceleration.y=0,void(this._currentAcceleration.z=0);var e=BABYLON.Tools.GetDeltaTime()/1e3,t=this._tempSpeed;this._targetSpeed.subtractToRef(this._lastFrameSpeed,t);var i=t.length()/e;i<this.maxAbsoluteAcceleration?(this._currentSpeed.x=this._targetSpeed.x,this._currentSpeed.y=this._targetSpeed.y,this._currentSpeed.z=this._targetSpeed.z,t.normalize(),t.scaleToRef(i,this._currentAcceleration)):(t.normalize(),t.scaleToRef(this.maxAbsoluteAcceleration,this._currentAcceleration),t.scaleInPlace(this.maxAbsoluteAcceleration*e),this._currentSpeed.addInPlace(t))},BABYLON.KeyboardMoveController.prototype.update=function(){this._targetSpeed.x=0,this._targetSpeed.y=0,this._targetSpeed.z=0;for(var e=0;e<this._keys.length;e++){var t=this._keys[e];-1!==this.keysLeft.indexOf(t)?this._targetSpeed.x-=1:-1!==this.keysUp.indexOf(t)?this._targetSpeed.z+=1:-1!==this.keysRight.indexOf(t)?this._targetSpeed.x+=1:-1!==this.keysDown.indexOf(t)&&(this._targetSpeed.z-=1)}if((0!=this._targetSpeed.x||0!=this._targetSpeed.z)&&(this._targetSpeed.normalize(),this._targetSpeed.scaleInPlace(this.maxAbsoluteSpeed)),this.updateCurrentSpeed(),0!=this._lastFrameSpeed.x||0!=this._lastFrameSpeed.z||0!=this._currentAcceleration.x||0!=this._currentAcceleration.z){var i=BABYLON.Tools.GetDeltaTime()/1e3;this._lastFrameSpeed.scaleToRef(i,this._tempSpeed),this._currentAcceleration.scaleToRef(i*i*.5,this._tempSpeed2),this._tempSpeed.addInPlace(this._tempSpeed2),(0!=this._tempSpeed.x||0!=this._tempSpeed.z)&&this.target.moveRelative(this._tempSpeed)}}}();var BABYLON=BABYLON||{};!function(){BABYLON.InputCollisionFilter=function(e,t,i){BABYLON.inputFilter.call(this,e,t),this._transformedDirection=new BABYLON.Vector3,this._tempNewPosition=new BABYLON.Vector3,this._tempNewPosition2=new BABYLON.Vector3,this._ellipsoid=i||new BABYLON.Vector3(.2,.855,.2),this._collider=new BABYLON.Collider,this._collidedPosition=new BABYLON.Vector3(0,0,0),this._cameraHeight=1.7,this._positionBottom=new BABYLON.Vector3(0,0,0)},BABYLON.InputCollisionFilter.prototype=Object.create(BABYLON.inputFilter.prototype),BABYLON.InputCollisionFilter.prototype.moveRelative=function(e){this.getOrientation();BABYLON.Vector3.TransformNormalToRef(e,this.getOrientationMatrix(),this._transformedDirection),this.getPosition().addToRef(this._transformedDirection,this._tempNewPosition),this._collider.radius=this._ellipsoid;var t=this.getPosition();this._positionBottom.x=t.x,this._positionBottom.y=t.y,this._positionBottom.z=t.z,this._positionBottom.y+=this._ellipsoid.y-this._cameraHeight,this.scene._getNewPosition(this._positionBottom,this._transformedDirection,this._collider,3,this._collidedPosition),this._collidedPosition.subtractToRef(this._positionBottom,this._tempNewPosition2),this._tempNewPosition2.length()>2*BABYLON.Engine.collisionsEpsilon&&(BABYLON.Vector3.TransformNormalToRef(this._tempNewPosition2,this.getInvertOrientationMatrix(),this._tempNewPosition),this.target.moveRelative(this._tempNewPosition))}}();var BABYLON=BABYLON||{};!function(){BABYLON.GravityInputController=function(e,t){BABYLON.InputController.call(this,e,t),this._moveVectorGlobal=new BABYLON.Vector3(0,0,0),this._moveVectorLocal=new BABYLON.Vector3(0,0,0),this._fallSpeed=2},BABYLON.GravityInputController.prototype=Object.create(BABYLON.InputController.prototype),BABYLON.GravityInputController.prototype.update=function(){this._moveVectorGlobal.x=0,this._moveVectorGlobal.y=-this._fallSpeed*BABYLON.Tools.GetDeltaTime()/1e3,this._moveVectorGlobal.z=0,BABYLON.Vector3.TransformNormalToRef(this._moveVectorGlobal,this.target.getInvertOrientationMatrix(),this._moveVectorLocal),this.target.moveRelative(this._moveVectorLocal)}}();var BABYLON=BABYLON||{};!function(){BABYLON.GlobalAxisFactorsFilter=function(e,t,i,r,n){BABYLON.inputFilter.call(this,e,t),this.xFactor=i,this.yFactor=r,this.zFactor=n,this._globalMovement=new BABYLON.Vector3(0,0,0)},BABYLON.GlobalAxisFactorsFilter.prototype=Object.create(BABYLON.inputFilter.prototype),BABYLON.GlobalAxisFactorsFilter.prototype.moveRelative=function(e){this.getOrientation();BABYLON.Vector3.TransformNormalToRef(e,this.getOrientationMatrix(),this._globalMovement),this._globalMovement.x*=this.xFactor,this._globalMovement.y*=this.yFactor,this._globalMovement.z*=this.zFactor,BABYLON.Vector3.TransformNormalToRef(this._globalMovement,this.getInvertOrientationMatrix(),e),this.target.moveRelative(e)}}();var __extends=this.__extends||function(e,t){function i(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);i.prototype=t.prototype,e.prototype=new i},BABYLON;!function(e){var t=function(t){function i(i,r,n,o){t.call(this,i,r),this._textures=new Array,this._floats=new Array,this._floatsArrays={},this._colors3=new Array,this._colors4=new Array,this._vectors2=new Array,this._vectors3=new Array,this._matrices=new Array,this._cachedWorldViewMatrix=new e.Matrix,this._shaderPath=n,o.needAlphaBlending=o.needAlphaBlending||!1,o.needAlphaTesting=o.needAlphaTesting||!1,o.attributes=o.attributes||["position","normal","uv"],o.uniforms=o.uniforms||["worldViewProjection"],o.samplers=o.samplers||[],this._options=o}return __extends(i,t),i.prototype.needAlphaBlending=function(){return this._options.needAlphaBlending},i.prototype.needAlphaTesting=function(){return this._options.needAlphaTesting},i.prototype._checkUniform=function(e){-1===this._options.uniforms.indexOf(e)&&this._options.uniforms.push(e)},i.prototype.setTexture=function(e,t){return-1===this._options.samplers.indexOf(e)&&this._options.samplers.push(e),this._textures[e]=t,this},i.prototype.setFloat=function(e,t){return this._checkUniform(e),this._floats[e]=t,this},i.prototype.setFloats=function(e,t){return this._checkUniform(e),this._floatsArrays[e]=t,this},i.prototype.setColor3=function(e,t){return this._checkUniform(e),this._colors3[e]=t,this},i.prototype.setColor4=function(e,t){return this._checkUniform(e),this._colors4[e]=t,this},i.prototype.setVector2=function(e,t){return this._checkUniform(e),this._vectors2[e]=t,this},i.prototype.setVector3=function(e,t){return this._checkUniform(e),this._vectors3[e]=t,this},i.prototype.setMatrix=function(e,t){return this._checkUniform(e),this._matrices[e]=t,this},i.prototype.isReady=function(){var e=this.getScene().getEngine();return this._effect=e.createEffect(this._shaderPath,this._options.attributes,this._options.uniforms,this._options.samplers,"",null,this.onCompiled,this.onError),this._effect.isReady()?!0:!1},i.prototype.bind=function(e){-1!==this._options.uniforms.indexOf("world")&&this._effect.setMatrix("world",e),-1!==this._options.uniforms.indexOf("view")&&this._effect.setMatrix("view",this.getScene().getViewMatrix()),-1!==this._options.uniforms.indexOf("worldView")&&(e.multiplyToRef(this.getScene().getViewMatrix(),this._cachedWorldViewMatrix),this._effect.setMatrix("worldView",this._cachedWorldViewMatrix)),-1!==this._options.uniforms.indexOf("projection")&&this._effect.setMatrix("projection",this.getScene().getProjectionMatrix()),-1!==this._options.uniforms.indexOf("worldViewProjection")&&this._effect.setMatrix("worldViewProjection",e.multiply(this.getScene().getTransformMatrix()));for(var t in this._textures)this._effect.setTexture(t,this._textures[t]);for(t in this._floats)this._effect.setFloat(t,this._floats[t]);for(t in this._floatsArrays)this._effect.setArray(t,this._floatsArrays[t]);for(t in this._colors3)this._effect.setColor3(t,this._colors3[t]);for(t in this._colors4){var i=this._colors4[t];this._effect.setFloat4(t,i.r,i.g,i.b,i.a)}for(t in this._vectors2)this._effect.setVector2(t,this._vectors2[t]);for(t in this._vectors3)this._effect.setVector3(t,this._vectors3[t]);for(t in this._matrices)this._effect.setMatrix(t,this._matrices[t])},i.prototype.dispose=function(e){for(var i in this._textures)this._textures[i].dispose();this._textures=[],t.prototype.dispose.call(this,e)},i}(e.Material);e.ShaderMaterial=t}(BABYLON||(BABYLON={}));var BABYLON;!function(e){var t=function(){function t(){}return t.prototype.set=function(t,i){switch(i){case e.VertexBuffer.PositionKind:this.positions=t;break;case e.VertexBuffer.NormalKind:this.normals=t;break;case e.VertexBuffer.UVKind:this.uvs=t;break;case e.VertexBuffer.UV2Kind:this.uv2s=t;break;case e.VertexBuffer.ColorKind:this.colors=t;break;case e.VertexBuffer.MatricesIndicesKind:this.matricesIndices=t;break;case e.VertexBuffer.MatricesWeightsKind:this.matricesWeights=t}},t.prototype.applyToMesh=function(e,t){this._applyTo(e,t)},t.prototype.applyToGeometry=function(e,t){this._applyTo(e,t)},t.prototype.updateMesh=function(e){this._update(e)},t.prototype.updateGeometry=function(e){this._update(e)},t.prototype._applyTo=function(t,i){this.positions&&t.setVerticesData(e.VertexBuffer.PositionKind,this.positions,i),this.normals&&t.setVerticesData(e.VertexBuffer.NormalKind,this.normals,i),this.uvs&&t.setVerticesData(e.VertexBuffer.UVKind,this.uvs,i),this.uv2s&&t.setVerticesData(e.VertexBuffer.UV2Kind,this.uv2s,i),this.colors&&t.setVerticesData(e.VertexBuffer.ColorKind,this.colors,i),this.matricesIndices&&t.setVerticesData(e.VertexBuffer.MatricesIndicesKind,this.matricesIndices,i),this.matricesWeights&&t.setVerticesData(e.VertexBuffer.MatricesWeightsKind,this.matricesWeights,i),this.indices&&t.setIndices(this.indices)},t.prototype._update=function(t,i,r){this.positions&&t.updateVerticesData(e.VertexBuffer.PositionKind,this.positions,i,r),this.normals&&t.updateVerticesData(e.VertexBuffer.NormalKind,this.normals,i,r),this.uvs&&t.updateVerticesData(e.VertexBuffer.UVKind,this.uvs,i,r),this.uv2s&&t.updateVerticesData(e.VertexBuffer.UV2Kind,this.uv2s,i,r),this.colors&&t.updateVerticesData(e.VertexBuffer.ColorKind,this.colors,i,r),this.matricesIndices&&t.updateVerticesData(e.VertexBuffer.MatricesIndicesKind,this.matricesIndices,i,r),this.matricesWeights&&t.updateVerticesData(e.VertexBuffer.MatricesWeightsKind,this.matricesWeights,i,r),this.indices&&t.setIndices(this.indices)
},t.prototype.transform=function(t){var i=e.Vector3.Zero();if(this.positions)for(var r=e.Vector3.Zero(),n=0;n<this.positions.length;n+=3)e.Vector3.FromArrayToRef(this.positions,n,r),e.Vector3.TransformCoordinatesToRef(r,t,i),this.positions[n]=i.x,this.positions[n+1]=i.y,this.positions[n+2]=i.z;if(this.normals){var o=e.Vector3.Zero();for(n=0;n<this.normals.length;n+=3)e.Vector3.FromArrayToRef(this.normals,n,o),e.Vector3.TransformNormalToRef(o,t,i),this.normals[n]=i.x,this.normals[n+1]=i.y,this.normals[n+2]=i.z}},t.prototype.merge=function(e){if(e.indices){this.indices||(this.indices=[]);for(var t=this.positions?this.positions.length/3:0,i=0;i<e.indices.length;i++)this.indices.push(e.indices[i]+t)}if(e.positions)for(this.positions||(this.positions=[]),i=0;i<e.positions.length;i++)this.positions.push(e.positions[i]);if(e.normals)for(this.normals||(this.normals=[]),i=0;i<e.normals.length;i++)this.normals.push(e.normals[i]);if(e.uvs)for(this.uvs||(this.uvs=[]),i=0;i<e.uvs.length;i++)this.uvs.push(e.uvs[i]);if(e.uv2s)for(this.uv2s||(this.uv2s=[]),i=0;i<e.uv2s.length;i++)this.uv2s.push(e.uv2s[i]);if(e.matricesIndices)for(this.matricesIndices||(this.matricesIndices=[]),i=0;i<e.matricesIndices.length;i++)this.matricesIndices.push(e.matricesIndices[i]);if(e.matricesWeights)for(this.matricesWeights||(this.matricesWeights=[]),i=0;i<e.matricesWeights.length;i++)this.matricesWeights.push(e.matricesWeights[i]);if(e.colors)for(this.colors||(this.colors=[]),i=0;i<e.colors.length;i++)this.colors.push(e.colors[i])},t.ExtractFromMesh=function(e){return t._ExtractFrom(e)},t.ExtractFromGeometry=function(e){return t._ExtractFrom(e)},t._ExtractFrom=function(t){var i=new e.VertexData;return t.isVerticesDataPresent(e.VertexBuffer.PositionKind)&&(i.positions=t.getVerticesData(e.VertexBuffer.PositionKind)),t.isVerticesDataPresent(e.VertexBuffer.NormalKind)&&(i.normals=t.getVerticesData(e.VertexBuffer.NormalKind)),t.isVerticesDataPresent(e.VertexBuffer.UVKind)&&(i.uvs=t.getVerticesData(e.VertexBuffer.UVKind)),t.isVerticesDataPresent(e.VertexBuffer.UV2Kind)&&(i.uv2s=t.getVerticesData(e.VertexBuffer.UV2Kind)),t.isVerticesDataPresent(e.VertexBuffer.ColorKind)&&(i.colors=t.getVerticesData(e.VertexBuffer.ColorKind)),t.isVerticesDataPresent(e.VertexBuffer.MatricesIndicesKind)&&(i.matricesIndices=t.getVerticesData(e.VertexBuffer.MatricesIndicesKind)),t.isVerticesDataPresent(e.VertexBuffer.MatricesWeightsKind)&&(i.matricesWeights=t.getVerticesData(e.VertexBuffer.MatricesWeightsKind)),i.indices=t.getIndices(),i},t.CreateBox=function(t){var i=[new e.Vector3(0,0,1),new e.Vector3(0,0,-1),new e.Vector3(1,0,0),new e.Vector3(-1,0,0),new e.Vector3(0,1,0),new e.Vector3(0,-1,0)],r=[],n=[],o=[],s=[];t=t||1;for(var a=0;a<i.length;a++){var h=i[a],c=new e.Vector3(h.y,h.z,h.x),u=e.Vector3.Cross(h,c),l=n.length/3;r.push(l),r.push(l+1),r.push(l+2),r.push(l),r.push(l+2),r.push(l+3);var f=h.subtract(c).subtract(u).scale(t/2);n.push(f.x,f.y,f.z),o.push(h.x,h.y,h.z),s.push(1,1),f=h.subtract(c).add(u).scale(t/2),n.push(f.x,f.y,f.z),o.push(h.x,h.y,h.z),s.push(0,1),f=h.add(c).add(u).scale(t/2),n.push(f.x,f.y,f.z),o.push(h.x,h.y,h.z),s.push(0,0),f=h.add(c).subtract(u).scale(t/2),n.push(f.x,f.y,f.z),o.push(h.x,h.y,h.z),s.push(1,0)}var d=new e.VertexData;return d.indices=r,d.positions=n,d.normals=o,d.uvs=s,d},t.CreateSphere=function(t,i){t=t||32,i=i||1;for(var r=i/2,n=2+t,o=2*n,s=[],a=[],h=[],c=[],u=0;n>=u;u++){for(var l=u/n,f=l*Math.PI,d=0;o>=d;d++){var p=d/o,m=p*Math.PI*2,_=e.Matrix.RotationZ(-f),g=e.Matrix.RotationY(m),v=e.Vector3.TransformCoordinates(e.Vector3.Up(),_),y=e.Vector3.TransformCoordinates(v,g),x=y.scale(r),A=e.Vector3.Normalize(x);a.push(x.x,x.y,x.z),h.push(A.x,A.y,A.z),c.push(l,p)}if(u>0)for(var B=a.length/3,T=B-2*(o+1);B>T+o+2;T++)s.push(T),s.push(T+1),s.push(T+o+1),s.push(T+o+1),s.push(T+1),s.push(T+o+2)}var b=new e.VertexData;return b.indices=s,b.positions=a,b.normals=h,b.uvs=c,b},t.CreateCylinder=function(t,i,r,n){var o=i/2,s=r/2,a=[],h=[],c=[],u=[];t=t||1,i=i||.5,r=r||1,n=n||16;var l=function(t){var i=2*t*Math.PI/n,r=Math.sin(i),o=Math.cos(i);return new e.Vector3(r,0,o)},f=function(i){var r=i?o:s;if(0!=r){for(var f=0;n-2>f;f++){var d=(f+1)%n,p=(f+2)%n;if(!i){var m=d;d=p,p=m}var _=h.length/3;a.push(_),a.push(_+d),a.push(_+p)}var g=new e.Vector3(0,-1,0),v=new e.Vector2(-.5,-.5);for(i||(g=g.scale(-1),v.x=-v.x),f=0;n>f;f++){var y=l(f),x=y.scale(r).add(g.scale(t)),A=new e.Vector2(y.x*v.x+.5,y.z*v.y+.5);h.push(x.x,x.y,x.z),c.push(g.x,g.y,g.z),u.push(A.x,A.y)}}};t/=2;for(var d=new e.Vector3(0,1,0).scale(t),p=n+1,m=0;n>=m;m++){var _=l(m),g=_.scale(s),v=_.scale(o),y=new e.Vector2(m/n,0),x=g.add(d);h.push(x.x,x.y,x.z),c.push(_.x,_.y,_.z),u.push(y.x,y.y),x=v.subtract(d),y.y+=1,h.push(x.x,x.y,x.z),c.push(_.x,_.y,_.z),u.push(y.x,y.y),a.push(2*m),a.push((2*m+2)%(2*p)),a.push(2*m+1),a.push(2*m+1),a.push((2*m+2)%(2*p)),a.push((2*m+3)%(2*p))}f(!0),f(!1);var A=new e.VertexData;return A.indices=a,A.positions=h,A.normals=c,A.uvs=u,A},t.CreateTorus=function(t,i,r){var n=[],o=[],s=[],a=[];t=t||1,i=i||.5,r=r||16;for(var h=r+1,c=0;r>=c;c++)for(var u=c/r,l=c*Math.PI*2/r-Math.PI/2,f=e.Matrix.Translation(t/2,0,0).multiply(e.Matrix.RotationY(l)),d=0;r>=d;d++){var p=1-d/r,m=d*Math.PI*2/r+Math.PI,_=Math.cos(m),g=Math.sin(m),v=new e.Vector3(_,g,0),y=v.scale(i/2),x=new e.Vector2(u,p);y=e.Vector3.TransformCoordinates(y,f),v=e.Vector3.TransformNormal(v,f),o.push(y.x,y.y,y.z),s.push(v.x,v.y,v.z),a.push(x.x,x.y);var A=(c+1)%h,B=(d+1)%h;n.push(c*h+d),n.push(c*h+B),n.push(A*h+d),n.push(c*h+B),n.push(A*h+B),n.push(A*h+d)}var T=new e.VertexData;return T.indices=n,T.positions=o,T.normals=s,T.uvs=a,T},t.CreateGround=function(t,i,r){var n,o,s=[],a=[],h=[],c=[];for(t=t||1,i=i||1,r=r||1,n=0;r>=n;n++)for(o=0;r>=o;o++){var u=new e.Vector3(o*t/r-t/2,0,(r-n)*i/r-i/2),l=new e.Vector3(0,1,0);a.push(u.x,u.y,u.z),h.push(l.x,l.y,l.z),c.push(o/r,1-n/r)}for(n=0;r>n;n++)for(o=0;r>o;o++)s.push(o+1+(n+1)*(r+1)),s.push(o+1+n*(r+1)),s.push(o+n*(r+1)),s.push(o+(n+1)*(r+1)),s.push(o+1+(n+1)*(r+1)),s.push(o+n*(r+1));var f=new e.VertexData;return f.indices=s,f.positions=a,f.normals=h,f.uvs=c,f},t.CreateGroundFromHeightMap=function(t,i,r,n,o,s,a,h){var c,u,l=[],f=[],d=[],p=[];for(c=0;r>=c;c++)for(u=0;r>=u;u++){var m=new e.Vector3(u*t/r-t/2,0,(r-c)*i/r-i/2),_=(m.x+t/2)/t*(a-1)|0,g=(1-(m.z+i/2)/i)*(h-1)|0,v=4*(_+g*a),y=s[v]/255,x=s[v+1]/255,A=s[v+2]/255,B=.3*y+.59*x+.11*A;m.y=n+(o-n)*B,f.push(m.x,m.y,m.z),d.push(0,0,0),p.push(u/r,1-c/r)}for(c=0;r>c;c++)for(u=0;r>u;u++)l.push(u+1+(c+1)*(r+1)),l.push(u+1+c*(r+1)),l.push(u+c*(r+1)),l.push(u+(c+1)*(r+1)),l.push(u+1+(c+1)*(r+1)),l.push(u+c*(r+1));e.VertexData.ComputeNormals(f,l,d);var T=new e.VertexData;return T.indices=l,T.positions=f,T.normals=d,T.uvs=p,T},t.CreatePlane=function(t){var i=[],r=[],n=[],o=[];t=t||1;var s=t/2;r.push(-s,-s,0),n.push(0,0,-1),o.push(0,0),r.push(s,-s,0),n.push(0,0,-1),o.push(1,0),r.push(s,s,0),n.push(0,0,-1),o.push(1,1),r.push(-s,s,0),n.push(0,0,-1),o.push(0,1),i.push(0),i.push(1),i.push(2),i.push(0),i.push(2),i.push(3);var a=new e.VertexData;return a.indices=i,a.positions=r,a.normals=n,a.uvs=o,a},t.CreateTorusKnot=function(t,i,r,n,o,s){var a=[],h=[],c=[],u=[];t=t||2,i=i||.5,r=r||32,n=n||32,o=o||2,s=s||3;for(var l=function(i){var r=Math.cos(i),n=Math.sin(i),a=s/o*i,h=Math.cos(a),c=t*(2+h)*.5*r,u=t*(2+h)*n*.5,l=t*Math.sin(a)*.5;return new e.Vector3(c,u,l)},f=0;r>=f;f++){var d=f%r,p=d/r*2*o*Math.PI,m=l(p),_=l(p+.01),g=_.subtract(m),v=_.add(m),y=e.Vector3.Cross(g,v);v=e.Vector3.Cross(y,g),y.normalize(),v.normalize();for(var x=0;n>x;x++){var A=x%n,B=A/n*2*Math.PI,T=-i*Math.cos(B),b=i*Math.sin(B);h.push(m.x+T*v.x+b*y.x),h.push(m.y+T*v.y+b*y.y),h.push(m.z+T*v.z+b*y.z),u.push(f/r),u.push(x/n)}}for(f=0;r>f;f++)for(x=0;n>x;x++){var M=(x+1)%n,L=f*n+x,E=(f+1)*n+x,O=(f+1)*n+M,P=f*n+M;a.push(P),a.push(E),a.push(L),a.push(P),a.push(O),a.push(E)}e.VertexData.ComputeNormals(h,a,c);var S=new e.VertexData;return S.indices=a,S.positions=h,S.normals=c,S.uvs=u,S},t.ComputeNormals=function(t,i,r){var n,o=[],s=[];for(n=0;n<t.length;n+=3){var a=new e.Vector3(t[n],t[n+1],t[n+2]);o.push(a),s.push([])}var h=[];for(n=0;n<i.length/3;n++){var c=i[3*n],u=i[3*n+1],l=i[3*n+2],f=o[c],d=o[u],p=o[l],m=f.subtract(d),_=p.subtract(d);h[n]=e.Vector3.Normalize(e.Vector3.Cross(m,_)),s[c].push(n),s[u].push(n),s[l].push(n)}for(n=0;n<o.length;n++){for(var g=s[n],v=e.Vector3.Zero(),y=0;y<g.length;y++)v.addInPlace(h[g[y]]);v=e.Vector3.Normalize(v.scale(1/g.length)),r[3*n]=v.x,r[3*n+1]=v.y,r[3*n+2]=v.z}},t}();e.VertexData=t}(BABYLON||(BABYLON={}));var __extends=this.__extends||function(e,t){function i(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);i.prototype=t.prototype,e.prototype=new i},BABYLON;!function(e){var t=function(t,i){t._leftCamera.isIntermediate=!0,t.subCameras.push(t._leftCamera),t.subCameras.push(t._rightCamera),t._leftTexture=new e.PassPostProcess(i+"_leftTexture",1,t._leftCamera),t._anaglyphPostProcess=new e.AnaglyphPostProcess(i+"_anaglyph",1,t._rightCamera),t._anaglyphPostProcess.onApply=function(e){e.setTextureFromPostProcess("leftSampler",t._leftTexture)},t._update()},i=function(i){function r(r,n,o,s,a,h,c){i.call(this,r,n,o,s,a,c),this._eyeSpace=e.Tools.ToRadians(h),this._leftCamera=new e.ArcRotateCamera(r+"_left",n-this._eyeSpace,o,s,a,c),this._rightCamera=new e.ArcRotateCamera(r+"_right",n+this._eyeSpace,o,s,a,c),t(this,r)}return __extends(r,i),r.prototype._update=function(){this._updateCamera(this._leftCamera),this._updateCamera(this._rightCamera),this._leftCamera.alpha=this.alpha-this._eyeSpace,this._rightCamera.alpha=this.alpha+this._eyeSpace,i.prototype._update.call(this)},r.prototype._updateCamera=function(e){e.beta=this.beta,e.radius=this.radius,e.minZ=this.minZ,e.maxZ=this.maxZ,e.fov=this.fov,e.target=this.target},r}(e.ArcRotateCamera);e.AnaglyphArcRotateCamera=i;var r=function(i){function r(r,n,o,s){i.call(this,r,n,s),this._eyeSpace=e.Tools.ToRadians(o),this._transformMatrix=new e.Matrix,this._leftCamera=new e.FreeCamera(r+"_left",n.clone(),s),this._rightCamera=new e.FreeCamera(r+"_right",n.clone(),s),t(this,r)}return __extends(r,i),r.prototype._getSubCameraPosition=function(t,i){var r=this.getTarget();e.Matrix.Translation(-r.x,-r.y,-r.z).multiplyToRef(e.Matrix.RotationY(t),this._transformMatrix),this._transformMatrix=this._transformMatrix.multiply(e.Matrix.Translation(r.x,r.y,r.z)),e.Vector3.TransformCoordinatesToRef(this.position,this._transformMatrix,i)},r.prototype._update=function(){this._getSubCameraPosition(-this._eyeSpace,this._leftCamera.position),this._getSubCameraPosition(this._eyeSpace,this._rightCamera.position),this._updateCamera(this._leftCamera),this._updateCamera(this._rightCamera),i.prototype._update.call(this)},r.prototype._updateCamera=function(e){e.minZ=this.minZ,e.maxZ=this.maxZ,e.fov=this.fov,e.viewport=this.viewport,e.setTarget(this.getTarget())},r}(e.FreeCamera);e.AnaglyphFreeCamera=r}(BABYLON||(BABYLON={}));var __extends=this.__extends||function(e,t){function i(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);i.prototype=t.prototype,e.prototype=new i},BABYLON;!function(e){var t=function(e){function t(t,i,r,n,o,s){e.call(this,t,"anaglyph",null,["leftSampler"],i,r,n,o,s)}return __extends(t,e),t}(e.PostProcess);e.AnaglyphPostProcess=t}(BABYLON||(BABYLON={}));var BABYLON;!function(e){var t=function(){function t(){}return t.EnableFor=function(e){e._tags=e._tags||{},e.hasTags=function(){return t.HasTags(e)},e.addTags=function(i){return t.AddTagsTo(e,i)},e.removeTags=function(i){return t.RemoveTagsFrom(e,i)},e.matchesTagsQuery=function(i){return t.MatchesQuery(e,i)}},t.DisableFor=function(e){delete e._tags,delete e.hasTags,delete e.addTags,delete e.removeTags,delete e.matchesTagsQuery},t.HasTags=function(t){return t._tags?!e.Tools.IsEmpty(t._tags):!1},t.GetTags=function(e){return e._tags?e._tags:null},t.AddTagsTo=function(e,i){if(i){var r=i.split(" ");for(var n in r)t._AddTagTo(e,r[n])}},t._AddTagTo=function(e,i){i=i.trim(),""!==i&&"true"!==i&&"false"!==i&&(i.match(/[\s]/)||i.match(/^([!]|([|]|[&]){2})/)||(t.EnableFor(e),e._tags[i]=!0))},t.RemoveTagsFrom=function(e,i){if(t.HasTags(e)){var r=i.split(" ");for(var n in r)t._RemoveTagFrom(e,r[n])}},t._RemoveTagFrom=function(e,t){delete e._tags[t]},t.MatchesQuery=function(i,r){return void 0===r?!0:""===r?t.HasTags(i):e.Internals.AndOrNotEvaluator.Eval(r,function(e){return t.HasTags(i)&&i._tags[e]})},t}();e.Tags=t}(BABYLON||(BABYLON={}));var BABYLON;!function(e){!function(e){var t=function(){function e(){}return e.Eval=function(t,i){return t=t.match(/\([^\(\)]*\)/g)?t.replace(/\([^\(\)]*\)/g,function(t){return t=t.slice(1,t.length-1),e._HandleParenthesisContent(t,i)}):e._HandleParenthesisContent(t,i),"true"===t?!0:"false"===t?!1:e.Eval(t,i)},e._HandleParenthesisContent=function(t,i){i=i||function(e){return"true"===e?!0:!1};var r,n=t.split("||");for(var o in n){var s=e._SimplifyNegation(n[o].trim()),a=s.split("&&");if(a.length>1)for(var h=0;h<a.length;++h){var c=e._SimplifyNegation(a[h].trim());if(r="true"!==c&&"false"!==c?"!"===c[0]?!i(c.substring(1)):i(c):"true"===c?!0:!1,!r){s="false";break}}if(r||"true"===s){r=!0;break}r="true"!==s&&"false"!==s?"!"===s[0]?!i(s.substring(1)):i(s):"true"===s?!0:!1}return r?"true":"false"},e._SimplifyNegation=function(e){return e=e.replace(/^[\s!]+/,function(e){return e=e.replace(/[\s]/g,function(){return""}),e.length%2?"!":""}),e=e.trim(),"!true"===e?e="false":"!false"===e&&(e="true"),e},e}();e.AndOrNotEvaluator=t}(e.Internals||(e.Internals={}));e.Internals}(BABYLON||(BABYLON={}));var BABYLON;!function(e){var t=function(){function t(t,i,r,n,o,s){this._enabled=!0,this._refCount=0,this._name=i,this._renderTexture=new e.RenderTargetTexture(i,r,t),this.setRenderList(n),this._renderTexture.onBeforeRender=o,this._renderTexture.onAfterRender=s,this._scene=t}return t.prototype._incRefCount=function(){return 0===this._refCount&&this._scene.customRenderTargets.push(this._renderTexture),++this._refCount},t.prototype._decRefCount=function(){return this._refCount--,this._refCount<=0&&this._scene.customRenderTargets.splice(this._scene.customRenderTargets.indexOf(this._renderTexture),1),this._refCount},t.prototype._update=function(){this.setRenderList(this._renderList)},t.prototype.setRenderList=function(e){this._renderTexture.renderList=e},t.prototype.getRenderTexture=function(){return this._renderTexture},t}();e.PostProcessRenderPass=t}(BABYLON||(BABYLON={}));var BABYLON;!function(e){var t=function(){function t(e,t,i,r,n,o){this._engine=e,this._name=t,this._postProcessType=i,this._ratio=r||1,this._samplingMode=n||null,this._singleInstance=o||!0,this._cameras=[],this._postProcesses=[],this._indicesForCamera=[],this._renderPasses=[],this._renderEffectAsPasses=[],this.parameters=function(){}}return t._GetInstance=function(e,i,r,n){for(var o,s,a=[],h=t._GetParametersNames(i),c=0;c<h.length;c++)switch(h[c]){case"name":a[c]=i.toString();break;case"ratio":a[c]=r;break;case"camera":a[c]=null;break;case"samplingMode":a[c]=n;break;case"engine":a[c]=e;break;case"reusable":a[c]=!0;break;default:a[c]=null}return o=function(){},o.prototype=i.prototype,s=new o,i.apply(s,a),s},t._GetParametersNames=function(e){var t=/((\/\/.*$)|(\/\*[\s\S]*?\*\/))/gm,i=e.toString().replace(t,""),r=i.slice(i.indexOf("(")+1,i.indexOf(")")).match(/([^\s,]+)/g);return null===r&&(r=[]),r},t.prototype._update=function(){for(var e in this._renderPasses)this._renderPasses[e]._update()},t.prototype.addPass=function(e){this._renderPasses[e._name]=e,this._linkParameters()},t.prototype.removePass=function(e){delete this._renderPasses[e._name],this._linkParameters()},t.prototype.addRenderEffectAsPass=function(e){this._renderEffectAsPasses[e._name]=e,this._linkParameters()},t.prototype.getPass=function(e){for(var t in this._renderPasses)if(t===e)return this._renderPasses[e]},t.prototype.emptyPasses=function(){this._renderPasses.length=0,this._linkParameters()},t.prototype._attachCameras=function(i){for(var r,n=e.Tools.MakeArray(i||this._cameras),o=0;o<n.length;o++){var s=n[o],a=s.name;r=this._singleInstance?0:a,this._postProcesses[r]=this._postProcesses[r]||t._GetInstance(this._engine,this._postProcessType,this._ratio,this._samplingMode);var h=s.attachPostProcess(this._postProcesses[r]);null===this._indicesForCamera[a]&&(this._indicesForCamera[a]=[]),this._indicesForCamera[a].push(h),-1===this._cameras.indexOf(s)&&(this._cameras[a]=s);for(var c in this._renderPasses)this._renderPasses[c]._incRefCount()}this._linkParameters()},t.prototype._detachCameras=function(t){for(var i=e.Tools.MakeArray(t||this._cameras),r=0;r<i.length;r++){var n=i[r],o=n.name;n.detachPostProcess(this._postProcesses[this._singleInstance?0:o],this._indicesForCamera[o]);var s=this._cameras.indexOf(o);this._indicesForCamera.splice(s,1),this._cameras.splice(s,1);for(var a in this._renderPasses)this._renderPasses[a]._decRefCount()}},t.prototype._enable=function(t){for(var i=e.Tools.MakeArray(t||this._cameras),r=0;r<i.length;r++){for(var n=i[r],o=n.name,s=0;s<this._indicesForCamera[o].length;s++)void 0===n._postProcesses[this._indicesForCamera[o][s]]&&t[r].attachPostProcess(this._postProcesses[this._singleInstance?0:o],this._indicesForCamera[o][s]);for(var a in this._renderPasses)this._renderPasses[a]._incRefCount()}},t.prototype._disable=function(t){for(var i=e.Tools.MakeArray(t||this._cameras),r=0;r<i.length;r++){var n=i[r],o=n.Name;n.detachPostProcess(this._postProcesses[this._singleInstance?0:o],this._indicesForCamera[o]);for(var s in this._renderPasses)this._renderPasses[s]._decRefCount()}},t.prototype.getPostProcess=function(e){return this._singleInstance?this._postProcesses[0]:this._postProcesses[e.name]},t.prototype._linkParameters=function(){var e=this;for(var t in this._postProcesses)this._postProcesses[t].onApply=function(t){e.parameters(t),e._linkTextures(t)}},t.prototype._linkTextures=function(e){for(var t in this._renderPasses)e.setTexture(t,this._renderPasses[t].getRenderTexture());for(var i in this._renderEffectAsPasses)e.setTextureFromPostProcess(i+"Sampler",this._renderEffectAsPasses[i].getPostProcess())},t}();e.PostProcessRenderEffect=t}(BABYLON||(BABYLON={}));var BABYLON;!function(e){var t=function(){function t(e,t){this._engine=e,this._name=t,this._renderEffects=[],this._renderEffectsForIsolatedPass=[],this._cameras=[]}return t.prototype.addEffect=function(e){this._renderEffects[e._name]=e},t.prototype._enableEffect=function(t,i){var r=this._renderEffects[t];r&&r.enable(e.Tools.MakeArray(i||this._cameras))},t.prototype._disableEffect=function(t,i){var r=this._renderEffects[t];r&&r.disable(e.Tools.MakeArray(i||this._cameras))},t.prototype._attachCameras=function(t,i){for(var r=e.Tools.MakeArray(t||this._cameras),n=[],o=0;o<r.length;o++){var s=r[o],a=s.name;-1===this._cameras.indexOf(s)?this._cameras[a]=s:i&&n.push(o)}for(var o=0;o<n.length;o++)t.splice(n[o],1);for(var h in this._renderEffects)this._renderEffects[h]._attachCameras(r)},t.prototype._detachCameras=function(t){var i=e.Tools.MakeArray(t||this._cameras);for(var r in this._renderEffects)this._renderEffects[r]._detachCameras(i);for(var n=0;n<i.length;n++)this._cameras.splice(this._cameras.indexOf(i[n]),1)},t.prototype._enableDisplayOnlyPass=function(i,r){var n=e.Tools.MakeArray(r||this._cameras),o=null;for(var s in this._renderEffects)if(o=this._renderEffects[s].getPass(i),null!=o)break;if(null!==o){for(var s in this._renderEffects)this._renderEffects[s]._disable(n);o._name=t.PASS_SAMPLER_NAME;for(var a=0;a<n.length;a++){var h=n[a],c=h.name;this._renderEffectsForIsolatedPass[c]=this._renderEffectsForIsolatedPass[c]||new e.PostProcessRenderEffect(this._engine,t.PASS_EFFECT_NAME,"BABYLON.DisplayPassPostProcess",1,null,null),this._renderEffectsForIsolatedPass[c].emptyPasses(),this._renderEffectsForIsolatedPass[c].addPass(o),this._renderEffectsForIsolatedPass[c]._attachCameras(h)}}},t.prototype._disableDisplayOnlyPass=function(i){for(var r=e.Tools.MakeArray(i||this._cameras),n=0;n<r.length;n++){var o=r[n],s=o.name;this._renderEffectsForIsolatedPass[s]=this._renderEffectsForIsolatedPass[s]||new e.PostProcessRenderEffect(this._engine,t.PASS_EFFECT_NAME,"BABYLON.DisplayPassPostProcess",1,null,null),this._renderEffectsForIsolatedPass[s]._disable(o)}for(var a in this._renderEffects)this._renderEffects[a]._enable(r)},t.prototype._update=function(){for(var e in this._renderEffects)this._renderEffects[e]._update();for(var t=0;t<this._cameras.length;t++){var i=this._cameras[t].name;this._renderEffectsForIsolatedPass[i]&&this._renderEffectsForIsolatedPass[i]._update()}},t.PASS_EFFECT_NAME="passEffect",t.PASS_SAMPLER_NAME="passSampler",t}();e.PostProcessRenderPipeline=t}(BABYLON||(BABYLON={}));var BABYLON;!function(e){var t=function(){function e(){this._renderPipelines=[]}return e.prototype.addPipeline=function(e){this._renderPipelines[e._name]=e},e.prototype.attachCamerasToRenderPipeline=function(e,t,i){var r=this._renderPipelines[e];r&&r.attachCameras(t,i)},e.prototype.detachCamerasFromRenderPipeline=function(e,t){var i=this._renderPipelines[e];i&&i.detachCameras(t)},e.prototype.enableEffectInPipeline=function(e,t,i){var r=this._renderPipelines[e];r&&r.enableEffect(t,i)},e.prototype.disableEffectInPipeline=function(e,t,i){var r=this._renderPipelines[e];r&&r.disableEffect(t,i)},e.prototype.enableDisplayOnlyPassInPipeline=function(e,t,i){var r=this._renderPipelines[e];r&&r.enableDisplayOnlyPass(t,i)},e.prototype.disableDisplayOnlyPassInPipeline=function(e,t){var i=this._renderPipelines[e];i&&i.disableDisplayOnlyPass(t)},e.prototype.update=function(){for(var e in this._renderPipelines)this._renderPipelines[e]._update()},e}();e.PostProcessRenderPipelineManager=t}(BABYLON||(BABYLON={}));var __extends=this.__extends||function(e,t){function i(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);i.prototype=t.prototype,e.prototype=new i},BABYLON;!function(e){var t=function(e){function t(t,i,r,n,o,s){e.call(this,t,"displayPass",["passSampler"],["passSampler"],i,r,n,o,s)}return __extends(t,e),t}(e.PostProcess);e.DisplayPassPostProcess=t}(BABYLON||(BABYLON={}));var BABYLON;!function(e){var t=function(){function t(t){this.frontColor=new e.Color3(1,1,1),this.backColor=new e.Color3(.1,.1,.1),this.showBackLines=!0,this.renderList=new e.SmartArray(32),this._scene=t,this._colorShader=new e.ShaderMaterial("colorShader",t,"color",{attributes:["position"],uniforms:["worldViewProjection","color"]});var i=this._scene.getEngine(),r=e.VertexData.CreateBox(1);this._vb=new e.VertexBuffer(i,r.positions,e.VertexBuffer.PositionKind,!1),this._ib=i.createIndexBuffer([0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,0,7,1,6,2,5,3,4])}return t.prototype.reset=function(){this.renderList.reset()},t.prototype.render=function(){if(0!=this.renderList.length&&this._colorShader.isReady()){var t=this._scene.getEngine();t.setDepthWrite(!1),this._colorShader._preBind();for(var i=0;i<this.renderList.length;i++){var r=this.renderList.data[i],n=r.minimum,o=r.maximum,s=o.subtract(n),a=n.add(s.scale(.5)),h=e.Matrix.Scaling(s.x,s.y,s.z).multiply(e.Matrix.Translation(a.x,a.y,a.z)).multiply(r.getWorldMatrix());t.bindBuffers(this._vb.getBuffer(),this._ib,[3],12,this._colorShader.getEffect()),this.showBackLines&&(t.setDepthFunctionToGreaterOrEqual(),this._colorShader.setColor3("color",this.backColor),this._colorShader.bind(h),t.draw(!1,0,24)),t.setDepthFunctionToLess(),this._colorShader.setColor3("color",this.frontColor),this._colorShader.bind(h),t.draw(!1,0,24)}this._colorShader.unbind(),t.setDepthFunctionToLessOrEqual(),t.setDepthWrite(!0)}},t.prototype.dispose=function(){this._colorShader.dispose(),this._vb.dispose(),this._scene.getEngine()._releaseBuffer(this._ib)},t}();e.BoundingBoxRenderer=t}(BABYLON||(BABYLON={}));var __extends=this.__extends||function(e,t){function i(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);i.prototype=t.prototype,e.prototype=new i},BABYLON;!function(e){var t=function(){function e(e){this._actionManager=e}return e.prototype.isValid=function(){return!0},e.prototype._getProperty=function(e){return this._actionManager._getProperty(e)},e.prototype._getEffectiveTarget=function(e,t){return this._actionManager._getEffectiveTarget(e,t)},e}();e.Condition=t;var i=function(e){function t(i,r,n,o,s){"undefined"==typeof s&&(s=t.IsEqual),e.call(this,i),this.propertyPath=n,this.value=o,this.operator=s,this._target=this._getEffectiveTarget(r,this.propertyPath),this._property=this._getProperty(this.propertyPath)}return __extends(t,e),Object.defineProperty(t,"IsEqual",{get:function(){return t._IsEqual},enumerable:!0,configurable:!0}),Object.defineProperty(t,"IsDifferent",{get:function(){return t._IsDifferent},enumerable:!0,configurable:!0}),Object.defineProperty(t,"IsGreater",{get:function(){return t._IsGreater},enumerable:!0,configurable:!0}),Object.defineProperty(t,"IsLesser",{get:function(){return t._IsLesser},enumerable:!0,configurable:!0}),t.prototype.isValid=function(){switch(this.operator){case t.IsGreater:return this._target[this._property]>this.value;case t.IsLesser:return this._target[this._property]<this.value;case t.IsEqual:case t.IsDifferent:var e;return e=this.value.equals?this.value.equals(this._target[this._property]):this.value===this._target[this._property],this.operator===t.IsEqual?e:!e}return!1},t._IsEqual=0,t._IsDifferent=1,t._IsGreater=2,t._IsLesser=3,t}(t);e.ValueCondition=i;var r=function(e){function t(t,i){e.call(this,t),this.predicate=i}return __extends(t,e),t.prototype.isValid=function(){return this.predicate()},t}(t);e.PredicateCondition=r;var n=function(e){function t(t,i,r){e.call(this,t),this.value=r,this._target=i}return __extends(t,e),t.prototype.isValid=function(){return this._target.state===this.value},t}(t);e.StateCondition=n}(BABYLON||(BABYLON={}));var BABYLON;!function(e){var t=function(){function e(e,t){this.trigger=e,this._nextActiveAction=this,this._condition=t}return e.prototype._prepare=function(){},e.prototype._executeCurrent=function(e){if(this._condition){var t=this._actionManager.getScene().getRenderId();if(this._condition._evaluationId===t){if(!this._condition._currentResult)return}else{if(this._condition._evaluationId=t,!this._condition.isValid())return void(this._condition._currentResult=!1);this._condition._currentResult=!0}}this._nextActiveAction.execute(e),this._nextActiveAction=this._nextActiveAction._child?this._nextActiveAction._child:this},e.prototype.execute=function(){},e.prototype.then=function(e){return this._child=e,e._actionManager=this._actionManager,e._prepare(),e},e.prototype._getProperty=function(e){return this._actionManager._getProperty(e)},e.prototype._getEffectiveTarget=function(e,t){return this._actionManager._getEffectiveTarget(e,t)},e}();e.Action=t}(BABYLON||(BABYLON={}));var BABYLON;!function(e){var t=function(){function e(e,t,i,r){this.source=e,this.pointerX=t,this.pointerY=i,this.meshUnderPointer=r}return e.CreateNew=function(t){var i=t.getScene();return new e(t,i.pointerX,i.pointerY,i.meshUnderPointer)},e}();e.ActionEvent=t;var i=function(){function t(e){this.actions=new Array,this._scene=e}return Object.defineProperty(t,"NothingTrigger",{get:function(){return t._NothingTrigger},enumerable:!0,configurable:!0}),Object.defineProperty(t,"OnPickTrigger",{get:function(){return t._OnPickTrigger},enumerable:!0,configurable:!0}),Object.defineProperty(t,"OnLeftPickTrigger",{get:function(){return t._OnLeftPickTrigger},enumerable:!0,configurable:!0}),Object.defineProperty(t,"OnRightPickTrigger",{get:function(){return t._OnRightPickTrigger},enumerable:!0,configurable:!0}),Object.defineProperty(t,"OnCenterPickTrigger",{get:function(){return t._OnCenterPickTrigger},enumerable:!0,configurable:!0}),Object.defineProperty(t,"OnPointerOverTrigger",{get:function(){return t._OnPointerOverTrigger},enumerable:!0,configurable:!0}),Object.defineProperty(t,"OnPointerOutTrigger",{get:function(){return t._OnPointerOutTrigger},enumerable:!0,configurable:!0}),Object.defineProperty(t,"OnEveryFrameTrigger",{get:function(){return t._OnEveryFrameTrigger},enumerable:!0,configurable:!0}),t.prototype.getScene=function(){return this._scene},t.prototype.registerAction=function(i){return i.trigger===t.OnEveryFrameTrigger&&this.getScene().actionManager!==this?(e.Tools.Warn("OnEveryFrameTrigger can only be used with scene.actionManager"),null):(this.actions.push(i),i._actionManager=this,i._prepare(),i)},t.prototype.processTrigger=function(e,t){for(var i=0;i<this.actions.length;i++){var r=this.actions[i];r.trigger===e&&r._executeCurrent(t)}},t.prototype._getEffectiveTarget=function(e,t){for(var i=t.split("."),r=0;r<i.length-1;r++)e=e[i[r]];return e},t.prototype._getProperty=function(e){var t=e.split(".");return t[t.length-1]},t._NothingTrigger=0,t._OnPickTrigger=1,t._OnLeftPickTrigger=2,t._OnRightPickTrigger=3,t._OnCenterPickTrigger=4,t._OnPointerOverTrigger=5,t._OnPointerOutTrigger=6,t._OnEveryFrameTrigger=7,t}();e.ActionManager=i}(BABYLON||(BABYLON={}));var __extends=this.__extends||function(e,t){function i(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);i.prototype=t.prototype,e.prototype=new i},BABYLON;!function(e){var t=function(t){function i(e,i,r,n,o,s,a){"undefined"==typeof o&&(o=1e3),t.call(this,e,s),this.propertyPath=r,this.value=n,this.duration=o,this.stopOtherAnimations=a,this._target=i}return __extends(i,t),i.prototype._prepare=function(){this._target=this._getEffectiveTarget(this._target,this.propertyPath),this._property=this._getProperty(this.propertyPath)},i.prototype.execute=function(){var t,i=this._actionManager.getScene(),r=[{frame:0,value:this._target[this._property]},{frame:100,value:this.value}];if("number"==typeof this.value)t=e.Animation.ANIMATIONTYPE_FLOAT;else if(this.value instanceof e.Color3)t=e.Animation.ANIMATIONTYPE_COLOR3;else if(this.value instanceof e.Vector3)t=e.Animation.ANIMATIONTYPE_VECTOR3;else if(this.value instanceof e.Matrix)t=e.Animation.ANIMATIONTYPE_MATRIX;else{if(!(this.value instanceof e.Quaternion))return void e.Tools.Warn("InterpolateValueAction: Unsupported type ("+typeof this.value+")");t=e.Animation.ANIMATIONTYPE_QUATERNION}var n=new e.Animation("InterpolateValueAction",this._property,100*(1e3/this.duration),t,e.Animation.ANIMATIONLOOPMODE_CONSTANT);n.setKeys(r),this.stopOtherAnimations&&i.stopAnimation(this._target),i.beginDirectAnimation(this._target,[n],0,100)},i}(e.Action);e.InterpolateValueAction=t}(BABYLON||(BABYLON={}));var __extends=this.__extends||function(e,t){function i(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);i.prototype=t.prototype,e.prototype=new i},BABYLON;!function(e){var t=function(e){function t(t,i,r,n){e.call(this,t,n),this.propertyPath=r,this._target=i}return __extends(t,e),t.prototype._prepare=function(){this._target=this._getEffectiveTarget(this._target,this.propertyPath),this._property=this._getProperty(this.propertyPath)},t.prototype.execute=function(){this._target[this._property]=!this._target[this._property]},t}(e.Action);e.SwitchBooleanAction=t;var i=function(e){function t(t,i,r,n){e.call(this,t,n),this.value=r,this._target=i}return __extends(t,e),t.prototype.execute=function(){this._target.state=this.value},t}(e.Action);e.SetStateAction=i;var r=function(e){function t(t,i,r,n,o){e.call(this,t,o),this.propertyPath=r,this.value=n,this._target=i}return __extends(t,e),t.prototype._prepare=function(){this._target=this._getEffectiveTarget(this._target,this.propertyPath),this._property=this._getProperty(this.propertyPath)},t.prototype.execute=function(){this._target[this._property]=this.value},t}(e.Action);e.SetValueAction=r;var n=function(t){function i(e,i,r,n,o){t.call(this,e,o),this.propertyPath=r,this.value=n,this._target=i}return __extends(i,t),i.prototype._prepare=function(){this._target=this._getEffectiveTarget(this._target,this.propertyPath),this._property=this._getProperty(this.propertyPath),"number"!=typeof this._target[this._property]&&e.Tools.Warn("Warning: IncrementValueAction can only be used with number values")},i.prototype.execute=function(){this._target[this._property]+=this.value
},i}(e.Action);e.IncrementValueAction=n;var o=function(e){function t(t,i,r,n,o,s){e.call(this,t,s),this.from=r,this.to=n,this.loop=o,this._target=i}return __extends(t,e),t.prototype._prepare=function(){},t.prototype.execute=function(){var e=this._actionManager.getScene();e.beginAnimation(this._target,this.from,this.to,this.loop)},t}(e.Action);e.PlayAnimationAction=o;var s=function(e){function t(t,i,r){e.call(this,t,r),this._target=i}return __extends(t,e),t.prototype._prepare=function(){},t.prototype.execute=function(){var e=this._actionManager.getScene();e.stopAnimation(this._target)},t}(e.Action);e.StopAnimationAction=s;var a=function(t){function i(i,r){"undefined"==typeof i&&(i=e.ActionManager.NothingTrigger),t.call(this,i,r)}return __extends(i,t),i.prototype.execute=function(){},i}(e.Action);e.DoNothingAction=a;var h=function(e){function t(t,i,r){e.call(this,t,r),this.children=i}return __extends(t,e),t.prototype._prepare=function(){for(var e=0;e<this.children.length;e++)this.children[e]._actionManager=this._actionManager,this.children[e]._prepare()},t.prototype.execute=function(e){for(var t=0;t<this.children.length;t++)this.children[t].execute(e)},t}(e.Action);e.CombineAction=h;var c=function(e){function t(t,i,r){e.call(this,t,r),this.func=i}return __extends(t,e),t.prototype.execute=function(e){this.func(e)},t}(e.Action);e.ExecuteCodeAction=c;var u=function(t){function i(e,i,r,n){t.call(this,e,n),this._target=i,this._parent=r}return __extends(i,t),i.prototype._prepare=function(){},i.prototype.execute=function(){if(this._target.parent!==this._parent){var t=this._parent.getWorldMatrix().clone();t.invert(),this._target.position=e.Vector3.TransformCoordinates(this._target.position,t),this._target.parent=this._parent}},i}(e.Action);e.SetParentAction=u}(BABYLON||(BABYLON={}));var __extends=this.__extends||function(e,t){function i(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);i.prototype=t.prototype,e.prototype=new i},BABYLON;!function(e){var t=function(){function t(t,i,r,n,o){this.delayLoadState=e.Engine.DELAYLOADSTATE_NONE,this._totalVertices=0,this._indices=[],this.id=t,this._engine=i.getEngine(),this._meshes=[],this._scene=i,r?this.setAllVerticesData(r,n):(this._totalVertices=0,this._indices=[]),o&&this.applyToMesh(o)}return t.prototype.getScene=function(){return this._scene},t.prototype.getEngine=function(){return this._engine},t.prototype.isReady=function(){return this.delayLoadState===e.Engine.DELAYLOADSTATE_LOADED||this.delayLoadState===e.Engine.DELAYLOADSTATE_NONE},t.prototype.setAllVerticesData=function(e,t){e.applyToGeometry(this,t)},t.prototype.setVerticesData=function(t,i,r){if(this._vertexBuffers=this._vertexBuffers||{},this._vertexBuffers[t]&&this._vertexBuffers[t].dispose(),this._vertexBuffers[t]=new e.VertexBuffer(this._engine,i,t,r,0===this._meshes.length),t===e.VertexBuffer.PositionKind){var n=this._vertexBuffers[t].getStrideSize();this._totalVertices=i.length/n;for(var o=e.Tools.ExtractMinAndMax(i,0,this._totalVertices),s=this._meshes,a=s.length,h=0;a>h;h++){var c=s[h];c._resetPointsArrayCache(),c._boundingInfo=new e.BoundingInfo(o.minimum,o.maximum),c._createGlobalSubMesh(),c.computeWorldMatrix(!0)}}},t.prototype.updateVerticesData=function(t,i,r){var n=this.getVertexBuffer(t);if(n&&(n.update(i),t===e.VertexBuffer.PositionKind)){var o;if(r){var s=n.getStrideSize();this._totalVertices=i.length/s,o=e.Tools.ExtractMinAndMax(i,0,this._totalVertices)}for(var a=this._meshes,h=a.length,c=0;h>c;c++){var u=a[c];u._resetPointsArrayCache(),r&&(u._boundingInfo=new e.BoundingInfo(o.minimum,o.maximum))}}},t.prototype.getTotalVertices=function(){return this.isReady()?this._totalVertices:0},t.prototype.getVerticesData=function(e){var t=this.getVertexBuffer(e);return t?t.getData():null},t.prototype.getVertexBuffer=function(e){return this.isReady()?this._vertexBuffers[e]:null},t.prototype.getVertexBuffers=function(){return this.isReady()?this._vertexBuffers:null},t.prototype.isVerticesDataPresent=function(e){return this._vertexBuffers?void 0!==this._vertexBuffers[e]:this._delayInfo?-1!==this._delayInfo.indexOf(e):!1},t.prototype.getVerticesDataKinds=function(){var e=[];if(!this._vertexBuffers&&this._delayInfo)for(var t in this._delayInfo)e.push(t);else for(t in this._vertexBuffers)e.push(t);return e},t.prototype.setIndices=function(e){this._indexBuffer&&this._engine._releaseBuffer(this._indexBuffer),this._indices=e,0!==this._meshes.length&&this._indices&&(this._indexBuffer=this._engine.createIndexBuffer(this._indices));for(var t=this._meshes,i=t.length,r=0;i>r;r++)t[r]._createGlobalSubMesh()},t.prototype.getTotalIndices=function(){return this.isReady()?this._indices.length:0},t.prototype.getIndices=function(){return this.isReady()?this._indices:null},t.prototype.getIndexBuffer=function(){return this.isReady()?this._indexBuffer:null},t.prototype.releaseForMesh=function(e,t){var i=this._meshes,r=i.indexOf(e);if(-1!==r){for(var n in this._vertexBuffers)this._vertexBuffers[n].dispose();this._indexBuffer&&this._engine._releaseBuffer(this._indexBuffer)&&(this._indexBuffer=null),i.splice(r,1),e._geometry=null,0==i.length&&t&&this.dispose()}},t.prototype.applyToMesh=function(e){if(e._geometry!==this){var t=e._geometry;t&&t.releaseForMesh(e);var i=this._meshes;e._geometry=this,this._scene.pushGeometry(this),i.push(e),this.isReady()?this._applyToMesh(e):e._boundingInfo=this._boundingInfo}},t.prototype._applyToMesh=function(t){var i=this._meshes.length;for(var r in this._vertexBuffers)if(1===i&&this._vertexBuffers[r].create(),this._vertexBuffers[r]._buffer.references=i,r===e.VertexBuffer.PositionKind){t._resetPointsArrayCache();var n=e.Tools.ExtractMinAndMax(this._vertexBuffers[r].getData(),0,this._totalVertices);t._boundingInfo=new e.BoundingInfo(n.minimum,n.maximum),t._createGlobalSubMesh()}1===i&&this._indices&&(this._indexBuffer=this._engine.createIndexBuffer(this._indices)),this._indexBuffer&&(this._indexBuffer.references=i)},t.prototype.load=function(t,i){var r=this;if(this.delayLoadState!==e.Engine.DELAYLOADSTATE_LOADING){if(this.isReady())return void(i&&i());this.delayLoadState=e.Engine.DELAYLOADSTATE_LOADING,t._addPendingData(this),e.Tools.LoadFile(this.delayLoadingFile,function(n){r._delayLoadingFunction(JSON.parse(n),r),r.delayLoadState=e.Engine.DELAYLOADSTATE_LOADED,r._delayInfo=[],t._removePendingData(r);for(var o=r._meshes,s=o.length,a=0;s>a;a++)r._applyToMesh(o[a]);i&&i()},function(){},t.database)}},t.prototype.dispose=function(){for(var t=this._meshes,i=t.length,r=0;i>r;r++)this.releaseForMesh(t[r]);this._meshes=[];for(var n in this._vertexBuffers)this._vertexBuffers[n].dispose();this._vertexBuffers=[],this._totalVertices=0,this._indexBuffer&&this._engine._releaseBuffer(this._indexBuffer),this._indexBuffer=null,this._indices=[],this.delayLoadState=e.Engine.DELAYLOADSTATE_NONE,this.delayLoadingFile=null,this._delayLoadingFunction=null,this._delayInfo=[],this._boundingInfo=null;var o=this._scene.getGeometries();r=o.indexOf(this),r>-1&&o.splice(r,1)},t.prototype.copy=function(t){var i=new e.VertexData;i.indices=[];for(var r=this.getIndices(),n=0;n<r.length;n++)i.indices.push(r[n]);var o=!1,s=!1;for(var a in this._vertexBuffers)i.set(this.getVerticesData(a),a),s||(o=this.getVertexBuffer(a).isUpdatable(),s=!o);var h=new e.Geometry(t,this._scene,i,o,null);h.delayLoadState=this.delayLoadState,h.delayLoadingFile=this.delayLoadingFile,h._delayLoadingFunction=this._delayLoadingFunction;for(a in this._delayInfo)h._delayInfo=h._delayInfo||[],h._delayInfo.push(a);var c=e.Tools.ExtractMinAndMax(this.getVerticesData(e.VertexBuffer.PositionKind),0,this.getTotalVertices());return h._boundingInfo=new e.BoundingInfo(c.minimum,c.maximum),h},t.ExtractFromMesh=function(e,t){var i=e._geometry;return i?i.copy(t):null},t.RandomId=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0,i="x"==e?t:3&t|8;return i.toString(16)})},t}();e.Geometry=t,function(t){!function(i){var r=function(e){function t(t,i,r,n,o){this._beingRegenerated=!0,this._canBeRegenerated=n,e.call(this,t,i,r,!1,o),this._beingRegenerated=!1}return __extends(t,e),t.prototype.canBeRegenerated=function(){return this._canBeRegenerated},t.prototype.regenerate=function(){this._canBeRegenerated&&(this._beingRegenerated=!0,this.setAllVerticesData(this._regenerateVertexData(),!1),this._beingRegenerated=!1)},t.prototype.asNewGeometry=function(t){return e.prototype.copy.call(this,t)},t.prototype.setAllVerticesData=function(t){this._beingRegenerated&&e.prototype.setAllVerticesData.call(this,t,!1)},t.prototype.setVerticesData=function(t,i){this._beingRegenerated&&e.prototype.setVerticesData.call(this,t,i,!1)},t.prototype._regenerateVertexData=function(){throw new Error("Abstract method")},t.prototype.copy=function(){throw new Error("Must be overriden in sub-classes.")},t}(t);i._Primitive=r;var n=function(t){function i(e,i,r,n,o){this.size=r,t.call(this,e,i,this._regenerateVertexData(),n,o)}return __extends(i,t),i.prototype._regenerateVertexData=function(){return e.VertexData.CreateBox(this.size)},i.prototype.copy=function(e){return new i(e,this.getScene(),this.size,this.canBeRegenerated(),null)},i}(r);i.Box=n;var o=function(t){function i(e,i,r,n,o,s){this.segments=r,this.diameter=n,t.call(this,e,i,this._regenerateVertexData(),o,s)}return __extends(i,t),i.prototype._regenerateVertexData=function(){return e.VertexData.CreateSphere(this.segments,this.diameter)},i.prototype.copy=function(e){return new i(e,this.getScene(),this.segments,this.diameter,this.canBeRegenerated(),null)},i}(r);i.Sphere=o;var s=function(t){function i(e,i,r,n,o,s,a,h){this.height=r,this.diameterTop=n,this.diameterBottom=o,this.tessellation=s,t.call(this,e,i,this._regenerateVertexData(),a,h)}return __extends(i,t),i.prototype._regenerateVertexData=function(){return e.VertexData.CreateCylinder(this.height,this.diameterTop,this.diameterBottom,this.tessellation)},i.prototype.copy=function(e){return new i(e,this.getScene(),this.height,this.diameterTop,this.diameterBottom,this.tessellation,this.canBeRegenerated(),null)},i}(r);i.Cylinder=s;var a=function(t){function i(e,i,r,n,o,s,a){this.diameter=r,this.thickness=n,this.tessellation=o,t.call(this,e,i,this._regenerateVertexData(),s,a)}return __extends(i,t),i.prototype._regenerateVertexData=function(){return e.VertexData.CreateTorus(this.diameter,this.thickness,this.tessellation)},i.prototype.copy=function(e){return new i(e,this.getScene(),this.diameter,this.thickness,this.tessellation,this.canBeRegenerated(),null)},i}(r);i.Torus=a;var h=function(t){function i(e,i,r,n,o,s,a){this.width=r,this.height=n,this.subdivisions=o,t.call(this,e,i,this._regenerateVertexData(),s,a)}return __extends(i,t),i.prototype._regenerateVertexData=function(){return e.VertexData.CreateGround(this.width,this.height,this.subdivisions)},i.prototype.copy=function(e){return new i(e,this.getScene(),this.width,this.height,this.subdivisions,this.canBeRegenerated(),null)},i}(r);i.Ground=h;var c=function(t){function i(e,i,r,n,o){this.size=r,t.call(this,e,i,this._regenerateVertexData(),n,o)}return __extends(i,t),i.prototype._regenerateVertexData=function(){return e.VertexData.CreatePlane(this.size)},i.prototype.copy=function(e){return new i(e,this.getScene(),this.size,this.canBeRegenerated(),null)},i}(r);i.Plane=c;var u=function(t){function i(e,i,r,n,o,s,a,h,c,u){this.radius=r,this.tube=n,this.radialSegments=o,this.tubularSegments=s,this.p=a,this.q=h,t.call(this,e,i,this._regenerateVertexData(),c,u)}return __extends(i,t),i.prototype._regenerateVertexData=function(){return e.VertexData.CreateTorusKnot(this.radius,this.tube,this.radialSegments,this.tubularSegments,this.p,this.q)},i.prototype.copy=function(e){return new i(e,this.getScene(),this.radius,this.tube,this.radialSegments,this.tubularSegments,this.p,this.q,this.canBeRegenerated(),null)},i}(r);i.TorusKnot=u}(t.Primitives||(t.Primitives={}));t.Primitives}(e.Geometry||(e.Geometry={}));var t=e.Geometry}(BABYLON||(BABYLON={}));var __extends=this.__extends||function(e,t){function i(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);i.prototype=t.prototype,e.prototype=new i},BABYLON;!function(e){var t=function(t){function i(i,r){t.call(this,i,r),this.generateOctree=!1,this._worldInverse=new e.Matrix}return __extends(i,t),Object.defineProperty(i.prototype,"subdivisions",{get:function(){return this._subdivisions},enumerable:!0,configurable:!0}),i.prototype.optimize=function(){this.subdivide(this._subdivisions),this.createOrUpdateSubmeshesOctree(32)},i.prototype.getHeightAtCoordinates=function(t,i){var r=new e.Ray(new e.Vector3(t,this.getBoundingInfo().boundingBox.maximumWorld.y+1,i),new e.Vector3(0,-1,0));this.getWorldMatrix().invertToRef(this._worldInverse),r=e.Ray.Transform(r,this._worldInverse);var n=this.intersects(r);if(n.hit){var o=e.Vector3.TransformCoordinates(n.pickedPoint,this.getWorldMatrix());return o.y}return 0},i}(e.Mesh);e.GroundMesh=t}(BABYLON||(BABYLON={}));var __extends=this.__extends||function(e,t){function i(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);i.prototype=t.prototype,e.prototype=new i},BABYLON;!function(e){var t=function(){function t(e){var t=this;this.babylonGamepads=[],this.oneGamepadConnected=!1,this.isMonitoring=!1,this.gamepadEventSupported="GamepadEvent"in window,this.gamepadSupportAvailable=navigator.getGamepads||!!navigator.webkitGetGamepads||!!navigator.msGetGamepads||!!navigator.webkitGamepads,this.buttonADataURL="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAA9aSURBVHja7FtpbBzneX7m3otcihSpm9Z9UJalxPKhVLZlp6ktNzEaxE0CtAnQAgnSoPWPBi3syuiPwordFi5Qt2haFygCoylSV4Vby6os1I3kOLYrS65kXXQoypJJSaFEUTyXy925+rzfzC6HFFlL1kpAIe7i5czO7H7zPs97ft8MtTAMcSu/dNzirxkCZgiYIWCGgBkCZgi4hV/mDR5fSxAt+0ZiX0ucDxMSTJLK+f83BFSA6TFgK75OclshouKBFbA+xaV4k7Z+fD6sNRlmjYFXQMu4NiUVS/oHe5/ecnHo3MYxd7QthN9UcsdW6FqEPwgDOFbqpAajL2VlTrTULzj4Ow8+s4+nipSxWMoxIUkyrl/pGswFtIR7WzHgDCX77K7vfHNkbOA+AryjYZadb27OIJdzCNZBKmXw4kbk35qPsTEfJbeEkZESentHMdBfGtY142gu1bDvqV/925f4tQJlNCaj4hXX7RHXS0AFuJEAXvfHr/zmk67vPjir0V68aFEe8xtuQ6O1FHlrEXLmHBiaDUtzYBlpNYjrF+GFZfhhCcPeBQy53ehzT+H8QBe6uwfRf7l8xjKsvX/y5X98jl8fThDhJ4i46QQkrS5I6v7oX7/++77vPtLUlFnZtnIRlubvxRxnHbJmE79sxD/SqG0oZk8MFarRqufUkQAFrxcXSkfx0eB+nOggKX2jHYZhvf79r/z4L2IiipO84aYRkASfefnAX695p3P3c9mM/UufuaMVdzRvxVx7A0xaWdOMqVULJ6Z3TZv6KmHo0ztK6CkfxpHe3Th0pAuF0fLbn1u+9cmv3vW77bE3fGoSPi0BVfAvvPEHm9rPv//iooWz5m9Z/wCWZx+Go9UrN48QTD9IGMZ1cJIzTPisRQclPMrhME4W9mDfB2+i+2z/+TXz7/z2E7/85+9OIuGGE6BV3H77zm/d33nx6Ktr18zFg2t+DQude2n1tLJ8tcJ90vDhpG5Am7qTkJAQErywiLOld7G3/d9xvL0Hy1vWPbbtS3//00Q4hDeaAFXintrx1fu7+jp2r13bgofX/gaazbVkJQdLT9P6VqRFDSu2hIgXlBUBLgtCr3cce47/CMePX0Rr08qtzz7+8k8TpfKGtcKq1jPZre7oObyjdWkGd628l7AXwvMCeL7HjO6qrS8S1E5kTE9tfbiur665ccU9EB1EF9Ep0WXesEZIJb9j5/b/XUtzNrt29Rw0og2lchmBVqLo8LSAHlCixbTpddGm8Y7pjkttCCUP+JQy3FiatNuxdvUx9F4ayopO/OL9sQeEN4oA/eHn577oWPbGVes11PsrUBxjDafze1Te1VzouqnK2TgmLQljQqmrnAsT+iaPVb5b2co7EC+QhBgUeM1R1AcrsGp9Jy6+4W8U3fZ8r+e3EnOI2uaAX3l+zgNB4O9rW5/B8tY5WGo9BtOrJ4uMfUl+uj0B8HTmPXj8Pex86xVEnTDBBSE2r78fX9i09RPyZfT2A5ceIMSPwDOH8JH7Kk5+fAHtR0Zh6MZ9e7534Wc3wgO0sXLhD9OpFOa0egjGMhguD8BgTJooMfPbV1h/umz25ondcFP90IzY2iTgrfY9uH31aqSc9CeSEHkBEyITv28M8XMGc2/z0HGCpWCs8BS/9sWrDYOrJuCBZ+vu5sUfXbicia5kYGzUw4DWTwJKbApSjHuTBBjT2H68zg0MD4KlEwabZi0Y7wd85u/3O9/B6sVrPlEXeiF9nMmRxPt6Qf4y/HyIbh3HwkdF1zefGt5fUwK8wP2WAGwh02MFE/5ogYr3Qg/STL0W3d8aB1ppa+Pw0uI2Tz6/134Mg+UoIGZlZ2HMLaJYHkPICr6//RBamvPj/UA4dYKsegGrXqAXMaqNsDT6SreOY5Gu/FptCeBFN+caAphGiKFiGaOjA3AJHoGt6r7GgNbjqjo5yQkBUVHQ8PaJExjiaZ2yue12nO27gCNdHSptvf/xGdw11I2UZSmvCIJgQiJMhoEfeqpNDvUSRvUB5hMX9fUecg0aBi+Hm2uaAz633bmbm1VN8+h07LfKJdkOkQB2fL4BTlsj8No4YLG2putMSjwjp3QNvZdH8YsiExV501isFjU30lpF7D8dVfCA8sFHp7BuWYtaIwiCsCrCSDVhh9IX8k0CoHsoMQ84FrfFAE3zQAK0VaLzO9tK79XKAxSj+aYALt3XLfNipZD1v492YexrE/sP0zBgUIQIoYaflAXbz16CzyY6YKqYl8uheTarRioD7xAxCQHUpv18L1Yud+Iloujtk4zQo9WZcKURqjbHclzKvj0Gvcw8UA6oY2WqonSuGQGb5I+TJgEFEsB4daXzc0eopabcX13W0BXwgAnRZL4Q62s8ppnR/pFz/QjF+tRvxeIsY/cizGwRt83P4czACL8HdA1JUivCNGVogvdkNkgaGDNe4CvXFyJ8n+B5XGLJ1FmJXJ53AzjZKgGbatkKL5c/liNWIPO8uM/4VO2uKCQZjLmBqQAGJ4EmI8NMabDTOuyUobYXmPlCEpiqA1IkYdWSBpjpEDl6wsrF9aAjqHNOPXDyXAGprAknY5B0btOGGk/GlfE1taqofCNuuYNIJ+omOiZ1rpUHtEYWjkpWoP5EWV2sb5isA7aIQTHHxaIniNADui8PIs0Eb6SY/Z0UQc+j+mXYuoM7Vy/Age7zkBUyCZGLhRLSOYcWpfXFA1wPhqup8JNKq5UkKeoqSHxPLSoqnUQtw5ioc60IyE/VkOji8mYE2nZELNgCXLaOkGDFJBg4OzCMDEcxCfAzS1pQX5fHSNDLClLGwmwzls6vQ09hGFJYegdZ1hha2bqIBNelB5Qjog02TzpFNVEquYpMuTSYr/lcQPKPJHoRQ8W1GYO3lDgpO9pPWTEZEQGnuodg5Hyk66Lyd8fKOQQ6gqyWict7GeuWz8HQyWEFw+bB7ksF3Nk2V1nfpZTLQqSLslzXlDmHpsQ1osVoy/Solwf/GpdErpaAQUqjWxL2GWcWaSfAMIis7RBwiuCdtD1OgmNHBJCg7r4uZBnbdjaaq+3YewB+USYicY8juYPnMtloqdCjG3f39eO+3JKIAFadSiiZigBdgdcqItMxsmZbIbvUIKlzzQjoEgLGRjU2KTp8AjRCkzEnAG0mtQh8Ku0oAqok8JzP+Lw0MkB3jpKjKpapaL5WKZxafDdBqoC6O8LtyMAQhoZdzG7MwLU8FUYKPINcl+qimismRj26v2I71I3jDxfdpM41I6CTsmG4X0djKyc8RYu9t0Vl2QJbBJ5xFPiICJIg1hdhR3fs5HnWeldleZXABLA98b7Y5HtjkgwNEtbTN4iFC5oI3I1CTsAbsfVjAizJB3Qbx9HphRp6eqr3TDprSYA0FI/3ntOxbpUNM2OjpEcE6HYEWkhIKw+ICeBxi+T09F1WZU+iJq2n8fRDf4Ymu3XSrcOIgg8H9uOFn31fNUVC0oddZ7B5YxtDwlTgo66SEici2fokwCJjju0hw7J54WypQsB7tSRAza+H+nld30Y+m2b7SS+Qn9PKFl1egRciHIfWpxC8x+7tdA97+3zUcNyWX4Ci/THOoD2x/hmlQTox+3gDjWYeg/4gmF853xjBpUsjaGnJR24fu36FNzX5pmfY7EPStlSLIgb6gwk616QRYk8tS88/l/2PT/loyqbQkEmhPpNGNp1CmvtieQHvONGtL4sdy9Hjp5kkpTWmSzM7L529hErHs0cCpt2qW00BymDV3JXSU8HkAXKIjtNnedxS48m4Mr5cR9YlMrx+XTqNRmbP2ZkMOjvHKir/PNa5pouiitFjH44iZ6YwO5tFAy+eo6SdpOUJyhBQTJR+HT9HYLJaFve0PqQmTQLaVOCdmIRIWE+wrmWTzG8iAugF7qgWjSWkGbYa32EjJQTkGFv5dBZNJKCeHdb77UPXZP1rWhKLZ4Rqjv2Fz86lLMNlpusCY9BnqTNUIyTgrVhhs7rVq2KoW2TSxWlXLOCqWX4svmpzZdEjWvgQcdVWPnu+i4ClUS+HyLIFnsVf/9eBduw8eKYy2D1XMxO8Jg+IB9wl+3s/uAC3qKMpXY88m/ecnUHaSis3Na8Ab1UtaCh3j1y+sm8m9o0J+9Fv9MR4Zhw6DufTWasOebsOs+xZKHJOtvtQtertulrwV+0BtH5yWvyW7CxubsCTX9+KUQZ4ga7qmdGUFmrya8QWHwcxlReMF8Mw4QETrR8oy7tq2ivH5Tvya8n8aXZMGc4An/nRDpy52FfR8b5KCJCImt8YkYF/KDtnegfwz3sPodGajQajCTk9z/4mQ6iphMWv9AA9IeMWdyYdn+gBkVc5amwHWV6lHvVaI2YZzfinN95Ngv/htcT/p31CRNbdV8l8e++xD5HPNeHxhx5Bgf18kTN5T1kvjBfEjGjBJCai4gnjHqAnlvqS8e9NeujEjEul/NokDbai4V/2voafHD1S0evdWLeb8ojMNyly5fS//ffbcD0L33j4K4RX4rtMh/UUGLXmr6BWXN9MEFAhYfzmZ6hcXI+TpISRH8061Ui68gTWGUJP4aU9P8ZrB39S+Xkx1ummPSMkbebnJcxU1jm4D5eGhvB7j32HJcpUJHhxLIfxTZpxwGa8eKrHC51a9Tmp+N5P1RsQ01cJAwEflHw8/+pfYn/HgaQ+n7/a1vd6k+BUS2XvVD401TXhu488gQ0r71QUuLJsrWT8mSYtfkBMm0BAmFhNrgDX4oRqqeaJMw4c6TyIv/qPP0Xf8KUJ6sXuP1XluuEEyGsD5TXKgsqBNQvW4RtbnkDb4ttJQlGt/IQqLMJE7tWqOSBZCSrL6dFSqq3AnzhzDC/tewHt5w4nr3suvgN0+P8o3TeegFe3vYDHtj+xhLt/Q3kkeW5d693YuuHXsWHZPcixW4tCwo+trVU9QEs8G6HFqW5kdBiHTu3H64dfxpGuK8r665Tv7tz2D6e/tP23cT0E1OA5QR2iiIbs1i9u/9qTPPC12CtwlIofjZVvW/BZ3LVsC5bPW4u5DQuxaPay2NpRIuy61IkLA+dw8hdHceDUPpw49z9TXUysvWPXtl3bQ4yQtMJ1a18DAsbvRO/atvM5DXXPPbp9yzP8+GXBXTkngKYBdTWvE5RXdm87+HQEfLh2T57UIAdM95Js9+04LKSDbLzG31+Omxpx9xfxKR6AukkhMP0aKuUHsag5VEzE3fGSddsUVu6KFzIE+H/iJry0mX+bu8VfMwTMEDBDwAwBMwTMEHALv/5XgAEASpR5N6rB30UAAAAASUVORK5CYII=",this._callbackGamepadConnected=e,this.gamepadSupportAvailable?(this.gamepadEventSupported?(window.addEventListener("gamepadconnected",function(e){t._onGamepadConnected(e)},!1),window.addEventListener("gamepaddisconnected",function(e){t._onGamepadDisconnected(e)},!1)):this._startMonitoringGamepads(),this.oneGamepadConnected||this._insertGamepadDOMInstructions()):this._insertGamepadDOMNotSupported()}return t.prototype._insertGamepadDOMInstructions=function(){t.gamepadDOMInfo=document.createElement("div");var e=document.createElement("img");e.src=this.buttonADataURL;var i=document.createElement("span");i.innerHTML="<strong>to activate gamepad</strong>",t.gamepadDOMInfo.appendChild(e),t.gamepadDOMInfo.appendChild(i),t.gamepadDOMInfo.style.position="absolute",t.gamepadDOMInfo.style.width="100%",t.gamepadDOMInfo.style.height="48px",t.gamepadDOMInfo.style.bottom="0px",t.gamepadDOMInfo.style.backgroundColor="rgba(1, 1, 1, 0.15)",t.gamepadDOMInfo.style.textAlign="center",t.gamepadDOMInfo.style.zIndex="10",e.style.position="relative",e.style.bottom="8px",i.style.position="relative",i.style.fontSize="32px",i.style.bottom="32px",i.style.color="green",document.body.appendChild(t.gamepadDOMInfo)},t.prototype._insertGamepadDOMNotSupported=function(){t.gamepadDOMInfo=document.createElement("div");var e=document.createElement("span");e.innerHTML="<strong>gamepad not supported</strong>",t.gamepadDOMInfo.appendChild(e),t.gamepadDOMInfo.style.position="absolute",t.gamepadDOMInfo.style.width="100%",t.gamepadDOMInfo.style.height="40px",t.gamepadDOMInfo.style.bottom="0px",t.gamepadDOMInfo.style.backgroundColor="rgba(1, 1, 1, 0.15)",t.gamepadDOMInfo.style.textAlign="center",t.gamepadDOMInfo.style.zIndex="10",e.style.position="relative",e.style.fontSize="32px",e.style.color="red",document.body.appendChild(t.gamepadDOMInfo)},t.prototype._onGamepadConnected=function(e){var t=this._addNewGamepad(e.gamepad);this._callbackGamepadConnected&&this._callbackGamepadConnected(t),this._startMonitoringGamepads()},t.prototype._addNewGamepad=function(i){this.oneGamepadConnected||(this.oneGamepadConnected=!0,t.gamepadDOMInfo&&(document.body.removeChild(t.gamepadDOMInfo),t.gamepadDOMInfo=null));var r;return r=-1!==i.id.search("Xbox 360")||-1!==i.id.search("xinput")?new e.Xbox360Pad(i.id,i.index,i):new e.GenericPad(i.id,i.index,i),this.babylonGamepads.push(r),r},t.prototype._onGamepadDisconnected=function(e){for(var t in this.babylonGamepads)if(this.babylonGamepads[t].index==e.gamepad.index){this.babylonGamepads.splice(t,1);break}0==this.babylonGamepads.length&&this._stopMonitoringGamepads()},t.prototype._startMonitoringGamepads=function(){this.isMonitoring||(this.isMonitoring=!0,this._checkGamepadsStatus())},t.prototype._stopMonitoringGamepads=function(){this.isMonitoring=!1},t.prototype._checkGamepadsStatus=function(){var e=this;this._updateGamepadObjects();for(var t in this.babylonGamepads)this.babylonGamepads[t].update();this.isMonitoring&&(window.requestAnimationFrame?window.requestAnimationFrame(function(){e._checkGamepadsStatus()}):window.mozRequestAnimationFrame?window.mozRequestAnimationFrame(function(){e._checkGamepadsStatus()}):window.webkitRequestAnimationFrame&&window.webkitRequestAnimationFrame(function(){e._checkGamepadsStatus()}))},t.prototype._updateGamepadObjects=function(){for(var e=navigator.getGamepads?navigator.getGamepads():navigator.webkitGetGamepads?navigator.webkitGetGamepads():[],t=0;t<e.length;t++)if(e[t])if(e[t].index in this.babylonGamepads)this.babylonGamepads[t].browserGamepad=e[t];else{var i=this._addNewGamepad(e[t]);this._callbackGamepadConnected&&this._callbackGamepadConnected(i)}},t}();e.Gamepads=t;var i=function(){function e(e,t){this.x=e,this.y=t}return e}();e.StickValues=i;var r=function(){function e(e,t,i){this.id=e,this.index=t,this.browserGamepad=i,this.browserGamepad.axes.length>=2&&(this._leftStick={x:this.browserGamepad.axes[0],y:this.browserGamepad.axes[1]}),this.browserGamepad.axes.length>=4&&(this._rightStick={x:this.browserGamepad.axes[2],y:this.browserGamepad.axes[3]})}return e.prototype.onleftstickchanged=function(e){this._onleftstickchanged=e},e.prototype.onrightstickchanged=function(e){this._onrightstickchanged=e},Object.defineProperty(e.prototype,"leftStick",{get:function(){return this._leftStick},set:function(e){!this._onleftstickchanged||this._leftStick.x===e.x&&this._leftStick.y===e.y||this._onleftstickchanged(e),this._leftStick=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"rightStick",{get:function(){return this._rightStick},set:function(e){!this._onrightstickchanged||this._rightStick.x===e.x&&this._rightStick.y===e.y||this._onrightstickchanged(e),this._rightStick=e},enumerable:!0,configurable:!0}),e.prototype.update=function(){this._leftStick&&(this.leftStick={x:this.browserGamepad.axes[0],y:this.browserGamepad.axes[1]}),this._rightStick&&(this.rightStick={x:this.browserGamepad.axes[2],y:this.browserGamepad.axes[3]})},e}();e.Gamepad=r;var n=function(e){function t(t,i,r){e.call(this,t,i,r),this.id=t,this.index=i,this.gamepad=r,this._buttons=new Array(r.buttons.length)}return __extends(t,e),t.prototype.onbuttondown=function(e){this._onbuttondown=e},t.prototype.onbuttonup=function(e){this._onbuttonup=e},t.prototype._setButtonValue=function(e,t,i){return e!==t&&(this._onbuttondown&&1===e&&this._onbuttondown(i),this._onbuttonup&&0===e&&this._onbuttonup(i)),e},t.prototype.update=function(){e.prototype.update.call(this);for(var t=0;t<this._buttons.length;t++)this._buttons[t]=this._setButtonValue(this.gamepad.buttons[t].value,this._buttons[t],t)},t}(r);e.GenericPad=n,function(e){e[e.A=0]="A",e[e.B=1]="B",e[e.X=2]="X",e[e.Y=3]="Y",e[e.Start=4]="Start",e[e.Back=5]="Back",e[e.LB=6]="LB",e[e.RB=7]="RB",e[e.LeftStick=8]="LeftStick",e[e.RightStick=9]="RightStick"}(e.Xbox360Button||(e.Xbox360Button={}));e.Xbox360Button;!function(e){e[e.Up=0]="Up",e[e.Down=1]="Down",e[e.Left=2]="Left",e[e.Right=3]="Right"}(e.Xbox360Dpad||(e.Xbox360Dpad={}));var o=(e.Xbox360Dpad,function(e){function t(){e.apply(this,arguments),this._leftTrigger=0,this._rightTrigger=0,this._buttonA=0,this._buttonB=0,this._buttonX=0,this._buttonY=0,this._buttonBack=0,this._buttonStart=0,this._buttonLB=0,this._buttonRB=0,this._buttonLeftStick=0,this._buttonRightStick=0,this._dPadUp=0,this._dPadDown=0,this._dPadLeft=0,this._dPadRight=0}return __extends(t,e),t.prototype.onlefttriggerchanged=function(e){this._onlefttriggerchanged=e},t.prototype.onrighttriggerchanged=function(e){this._onrighttriggerchanged=e},Object.defineProperty(t.prototype,"leftTrigger",{get:function(){return this._leftTrigger},set:function(e){this._onlefttriggerchanged&&this._leftTrigger!==e&&this._onlefttriggerchanged(e),this._leftTrigger=e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"rightTrigger",{get:function(){return this._rightTrigger},set:function(e){this._onrighttriggerchanged&&this._rightTrigger!==e&&this._onrighttriggerchanged(e),this._rightTrigger=e},enumerable:!0,configurable:!0}),t.prototype.onbuttondown=function(e){this._onbuttondown=e},t.prototype.onbuttonup=function(e){this._onbuttonup=e},t.prototype.ondpaddown=function(e){this._ondpaddown=e},t.prototype.ondpadup=function(e){this._ondpadup=e},t.prototype._setButtonValue=function(e,t,i){return e!==t&&(this._onbuttondown&&1===e&&this._onbuttondown(i),this._onbuttonup&&0===e&&this._onbuttonup(i)),e},t.prototype._setDPadValue=function(e,t,i){return e!==t&&(this._ondpaddown&&1===e&&this._ondpaddown(i),this._ondpadup&&0===e&&this._ondpadup(i)),e},Object.defineProperty(t.prototype,"buttonA",{get:function(){return this._buttonA},set:function(e){this._buttonA=this._setButtonValue(e,this._buttonA,0)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"buttonB",{get:function(){return this._buttonB},set:function(e){this._buttonB=this._setButtonValue(e,this._buttonB,1)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"buttonX",{get:function(){return this._buttonX},set:function(e){this._buttonX=this._setButtonValue(e,this._buttonX,2)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"buttonY",{get:function(){return this._buttonY},set:function(e){this._buttonY=this._setButtonValue(e,this._buttonY,3)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"buttonStart",{get:function(){return this._buttonStart},set:function(e){this._buttonStart=this._setButtonValue(e,this._buttonStart,4)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"buttonBack",{get:function(){return this._buttonBack},set:function(e){this._buttonBack=this._setButtonValue(e,this._buttonBack,5)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"buttonLB",{get:function(){return this._buttonLB},set:function(e){this._buttonLB=this._setButtonValue(e,this._buttonLB,6)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"buttonRB",{get:function(){return this._buttonRB},set:function(e){this._buttonRB=this._setButtonValue(e,this._buttonRB,7)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"buttonLeftStick",{get:function(){return this._buttonLeftStick},set:function(e){this._buttonLeftStick=this._setButtonValue(e,this._buttonLeftStick,8)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"buttonRightStick",{get:function(){return this._buttonRightStick},set:function(e){this._buttonRightStick=this._setButtonValue(e,this._buttonRightStick,9)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"dPadUp",{get:function(){return this._dPadUp},set:function(e){this._dPadUp=this._setDPadValue(e,this._dPadUp,0)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"dPadDown",{get:function(){return this._dPadDown},set:function(e){this._dPadDown=this._setDPadValue(e,this._dPadDown,1)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"dPadLeft",{get:function(){return this._dPadLeft},set:function(e){this._dPadLeft=this._setDPadValue(e,this._dPadLeft,2)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"dPadRight",{get:function(){return this._dPadRight},set:function(e){this._dPadRight=this._setDPadValue(e,this._dPadRight,3)},enumerable:!0,configurable:!0}),t.prototype.update=function(){e.prototype.update.call(this),this.buttonA=this.browserGamepad.buttons[0].value,this.buttonB=this.browserGamepad.buttons[1].value,this.buttonX=this.browserGamepad.buttons[2].value,this.buttonY=this.browserGamepad.buttons[3].value,this.buttonLB=this.browserGamepad.buttons[4].value,this.buttonRB=this.browserGamepad.buttons[5].value,this.leftTrigger=this.browserGamepad.buttons[6].value,this.rightTrigger=this.browserGamepad.buttons[7].value,this.buttonBack=this.browserGamepad.buttons[8].value,this.buttonStart=this.browserGamepad.buttons[9].value,this.buttonLeftStick=this.browserGamepad.buttons[10].value,this.buttonRightStick=this.browserGamepad.buttons[11].value,this.dPadUp=this.browserGamepad.buttons[12].value,this.dPadDown=this.browserGamepad.buttons[13].value,this.dPadLeft=this.browserGamepad.buttons[14].value,this.dPadRight=this.browserGamepad.buttons[15].value},t}(r));e.Xbox360Pad=o}(BABYLON||(BABYLON={}));var __extends=this.__extends||function(e,t){function i(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);i.prototype=t.prototype,e.prototype=new i},BABYLON;!function(e){var t=function(t){function i(i,r,n){var o=this;t.call(this,i,r,n),this.angularSensibility=200,this.moveSensibility=75,this._gamepads=new e.Gamepads(function(e){o._onNewGameConnected(e)})}return __extends(i,t),i.prototype._onNewGameConnected=function(e){0===e.index&&(this._gamepad=e)},i.prototype._checkInputs=function(){if(this._gamepad){var t=this._gamepad.leftStick,i=t.x/this.moveSensibility,r=t.y/this.moveSensibility;t.x=Math.abs(i)>.005?0+i:0,t.y=Math.abs(r)>.005?0+r:0;var n=this._gamepad.rightStick,o=n.x/this.angularSensibility,s=n.y/this.angularSensibility;n.x=Math.abs(o)>.001?0+o:0,n.y=Math.abs(s)>.001?0+s:0;var a=e.Matrix.RotationYawPitchRoll(this.rotation.y,this.rotation.x,0),h=e.Vector3.TransformCoordinates(new e.Vector3(t.x,0,-t.y),a);this.cameraDirection=this.cameraDirection.add(h),this.cameraRotation=this.cameraRotation.add(new e.Vector3(n.y,n.x,0))}},i.prototype.dispose=function(){},i}(e.FreeCamera);e.GamepadCamera=t}(BABYLON||(BABYLON={}));